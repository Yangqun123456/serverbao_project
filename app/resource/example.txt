/**
 * 
 */
package com.jusfoun;

import org.apache.log4j.Logger;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.context.web.SpringBootServletInitializer;
import org.springframework.boot.web.servlet.ServletComponentScan;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.scheduling.annotation.EnableScheduling;

@SpringBootApplication
@ServletComponentScan
@ComponentScan
@EnableScheduling
public class Application extends SpringBootServletInitializer 
{
    private static Logger logger = Logger.getLogger(Application.class);
    
    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder application) {
        return application.sources(Application.class);
    }

    
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
        logger.info("============= SpringBoot Start Success =============");
    }
}

package com.jusfoun.core.druid;

import com.alibaba.druid.pool.DruidDataSource;
import com.alibaba.druid.support.http.StatViewServlet;
import com.alibaba.druid.support.http.WebStatFilter;
import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;
import org.springframework.boot.context.embedded.FilterRegistrationBean;
import org.springframework.boot.context.embedded.ServletRegistrationBean;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;
import java.sql.SQLException;

/**
 * projectName:jap
 * author:mic
 * version:2016/8/10 16:30
 * desc:
 */
@Configuration
public class DruidConfiguration {
    @Bean
    public DataSource dataSource(DataSourceProperties dataSourceProperties) {
        DruidDataSource druidDataSource = new DruidDataSource();
        druidDataSource.setDriverClassName(dataSourceProperties.getDriverClassName());
        druidDataSource.setUrl(dataSourceProperties.getUrl());
        druidDataSource.setUsername(dataSourceProperties.getUsername());
        druidDataSource.setPassword(dataSourceProperties.getPassword());
        try {
            druidDataSource.setFilters("stat,wall");
            druidDataSource.init();
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return druidDataSource;
    }

    @Bean
    public ServletRegistrationBean druidServlet() {
        return new ServletRegistrationBean(new StatViewServlet(), "/druid/*");
    }

    @Bean
    public FilterRegistrationBean filterRegistrationBean() {
        FilterRegistrationBean filterRegistrationBean = new FilterRegistrationBean();
        filterRegistrationBean.setFilter(new WebStatFilter());
        filterRegistrationBean.addUrlPatterns("/*");
        filterRegistrationBean.addInitParameter("exclusions", "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*");
        return filterRegistrationBean;
    }

}

/*
 * The MIT License (MIT)
 *
 * Copyright (c) 2014-2016 abel533@gmail.com
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

package com.jusfoun.core.mybatis;

import com.github.pagehelper.PageHelper;
import org.apache.ibatis.plugin.Interceptor;
import org.apache.ibatis.session.SqlSessionFactory;
import org.mybatis.spring.SqlSessionFactoryBean;
import org.mybatis.spring.SqlSessionTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;
import org.springframework.core.io.support.ResourcePatternResolver;
import org.springframework.jdbc.datasource.DataSourceTransactionManager;
import org.springframework.transaction.PlatformTransactionManager;
import org.springframework.transaction.annotation.EnableTransactionManagement;
import org.springframework.transaction.annotation.TransactionManagementConfigurer;

import javax.sql.DataSource;
import java.util.Properties;

/**
 * MyBatis基础配置
 *
 * @author liuzh
 * @since 2015-12-19 10:11
 */
@Configuration
@EnableTransactionManagement
public class MyBatisConfig implements TransactionManagementConfigurer {

    @Autowired
    DataSource dataSource;

    @Bean(name = "sqlSessionFactory")
    public SqlSessionFactory sqlSessionFactoryBean() {
        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();
        bean.setDataSource(dataSource);
        bean.setTypeAliasesPackage("com.jusfoun.jap");

        //分页插件
        PageHelper pageHelper = new PageHelper();
        Properties properties = new Properties();
        properties.setProperty("reasonable", "true");
        properties.setProperty("supportMethodsArguments", "true");
        properties.setProperty("returnPageInfo", "check");
        properties.setProperty("params", "count=countSql");
        pageHelper.setProperties(properties);

        //添加插件
        bean.setPlugins(new Interceptor[]{pageHelper});

        //添加XML目录
        ResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
        try {
            bean.setMapperLocations(resolver.getResources("classpath:/mybatis/*/*.xml"));
            return bean.getObject();
        } catch (Exception e) {
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }

    @Bean
    public SqlSessionTemplate sqlSessionTemplate(SqlSessionFactory sqlSessionFactory) {
        return new SqlSessionTemplate(sqlSessionFactory);
    }

    @Bean
    @Override
    public PlatformTransactionManager annotationDrivenTransactionManager() {
        return new DataSourceTransactionManager(dataSource);
    }
}

/*
 * The MIT License (MIT)
 *
 * Copyright (c) 2014-2016 abel533@gmail.com
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

package com.jusfoun.core.mybatis;

import org.springframework.boot.autoconfigure.AutoConfigureAfter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import tk.mybatis.spring.mapper.MapperScannerConfigurer;
import java.util.Properties;
//import tk.mybatis.mapper.common.Mapper;

/**
 * MyBatis扫描接口，使用的tk.mybatis.spring.mapper.MapperScannerConfigurer，如果你不使用通用Mapper，可以改为org.xxx...
 *
 * @author liuzh
 * @since 2015-12-19 14:46
 */
@Configuration
//TODO 注意，由于MapperScannerConfigurer执行的比较早，所以必须有下面的注解
@AutoConfigureAfter(MyBatisConfig.class)
public class MyBatisMapperScannerConfig {

    @Bean
    public MapperScannerConfigurer mapperScannerConfigurer() {
        MapperScannerConfigurer mapperScannerConfigurer = new MapperScannerConfigurer();
        mapperScannerConfigurer.setSqlSessionFactoryBeanName("sqlSessionFactory");
        mapperScannerConfigurer.setBasePackage("com.jusfoun.jap");
        Properties properties = new Properties();
        properties.setProperty("mappers", "tk.mybatis.mapper.common.Mapper");
        properties.setProperty("notEmpty", "false");
//        properties.setProperty("IDENTITY", "MYSQL");
        mapperScannerConfigurer.setProperties(properties);
        return mapperScannerConfigurer;
    }

}

package com.jusfoun.core.shiro;

import java.util.List;

import javax.annotation.Resource;
import org.apache.shiro.authc.AuthenticationInfo;
import org.apache.shiro.authc.AuthenticationToken;
import org.apache.shiro.authc.UsernamePasswordToken;
import org.apache.shiro.authc.credential.HashedCredentialsMatcher;
import com.jusfoun.jap.dataCenter.request.UserAuthenticationRequest;
import com.jusfoun.jap.dataCenter.response.UserAuthenticationResponse;
import com.jusfoun.jap.dataCenter.service.UserAuthenticationService;
import com.jusfoun.jap.dataCenter.util.ConvertBeanUtil;
import com.jusfoun.jap.dataCenter.util.DataCenterConstant;

public class MyHashedCredentialsMatcher extends HashedCredentialsMatcher {
	@Resource
	private UserAuthenticationService userAuthenticationService;
	public boolean doCredentialsMatch(AuthenticationToken token, AuthenticationInfo info) {
		
		UsernamePasswordToken t = (UsernamePasswordToken) token;
		String username = t.getUsername();
		String password = String.valueOf(t.getPassword());
		
		if ("1".equals(DataCenterConstant.SSO)) {
			UserAuthenticationRequest request = new UserAuthenticationRequest();
			request.setUsername(username);
			request.setPassword(password);
			request.setSystemFlag(DataCenterConstant.SYSTEMFLAG);
			List<UserAuthenticationResponse> response = (List<UserAuthenticationResponse>) userAuthenticationService
					.sendRequest("userAuthenticationService", ConvertBeanUtil.convertBean(request));
			if(null != response && response.size() > 0)
			{
				return true;
			}
			else
			{
				return false;
			}
		} else {
			Object tokenHashedCredentials = hashProvidedCredentials(token, info);
			Object accountCredentials = getCredentials(info);
			return equals(tokenHashedCredentials, accountCredentials);
		}
	}
}

package com.jusfoun.core.shiro;

import java.util.LinkedHashMap;
import java.util.Map;

import javax.servlet.Filter;

import org.apache.shiro.cache.ehcache.EhCacheManager;
import org.apache.shiro.session.mgt.eis.EnterpriseCacheSessionDAO;
import org.apache.shiro.spring.LifecycleBeanPostProcessor;
import org.apache.shiro.spring.web.ShiroFilterFactoryBean;
import org.apache.shiro.web.filter.authc.LogoutFilter;
import org.apache.shiro.web.mgt.DefaultWebSecurityManager;
import org.apache.shiro.web.servlet.SimpleCookie;
import org.apache.shiro.web.session.mgt.DefaultWebSessionManager;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class ShiroConfiguration {
    
	@Bean(name = "securityManager")
	public DefaultWebSecurityManager securityManager(){
		DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager();
		securityManager.setCacheManager(shiroCacheManager());
		securityManager.setRealm(shiroDbRealm());
		securityManager.setSessionMode("native");
		securityManager.setSessionManager(shiroSessionManager());
		return securityManager;
	}
	
	@Bean(name = "shiroCacheManager")
	public EhCacheManager shiroCacheManager(){
		EhCacheManager ehCacheManager = new EhCacheManager();
		ehCacheManager.setCacheManagerConfigFile("classpath:ehcache.xml");
		return ehCacheManager;
	}
	
	@Bean(name = "shiroDbRealm")
    public ShiroDbRealm shiroDbRealm() {
		ShiroDbRealm realm = new ShiroDbRealm(); 
		realm.setCredentialsMatcher(credentialsMatcher());
        return realm;
    }
	
	@Bean(name = "credentialsMatcher")
	public MyHashedCredentialsMatcher credentialsMatcher() {
		MyHashedCredentialsMatcher credentialsMatcher = new MyHashedCredentialsMatcher();
		credentialsMatcher.setHashAlgorithmName("MD5");
		credentialsMatcher.setHashIterations(1);
		credentialsMatcher.setStoredCredentialsHexEncoded(true);
		return credentialsMatcher;
	}
	
	@Bean(name = "shiroSessionManager")
    public DefaultWebSessionManager shiroSessionManager() {
		DefaultWebSessionManager sessionManager = new DefaultWebSessionManager(); 
		sessionManager.setSessionDAO(sessionDAO());
		sessionManager.setSessionIdCookieEnabled(true);
		sessionManager.setSessionIdCookie(sessionIdCookie());
		sessionManager.setSessionValidationSchedulerEnabled(true);
		sessionManager.setDeleteInvalidSessions(true);
        return sessionManager;
    }
	
	@Bean(name = "sessionDAO")
    public EnterpriseCacheSessionDAO sessionDAO() {
		EnterpriseCacheSessionDAO sessionDao = new EnterpriseCacheSessionDAO(); 
		sessionDao.setActiveSessionsCacheName("shiro-activeSessionCache");
        return sessionDao;
    }
	
	@Bean(name = "sessionIdCookie")
    public SimpleCookie sessionIdCookie() {
		SimpleCookie simpleCookie = new SimpleCookie(); 
		simpleCookie.setName("sid");
		simpleCookie.setHttpOnly(true);
		simpleCookie.setMaxAge(-1);
        return simpleCookie;
    }
	
	@Bean(name = "shiroFilter")
	public ShiroFilterFactoryBean shiroFilterFactoryBean(){
		ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
		shiroFilterFactoryBean.setSecurityManager(securityManager());
		shiroFilterFactoryBean.setLoginUrl("/login");
		shiroFilterFactoryBean.setSuccessUrl("/");
		shiroFilterFactoryBean.setUnauthorizedUrl("/403");
		
		Map<String, Filter> filters = new LinkedHashMap<String, Filter>();
		LogoutFilter logoutFilter = new LogoutFilter();
		logoutFilter.setRedirectUrl("/login");
		filters.put("logout", logoutFilter);
		shiroFilterFactoryBean.setFilters(filters);
		
		Map<String, String> filterChainDefinitionManager = new LinkedHashMap<String, String>();
		//放开请求kylin的公共方法
		filterChainDefinitionManager.put("/api/kylin/**", "anon");
		filterChainDefinitionManager.put("/stories/**", "anon");
		filterChainDefinitionManager.put("/login", "anon");
		filterChainDefinitionManager.put("/logout", "logout");
		filterChainDefinitionManager.put("/logon.html", "anon");
		filterChainDefinitionManager.put("/api.html", "anon");
		filterChainDefinitionManager.put("/css/**", "anon");
		filterChainDefinitionManager.put("/img/**", "anon");
		filterChainDefinitionManager.put("/js/**", "anon");
		filterChainDefinitionManager.put("/scripts/**", "anon");
		filterChainDefinitionManager.put("/jsonData/**", "anon");
		filterChainDefinitionManager.put("/**", "user");
		filterChainDefinitionManager.put("/*.json", "anon");
		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionManager);
		
		return shiroFilterFactoryBean;
	}

	@Bean(name = "lifecycleBeanPostProcessor")
    public LifecycleBeanPostProcessor lifecycleBeanPostProcessor() {
        return new LifecycleBeanPostProcessor();
    }
}


package com.jusfoun.core.shiro;

import java.util.List;
import java.util.Set;

import javax.annotation.Resource;

import org.apache.commons.collections.CollectionUtils;
import org.apache.shiro.SecurityUtils;
import org.apache.shiro.authc.AuthenticationException;
import org.apache.shiro.authc.AuthenticationInfo;
import org.apache.shiro.authc.AuthenticationToken;
import org.apache.shiro.authc.SimpleAuthenticationInfo;
import org.apache.shiro.authc.UsernamePasswordToken;
import org.apache.shiro.authz.AuthorizationInfo;
import org.apache.shiro.authz.SimpleAuthorizationInfo;
import org.apache.shiro.cache.Cache;
import org.apache.shiro.realm.AuthorizingRealm;
import org.apache.shiro.session.Session;
import org.apache.shiro.subject.PrincipalCollection;
import org.apache.shiro.subject.SimplePrincipalCollection;
import org.apache.shiro.subject.Subject;
import org.apache.shiro.util.ByteSource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.itmuch.core.constants.SessionConstants;
import com.itmuch.core.util.SubjectUtil;
import com.jusfoun.jap.admin.domain.User;
import com.jusfoun.jap.admin.service.RoleService;
import com.jusfoun.jap.admin.service.UserService;

public class ShiroDbRealm extends AuthorizingRealm {

	@Resource
    private UserService userService;
    @Resource
    private RoleService roleService;

    private static final Logger LOGGER = LoggerFactory.getLogger(ShiroDbRealm.class);

    /**
     * 授权查询回调函数, 进行鉴权但缓存中无用户的授权信息时调用.
     */
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {

        SimpleAuthorizationInfo auth = new SimpleAuthorizationInfo();

        // 1. 通过用户id,查询用户具有的角色(查询sys_admin_role)
        Long id = SubjectUtil.getUser().getId();
        // 如果是超级管理员, 则拥有所有权限, 不受角色约束
        List<String> permissions = null;
        if (1L == id) {
            permissions = this.userService.selectAllPermissions();
        }
        // 并非超管
        else {
            List<Long> roleIds = this.userService.selectRoleIdListByUserId(id);
            if ((roleIds != null) && !roleIds.isEmpty()) {
                // 2. 通过角色id, 查询角色具有的权限
                permissions = this.userService.selectPermissionsByRoleIds(roleIds);

            }
        }
        if ((permissions != null) && !permissions.isEmpty()) {
            auth.addStringPermissions(permissions);
            return auth;
        }
        return null;
    }

    /**
     * 认证回调函数,登录时调用.
     */
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException {
        UsernamePasswordToken token = (UsernamePasswordToken) authenticationToken;
        String username = token.getUsername();
        LOGGER.info("用户:{}尝试登陆.", username);

        User user = this.userService.selectByUsername(username);

        if (user != null) {
            SimpleAuthenticationInfo info = new SimpleAuthenticationInfo(username, user.getPassword(), ByteSource.Util.bytes(user.getSalt()),
                    this.getName());

            com.itmuch.core.util.User currUser = new com.itmuch.core.util.User();
            currUser.setUsername(user.getUsername());
            currUser.setMobile(user.getMobile());
            currUser.setId(user.getId());

            this.setSession(SessionConstants.USER, currUser);

            return info;
        } else {
            return null;
        }

    }

    /**
     * 设置session
     * @param key key
     * @param value value
     */
    private void setSession(Object key, Object value) {
        Subject currentUser = SecurityUtils.getSubject();
        if (null != currentUser) {
            Session session = currentUser.getSession();
            if (null != session) {
                session.setAttribute(key, value);
            }
        }
    }

    /**
     * 参考文档: http://www.tuicool.com/articles/rEvqym
     * 参考文档: http://sishuok.com/forum/blogPost/list/7461.html
     * 参考文档: http://m.blog.csdn.net/blog/LHacker/19340757
     */
    public void clearCache() {
        Subject subject = SecurityUtils.getSubject();
        super.clearCachedAuthorizationInfo(subject.getPrincipals());
    }

    /**
     * 通过身份信息, 清空该用户的权限缓存
     * 参考: http://m.blog.csdn.net/blog/LHacker/19340757
     * @param principle 身份信息
     */
    public void clearAuthorizationCacheByPrinciple(String principle) {
        String cacheName = this.getAuthorizationCacheName();
        Cache<Object, Object> cache = this.getCacheManager().getCache(cacheName);

        Set<Object> keys = cache.keys();
        if (CollectionUtils.isNotEmpty(keys)) {
            for (Object key : keys) {
                SimplePrincipalCollection spc = (SimplePrincipalCollection) key;
                if (principle.equals(spc.toString())) {
                    cache.remove(key);
                    break;
                }
            }
        }

    }

}

package com.jusfoun.jap.admin.controller;

import java.util.Map;

import javax.servlet.ServletRequest;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.apache.shiro.SecurityUtils;
import org.apache.shiro.authc.AuthenticationException;
import org.apache.shiro.authc.UsernamePasswordToken;
import org.apache.shiro.session.Session;
import org.apache.shiro.subject.Subject;
import org.apache.tomcat.util.http.fileupload.servlet.ServletRequestContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import com.itmuch.core.util.SubjectUtil;
import com.jusfoun.jap.admin.domain.User;
import com.jusfoun.jap.util.StringUtil;

/**
 * 登陆controller, 用于未整合cas的情况
 * @author zhouli
 */
@Controller
public class LoginAdminController {
	
	private static final Logger LOGGER = LoggerFactory.getLogger(LoginAdminController.class);
	
    @RequestMapping("/login")
    public String login(ServletRequest request) {
    	String username = request.getParameter("username");
    	String sysflag = request.getParameter("sysflag");
        Subject subject = SecurityUtils.getSubject();
        if (!subject.isAuthenticated()) {
        	if(StringUtil.isEmpty(sysflag))
        	{
        		return "redirect:/logon.html";
        	}
        	else
        	{
				try {
					UsernamePasswordToken token = new UsernamePasswordToken(username, "");
					SecurityUtils.getSubject().login(token);
				} catch (AuthenticationException e) {
					LOGGER.error(e.getMessage(), e);
					return "redirect:/logon.html";
				}
				return "redirect:/index.html";
			}
        } else {
            // 登陆成功/以及已经登陆过的用户,直接跳到后台首页
            return "redirect:/index.html";
        }

    }

    @RequestMapping(value = "/login", method = RequestMethod.POST)
    @ResponseBody
    public boolean preLogin(User user, RedirectAttributes ra,ServletRequest request) throws Exception {
        // 查询用户的手机号和验证码对比，如果成功：
        boolean mobileCheck = true;
        if (mobileCheck) {
            UsernamePasswordToken token = new UsernamePasswordToken(user.getUsername(), user.getPassword());
            try {
                SecurityUtils.getSubject().login(token);
                ra.addFlashAttribute("username", user.getUsername());
            } catch (AuthenticationException e) {
            	LOGGER.error(e.getMessage(), e);
                ra.addFlashAttribute("loginError", "账号或密码有误.");
                ra.addFlashAttribute("username", user.getUsername());
                ra.addFlashAttribute("password", user.getPassword());
                return false;
            }
            return true;
        } else {
            // 告诉用户验证码不正确
            return true;
        }
    }
    
    /**
     * 登出
     *
     * @param result
     *            返回结果
     * @return 登出返回的信息
     * @throws Exception 
     */
    @RequestMapping(value = "/logout")
    @ResponseBody
    public String logout(ServletRequest request) throws Exception {
    	if (SecurityUtils.getSubject().getSession() != null) {
        SecurityUtils.getSubject().logout();
    	 }
        return "redirect:/logon.html";
    }
    
    /**
     * 获取用户名
     * @return
     * @throws Exception
     */
    @RequestMapping(value = "/getUserName")
    @ResponseBody
    public String getUserName() throws Exception {
    	String name = SubjectUtil.getUser().getUsername();
        if(name != null){
        	return name;
        }else{
        	return null;
        }
    }

}

package com.jusfoun.jap.admin.domain;

import javax.persistence.Column;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "B_MENU")
public class Menu extends BaseEntity {
    /**
     * id
     */
    @Id
    @Column(name = "ID")
    @GeneratedValue(strategy = GenerationType.IDENTITY, generator = "select B_MENU_ID_SEQ.nextval from dual")
    private Long id;

    /**
     * 父级id
     */
    @Column(name = "PARENT_ID")
    private Long parentId;

    /**
     * 名称
     */
    @Column(name = "NAME")
    private String name;

    /**
     * 排序
     */
    @Column(name = "LIST_ORDER")
    private Integer listOrder;

    /**
     * 链接
     */
    @Column(name = "HREF")
    private String href;

    /**
     * 目标
     */
    @Column(name = "TARGET")
    private String target;

    /**
     * 图标
     */
    @Column(name = "ICON")
    private String icon;

    /**
     * 是否在菜单中显示 0:否 1:是
     */
    @Column(name = "SHOW_FLAG")
    private Short showFlag;

    /**
     * 权限标识
     */
    @Column(name = "PERMISSION")
    private String permission;

    private static final long serialVersionUID = 1L;

    /**
     * 获取id
     *
     * @return ID - id
     */
    @Override
    public Long getId() {
        return this.id;
    }

    /**
     * 设置id
     *
     * @param id id
     */
    @Override
    public void setId(Long id) {
        this.id = id;
    }

    /**
     * 获取父级id
     *
     * @return PARENT_ID - 父级id
     */
    public Long getParentId() {
        return this.parentId;
    }

    /**
     * 设置父级id
     *
     * @param parentId 父级id
     */
    public void setParentId(Long parentId) {
        this.parentId = parentId;
    }

    /**
     * 获取名称
     *
     * @return NAME - 名称
     */
    public String getName() {
        return this.name;
    }

    /**
     * 设置名称
     *
     * @param name 名称
     */
    public void setName(String name) {
        this.name = name;
    }

    /**
     * 获取排序
     *
     * @return LIST_ORDER - 排序
     */
    public Integer getListOrder() {
        return this.listOrder;
    }

    /**
     * 设置排序
     *
     * @param listOrder 排序
     */
    public void setListOrder(Integer listOrder) {
        this.listOrder = listOrder;
    }

    /**
     * 获取链接
     *
     * @return HREF - 链接
     */
    public String getHref() {
        return this.href;
    }

    /**
     * 设置链接
     *
     * @param href 链接
     */
    public void setHref(String href) {
        this.href = href;
    }

    /**
     * 获取目标
     *
     * @return TARGET - 目标
     */
    public String getTarget() {
        return this.target;
    }

    /**
     * 设置目标
     *
     * @param target 目标
     */
    public void setTarget(String target) {
        this.target = target;
    }

    /**
     * 获取图标
     *
     * @return ICON - 图标
     */
    public String getIcon() {
        return this.icon;
    }

    /**
     * 设置图标
     *
     * @param icon 图标
     */
    public void setIcon(String icon) {
        this.icon = icon;
    }

    /**
     * 获取是否在菜单中显示 0:否 1:是
     *
     * @return SHOW_FLAG - 是否在菜单中显示 0:否 1:是
     */
    public Short getShowFlag() {
        return this.showFlag;
    }

    /**
     * 设置是否在菜单中显示 0:否 1:是
     *
     * @param showFlag 是否在菜单中显示 0:否 1:是
     */
    public void setShowFlag(Short showFlag) {
        this.showFlag = showFlag;
    }

    /**
     * 获取权限标识
     *
     * @return PERMISSION - 权限标识
     */
    public String getPermission() {
        return this.permission;
    }

    /**
     * 设置权限标识
     *
     * @param permission 权限标识
     */
    public void setPermission(String permission) {
        this.permission = permission;
    }
}
package com.jusfoun.jap.admin.domain;

import javax.persistence.Column;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "B_ROLE")
public class Role extends BaseEntity {
    /**
     * id
     */
    @Id
    @Column(name = "ID")
    @GeneratedValue(strategy = GenerationType.IDENTITY, generator = "select B_ROLE_ID_SEQ.nextval from dual")
    private Long id;

    /**
     * 归属机构
     */
    @Column(name = "OFFICE_ID")
    private Long officeId;

    /**
     * 角色名称
     */
    @Column(name = "NAME")
    private String name;

    /**
     * 英文名称
     */
    @Column(name = "ENNAME")
    private String enname;

    /**
     * 角色类型
     */
    @Column(name = "ROLE_TYPE")
    private Short roleType;

    /**
     * 是否系统数据 0否 1是
     */
    @Column(name = "SYS_FLAG")
    private Short sysFlag;

    /**
     * 状态 0:可用 1:禁用
     */
    @Column(name = "STATUS")
    private Short status;

    private static final long serialVersionUID = 1L;

    /**
     * 获取id
     *
     * @return ID - id
     */
    @Override
    public Long getId() {
        return this.id;
    }

    /**
     * 设置id
     *
     * @param id id
     */
    @Override
    public void setId(Long id) {
        this.id = id;
    }

    /**
     * 获取归属机构
     *
     * @return OFFICE_ID - 归属机构
     */
    public Long getOfficeId() {
        return this.officeId;
    }

    /**
     * 设置归属机构
     *
     * @param officeId 归属机构
     */
    public void setOfficeId(Long officeId) {
        this.officeId = officeId;
    }

    /**
     * 获取角色名称
     *
     * @return NAME - 角色名称
     */
    public String getName() {
        return this.name;
    }

    /**
     * 设置角色名称
     *
     * @param name 角色名称
     */
    public void setName(String name) {
        this.name = name;
    }

    /**
     * 获取英文名称
     *
     * @return ENNAME - 英文名称
     */
    public String getEnname() {
        return this.enname;
    }

    /**
     * 设置英文名称
     *
     * @param enname 英文名称
     */
    public void setEnname(String enname) {
        this.enname = enname;
    }

    /**
     * 获取角色类型
     *
     * @return ROLE_TYPE - 角色类型
     */
    public Short getRoleType() {
        return this.roleType;
    }

    /**
     * 设置角色类型
     *
     * @param roleType 角色类型
     */
    public void setRoleType(Short roleType) {
        this.roleType = roleType;
    }

    /**
     * 获取是否系统数据 0否 1是
     *
     * @return SYS_FLAG - 是否系统数据 0否 1是
     */
    public Short getSysFlag() {
        return this.sysFlag;
    }

    /**
     * 设置是否系统数据 0否 1是
     *
     * @param sysFlag 是否系统数据 0否 1是
     */
    public void setSysFlag(Short sysFlag) {
        this.sysFlag = sysFlag;
    }

    /**
     * 获取状态 0:可用 1:禁用
     *
     * @return STATUS - 状态 0:可用 1:禁用
     */
    public Short getStatus() {
        return this.status;
    }

    /**
     * 设置状态 0:可用 1:禁用
     *
     * @param status 状态 0:可用 1:禁用
     */
    public void setStatus(Short status) {
        this.status = status;
    }
}
package com.jusfoun.jap.admin.domain;

import java.util.Date;

import javax.persistence.Column;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "B_USER")
public class User extends BaseEntity {
    /**
     * id
     */
    @Id
    @Column(name = "ID")
    @GeneratedValue(strategy = GenerationType.IDENTITY, generator = "select B_USER_ID_SEQ.nextval from dual")
    private Long id;

    /**
     * 用户名
     */
    @Column(name = "USERNAME")
    private String username;

    /**
     * 密码
     */
    @Column(name = "PASSWORD")
    private String password;

    /**
     * 盐
     */
    @Column(name = "SALT")
    private String salt;

    /**
     * 姓名
     */
    @Column(name = "NAME")
    private String name;

    /**
     * 邮箱
     */
    @Column(name = "EMAIL")
    private String email;

    /**
     * 电话
     */
    @Column(name = "PHONE")
    private String phone;

    /**
     * 手机
     */
    @Column(name = "MOBILE")
    private String mobile;

    /**
     * 用户类型 0普通用户 1管理员
     */
    @Column(name = "USER_TYPE")
    private Short userType;

    /**
     * 用户头像
     */
    @Column(name = "PHOTO")
    private String photo;

    /**
     * 最后登陆IP
     */
    @Column(name = "LAST_IP")
    private String lastIp;

    /**
     * 最后登陆时间
     */
    @Column(name = "LAST_TIME")
    private Date lastTime;

    /**
     * 用户状态 0:正常 1:查封 2:待审核
     */
    @Column(name = "STATUS")
    private Short status;
    

    /**
     * 用户uuid-用户中心
     */
    @Column(name = "USER_ID")
    private String userId;

    /**
     * 性别
     */
    @Column(name = "USER_GENDER")
    private String userGender;

    /**
     * 安全级别
     */
    @Column(name = "SECURITY_LEVEL")
    private String securityLevel;

    /**
     * 所在机构
     */
    @Column(name = "GOV_NAME")
    private String govName;

    /**
     * 所在岗位
     */
    @Column(name = "JOB_NAME")
    private String jobName;
    
    /**
     * 创建时间
     */
    @Column(name = "CREATE_TIME")
    private Date createTime;
    
    /**
     * 更新时间
     */
    @Column(name = "UPDATE_TIME")
    private Date updateTime;

    private static final long serialVersionUID = 1L;

    /**
     * 获取id
     *
     * @return ID - id
     */
    @Override
    public Long getId() {
        return this.id;
    }

    /**
     * 设置id
     *
     * @param id id
     */
    @Override
    public void setId(Long id) {
        this.id = id;
    }

    /**
     * 获取用户名
     *
     * @return USERNAME - 用户名
     */
    public String getUsername() {
        return this.username;
    }

    /**
     * 设置用户名
     *
     * @param username 用户名
     */
    public void setUsername(String username) {
        this.username = username;
    }

    /**
     * 获取密码
     *
     * @return PASSWORD - 密码
     */
    public String getPassword() {
        return this.password;
    }

    /**
     * 设置密码
     *
     * @param password 密码
     */
    public void setPassword(String password) {
        this.password = password;
    }

    /**
     * 获取盐
     *
     * @return SALT - 盐
     */
    public String getSalt() {
        return this.salt;
    }

    /**
     * 设置盐
     *
     * @param salt 盐
     */
    public void setSalt(String salt) {
        this.salt = salt;
    }

    /**
     * 获取姓名
     *
     * @return NAME - 姓名
     */
    public String getName() {
        return this.name;
    }

    /**
     * 设置姓名
     *
     * @param name 姓名
     */
    public void setName(String name) {
        this.name = name;
    }

    /**
     * 获取邮箱
     *
     * @return EMAIL - 邮箱
     */
    public String getEmail() {
        return this.email;
    }

    /**
     * 设置邮箱
     *
     * @param email 邮箱
     */
    public void setEmail(String email) {
        this.email = email;
    }

    /**
     * 获取电话
     *
     * @return PHONE - 电话
     */
    public String getPhone() {
        return this.phone;
    }

    /**
     * 设置电话
     *
     * @param phone 电话
     */
    public void setPhone(String phone) {
        this.phone = phone;
    }

    /**
     * 获取手机
     *
     * @return MOBILE - 手机
     */
    public String getMobile() {
        return this.mobile;
    }

    /**
     * 设置手机
     *
     * @param mobile 手机
     */
    public void setMobile(String mobile) {
        this.mobile = mobile;
    }

    /**
     * 获取用户类型 0普通用户 1管理员
     *
     * @return USER_TYPE - 用户类型 0普通用户 1管理员
     */
    public Short getUserType() {
        return this.userType;
    }

    /**
     * 设置用户类型 0普通用户 1管理员
     *
     * @param userType 用户类型 0普通用户 1管理员
     */
    public void setUserType(Short userType) {
        this.userType = userType;
    }

    /**
     * 获取用户头像
     *
     * @return PHOTO - 用户头像
     */
    public String getPhoto() {
        return this.photo;
    }

    /**
     * 设置用户头像
     *
     * @param photo 用户头像
     */
    public void setPhoto(String photo) {
        this.photo = photo;
    }

    /**
     * 获取最后登陆IP
     *
     * @return LAST_IP - 最后登陆IP
     */
    public String getLastIp() {
        return this.lastIp;
    }

    /**
     * 设置最后登陆IP
     *
     * @param lastIp 最后登陆IP
     */
    public void setLastIp(String lastIp) {
        this.lastIp = lastIp;
    }

    /**
     * 获取最后登陆时间
     *
     * @return LAST_TIME - 最后登陆时间
     */
    public Date getLastTime() {
        return this.lastTime;
    }

    /**
     * 设置最后登陆时间
     *
     * @param lastTime 最后登陆时间
     */
    public void setLastTime(Date lastTime) {
        this.lastTime = lastTime;
    }

    /**
     * 获取用户状态 0:正常 1:查封 2:待审核
     *
     * @return STATUS - 用户状态 0:正常 1:查封 2:待审核
     */
    public Short getStatus() {
        return this.status;
    }

    /**
     * 设置用户状态 0:正常 1:查封 2:待审核
     *
     * @param status 用户状态 0:正常 1:查封 2:待审核
     */
    public void setStatus(Short status) {
        this.status = status;
    }

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public String getUserGender() {
		return userGender;
	}

	public void setUserGender(String userGender) {
		this.userGender = userGender;
	}

	public String getSecurityLevel() {
		return securityLevel;
	}

	public void setSecurityLevel(String securityLevel) {
		this.securityLevel = securityLevel;
	}

	public String getGovName() {
		return govName;
	}

	public void setGovName(String govName) {
		this.govName = govName;
	}

	public String getJobName() {
		return jobName;
	}

	public void setJobName(String jobName) {
		this.jobName = jobName;
	}

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}
}
package com.jusfoun.jap.admin.mapper;

import java.util.List;

import org.apache.ibatis.annotations.Param;

import com.jusfoun.jap.admin.domain.Role;
import com.jusfoun.jap.admin.vo.RoleVo;

import tk.mybatis.mapper.common.Mapper;

public interface RoleMapper extends Mapper<Role> {

    public Integer insertRoleMenu(@Param("roleId") Long roleId, @Param("menuIds") List<Long> menuIds);

    public void deleteRoleMenuById(Long id);

    public Long selectCountAdminIdByRoleId(Long id);

    public List<Long> selectMenuIdsByRoleId(Long id);

    /**
     * 封装前台查询条件
     * @param queuryVo  前台查询条件
     * @return
     */
    public List<Role> conditionPageQuery(RoleVo queuryVo);
}
package com.jusfoun.jap.admin.mapper;

import java.util.List;

import org.apache.ibatis.annotations.Param;

import com.jusfoun.jap.admin.domain.User;
import com.jusfoun.jap.admin.vo.UserVo;

import tk.mybatis.mapper.common.Mapper;

public interface UserMapper extends Mapper<User> {

    public List<Long> selectRoleIdListByUserId(Long id);

    public void insertUserRole(@Param("userId") Long userId, @Param("roleIds") List<Long> roleIds);

    public void deleteUserRoleByUserId(Long id);

    public User selectByUsername(String loginName);

    public List<String> selectAllPermissions();

    public List<String> selectPermissionsByRoleIds(List<Long> roleIds);

    public Long selectIdByUsername(String loginName);

    /**
     * 封装前台查询条件
     * @param queuryVo  前台查询条件
     * @return
     */
    public List<User> conditionPageQuery(UserVo queuryVo);

	public void insertBatchUser(List<User> userList);

	public void updateBatchUser(List<User> updateUserList);

	public void delBatchUser(List<Long> delUserList);
}
package com.jusfoun.jap.admin.service;

import java.util.List;

import org.springframework.stereotype.Service;

import com.github.pagehelper.PageHelper;
import com.itmuch.core.page.PageInfo;
import com.itmuch.core.page.PageVo;
import com.itmuch.core.service.BaseService;
import com.itmuch.core.util.DozerUtil;
import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.admin.domain.Role;
import com.jusfoun.jap.admin.mapper.RoleMapper;
import com.jusfoun.jap.admin.vo.PageInfoVo;
import com.jusfoun.jap.admin.vo.RoleVo;

@Service
public class RoleService extends BaseService<RoleMapper, Role> {

    public PageInfoVo<Role> listAllPaged(PageVo pageVo, RoleVo roleVo) {
        PageHelper.startPage(pageVo.getPage(), pageVo.getRows(), " u.id");
        List<Role> list = this.dao.conditionPageQuery(roleVo);
        PageInfo<Role> info = new PageInfo<Role>(list);
        PageInfoVo<Role> infoVo = new PageInfoVo<Role>(info.getList(), list);
        return infoVo;
    }

    public List<Role> listAll() {
        return this.dao.selectAll();
    }

    // TODO 数据权限暂时不做
    public Integer insert(RoleVo vo) {
        Role role = DozerUtil.map(vo, Role.class);

        super.insertSelective(role);
        Long roleId = role.getId();

        // 插入到sys_role_menu中间表
        List<Long> menuIds = vo.getMenuIds();
        if ((menuIds != null) && !menuIds.isEmpty()) {
            this.dao.insertRoleMenu(roleId, menuIds);
        }
        return 0;
    }

    /**
     * 修改角色信息，已更新为只修改角色描述信息，角色授权以独立单独功能
     * @param vo
     * @return
     */
    public Integer updateById(RoleVo vo) {
        // 1. 修改实体
        Role role = DozerUtil.map(vo, Role.class);
        super.updateByPrimaryKeySelective(role);

        //        // 2. 清除中间表
        //        this.dao.deleteRoleMenuById(vo.getId());
        //
        //        // 3. 插入中间表
        //        List<Long> menuIds = vo.getMenuIds();
        //        if ((menuIds != null) && !menuIds.isEmpty()) {
        //            this.dao.insertRoleMenu(vo.getId(), menuIds);
        //        }
        return 0;
    }

    public Result deleteRoleById(Long id) {
        // 1. 查询该角色下有多少用户
        Long count = this.dao.selectCountAdminIdByRoleId(id);
        // 2. 角色下存在用户, 不允许删除
        if (count != 0) {
            return new Result("非法操作", "该角色下有用户存在, 该角色不允许删除!");
        }
        super.deleteById(id);
        return new Result("成功", "角色删除成功.");
    }

    /**
     * 根据角色id获RoleVo
     * @param id 角色id
     * @return
     */
    public RoleVo queryVoById(Long id) {
        if (id == null) {
            return null;
        } else {
            Role role = this.dao.selectByPrimaryKey(id);
            RoleVo roleVo = DozerUtil.map(role, RoleVo.class);
            List<Long> menuIds = this.dao.selectMenuIdsByRoleId(id);
            roleVo.setMenuIds(menuIds);
            return roleVo;
        }
    }

    /**
     * 修改角色、菜单关联关系表
     * @param roleVo
     */
    public int updageRoleMenuAuth(RoleVo roleVo) {
        // 1. 清除中间表
        this.dao.deleteRoleMenuById(roleVo.getId());
        // 2. 插入中间表
        List<Long> menuIds = roleVo.getMenuIds();
        if ((menuIds != null) && !menuIds.isEmpty()) {
            this.dao.insertRoleMenu(roleVo.getId(), menuIds);
        }
        return 0;
    }
}

package com.jusfoun.jap.admin.service;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.apache.shiro.crypto.hash.Md5Hash;
import org.springframework.stereotype.Service;

import com.github.pagehelper.PageHelper;
import com.google.common.collect.Lists;
import com.itmuch.core.constants.CodeConstant;
import com.itmuch.core.page.PageInfo;
import com.itmuch.core.page.PageVo;
import com.itmuch.core.service.BaseService;
import com.itmuch.core.util.DozerUtil;
import com.itmuch.core.util.ErrorMsgUtil;
import com.itmuch.core.util.SaltUtil;
import com.itmuch.core.util.SubjectUtil;
import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.admin.domain.User;
import com.jusfoun.jap.admin.mapper.UserMapper;
import com.jusfoun.jap.admin.vo.PageInfoVo;
import com.jusfoun.jap.admin.vo.UserAdminEditVo;
import com.jusfoun.jap.admin.vo.UserAdminRegVo;
import com.jusfoun.jap.admin.vo.UserVo;

@Service
public class UserService extends BaseService<UserMapper, User> {

    private static final int SALT_SIZE = 8;

    /**
     * 分页显示条件查询
     * @param vo
     * @param queuryVo
     * @return
     */
    public PageInfoVo<UserVo> conditionPageQuery(PageVo vo, UserVo queuryVo) {

        if ((queuryVo.getRoleIds() != null) && (queuryVo.getRoleIds().size() == 0)) {
            queuryVo.setRoleIds(null);
        }

        PageHelper.startPage(vo.getPage(), vo.getRows(), " u.username");
        List<User> list = this.dao.conditionPageQuery(queuryVo);
        PageInfo<User> info = new PageInfo<User>(list);
        List<UserVo> voList = Lists.newArrayList();

        if ((list != null) && !list.isEmpty()) {

            for (User admin : list) {
                UserVo adminVo = DozerUtil.map(admin, UserVo.class);
                adminVo.setPassword(null);

                // 查询用户的角色
                List<Long> roleIds = this.dao.selectRoleIdListByUserId(admin.getId());
                adminVo.setRoleIds(roleIds);
                voList.add(adminVo);
            }

            PageInfoVo<UserVo> infoVo = new PageInfoVo<UserVo>(info.getList(), voList);
            return infoVo;
        }
        return null;
    }

    public PageInfo<UserVo> listAllPaged(PageVo vo) {
        String order = vo.getOrder("CREATE_TIME");
        PageHelper.startPage(vo.getPage(), vo.getRows(), order);

        List<User> list = this.dao.selectAll();
        PageInfo<User> info = new PageInfo<User>(list);

        List<UserVo> voList = Lists.newArrayList();

        if ((list != null) && !list.isEmpty()) {

            for (User admin : list) {
                UserVo adminVo = DozerUtil.map(admin, UserVo.class);
                adminVo.setPassword(null);

                // 查询用户的角色
                List<Long> roleIds = this.dao.selectRoleIdListByUserId(admin.getId());
                // 之所以要加这个判断,是因为easyui 的combobox
                if ((roleIds != null) && roleIds.isEmpty()) {

                }
                adminVo.setRoleIds(roleIds);
                voList.add(adminVo);
            }
            PageInfo<UserVo> pageInfo = new PageInfo<UserVo>(null);
            pageInfo.setTotal(info.getTotal());
            pageInfo.setList(voList);

            return pageInfo;
        }
        return null;

    }

    public Integer insert(UserAdminRegVo vo) {
        User user = DozerUtil.map(vo, User.class);

        String saltString = SaltUtil.genSaltString(SALT_SIZE);
        user.setSalt(saltString);
        String password = user.getPassword();
        if (!StringUtils.isEmpty(password)) {
            user.setPassword(new Md5Hash(password, saltString).toString());
        }

        // 1. 插入到实体
        super.insertSelective(user);
        Long id = user.getId();

        // 2. 插入到中间表
        List<Long> roleIds = vo.getRoleIds();
        if ((roleIds != null) && !roleIds.isEmpty()) {
            this.dao.insertUserRole(id, roleIds);
        }
        return 0;
    }

    public Result updateUserById(UserAdminEditVo vo) {
        Long idSession = SubjectUtil.getUser().getId();
        if (idSession != 1L) {
            if (vo.getId() == 1) {
                return ErrorMsgUtil.error("失败", "该用户不允许被其他用户修改.", CodeConstant.DUPLICATE_DATA);
            }

            // 对于非id=1的用户,不允许修改自己的角色
            if (vo.getRoleIds() != null) {
                List<Long> roleIdsDB = this.dao.selectRoleIdListByUserId(vo.getId());
                if (!vo.getRoleIds().equals(roleIdsDB)) {
                    return ErrorMsgUtil.error("失败", "用户不允许修改自己的角色.", CodeConstant.PARAMTER_ERROR_CODE);
                }
            }
        }

        User userById = this.dao.selectByPrimaryKey(vo.getId());
        // 如果修改了用户名
        if (!userById.getUsername().equals(vo.getUsername())) {
            Long id = this.selectIdByUsername(vo.getUsername());
            if (id != null) {
                return ErrorMsgUtil.error("失败", "修改会员失败, 用户名重复.", CodeConstant.DUPLICATE_DATA);
            }
        }

        // 以下是允许修改的情况
        User user = DozerUtil.map(vo, User.class);
        String plainPassword = vo.getPassword();
        if (!StringUtils.isEmpty(plainPassword)) {
            user.setPassword(new Md5Hash(plainPassword, userById.getSalt()).toString());
        }
        // 1. 修改基础表
        super.updateByPrimaryKeySelective(user);

        // 2. 清除中间表
        this.dao.deleteUserRoleByUserId(vo.getId());

        // 3. 插入中间表
        List<Long> roleIds = vo.getRoleIds();
        if ((roleIds != null) && !roleIds.isEmpty()) {
            this.dao.insertUserRole(vo.getId(), roleIds);
        }
        return new Result("成功", "修改会员成功.");

    }

    /**
     * 通过登录名, 查询用户
     * @param loginName 登录名
     * @return 用户
     */
    public User selectByUsername(String loginName) {

        return this.dao.selectByUsername(loginName);
    }

    /**
     * 通过用户id, 查询用户拥有的角色id列表
     * @param id id
     * @return 角色id列表
     */
    public List<Long> selectRoleIdListByUserId(Long id) {
        return this.dao.selectRoleIdListByUserId(id);
    }

    /**
     * 查询所有的权限字符串, 用于超管授权
     * @return 所有权限字符串
     */
    public List<String> selectAllPermissions() {
        return this.dao.selectAllPermissions();
    }

    /**
     * 通过角色id列表, 查询权限字符串列表
     * @param roleIds 角色id列表
     * @return 权限字符串列表
     */
    public List<String> selectPermissionsByRoleIds(List<Long> roleIds) {

        return this.dao.selectPermissionsByRoleIds(roleIds);
    }

    @Override
    public Integer deleteById(Long id) {

        // 1. 删除用户 b_user表
        super.deleteById(id);
        // 2. 删除b_user_role表数据, 避免脏数据
        this.dao.deleteUserRoleByUserId(id);
        return 0;
    }

    /**
     * 通过登录名查询用户id
     * @param loginName 登录名
     * @return 个数
     */
    public Long selectIdByUsername(String loginName) {
        return this.dao.selectIdByUsername(loginName);
    }
    
    public List<User> queryAllUser()
    {
    	return this.dao.selectAll();
    }

	public void insertBatchUser(List<User> userList) {
		List<Long> roleIds = new ArrayList<Long>();
		roleIds.add(new Long(2));
		for(User user : userList)
		{
			this.dao.insertSelective(user);
	        this.dao.insertUserRole(user.getId(), roleIds);
		}
	}

	public void updateBatchUser(List<User> updateUserList) {
		for(User user : updateUserList)
		{
			this.dao.updateByPrimaryKeySelective(user);
		}
	}

	public void delBatchUser(List<Long> delUserList) {
		this.dao.delBatchUser(delUserList);
	}
}

package com.jusfoun.jap.admin.vo;

import java.util.Date;

import com.itmuch.core.entity.TreeEntity;

public class MenuTreeVo extends TreeEntity<MenuTreeVo> {
    private static final long serialVersionUID = -7111524913053070340L;
    
    /**
     * 角色菜单关联关系
     */
    private short roleMenu;
    /**
     * 名称.
     */
    private String name;
    /**
     * 父级菜单名称.
     */
    private String parentName;
    /**
     * 排序.
     */
    private Short sort;
    
    private Integer listOrder;
    /**
     * 链接.
     */
    private String href;

    /**
     * 目标.
     */
    private String target;

    /**
     * 图标.
     */
    private String icon;

    /**
     * 是否在菜单中显示 0:否 1:是.
     */
    private Byte showFlag;

    /**
     * 权限标识.
     */
    private String permission;

    /**
     * 创建者.
     */
    private Integer createId;

    /**
     * 创建时间.
     */
    private Date createTime;

    /**
     * 更新者.
     */
    private Integer updateId;

    /**
     * 更新时间.
     */
    private Date updateTime;

    /**
     * 备注信息.
     */
    private String remark;

    /**
     * 删除标记.
     */
    private Byte delFlag;

    private String text;

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public Short getSort() {
        return this.sort;
    }

    public void setSort(Short sort) {
        this.sort = sort;
    }

    public String getHref() {
        return this.href;
    }

    public void setHref(String href) {
        this.href = href;
    }

    public String getTarget() {
        return this.target;
    }

    public void setTarget(String target) {
        this.target = target;
    }

    public String getIcon() {
        return this.icon;
    }

    public void setIcon(String icon) {
        this.icon = icon;
    }

    public Byte getShowFlag() {
        return this.showFlag;
    }

    public void setShowFlag(Byte showFlag) {
        this.showFlag = showFlag;
    }

    public String getPermission() {
        return this.permission;
    }

    public void setPermission(String permission) {
        this.permission = permission;
    }

    public Integer getCreateId() {
        return this.createId;
    }

    public void setCreateId(Integer createId) {
        this.createId = createId;
    }

    public Date getCreateTime() {
        return this.createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public Integer getUpdateId() {
        return this.updateId;
    }

    public void setUpdateId(Integer updateId) {
        this.updateId = updateId;
    }

    public Date getUpdateTime() {
        return this.updateTime;
    }

    public void setUpdateTime(Date updateTime) {
        this.updateTime = updateTime;
    }

    public String getRemark() {
        return this.remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

    public Byte getDelFlag() {
        return this.delFlag;
    }

    public void setDelFlag(Byte delFlag) {
        this.delFlag = delFlag;
    }

    @Override
    public String getText() {
        return this.text;
    }

    @Override
    public void setText(String text) {
        this.text = text;
    }

	public short getRoleMenu() {
		return roleMenu;
	}

	public void setRoleMenu(short roleMenu) {
		this.roleMenu = roleMenu;
	}

	public String getParentName() {
		return parentName;
	}

	public void setParentName(String parentName) {
		this.parentName = parentName;
	}

	public Integer getListOrder() {
		return listOrder;
	}

	public void setListOrder(Integer listOrder) {
		this.listOrder = listOrder;
	}

}

package com.jusfoun.jap.admin.vo;

import java.util.List;
import java.util.Map;

import com.github.pagehelper.Page;

/**
 * 分页显示vo类，用于转换从数据库查询的对象集合为前台显示的vo对象集合
 * 封装了原始的分页数据信息
 * @author zhengshuguo
 * 2016年4月28日
 * @param <T> 用于转换前台显示的vo对象类型
 */
public class PageInfoVo<T> {
    public void setList(List<T> list) {
        this.list = list;
    }

    private final Boolean success = true;
    //当前页
    private int pageNum;
    //每页的数量
    private int pageSize;
    //当前页的数量
    private int size;
    //由于startRow和endRow不常用，这里说个具体的用法
    //可以在页面中"显示startRow到endRow 共size条数据"

    //当前页面第一个元素在数据库中的行号
    private int startRow;
    //当前页面最后一个元素在数据库中的行号
    private int endRow;
    //记录每页起始rowKey
    private List pageRowKey;
    //总记录数
    private long total;

    public void setTotal(long total) {
    	this.total = total;
        if (pageSize > 0) {
            pages = (int) (total / pageSize + ((total % pageSize == 0) ? 0 : 1));
        } else {
            pages = 0;
        }
        //判断页面边界
        this.judgePageBoudary();
    }
    

    //总页数
    private int pages;
    //结果集
    private List<T> list;

    //第一页
    private int firstPage;
    //前一页
    private int prePage;
    //下一页
    private int nextPage;
    //最后一页
    private int lastPage;

    //是否为第一页
    private boolean isFirstPage = false;
    //是否为最后一页
    private boolean isLastPage = false;
    //是否有前一页
    private boolean hasPreviousPage = false;
    //是否有下一页
    private boolean hasNextPage = false;
    //导航页码数
    private int navigatePages;
    //所有导航页号
    private int[] navigatepageNums;

    //phoenix分页需要
    private String nextRowKey;
    
    public PageInfoVo() {
		super();
		// TODO Auto-generated constructor stub
	}

	/**
     *
     * @param pageList Page类型的数据库查询的支持分页的对象集合
     * @param pageVoList   已经被转换的用于前台显示的vo对象集合
     */
    public PageInfoVo(List pageList, List<T> pageVoList) {
        this(pageList, 8);
        this.list = pageVoList;
    }

    /**
     * 包装Page对象
     *
     * @param list          page结果
     * @param navigatePages 页码数量
     */
    public PageInfoVo(List pageList, int navigatePages) {
        if (pageList instanceof Page) {
            Page page = (Page) pageList;
            this.pageNum = page.getPageNum();
            this.pageSize = page.getPageSize();

            this.total = page.getTotal();
            this.pages = page.getPages();
            //this.list = page;
            this.size = page.size();
            //由于结果是>startRow的，所以实际的需要+1
            if (this.size == 0) {
                this.startRow = 0;
                this.endRow = 0;
            } else {
                this.startRow = page.getStartRow() + 1;
                //计算实际的endRow（最后一页的时候特殊）
                this.endRow = (this.startRow - 1) + this.size;
            }
            this.navigatePages = navigatePages;
            //计算导航页
            this.calcNavigatepageNums();
            //计算前后页，第一页，最后一页
            this.calcPage();
            //判断页面边界
            this.judgePageBoudary();
        }
    }

    /**
     * 计算导航页
     */
    private void calcNavigatepageNums() {
        //当总页数小于或等于导航页码数时
        if (this.pages <= this.navigatePages) {
            this.navigatepageNums = new int[this.pages];
            for (int i = 0; i < this.pages; i++) {
                this.navigatepageNums[i] = i + 1;
            }
        } else { //当总页数大于导航页码数时
            this.navigatepageNums = new int[this.navigatePages];
            int startNum = this.pageNum - (this.navigatePages / 2);
            int endNum = this.pageNum + (this.navigatePages / 2);

            if (startNum < 1) {
                startNum = 1;
                //(最前navigatePages页
                for (int i = 0; i < this.navigatePages; i++) {
                    this.navigatepageNums[i] = startNum++;
                }
            } else if (endNum > this.pages) {
                endNum = this.pages;
                //最后navigatePages页
                for (int i = this.navigatePages - 1; i >= 0; i--) {
                    this.navigatepageNums[i] = endNum--;
                }
            } else {
                //所有中间页
                for (int i = 0; i < this.navigatePages; i++) {
                    this.navigatepageNums[i] = startNum++;
                }
            }
        }
    }

    /**
     * 计算前后页，第一页，最后一页
     */
    private void calcPage() {
        if ((this.navigatepageNums != null) && (this.navigatepageNums.length > 0)) {
            this.firstPage = this.navigatepageNums[0];
            this.lastPage = this.navigatepageNums[this.navigatepageNums.length - 1];
            if (this.pageNum > 1) {
                this.prePage = this.pageNum - 1;
            }
            if (this.pageNum < this.pages) {
                this.nextPage = this.pageNum + 1;
            }
        }
    }

    /**
     * 判定页面边界
     */
    private void judgePageBoudary() {
        this.isFirstPage = this.pageNum == 1;
        this.isLastPage = this.pageNum == this.pages;
        this.hasPreviousPage = this.pageNum > 1;
        this.hasNextPage = this.pageNum < this.pages;
    }

    public void setPageNum(int pageNum) {
        this.pageNum = pageNum;
    }

    public int getPageNum() {
        return this.pageNum;
    }

    public int getPageSize() {
        return this.pageSize;
    }

    public void setPageSize(int pageSize) {
		this.pageSize = pageSize;
	}

	public int getSize() {
        return this.size;
    }

    public int getStartRow() {
        return this.startRow;
    }

    public int getEndRow() {
        return this.endRow;
    }

    public long getTotal() {
        return this.total;
    }

    public int getPages() {
        return this.pages;
    }

    public List<T> getList() {
        return this.list;
    }

    public int getFirstPage() {
        return this.firstPage;
    }

    public int getPrePage() {
        return this.prePage;
    }

    public int getNextPage() {
        return this.nextPage;
    }

    public int getLastPage() {
        return this.lastPage;
    }

    public boolean isIsFirstPage() {
        return this.isFirstPage;
    }

    public boolean isIsLastPage() {
        return this.isLastPage;
    }

    public boolean isHasPreviousPage() {
        return this.hasPreviousPage;
    }

    public boolean isHasNextPage() {
        return this.hasNextPage;
    }

    public int getNavigatePages() {
        return this.navigatePages;
    }

    public int[] getNavigatepageNums() {
        return this.navigatepageNums;
    }

    public String getNextRowKey() {
		return nextRowKey;
	}

	public void setNextRowKey(String nextRowKey) {
		this.nextRowKey = nextRowKey;
	}


	public List getPageRowKey() {
		return pageRowKey;
	}

	public void setPageRowKey(List pageRowKey) {
		this.pageRowKey = pageRowKey;
	}

	@Override
    public String toString() {
        final StringBuffer sb = new StringBuffer("PageInfo{");
        sb.append("pageNum=").append(this.pageNum);
        sb.append(", pageSize=").append(this.pageSize);
        sb.append(", size=").append(this.size);
        sb.append(", startRow=").append(this.startRow);
        sb.append(", endRow=").append(this.endRow);
        sb.append(", total=").append(this.total);
        sb.append(", pages=").append(this.pages);
        sb.append(", list=").append(this.list);
        sb.append(", firstPage=").append(this.firstPage);
        sb.append(", prePage=").append(this.prePage);
        sb.append(", nextPage=").append(this.nextPage);
        sb.append(", lastPage=").append(this.lastPage);
        sb.append(", isFirstPage=").append(this.isFirstPage);
        sb.append(", isLastPage=").append(this.isLastPage);
        sb.append(", hasPreviousPage=").append(this.hasPreviousPage);
        sb.append(", hasNextPage=").append(this.hasNextPage);
        sb.append(", navigatePages=").append(this.navigatePages);
        sb.append(", navigatepageNums=");
        if (this.navigatepageNums == null) {
            sb.append("null");
        } else {
            sb.append('[');
            for (int i = 0; i < this.navigatepageNums.length; ++i) {
                sb.append(i == 0 ? "" : ", ").append(this.navigatepageNums[i]);
            }
            sb.append(']');
        }
        sb.append('}');
        return sb.toString();
    }

    public Boolean getSuccess() {
        return this.success;
    }

}

package com.jusfoun.jap.admin.vo;

import java.util.Date;
import java.util.List;

import com.fasterxml.jackson.annotation.JsonFormat;

public class RoleVo {
    /**
     * 编号.
     */
    private Long id;

    /**
     * 归属机构.
     */
    private Integer officeId;

    /**
     * 角色名称.
     */
    private String name;

    /**
     * 英文名称.
     */
    private String enname;

    /**
     * 角色类型.
     */
    private Byte roleType;

    /**
     * 是否系统数据 0否 1是.
     */
    private Byte sysFlag;

    /**
     * 状态 0:可用 1:禁用.
     */
    private Byte status;

    /**
     * 创建者.
     */
    private Integer createId;

    /**
     * 创建时间.
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private Date createTime;

    /**
     * 更新者.
     */
    private Integer updateId;

    /**
     * 更新时间.
     */
    private Date updateTime;

    /**
     * 备注信息.
     */
    private String remark;

    /**
     * 删除标记.
     */
    private Byte delFlag;

    private List<Long> menuIds;

    public Long getId() {
        return this.id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public Integer getOfficeId() {
        return this.officeId;
    }

    public void setOfficeId(Integer officeId) {
        this.officeId = officeId;
    }

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEnname() {
        return this.enname;
    }

    public void setEnname(String enname) {
        this.enname = enname;
    }

    public Byte getRoleType() {
        return this.roleType;
    }

    public void setRoleType(Byte roleType) {
        this.roleType = roleType;
    }

    public Byte getSysFlag() {
        return this.sysFlag;
    }

    public void setSysFlag(Byte sysFlag) {
        this.sysFlag = sysFlag;
    }

    public Byte getStatus() {
        return this.status;
    }

    public void setStatus(Byte status) {
        this.status = status;
    }

    public Integer getCreateId() {
        return this.createId;
    }

    public void setCreateId(Integer createId) {
        this.createId = createId;
    }

    public Date getCreateTime() {
        return this.createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public Integer getUpdateId() {
        return this.updateId;
    }

    public void setUpdateId(Integer updateId) {
        this.updateId = updateId;
    }

    public Date getUpdateTime() {
        return this.updateTime;
    }

    public void setUpdateTime(Date updateTime) {
        this.updateTime = updateTime;
    }

    public String getRemark() {
        return this.remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

    public Byte getDelFlag() {
        return this.delFlag;
    }

    public void setDelFlag(Byte delFlag) {
        this.delFlag = delFlag;
    }

    public List<Long> getMenuIds() {
        return this.menuIds;
    }

    public void setMenuIds(List<Long> menuIds) {
        this.menuIds = menuIds;
    }

}
package com.jusfoun.jap.admin.vo;

import java.util.Date;
import java.util.List;

import javax.validation.constraints.NotNull;

import org.hibernate.validator.constraints.Length;
import org.hibernate.validator.constraints.NotEmpty;

public class UserAdminEditVo {

    /**
     * id.
     */
    @NotNull
    private Long id;

    /**
     * 登录名.
     */
    @NotEmpty(message = "登录名不能为空.")
    @Length(min = 5, max = 20, message = "登录名长度需在5-20之间.")
    private String username;

    /**
     * 密码.
     */
    @Length(min = 5, max = 20, message = "密码长度需在5-20之间.")
    private String password;
    /**
     * 盐.
     */
    private String salt;

    @NotEmpty(message = "角色不能为空.")
    @NotNull
    private List<Long> roleIds;

    /**
     * 姓名.
     */
    private String name;

    /**
     * 邮箱.
     */
    private String email;

    /**
     * 电话.
     */
    private String phone;

    /**
     * 手机.
     */
    private String mobile;

    /**
     * 用户类型 0普通用户 1管理员.
     */
    private Short userType;

    /**
     * 用户头像.
     */
    private String photo;

    /**
     * 最后登陆IP.
     */
    private String lastIp;

    /**
     * 最后登陆时间.
     */
    private Date lastTime;

    /**
     * 用户状态 0:正常 1:查封 2:待审核.
     */
    private Short status;

    public Long getId() {
        return this.id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return this.username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSalt() {
        return this.salt;
    }

    public void setSalt(String salt) {
        this.salt = salt;
    }

    public List<Long> getRoleIds() {
        return this.roleIds;
    }

    public void setRoleIds(List<Long> roleIds) {
        this.roleIds = roleIds;
    }

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return this.email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPhone() {
        return this.phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getMobile() {
        return this.mobile;
    }

    public void setMobile(String mobile) {
        this.mobile = mobile;
    }

    public Short getUserType() {
        return this.userType;
    }

    public void setUserType(Short userType) {
        this.userType = userType;
    }

    public String getPhoto() {
        return this.photo;
    }

    public void setPhoto(String photo) {
        this.photo = photo;
    }

    public String getLastIp() {
        return this.lastIp;
    }

    public void setLastIp(String lastIp) {
        this.lastIp = lastIp;
    }

    public Date getLastTime() {
        return this.lastTime;
    }

    public void setLastTime(Date lastTime) {
        this.lastTime = lastTime;
    }

    public Short getStatus() {
        return this.status;
    }

    public void setStatus(Short status) {
        this.status = status;
    }

}

package com.jusfoun.jap.admin.vo;

import java.util.Date;
import java.util.List;

import javax.validation.constraints.NotNull;

import org.hibernate.validator.constraints.Length;
import org.hibernate.validator.constraints.NotEmpty;

public class UserAdminRegVo {

    /**
     * id.
     */
    private Long id;

    /**
     * 登录名.
     */
    @NotEmpty(message = "登录名不能为空.")
    @Length(min = 5, max = 20, message = "登录名长度需在5-20之间.")
    private String username;

    /**
     * 密码.
     */
    @NotEmpty(message = "密码不能为空.")
    @Length(min = 5, max = 20, message = "密码长度需在5-20之间.")
    private String password;
    /**
     * 盐.
     */
    private String salt;

    @NotEmpty(message = "角色不能为空.")
    @NotNull
    private List<Long> roleIds;
    /**
     * 工号.
     */
    private String no;

    /**
     * 姓名.
     */
    private String name;

    /**
     * 邮箱.
     */
    private String email;

    /**
     * 电话.
     */
    private String phone;

    /**
     * 手机.
     */
    private String mobile;

    /**
     * 用户类型 0普通用户 1管理员.
     */
    private Byte userType;

    /**
     * 用户头像.
     */
    private String photo;

    /**
     * 最后登陆IP.
     */
    private String lastIp;

    /**
     * 最后登陆时间.
     */
    private Date lastTime;

    /**
     * 用户状态 0:正常 1:查封 2:待审核.
     */
    private Short status;

    public Long getId() {
        return this.id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getUsername() {
        return this.username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSalt() {
        return this.salt;
    }

    public void setSalt(String salt) {
        this.salt = salt;
    }

    public List<Long> getRoleIds() {
        return this.roleIds;
    }

    public void setRoleIds(List<Long> roleIds) {
        this.roleIds = roleIds;
    }

    public String getNo() {
        return this.no;
    }

    public void setNo(String no) {
        this.no = no;
    }

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getEmail() {
        return this.email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPhone() {
        return this.phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getMobile() {
        return this.mobile;
    }

    public void setMobile(String mobile) {
        this.mobile = mobile;
    }

    public Byte getUserType() {
        return this.userType;
    }

    public void setUserType(Byte userType) {
        this.userType = userType;
    }

    public String getPhoto() {
        return this.photo;
    }

    public void setPhoto(String photo) {
        this.photo = photo;
    }

    public String getLastIp() {
        return this.lastIp;
    }

    public void setLastIp(String lastIp) {
        this.lastIp = lastIp;
    }

    public Date getLastTime() {
        return this.lastTime;
    }

    public void setLastTime(Date lastTime) {
        this.lastTime = lastTime;
    }

    public Short getStatus() {
        return this.status;
    }

    public void setStatus(Short status) {
        this.status = status;
    }

}

package com.jusfoun.jap.admin.vo;

import java.util.Date;
import java.util.List;

import com.fasterxml.jackson.annotation.JsonFormat;

public class UserVo {
    /**
     * 公司名称
     */
    private String companyName;
    /**
     * 部门名称
     */
    private String officeName;

    /**
     * 编号.
     */
    private Integer id;

    /**
     * 归属公司.
     */
    private String companyId;

    /**
     * 归属部门.
     */
    private String officeId;

    /**
     * 登录名.
     */
    private String username;

    /**
     * 密码.
     */
    private String password;
    /**
     * 盐.
     */
    private String salt;

    private List<Long> roleIds;
    /**
     * 工号.
     */
    private String no;

    /**
     * 姓名.
     */
    private String name;
    private String userGender;

    /**
     * 邮箱.
     */
    private String email;

    /**
     * 电话.
     */
    private String phone;

    /**
     * 手机.
     */
    private String mobile;

    /**
     * 用户类型 0普通用户 1管理员.
     */
    private Byte userType;

    /**
     * 用户头像.
     */
    private String photo;

    /**
     * 最后登陆IP.
     */
    private String lastIp;

    /**
     * 最后登陆时间.
     */
    private Date lastTime;

    /**
     * 用户状态 0:正常 1:查封 2:待审核.
     */
    private Byte status;

    /**
     * 创建者.
     */
    private String createBy;

    /**
     * 创建时间.
     */
    @JsonFormat(pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")
    private Date createTime;

    /**
     * 更新者.
     */
    private Integer updateId;

    /**
     * 更新时间.
     */
    private Date updateTime;

    /**
     * 备注信息.
     */
    private String remark;

    /**
     * 删除标记.
     */
    private Byte delFlag;
    
    private String govName;
    private String jobName;

    public String getGovName() {
		return govName;
	}

	public void setGovName(String govName) {
		this.govName = govName;
	}

	public String getJobName() {
		return jobName;
	}

	public void setJobName(String jobName) {
		this.jobName = jobName;
	}

	public String getCompanyName() {
        return this.companyName;
    }

    public void setCompanyName(String companyName) {
        this.companyName = companyName;
    }

    public String getOfficeName() {
        return this.officeName;
    }

    public void setOfficeName(String officeName) {
        this.officeName = officeName;
    }

    public Integer getId() {
        return this.id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getCompanyId() {
        return this.companyId;
    }

    public void setCompanyId(String companyId) {
        this.companyId = companyId;
    }

    public String getOfficeId() {
        return this.officeId;
    }

    public void setOfficeId(String officeId) {
        this.officeId = officeId;
    }

    public String getUsername() {
        return this.username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getPassword() {
        return this.password;
    }

    public void setPassword(String password) {
        this.password = password;
    }

    public String getSalt() {
        return this.salt;
    }

    public void setSalt(String salt) {
        this.salt = salt;
    }

    public List<Long> getRoleIds() {
        return this.roleIds;
    }

    public void setRoleIds(List<Long> roleIds) {
        this.roleIds = roleIds;
    }

    public String getNo() {
        return this.no;
    }

    public void setNo(String no) {
        this.no = no;
    }

    public String getName() {
        return this.name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getUserGender() {
		return userGender;
	}

	public void setUserGender(String userGender) {
		this.userGender = userGender;
	}

	public String getEmail() {
        return this.email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public String getPhone() {
        return this.phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getMobile() {
        return this.mobile;
    }

    public void setMobile(String mobile) {
        this.mobile = mobile;
    }

    public Byte getUserType() {
        return this.userType;
    }

    public void setUserType(Byte userType) {
        this.userType = userType;
    }

    public String getPhoto() {
        return this.photo;
    }

    public void setPhoto(String photo) {
        this.photo = photo;
    }

    public String getLastIp() {
        return this.lastIp;
    }

    public void setLastIp(String lastIp) {
        this.lastIp = lastIp;
    }

    public Date getLastTime() {
        return this.lastTime;
    }

    public void setLastTime(Date lastTime) {
        this.lastTime = lastTime;
    }

    public Byte getStatus() {
        return this.status;
    }

    public void setStatus(Byte status) {
        this.status = status;
    }

    public String getCreateBy() {
        return this.createBy;
    }

    public void setCreateBy(String createBy) {
        this.createBy = createBy;
    }

    public Date getCreateTime() {
        return this.createTime;
    }

    public void setCreateTime(Date createTime) {
        this.createTime = createTime;
    }

    public Integer getUpdateId() {
        return this.updateId;
    }

    public void setUpdateId(Integer updateId) {
        this.updateId = updateId;
    }

    public Date getUpdateTime() {
        return this.updateTime;
    }

    public void setUpdateTime(Date updateTime) {
        this.updateTime = updateTime;
    }

    public String getRemark() {
        return this.remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

    public Byte getDelFlag() {
        return this.delFlag;
    }

    public void setDelFlag(Byte delFlag) {
        this.delFlag = delFlag;
    }

}

/**
 * 
 */
package com.jusfoun.jap.common;

/**
 * @author wcq
 *
 */
 
import java.sql.SQLException;

import javax.annotation.Resource;

import org.json.JSONException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.util.kylin.GetKylinData;
import com.jusfoun.jap.workTable.service.WorkTableService;
import com.jusfoun.jap.workTable.vo.WorkTableCondition;

@RestController
@RequestMapping(value = "/api/jap")
public class Api {

	private transient Logger LOG = LoggerFactory.getLogger(getClass());
	@Resource
	private WorkTableService workTableService;
	@Value("${kylin.url}")
	private String kylinUrl;
	@Value("${kylin.username}")
	private String kylinUsername;
	@Value("${kylin.password}")
	private String kylinPassword;
	@Value("${kylin.database}")//kylin的数据库名称
	private String kylinDatabase;
	
	@RequestMapping(value="/query",method=RequestMethod.POST)
	public String queryKylinData(String sql) throws Exception {
		GetKylinData data = new GetKylinData();
		String result = "";
		try {
			result = data.getData(sql, kylinUrl, kylinUsername, kylinPassword);
		} catch (SQLException e) {
			LOG.error(e.getMessage(),e);
			throw e;
		} catch (Exception e) {
			LOG.error(e.getMessage(),e);
		}
		return result;
	}
	@RequestMapping(value = "/{workTableCode}",method=RequestMethod.GET)
	public Result queryWorktableData(WorkTableCondition workTable) throws Exception {
		return workTableService.queryWorktableData(workTable);
	}
	
}


/**
 * 
 */
package com.jusfoun.jap.common;

import com.itmuch.core.web.converter.Result;

/**
 * @author wcq
 *
 */
public class Results  extends Result{
private String workTableId ;

/**
 * @return the workTableId
 */
public String getWorkTableId() {
	return workTableId;
}

/**
 * @param workTableId the workTableId to set
 */
public void setWorkTableId(String workTableId) {
	this.workTableId = workTableId;
}
}

package com.jusfoun.jap.cube.controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.fastjson.JSON;
import com.itmuch.core.page.PageVo;
import com.jusfoun.jap.admin.vo.PageInfoVo;
import com.jusfoun.jap.cube.domain.Cube;
import com.jusfoun.jap.cube.service.CubeService;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.util.kylin.GetKylinData;
import com.jusfoun.jap.workTable.domain.ColumnChinese;
import com.jusfoun.jap.workTable.domain.CubeDim;
import com.jusfoun.jap.workTable.domain.CubeFact;
import com.jusfoun.jap.workTable.service.WorkTableService;
import com.jusfoun.jap.workTable.vo.ColumnChineseList;

@RestController
@RequestMapping(value = "/cube")
public class CubeController {
	@Resource
	private CubeService cubeService;
	@Resource
	private WorkTableService workTableService;


	@RequestMapping("/getCubeByCondition")
	public PageInfoVo<Cube> cubeQueryByStatus(PageVo pageVo, CubeVo cubeVo) {
		
		return cubeService.queryByCubeName(pageVo,cubeVo);
	}
	
	
	/**
	 * 全部同步/粗暴 1.获取kylin返回的所有cube的list 2.根据kylin的cubeid删除本地三张表中多余的数据
	 * 3.cubeinfo表做更新及插入操作 （因为本地不对事实表和维度表操作，数据均来自kylin，所以将本地的两表数据删除再做插入操作）
	 * 4.根据kyin逐个获取的cube详情， 对另外两张表做更新及插入操作
	 *
	 * @param cubeIds
	 * @return
	 * @throws JSONException
	 */
	@RequestMapping("/synCube")
	public PageInfoVo<Cube> synCube(PageVo pageVo,CubeVo cubeVo) throws JSONException {
		return cubeService.synCube(pageVo,cubeVo);
	}
	
	//数据分析用
	@RequestMapping("/getCubeListByCondition")
	public List<Cube> cubeQueryByStatus(CubeVo cubeVo) {
		List<Cube> list = new ArrayList<Cube>();
		list = cubeService.queryByCubeName(cubeVo);
		return list;
	}
	
	@RequestMapping("/del-by-id")
//	@ResponseBody
//	@RequiresPermissions("sys:cube:del")
//	@SystemControllerLog(description = "数据模型删除",module=Constant.XTGL_MXGL,operType=Constant.DELETE)
	public void delCubeByCondition(Cube cube) {
		cubeService.delCubeByCondition(cube);
		cubeService.delDimByCube(cube);
		cubeService.delFactByCube(cube);
	}


	@RequestMapping("/viewCubeInfo")
//	@ResponseBody
//	@RequiresPermissions("sys:cube:view")
	public CubeVo viewCubeInfo(Cube cube) {
			return cubeService.viewCubeByCondition(cube);
	}
	@RequestMapping("/updateCubeInfo")
//	@ResponseBody
	//保存修改的cube
//	@RequiresPermissions("sys:cube:view")
//	@SystemControllerLog(description = "数据模型修改",module=Constant.XTGL_MXGL,operType=Constant.UPDATE)
	public void updateCubeInfo(@ModelAttribute("cubeVo") String cubeVo) {
		CubeVo cubevo = new CubeVo();
		cubevo = JSON.parseObject(cubeVo, CubeVo.class);
		cubeService.updateCubeInfo(cubevo);
	}
	
	/**
	 * 获取cube表名和列名
	 */
	@RequestMapping("/getChnInfo")
//	@ResponseBody
	public PageInfoVo<ColumnChinese> getColumnChinese(PageVo pageVo,ColumnChinese columnChinese) {
		if(pageVo.getPage()==1){//第一页需要更新
			cubeService.insertColumn();
		}
		return workTableService.getColumnChinese(pageVo,columnChinese);
	}
	@RequestMapping("/updateChn")
//	@ResponseBody
	public void updateChnInfo(ColumnChinese columnChinese) {
		 workTableService.updateColumnChinese(columnChinese);
	}
	@RequestMapping("/updateAllChn")
	public void updateAllChn(@ModelAttribute("chnList") String chnList) {
		ColumnChineseList columnChineseList= JSON.parseObject(chnList, ColumnChineseList.class);
		workTableService.updateAllChn(columnChineseList.getColumnChineseList());
	}
	
}

package com.jusfoun.jap.cube.domain;

import java.io.Serializable;
import java.util.Date;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "T_cube_info")
public class Cube extends BaseEntity implements Serializable {
	/**
	 * id
	 */
	@Id
	@Column(name = "CUBE_ID")
	// 主键生成策略
	private String cubeId;

	/**
	 *
	 */
	@Column(name = "cube_name")
	private String cubeName;

	/**
	 * 操作
	 */
	@Column(name = "cube_name_cn")
	private String cubeNameCn;

	/**
	 * 操作类型
	 */
	@Column(name = "cube_description")
	private String cubeDescription;

	/**
	 * 登陆平台
	 */
	@Column(name = "cube_date")
	private Date cubeDate;
	
	@Column(name = "cube_status")
	private String cubeStatus;
	
	@Column(name = "sync_rule")
	private Long syncRule;
	
	@Column(name = "sync_status")
	private Long syncStatus;
	
	@Column(name = "sync_time")
	private Date syncTime;
	
	private static final long serialVersionUID = 1L;

	public String getCubeStatus() {
		return cubeStatus;
	}

	public void setCubeStatus(String cubeStatus) {
		this.cubeStatus = cubeStatus;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getCubeName() {
		return cubeName;
	}

	public void setCubeName(String cubeName) {
		this.cubeName = cubeName;
	}

	public String getCubeNameCn() {
		return cubeNameCn;
	}

	public void setCubeNameCn(String cubeNameCn) {
		this.cubeNameCn = cubeNameCn;
	}

	public String getCubeDescription() {
		return cubeDescription;
	}

	public void setCubeDescription(String cubeDescription) {
		this.cubeDescription = cubeDescription;
	}

	public Date getCubeDate() {
		return cubeDate;
	}

	public void setCubeDate(Date cubeDate) {
		this.cubeDate = cubeDate;
	}

	public Long getSyncRule() {
		return syncRule;
	}

	public void setSyncRule(Long syncRule) {
		this.syncRule = syncRule;
	}

	public Long getSyncStatus() {
		return syncStatus;
	}

	public void setSyncStatus(Long syncStatus) {
		this.syncStatus = syncStatus;
	}

	public Date getSyncTime() {
		return syncTime;
	}

	public void setSyncTime(Date syncTime) {
		this.syncTime = syncTime;
	}

}
package com.jusfoun.jap.cube.domain;

import java.io.Serializable;
import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "T_tag_info")
public class Tag extends BaseEntity implements Serializable {
	/**
	 * id
	 */
	@Id
	@Column(name = "tag_ID")
	// 主键生成策略
	private String tagId;

	/**
	 *
	 */
	@Column(name = "tag_name")
	private String tagName;

	public String getTagId() {
		return tagId;
	}

	public void setTagId(String tagId) {
		this.tagId = tagId;
	}

	public String getTagName() {
		return tagName;
	}

	public void setTagName(String tagName) {
		this.tagName = tagName;
	}
	
}
package com.jusfoun.jap.cube.mapper;

import java.util.List;

import com.jusfoun.jap.cube.domain.Cube;
import com.jusfoun.jap.cube.domain.Tag;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.workTable.domain.CubeDim;
import com.jusfoun.jap.workTable.domain.CubeFact;

public interface CubeMapper{
	public List<Cube> queryByCubeName(CubeVo cubeVo);

	// Cube表插入数据
	public void insertCube(CubeVo cubeinfo);

	// 事实表插入数据
	public void insertFact(List<CubeFact> cubeFacts);

	// 维表插入数据
	public void insertDim(List<CubeDim> cubeDims);

	//
	public void delCubeByCondition(Cube cube);

	//
	public Integer updateCubeInfo(CubeVo cube);

	//
	public CubeVo viewCubeByCondition(Cube cube);

	//
	public void delCubeByIds(String sCubeIds);

	//
	public void delDimByCondition(CubeVo cubeVo);

	//
	public void delFactByCondition(CubeVo cubeVo);

	public void delFactByCubeID(Cube cube);

	//
	public void delDimByCubeID(Cube cube);

	public int insertColumn();

	public List<Tag> findOtherTags(Cube cube);

	public void insertTagList(List<Tag> list);

	public List<Tag> findTags(List<Tag> newTagList);

	public void insertNewCubeTag(CubeVo cube);

	public void delTagList(CubeVo cube);

	public void insertCubeTag(CubeVo cube);

	public void delOtherTag();

}
package com.jusfoun.jap.cube.service;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.github.pagehelper.PageHelper;
import com.itmuch.core.page.PageInfo;
import com.itmuch.core.page.PageVo;
import com.jusfoun.jap.admin.vo.PageInfoVo;
import com.jusfoun.jap.cube.domain.Cube;
import com.jusfoun.jap.cube.domain.Tag;
import com.jusfoun.jap.cube.mapper.CubeMapper;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.util.StringUtil;
import com.jusfoun.jap.util.kylin.GetKylinData;
import com.jusfoun.jap.workTable.domain.CubeDim;
import com.jusfoun.jap.workTable.domain.CubeFact;

@Service
public class CubeService {
	@Value("${kylin.address}")
	private String kylinAddress;
	@Value("${kylin.authorization}")
	private String kylinAuthorization;
	@Value("${kylin.projectName}")
	private String kylinProjectName;
	@Autowired
	private CubeMapper dao;

	public PageInfoVo<Cube> queryByCubeName(PageVo pageVo, CubeVo cubeVo) {

		String order = pageVo.getOrder();
		order = " rownum";
		PageHelper.startPage(pageVo.getPage(), pageVo.getRows(), order);
		List<Cube> list = dao.queryByCubeName(cubeVo);
		PageInfo<Cube> info = new PageInfo<Cube>(list);
		PageInfoVo<Cube> cubePage = new PageInfoVo<Cube>(info.getList(), list);
		return cubePage;
	}
	
	public List<Cube> queryByCubeName(CubeVo cubeVo) {
		return dao.queryByCubeName(cubeVo);
	}

	/**
	 * 处理json返回cube的list
	 *
	 * @param result
	 * @param name
	 * @param fields
	 * @return
	 * @throws JSONException
	 */
	public List<Map<String, Object>> convertJSON2List(String result, String name, String[] fields)
			throws JSONException {
		List<Map<String, Object>> list = new ArrayList<Map<String, Object>>();
		JSONArray array = new JSONObject(result).getJSONArray(name);
		for (int i = 0; i < array.length(); i++) {
			JSONObject object = (JSONObject) array.opt(i);
			Map<String, Object> map = new HashMap<String, Object>();
			for (String str : fields) {
				map.put(str, object.get(str));
			}
			list.add(map);
		}
		return list;
	}

	public void delCubeByCondition(Cube cube) {
		// TODO Auto-generated method stub
		dao.delCubeByCondition(cube);
	}


	public CubeVo viewCubeByCondition(Cube cube) {
		CubeVo cubevo = new CubeVo();
		if(!(cube==null||cube.getCubeId()==null||"".equals(cube.getCubeId()))){
			cubevo = dao.viewCubeByCondition(cube);
			List<Tag> tagList = dao.findOtherTags(cube);
			cubevo.setOtherTagList(tagList);
			return cubevo;
		}else return null;
	}

	/**
	 * 1.删除kylin中没有的数据 2.更新或插入数据
	 *
	 * @param list
	 * @param cubeVo 
	 */
	public void synCubeTable(List<Map<String, Object>> list, CubeVo cubeVo) {
		// 1.删除T_cube_info多余的数据
		StringBuilder sbCubeId = new StringBuilder();
		String sCubeIds = "";
		CubeVo cubeinfo = new CubeVo();
		for (Map<String, Object> cube : list) {// 获取cubeid
			// 在循环获取所有cubeid的时候可将
			// 第二步 2.更新或插入数据顺带完成
			if(!"READY".equals(cube.get("status"))){
				continue;
			}
			cubeinfo.setCubeId((String) cube.get("uuid"));
			cubeinfo.setCubeName((String) cube.get("name"));
			cubeinfo.setCubeNameCn((String) cube.get("nameCn"));
			cubeinfo.setCubeDescription((String) cube.get("descriptor"));
			cubeinfo.setCubeDate(new Date(Long.parseLong(cube.get("create_time_utc").toString())));
			if (dao.updateCubeInfo(cubeinfo).intValue() == 0) {// 更新cubeinfo信息
				cubeinfo.setCubeStatus("0");
				dao.insertCube(cubeinfo);// 插入cube信息
			}
			sbCubeId.append(",'" + cube.get("uuid") + "'");// 获取kylin传来的所有的cubeid
		}
		sCubeIds = sbCubeId.toString().replaceFirst(",", "");
		if (sCubeIds != null && !"".equals(sCubeIds)) {
			sCubeIds = "(" + sCubeIds + ")";
		}
		if(cubeVo==null||StringUtil.isEmpty(cubeVo.getCubeName())){
			dao.delCubeByIds(sCubeIds);// 删除本地比kylin多的cube数据
		}
	}

	public void insertCube( CubeVo cubeinfo){
		dao.insertCube(cubeinfo);
	}
	public void delDimAndFactByCondition(CubeVo cubeVo) {
		dao.delDimByCondition(cubeVo);
		dao.delFactByCondition(cubeVo);
	}

	public void insertCubeFact(List<CubeFact> listValue) {
		dao.insertFact(listValue);

	}

	public void insertCubeDim(List<CubeDim> listDim) {
		dao.insertDim(listDim);
	}

	public void delDimByCube(Cube cube) {
		dao.delDimByCubeID(cube);
	}

	public void delFactByCube(Cube cube) {
		dao.delFactByCubeID(cube);
	}
	public void updateCubeInfo(CubeVo cube) {
		dao.updateCubeInfo(cube);
		if(cube.getNewTagList()!=null&&cube.getNewTagList().size()>0){//插入新添加的标签
			dao.insertTagList(cube.getNewTagList());
			dao.insertNewCubeTag(cube);//建立与新标签的关联
		}
		/*List<Tag> list = dao.findTags(cube.getNewTagList());
		cube.setNewTagList(list);*/
		if(cube.getDelTagList()!=null&&cube.getDelTagList().size()>0){
			dao.delTagList(cube);//删除去掉的表情
		}
		if(cube.getAddTagList()!=null&&cube.getAddTagList().size()>0){
			dao.insertCubeTag(cube);//建立与旧标签的关联
		}
		
		dao.delOtherTag();//删除不被使用的标签
		
	}

	public int insertColumn() {
		return dao.insertColumn();
	}
	
	public PageInfoVo<Cube> synCube(PageVo pageVo,CubeVo cubeVo) throws JSONException {
		String url = kylinAddress + "/kylin/api/cubes?projectName="+kylinProjectName;
		if(cubeVo!=null&&StringUtil.isNotEmpty(cubeVo.getCubeName())){
			url+="&cubeName="+cubeVo.getCubeName();
		}
		GetKylinData getKylinData = new GetKylinData();
		String segment = null, sFact = "", sDimTables = "", sForKey = "", sKey = "";// 内部json字符串，主表表名，维表名，事实表外键，维表主键
		String[] dictionaries = null;
		String responseString = getKylinData.getKylinData(url, kylinAuthorization);
		List<Map<String, Object>> list = convertJSON2List(// 获取json内所有cube转化为list
				"{\"cubes\":" + responseString + "}", "cubes",
				new String[] { "uuid", "name", "descriptor", "create_time_utc", "segments","status" });
		// 4.1逐个解析cube详情来给维表和度量表增数据
		List<CubeDim> listDim = new ArrayList<CubeDim>();// 存储需要插入的dim对象
		List<CubeFact> listValue = new ArrayList<CubeFact>();// 存储需要插入的fact对象
		for (Map<String, Object> cube : list) {
			if(!"READY".equals(cube.get("status"))){
				continue;
			}
			Map<String, String> mapDim = new HashMap<String, String>();// 维度表及其关联关系
			url = kylinAddress + "/kylin/api/cube_desc/" + cube.get("name");
			getKylinData = new GetKylinData();
			responseString = getKylinData.getKylinData(url, kylinAuthorization);
			responseString = responseString.substring(1, responseString.length() - 1);
			System.out.println("单个的cube为：");
			System.out.println(responseString);
			segment = new JSONObject(((JSONArray) cube.get("segments")).getString(0)).getJSONObject("dictionaries")
					.toString();// 获取cubes里面的维表相关信息，包括事实表名与事实表和维表的关联关系
			dictionaries = segment.split(",");
			sFact = dictionaries[0].substring(dictionaries[0].indexOf(".") + 1, dictionaries[0].indexOf("/"));
			for (String sTemString : dictionaries) {
				sDimTables = sTemString.substring(sTemString.indexOf(".", sTemString.indexOf(":")) + 1,
						sTemString.indexOf("/", sTemString.indexOf(".", sTemString.indexOf(":")) + 1));// 维度表的表名
				sForKey = sTemString.substring(sTemString.indexOf("/") + 1, sTemString.indexOf(":") - 1);
				sKey = sTemString.substring(
						sTemString.indexOf("/", sTemString.indexOf(".", sTemString.indexOf(":"))) + 1,
						sTemString.indexOf("/",
								sTemString.indexOf("/", sTemString.indexOf(".", sTemString.indexOf(":"))) + 1));
				mapDim.put(sDimTables, sFact + "." + sForKey + "=" + sDimTables + "." + sKey);
			}

			// 4.2维表详情开始解析
			JSONArray array = new JSONObject(responseString).getJSONArray("dimensions");
			String nameCnAndDesc = new JSONObject(responseString).getString("description");
			String uuid = new JSONObject(responseString).getString("uuid");//cube列表中的uuid和单个cube获取到的uuid不是一个
			cube.put("uuid", uuid);
			cube.put("descriptor", nameCnAndDesc);
			cube.put("nameCn", nameCnAndDesc);
			String sTablename = "", sColumn = "", sTableConnectColumn = "";// 维表表名，列名
			String[] arrColumn = null;
			for (int i = 0; i < array.length(); i++) {
				JSONObject jo = array.getJSONObject(i);
				sColumn = jo.getString("column");
				if (sColumn == "null") {
					sColumn = jo.getString("derived");
					arrColumn = sColumn.substring(2, sColumn.length() - 2).split("\",\"");
					for (String stem : arrColumn) {
						CubeDim cubeDim = new CubeDim();
						sTablename = jo.getString("table");
						sTablename = sTablename.substring(sTablename.indexOf(".") + 1);
						cubeDim.setDimTableName(sTablename);
						cubeDim.setCubeId((String) cube.get("uuid"));
						sTableConnectColumn = mapDim.get(sTablename);
						cubeDim.setTableConnectColumn(sTableConnectColumn);
						cubeDim.setDimColumn(stem);
						listDim.add(cubeDim);
					}
				} else {
					CubeDim cubeDim = new CubeDim();
					sTablename = jo.getString("table");
					sTablename = sTablename.substring(sTablename.indexOf(".") + 1);
					cubeDim.setDimTableName(sTablename);
					cubeDim.setCubeId((String) cube.get("uuid"));
					sTableConnectColumn = mapDim.get(sTablename);
					cubeDim.setTableConnectColumn(sTableConnectColumn);
					cubeDim.setDimColumn(sColumn);
					listDim.add(cubeDim);
				}
			}

			// 4.3度量表详情开始解析
			array = new JSONObject(responseString).getJSONArray("measures");
			String sValue = "";
			for (int i = 0; i < array.length(); i++) {
				sValue = array.getJSONObject(i).getJSONObject("function").getJSONObject("parameter").getString("value");
				String factTableRule = array.getJSONObject(i).getJSONObject("function").getString("expression");
				//if (!"1".equals(sValue)) {
					boolean hasTheCol = false;//假设list里没有该列
					for(CubeFact cubeFact1 :listValue){//一个列在有一种以上的运算方式的情况下json里会出现两次,若是第二次出现，则在原有的对象的FactTableRule添加新的统计方式，而不增加新的对象
						if(sTablename.equals(cubeFact1.getFactTableName())&&sValue.equals(cubeFact1.getFactTableColumn())){//该列存在
							List<String> factTableRules = cubeFact1.getFactTableRule();
							factTableRules.add(factTableRule);
							cubeFact1.setFactTableRule(factTableRules);
							cubeFact1.setFactTableRules(factTableRules.toString().replaceAll(" ", ""));
							hasTheCol = true;
						}
					}
					if(!hasTheCol){//如果没有该列，
						CubeFact cubeFact = new CubeFact();
						cubeFact.setCubeId((String) cube.get("uuid"));
						cubeFact.setFactTableName(sFact);
						if ("1".equals(sValue)) {
							sValue = "count1";
						}
						cubeFact.setFactTableColumn(sValue);
						List<String> factTableRules = new ArrayList<String>();
						factTableRules.add(factTableRule);
						cubeFact.setFactTableRule(factTableRules);
						cubeFact.setFactTableRules(factTableRules.toString());
						listValue.add(cubeFact);
					}
				//}
			}
		}
		delDimAndFactByCondition(cubeVo);// 3删除本地维表及度量表已有数据
		synCubeTable(list,cubeVo);// 1,2两步调用完成
		insertCubeDim(listDim);// 将所有值插入维度表
		insertCubeFact(listValue);// 度量表插值
		return queryByCubeName(pageVo,null);
	}


}

package com.jusfoun.jap.cube.util;

public class CubeConstants {

	/**
	 * 同步状态：0:待执行1：同步数据 2：创建数据集 9：同步完成
	 * @author syk
	 *
	 */
	public interface SyncStatus
	{
		int REDAY_EXEC = 0;
		int SYNC_DATA = 1;
		int BULID_CUBE = 2;
		int EXEC_COMPLATE= 9;
	}
	
	
}

package com.jusfoun.jap.cube.vo;

import java.util.Date;
import java.util.List;

import javax.persistence.Column;

import com.jusfoun.jap.cube.domain.Tag;

public class CubeVo {
	/**
	 * id
	 */
	// 主键生成策略
	private String cubeId;

	private String cubeName;

	private String cubeNameCn;

	private String cubeDescription;

	private Date cubeDate;
	
	private String cubeStatus;
	
	private Long syncRule;
	
	private Long syncStatus;
	
	private Date syncTime;
	
	private List<Tag> tagList;
	private List<Tag> otherTagList;
	
	private List<Tag> delTagList;
	private List<Tag> addTagList;
	private List<Tag> newTagList;
	
	public List<Tag> getDelTagList() {
		return delTagList;
	}

	public void setDelTagList(List<Tag> delTagList) {
		this.delTagList = delTagList;
	}

	public List<Tag> getAddTagList() {
		return addTagList;
	}

	public void setAddTagList(List<Tag> addTagList) {
		this.addTagList = addTagList;
	}

	public List<Tag> getNewTagList() {
		return newTagList;
	}

	public void setNewTagList(List<Tag> newTagList) {
		this.newTagList = newTagList;
	}

	public String getCubeStatus() {
		return cubeStatus;
	}

	public void setCubeStatus(String cubeStatus) {
		this.cubeStatus = cubeStatus;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getCubeName() {
		return cubeName;
	}

	public void setCubeName(String cubeName) {
		this.cubeName = cubeName;
	}

	public String getCubeDescription() {
		return cubeDescription;
	}

	public void setCubeDescription(String cubeDescription) {
		this.cubeDescription = cubeDescription;
	}

	public Date getCubeDate() {
		return cubeDate;
	}

	public void setCubeDate(Date cubeDate) {
		this.cubeDate = cubeDate;
	}

	public List<Tag> getTagList() {
		return tagList;
	}

	public void setTagList(List<Tag> tagList) {
		this.tagList = tagList;
	}

	public String getCubeNameCn() {
		return cubeNameCn;
	}

	public void setCubeNameCn(String cubeNameCn) {
		this.cubeNameCn = cubeNameCn;
	}

	public List<Tag> getOtherTagList() {
		return otherTagList;
	}

	public void setOtherTagList(List<Tag> otherTagList) {
		this.otherTagList = otherTagList;
	}

	public Long getSyncRule() {
		return syncRule;
	}

	public void setSyncRule(Long syncRule) {
		this.syncRule = syncRule;
	}

	public Long getSyncStatus() {
		return syncStatus;
	}

	public void setSyncStatus(Long syncStatus) {
		this.syncStatus = syncStatus;
	}
}
package com.jusfoun.jap.dashboard.controller;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import javax.annotation.Resource;

import org.json.JSONException;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.itmuch.core.util.SubjectUtil;
import com.jusfoun.jap.dashboard.domain.Dashboard;
import com.jusfoun.jap.dashboard.service.DashboardService;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.story.domain.Story;

@RestController
@RequestMapping(value = "/dashboards")
public class DashboardController {

    @Resource
    DashboardService dashboardService;

    //仪表盘详情
    @RequestMapping(value = "/{id}", method = RequestMethod.GET)
    public DashboardVo getDashboard(Dashboard dashboard) throws SQLException, JSONException {
        dashboard.setUserId(SubjectUtil.getUserId().toString());
        return dashboardService.getDashboard(dashboard);
    }
    
  //根据多个仪表盘查询详情
  	 @RequestMapping(value="/getDashboards",method=RequestMethod.POST,	consumes=MediaType.APPLICATION_JSON_UTF8_VALUE)
    public List<DashboardVo> getStoryByDashboards(@RequestBody List<Dashboard> dashboards) throws SQLException, JSONException{
  		List<DashboardVo> dashboardVos = new ArrayList<DashboardVo>();
  		 for(Dashboard dashboard : dashboards){
  			DashboardVo sad = dashboardService.getDashboard(dashboard);
  			dashboardVos.add(sad);
  		 }
	 	return dashboardVos;
   }

    //仪表盘列表
    @RequestMapping(method = RequestMethod.GET)
    public List<Dashboard> getDashboards(Dashboard dashboard) {
        dashboard.setUserId(SubjectUtil.getUserId().toString());
        return dashboardService.getDashboards(dashboard);
    }
    
  //仪表盘列表
  	 @RequestMapping(value="/getDashboards",method=RequestMethod.GET)
  	 public List<DashboardVo> getDashboardVos(Dashboard dashboard){
  		dashboard.setUserId(SubjectUtil.getUserId().toString());
  		 return dashboardService.getDashboardVos(dashboard);
  	 }

    //新建仪表盘
    @RequestMapping(method = RequestMethod.POST, consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)
    public DashboardVo createDashboard(@RequestBody DashboardVo dashboardVo) {
//        System.out.println("输入的参数为：" + dashboard);
//        DashboardVo dashboardVo = JSON.parseObject(dashboard, DashboardVo.class);// json转换为WorkCondition的对象
        dashboardVo.setUserId(SubjectUtil.getUserId().toString());
        return dashboardService.createDashboard(dashboardVo);
    }

    //更新仪表盘
    @RequestMapping(value = "/{id}", method = RequestMethod.PUT, consumes = MediaType.APPLICATION_JSON_UTF8_VALUE)
    public void updateDashboard(@PathVariable String id, @RequestBody  DashboardVo dashboardVo) {
        dashboardVo.setId(id);
        dashboardVo.setUserId(SubjectUtil.getUserId().toString());
        dashboardService.updateDashboard(dashboardVo);
    }

    //删除仪表盘
    @RequestMapping(value = "/{id}", method = RequestMethod.DELETE)
    public List<Story> delDashboard(DashboardVo dashboard) {
        return dashboardService.delDashboard(dashboard);
    }

    //复制仪表盘
    @RequestMapping(value = "/{id}", method = RequestMethod.POST)
    public void copyDashboard(Dashboard dashboard) {
        dashboard.setUserId(SubjectUtil.getUserId().toString());
        dashboardService.copyDashboard(dashboard);
    }
}

package com.jusfoun.jap.dashboard.domain;

import java.util.Date;

import javax.persistence.Column;
import javax.persistence.Table;
@Table(name = "Dashboard")
public class Dashboard{
	/**
	 * id
	 */
	@Column(name = "DASHBOARD_ID")
	private String id;

	/**
	 *
	 */
	@Column(name = "DASHBOARD_NAME")
	private String name;

	/**
	 * 操作
	 */
	@Column(name = "DASHBOARD_DESCRIPTION")
	private String description;
	
	@Column(name = "user_id")
	private String userId;
	
	@Column(name = "create_Time")
	private Date createTime;
	
	@Column(name = "update_Time")
	private Date updateTime;
	
	@Column(name = "LAYOUT")
	private String layout;
	@Column(name = "background_Color")
	private String backgroundColor;
	
	@Column(name = "BORDER_SHOW")
	private String borderShow;
	
	@Column(name = "BORDER_COLOR")
	private String borderColor;
	
	@Column(name = "BORDER_WIDTH")
	private String borderWidth;

	@Column(name = "TITLE_FONT_SIZE")
	private String titleFontSize;
	
	@Column(name = "TITLE_FONT_WEIGHT")
	private String titleFontWeight;
	
	@Column(name = "TITLE_FONT_COLOR")
	private String titleFontColor;
	
	@Column(name = "TITLE_SHOW")
	private String titleShow;
	
	@Column(name = "THEME_ID")
	private String themeId;
	
	
	public String getThemeId() {
		return themeId;
	}


	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}


	public String getBackgroundColor() {
		return backgroundColor;
	}


	public void setBackgroundColor(String backgroundColor) {
		this.backgroundColor = backgroundColor;
	}


	public String getBorderShow() {
		return borderShow;
	}



	public void setBorderShow(String borderShow) {
		this.borderShow = borderShow;
	}



	public String getBorderColor() {
		return borderColor;
	}



	public void setBorderColor(String borderColor) {
		this.borderColor = borderColor;
	}



	public String getBorderWidth() {
		return borderWidth;
	}



	public void setBorderWidth(String borderWidth) {
		this.borderWidth = borderWidth;
	}
	public String getLayout() {
		return layout;
	}

	public void setLayout(String layout) {
		this.layout = layout;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}


	public String getTitleFontSize() {
		return titleFontSize;
	}


	public void setTitleFontSize(String titleFontSize) {
		this.titleFontSize = titleFontSize;
	}


	public String getTitleFontWeight() {
		return titleFontWeight;
	}


	public void setTitleFontWeight(String titleFontWeight) {
		this.titleFontWeight = titleFontWeight;
	}


	public String getTitleFontColor() {
		return titleFontColor;
	}


	public void setTitleFontColor(String titleFontColor) {
		this.titleFontColor = titleFontColor;
	}


	public String getTitleShow() {
		return titleShow;
	}


	public void setTitleShow(String titleShow) {
		this.titleShow = titleShow;
	}
	
}

package com.jusfoun.jap.dashboard.mapper;

import java.util.List;
import java.util.Map;

import com.jusfoun.jap.dashboard.domain.Dashboard;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.story.domain.Story;

import tk.mybatis.mapper.common.Mapper;

public interface DashboardMapper extends Mapper<Dashboard> {

	DashboardVo getDashboard(Dashboard dashboard);

	List<Dashboard> getDashboards(Dashboard dashboard);

	int createDashboard(DashboardVo dashboard);

	void updateDashboard(DashboardVo dashboard);

	void delDashboard(DashboardVo dashboard);

	Integer copyDashboard(Dashboard dashboard);

	List<String> selectNames(Dashboard dashboard);


	String getCopyDashboardId(Dashboard dashboard);

	Integer copyDashboardWorkRela(Map<String,String> map);

	void delDashboardWorkRela(DashboardVo dashboard);

	void insertDashboardWorkRela(DashboardVo dashboard);
	
	List<Dashboard> queryDashboardbyStory(Story story);
	
	List<Story> queryDashboardUsedByStory(DashboardVo dashboard);
	
}
package com.jusfoun.jap.dashboard.service;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import javax.annotation.Resource;

import org.json.JSONException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.jusfoun.jap.common.Results;
import com.jusfoun.jap.dashboard.domain.Dashboard;
import com.jusfoun.jap.dashboard.mapper.DashboardMapper;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.story.domain.Story;
import com.jusfoun.jap.workTable.mapper.ColumnChineseMapper;
import com.jusfoun.jap.workTable.service.WorkTableService;
import com.jusfoun.jap.workTable.vo.WorkTableCondition;
import com.jusfoun.jap.workTable.vo.WorkTableResult;
import com.jusfoun.jap.workTable.vo.WorkTableVo;

@Service
public class DashboardService {

    @Autowired
    private DashboardMapper dao;
    @Autowired
    private ColumnChineseMapper daoc;
    @Resource
    private WorkTableService workTableService;

    public DashboardVo getDashboard(Dashboard dashboard) throws SQLException, JSONException {
        DashboardVo Dashboardvo = dao.getDashboard(dashboard);
        List<WorkTableVo> workTableList = daoc.queryWorkTablebyPie(dashboard);
        Dashboardvo.setWorkTableResults(this.wt2wtr(workTableList));
        return Dashboardvo;
    }

    private List<WorkTableResult> wt2wtr(List<WorkTableVo> workTableList) throws SQLException, JSONException {
        List<WorkTableResult> WorkTables = new ArrayList<WorkTableResult>();
        if (workTableList != null && workTableList.size() > 0) {//求出工作表的结果
            for (int i = 0; i < workTableList.size(); i++) {
                WorkTableVo WorkTableVo = workTableList.get(i);
                WorkTableResult WorkTableResult = new WorkTableResult();
                WorkTableCondition workTable = new WorkTableCondition();
                workTable.setWorkTableId(WorkTableVo.getWorkTableId());
                WorkTableCondition workTable1 = workTableService.showWorkTableofPie(workTable);
                WorkTableResult.setResult(workTableService.getKylinByCondition(workTable1));
                WorkTableResult.setWorkTableId(WorkTableVo.getWorkTableId());
                WorkTableResult.setWorkTableName(WorkTableVo.getWorkTableName());
                WorkTableResult.setWorkTableCode(WorkTableVo.getWorkTableCode());
                WorkTableResult.setWorkTableDate(WorkTableVo.getWorkTableDate());
                WorkTableResult.setUserId(WorkTableVo.getUserId());
                WorkTableResult.setCubeId(WorkTableVo.getCubeId());
                WorkTableResult.setDataType(WorkTableVo.getDataType());
                WorkTableResult.setTableBorderColor(WorkTableVo.getTableBorderColor());
                WorkTableResult.setTableBorderShow(WorkTableVo.getTableBorderShow());
                WorkTableResult.setTableBorderWidth(WorkTableVo.getTableBorderWidth());
                WorkTableResult.setWorkTableOrder(WorkTableVo.getWorkTableOrder());
                WorkTableResult.setXsColor(WorkTableVo.getXsColor());
                WorkTableResult.setYsColor(WorkTableVo.getYsColor());
                WorkTableResult.setXwColor(WorkTableVo.getXwColor());
                WorkTableResult.setYwColor(WorkTableVo.getYwColor());
                WorkTableResult.setHeaderColor(WorkTableVo.getHeaderColor());
                WorkTableResult.setBodyColor(WorkTableVo.getBodyColor());
                WorkTableResult.setTableColor(WorkTableVo.getTableColor());
                if("step".equals(WorkTableVo.getDataType())){//同比环比图需要传维度度量筛选
                	WorkTableResult.setFilters(workTable1.getFilters());
                	WorkTableResult.setDimTable(workTable1.getDimTable());
                	WorkTableResult.setMeasures(workTable1.getMeasures());
                }else if("steptext".equals(WorkTableVo.getDataType())){
                	WorkTableResult.setMeasures(workTable1.getMeasures());
                }
                WorkTables.add(WorkTableResult);
            }
        }
        return WorkTables;
    }

    public List<Dashboard> getDashboards(Dashboard dashboard) {
        List<Dashboard> Dashboards = dao.getDashboards(dashboard);
        return Dashboards;
    }

    public List<DashboardVo> getDashboardVos(Dashboard dashboard) {
        List<DashboardVo> dashboardVos = new ArrayList<DashboardVo>();
        List<Dashboard> Dashboards = dao.getDashboards(dashboard);
        for (Dashboard db : Dashboards) {
            DashboardVo dashboardVo = new DashboardVo();
//			dashboardVo.setWorkTableResults(this.wt2wtr(daoc.queryWorkTablebyPie(db)));
            dashboardVo.setId(db.getId());
            dashboardVo.setName(db.getName());
            dashboardVo.setDescription(db.getDescription());
            dashboardVo.setUserId(db.getUserId());
            dashboardVo.setCreateTime(db.getCreateTime());
            dashboardVo.setUpdateTime(db.getUpdateTime());
            dashboardVo.setLayout(db.getLayout());
            dashboardVo.setBackgroundColor(db.getBackgroundColor());
            dashboardVo.setBorderColor(db.getBorderColor());
            dashboardVo.setBorderShow(db.getBorderShow());
            dashboardVo.setBorderWidth(db.getBorderWidth());
            dashboardVos.add(dashboardVo);
        }
        return dashboardVos;
    }

    public DashboardVo createDashboard(DashboardVo dashboard) {
        String id = UUID.randomUUID().toString().replaceAll("-", "");
        dashboard.setId(id);
        dao.createDashboard(dashboard);
        if (dashboard.getWorkTables() != null && !dashboard.getWorkTables().isEmpty()) {
            dao.insertDashboardWorkRela(dashboard);//插入关联关系
        }
        return dashboard;
    }

    public void updateDashboard(DashboardVo dashboard) {
        dao.updateDashboard(dashboard);//更新详情名称之类
        dao.delDashboardWorkRela(dashboard);//删除原来的关联表信息
        if (dashboard.getWorkTables() != null && !dashboard.getWorkTables().isEmpty()) {
            dao.insertDashboardWorkRela(dashboard);//插入关联关系
        }
    }

    public List<Story> delDashboard(DashboardVo dashboard) {
        List<Story> list = dao.queryDashboardUsedByStory(dashboard);
        if (list == null || list.size() == 0) {
            dao.delDashboard(dashboard);
            dao.delDashboardWorkRela(dashboard);
        }
        return list;
    }

    public void copyDashboard(Dashboard dashboard) {
        //1获取该仪表盘的副本名列表
        List<String> names = dao.selectNames(dashboard);
        int copyOrder = 1;
        dashboard.setName(dao.getDashboard(dashboard).getName());
        boolean getOrder = false;//false 表示 该序号的副本没有
        for (; ; copyOrder++) {
            getOrder = false;
            for (String name : names) {
                if ((dashboard.getName() + "-副本" + copyOrder).equals(name)) {//检测到该序列的副本
                    getOrder = true;
                    break;
                }
            }
            if (!getOrder) {//如果没有检测到循环结束copyOrder为可以使用的值
                break;
            }
        }

        //2插入新的仪表盘记录并返回主键
        dashboard.setName(dashboard.getName() + "-副本" + copyOrder);//更换新的名字
        dao.copyDashboard(dashboard);//插入
        String copyId = dao.getCopyDashboardId(dashboard);//返回主键
        //3.插入与数据分析的关联记录
        Map<String, String> mapId = new HashMap<String, String>();
        mapId.put("copyId", copyId);
        mapId.put("id", dashboard.getId());
        dao.copyDashboardWorkRela(mapId);

    }

    public DashboardVo getListKylinByCondition(List<WorkTableVo> list) throws SQLException, JSONException {
		DashboardVo Dashboardvo = new DashboardVo();
        List<WorkTableVo> workTableList = daoc.queryWorkTableList(list);
        Dashboardvo.setWorkTableResults(this.wt2wtr(workTableList));
        return Dashboardvo;
	}
}

package com.jusfoun.jap.dashboard.vo;

import java.util.Date;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.Table;

import com.jusfoun.jap.workTable.vo.WorkTableResult;
import com.jusfoun.jap.workTable.vo.WorkTableVo;
@Table(name = "Dashboard")
public class DashboardVo{
	/**
	 * id
	 */
	@Column(name = "DASHBOARD_ID")
	private String id;

	/**
	 *
	 */
	@Column(name = "DASHBOARD_NAME")
	private String name;

	/**
	 * 操作
	 */
	@Column(name = "DASHBOARD_DESCRIPTION")
	private String description;

	private List<WorkTableResult> workTableResults;
	private List<WorkTableVo> workTables;
	
	private Integer dashboardOrder;//故事中仪表盘顺序
	
	@Column(name = "user_id")
	private String userId;
	
	@Column(name = "create_Time")
	private Date createTime;
	
	@Column(name = "update_Time")
	private Date updateTime;
	
	@Column(name = "LAYOUT")
	private String layout;
	
	@Column(name = "background_Color")
	private String backgroundColor;
	
	@Column(name = "BORDER_SHOW")
	private String borderShow;
	
	@Column(name = "BORDER_COLOR")
	private String borderColor;
	
	@Column(name = "BORDER_WIDTH")
	private String borderWidth;

	@Column(name = "TITLE_FONT_SIZE")
	private String titleFontSize;
	
	@Column(name = "TITLE_FONT_WEIGHT")
	private String titleFontWeight;
	
	@Column(name = "TITLE_FONT_COLOR")
	private String titleFontColor;
	
	@Column(name = "TITLE_SHOW")
	private String titleShow;
	
	@Column(name = "THEME_ID")
	private String themeId;
	
	
	public String getThemeId() {
		return themeId;
	}


	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}

	public String getTitleFontSize() {
		return titleFontSize;
	}

	public void setTitleFontSize(String titleFontSize) {
		this.titleFontSize = titleFontSize;
	}

	public String getTitleFontWeight() {
		return titleFontWeight;
	}

	public void setTitleFontWeight(String titleFontWeight) {
		this.titleFontWeight = titleFontWeight;
	}

	public String getTitleFontColor() {
		return titleFontColor;
	}

	public void setTitleFontColor(String titleFontColor) {
		this.titleFontColor = titleFontColor;
	}

	public String getTitleShow() {
		return titleShow;
	}

	public void setTitleShow(String titleShow) {
		this.titleShow = titleShow;
	}

	public String getLayout() {
		return layout;
	}
	
	public Integer getDashboardOrder() {
		return dashboardOrder;
	}

	public void setDashboardOrder(Integer dashboardOrder) {
		this.dashboardOrder = dashboardOrder;
	}


	public String getBackgroundColor() {
		return backgroundColor;
	}


	public void setBackgroundColor(String backgroundColor) {
		this.backgroundColor = backgroundColor;
	}


	public String getBorderShow() {
		return borderShow;
	}



	public void setBorderShow(String borderShow) {
		this.borderShow = borderShow;
	}



	public String getBorderColor() {
		return borderColor;
	}



	public void setBorderColor(String borderColor) {
		this.borderColor = borderColor;
	}



	public String getBorderWidth() {
		return borderWidth;
	}



	public void setBorderWidth(String borderWidth) {
		this.borderWidth = borderWidth;
	}



	public void setLayout(String layout) {
		this.layout = layout;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public List<WorkTableResult> getWorkTableResults() {
		return workTableResults;
	}

	public void setWorkTableResults(List<WorkTableResult> workTableResults) {
		this.workTableResults = workTableResults;
	}

	public List<WorkTableVo> getWorkTables() {
		return workTables;
	}

	public void setWorkTables(List<WorkTableVo> workTables) {
		this.workTables = workTables;
	}

}

package com.jusfoun.jap.dataCenter.request;

import org.apache.commons.lang.builder.ReflectionToStringBuilder;

public class BaseRequest {

	//时间起点
	private String startDate;
	//时间结束点
	private String endDate;
	//系统标识
	private String systemFlag;

	public String getStartDate() {
		return startDate;
	}

	public void setStartDate(String startDate) {
		this.startDate = startDate;
	}

	public String getEndDate() {
		return endDate;
	}

	public void setEndDate(String endDate) {
		this.endDate = endDate;
	}

	public String getSystemFlag() {
		return systemFlag;
	}

	public void setSystemFlag(String systemFlag) {
		this.systemFlag = systemFlag;
	}
	
	@Override
	public String toString()
	{
		return ReflectionToStringBuilder.toString(this);
	}
	
}

package com.jusfoun.jap.dataCenter.request;

import org.apache.commons.lang.builder.ReflectionToStringBuilder;

public class UserAuthenticationRequest extends BaseRequest{
	//用户名
	private String username;
	//密码
	private String password;

	public String getUsername() {
		return username;
	}

	public void setUsername(String username) {
		this.username = username;
	}

	public String getPassword() {
		return password;
	}

	public void setPassword(String password) {
		this.password = password;
	}
	
	@Override
	public String toString()
	{
		return ReflectionToStringBuilder.toString(this);
	}

}

package com.jusfoun.jap.dataCenter.response;

import org.apache.commons.lang.builder.ReflectionToStringBuilder;

public class BaseResponse {

	//http响应状态
	private String httpResult;

	public String getHttpResult() {
		return httpResult;
	}

	public void setHttpResult(String httpResult) {
		this.httpResult = httpResult;
	}
	
	@Override
	public String toString()
	{
		return ReflectionToStringBuilder.toString(this);
	}
}

package com.jusfoun.jap.dataCenter.response;

import org.apache.commons.lang.builder.ReflectionToStringBuilder;

public class UserAuthenticationResponse extends BaseResponse {
	//权限ID
	private String moduleId;
	//权限名称
	private String moduleName;
	//权限连接/权限标识
	private String url;
	//父ID
	private String parentId;

	public String getModuleId() {
		return moduleId;
	}

	public void setModuleId(String moduleId) {
		this.moduleId = moduleId;
	}

	public String getModuleName() {
		return moduleName;
	}

	public void setModuleName(String moduleName) {
		this.moduleName = moduleName;
	}

	public String getUrl() {
		return url;
	}

	public void setUrl(String url) {
		this.url = url;
	}

	public String getParentId() {
		return parentId;
	}

	public void setParentId(String parentId) {
		this.parentId = parentId;
	}
	
	@Override
	public String toString()
	{
		return ReflectionToStringBuilder.toString(this);
	}
}

package com.jusfoun.jap.dataCenter.service;

import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import com.jusfoun.jap.dataCenter.util.DataCenterConstant;
import com.jusfoun.jap.dataCenter.util.HttpClientUtil;

@Service
public abstract class HttpRequestService {

	/**
     * 日志
     */
    private Logger LOGGER = LoggerFactory.getLogger(getClass());
    
    /**
     * @brief 功能:发送http请求主方法
     * @param params 请求参数
     * @return Object
     * @throws Exception 
     */
    public Object sendRequest(String method, Map<String, Object> params)
    {
    	String httpUrl = null;
    	String result = null;
    	Object object = null;
    	try{
	    	httpUrl = DataCenterConstant.DATACENTER_URL + DataCenterConstant.SERVICE_METHOD.get(method);
	    	if(DataCenterConstant.requestType.POST.equals(getRequestType()))
	    	{
	    		result = HttpClientUtil.sendHttpPost(httpUrl, params);
	    	}
	    	else if(DataCenterConstant.requestType.GET.equals(getRequestType()))
	    	{
	    		result = HttpClientUtil.sendHttpGet(httpUrl, params);
	    	}
	    	object = parseResult(result);
    	}
    	catch(Exception e)
    	{
    		LOGGER.error("request:httpUrl="+httpUrl +";params="+params.toString());
    		LOGGER.error(e.getMessage(), e);
    	}
    	return object;
    }
    
    protected abstract Object parseResult(String result);

	/**
     * 请求类型
     * @return
     */
    protected String getRequestType()
    {
    	return DataCenterConstant.requestType.POST;
    }
}

package com.jusfoun.jap.dataCenter.service;

import java.lang.reflect.Type;
import java.util.List;

import org.springframework.stereotype.Service;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.reflect.TypeToken;
import com.jusfoun.jap.dataCenter.response.UserAuthenticationResponse;
import com.jusfoun.jap.dataCenter.util.DataCenterConstant;


@Service
public class UserAuthenticationService  extends HttpRequestService {

	@Override
	protected Object parseResult(String result) {
		Gson gson = new GsonBuilder().create();
		Type type = new TypeToken<List<UserAuthenticationResponse>>(){}.getType();
		return gson.fromJson(result, type);
	}

	/**
     * 请求类型
     * @return
     */
    protected String getRequestType()
    {
    	return DataCenterConstant.requestType.GET;
    }
}

package com.jusfoun.jap.dataCenter.util;

import java.beans.BeanInfo;
import java.beans.IntrospectionException;
import java.beans.Introspector;
import java.beans.PropertyDescriptor;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.util.HashMap;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


public class ConvertBeanUtil
{
    private final static Logger log = LoggerFactory.getLogger(ConvertBeanUtil.class);
    /**
     * 将一个 JavaBean 对象转化为一个 Map
     * 
     * @param bean
     *            要转化的JavaBean 对象
     * @return 转化出来的 Map 对象
     * @throws IntrospectionException
     *             如果分析类属性失败
     * @throws IllegalAccessException
     *             如果实例化 JavaBean 失败
     * @throws InvocationTargetException
     *             如果调用属性的 setter 方法失败
     */
    public static Map<String, Object> convertBean(Object bean)
    {
        Class<? extends Object> type = bean.getClass();
        Map<String, Object> returnMap = new HashMap<String, Object>();
        try
        {
            BeanInfo beanInfo = Introspector.getBeanInfo(type);
    
            PropertyDescriptor[] propertyDescriptors = beanInfo
                    .getPropertyDescriptors();
            for (int i = 0; i < propertyDescriptors.length; i++)
            {
                PropertyDescriptor descriptor = propertyDescriptors[i];
                String propertyName = descriptor.getName();
                if (!propertyName.equals("class"))
                {
                    Method readMethod = descriptor.getReadMethod();
                    Object result = readMethod.invoke(bean, new Object[0]);
                    if (null != result)
                    {
                        returnMap.put(propertyName, result);
                    }
                }
            }
        }catch (Exception e)
        {
            log.error(e.getMessage(), e);
        }
        return returnMap;
    }

//    public static void main(String[] args)
//    {
        //ResponseMessage message = new ResponseMessage();
//        message.setHttpResult(1);
//
//        Map<String, Object> map = ConvertBeanUtil.convertBean(message);
//        for (Entry<String, Object> e : map.entrySet())
//        {
//            System.out.println(e.getKey() + "-" + e.getValue());
//        }
//    }

}

package com.jusfoun.jap.dataCenter.util;

import java.util.HashMap;
import java.util.Map;

import com.jusfoun.jap.util.InitParam;


public interface DataCenterConstant {
	
	/**
	 * 统一认证平台
	 */
	String DATACENTER_URL = InitParam.getInitParamMap().get("datacenter.url");
	int SOCKETTIMEOUT = Integer.parseInt(InitParam.getInitParamMap().get("datacenter.socketTimeout"));
	String SYSTEMFLAG = InitParam.getInitParamMap().get("datacenter.systemFlag");
	String SSO = InitParam.getInitParamMap().get("datacenter.sso");
	/**
     * 功能地址 
     */
    interface Method
    {
    	//Get请求 权限列表
    	String M_GETUSERAUTHENTICATION = "/sysUser/userInfo/getUserAuthentication";
    	//Post请求 用户信息同步
    	String M_SYNCHRONIZATION = "/sysUser/userInfo/synchronization";
    	//Post请求 组织机构同步
    	String M_GETSYSGOVLISTBYDATE = "/sysGov/getSysGovListByDate";
    	
    }
    
	Map<String, String> SERVICE_METHOD = new HashMap<String, String>()
    {
		{
			put("userAuthenticationService", Method.M_GETUSERAUTHENTICATION);
			put("sysSimpleUserService", Method.M_SYNCHRONIZATION);
    		put("sysSimpleGovService", Method.M_GETSYSGOVLISTBYDATE);
    	}
    };
    
    
	/**
	 * 请求类型
	 * @author syk
	 *
	 */
	interface requestType
	{
		String GET = "GET";
		String POST = "POST";
	}
	
}

package com.jusfoun.jap.dataCenter.util;

import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.http.HttpEntity;
import org.apache.http.HttpStatus;
import org.apache.http.NameValuePair;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.message.BasicNameValuePair;
import org.apache.http.util.EntityUtils;
import org.apache.log4j.Logger;

public class HttpClientUtil {

	private static final Logger LOGGER = Logger.getLogger(HttpClientUtil.class);

	public static final String CONTENT_TYPE = "application/x-www-form-urlencoded;charset=UTF-8";
	public static final String UTF_8 = "UTF-8";
	public static final int CONNECTION_TIMEOUT = 60000;

	private static RequestConfig requestConfig = RequestConfig.custom()
			.setSocketTimeout(CONNECTION_TIMEOUT)
			.setConnectTimeout(CONNECTION_TIMEOUT).build();

	/**
	 * 发送 post请求
	 * 
	 * @param httpUrl
	 *            地址
	 * @param maps
	 *            参数
	 * @throws Exception 
	 */
	public static String sendHttpPost(String httpUrl, Map<String, Object> maps) throws Exception {
		HttpPost httpPost = new HttpPost(httpUrl);// 创建httpPost
		// 创建参数队列
		List<NameValuePair> nameValuePairs = new ArrayList<NameValuePair>();
		for (String key : maps.keySet()) {
			nameValuePairs.add(new BasicNameValuePair(key, maps.get(key).toString()));
		}
		httpPost.setEntity(new UrlEncodedFormEntity(nameValuePairs, UTF_8));
		return sendHttpPost(httpPost);
	}

	/**
	 * 发送Post请求
	 * 
	 * @param httpPost
	 * @return
	 * @throws Exception 
	 */
	private static String sendHttpPost(HttpPost httpPost) throws Exception {
		CloseableHttpClient httpClient = null;
		CloseableHttpResponse response = null;
		HttpEntity entity = null;
		String responseContent = null;
		try {
			// 创建默认的httpClient实例.
			httpClient = HttpClients.createDefault();
			httpPost.setConfig(requestConfig);
			// 执行请求
			response = httpClient.execute(httpPost);
			int statusCode = response.getStatusLine().getStatusCode();
			entity = response.getEntity();
        	responseContent = EntityUtils.toString(entity, UTF_8);
            if (statusCode != HttpStatus.SC_OK) {
            	LOGGER.error("responseContent=" + responseContent);
            	throw new Exception(responseContent);
            }
		} catch (Exception e) {
			LOGGER.error(e.getMessage(), e);
			throw e;
		} finally {
			try {
				// 关闭连接,释放资源
				if (response != null) {
					response.close();
				}
				if (httpClient != null) {
					httpClient.close();
				}
			} catch (IOException e) {
				LOGGER.error(e.getMessage(), e);
				throw e;
			}
		}
		return responseContent;
	}

	/**
	 * 发送 get请求
	 * 
	 * @param httpUrl
	 * @throws Exception 
	 */
	public static String sendHttpGet(String httpUrl, Map<String, Object> maps) throws Exception {
		//封装参数
		StringBuffer param = new StringBuffer();
		int i = 0;
		for (String key : maps.keySet()) {
			if (i == 0)
			{
				param.append("?");
			}
			else
			{
				param.append("&");
			}
			param.append(key).append("=").append(maps.get(key));
			i++;
		}
		httpUrl += param;
		HttpGet httpGet = new HttpGet(httpUrl);// 创建get请求
		return sendHttpGet(httpGet);
	}

	/**
	 * 发送Get请求
	 * 
	 * @param httpPost
	 * @return
	 * @throws Exception 
	 */
	private static String sendHttpGet(HttpGet httpGet) throws Exception {
		CloseableHttpClient httpClient = null;
		CloseableHttpResponse response = null;
		HttpEntity entity = null;
		String responseContent = null;

		try {
			// 创建默认的httpClient实例.
			httpClient = HttpClients.createDefault();
			httpGet.setConfig(requestConfig);
			// 执行请求
			response = httpClient.execute(httpGet);
			int statusCode = response.getStatusLine().getStatusCode();
			entity = response.getEntity();
			responseContent = EntityUtils.toString(entity, "UTF-8");
			if (statusCode != HttpStatus.SC_OK) {
            	LOGGER.error("responseContent=" + responseContent);
            	throw new Exception(responseContent);
            }
		} catch (Exception e) {
			LOGGER.error(e.getMessage(), e);
			throw e;
		} finally {
			try {
				// 关闭连接,释放资源
				if (response != null) {
					response.close();
				}
				if (httpClient != null) {
					httpClient.close();
				}
			} catch (IOException e) {
				LOGGER.error(e.getMessage(), e);
				throw e;
			}
		}
		return responseContent;
	}
}

package com.jusfoun.jap.hive.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.fastjson.JSON;
import com.itmuch.core.page.PageVo;
import com.jusfoun.jap.hive.service.HiveService;
import com.jusfoun.jap.hive.util.HiveUtil;
import com.jusfoun.jap.hive.vo.ColumnVo;
import com.jusfoun.jap.hive.vo.DataSourceTable;
import com.jusfoun.jap.hive.vo.HiveTableVo;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.kylin.service.KylinCubeService;
import com.jusfoun.jap.kylin.service.KylinModelService;

@RestController
@RequestMapping(value = "/hive")
public class HiveController {
	
	@Autowired
	HiveService hiveService;
	@Autowired
	static KylinModelService kylinModelService;
	@Autowired
	static KylinCubeService kylinCubeService;
	//数据模型展示和查询
	@RequestMapping("/myDataModel")
	public void myDataModel(PageVo pageVo, String modelName, Boolean isShow){
		hiveService.myDataModel(pageVo, modelName, isShow);
	}
	
	//数据模型新增
	@RequestMapping("/myDataModelAdd")
	public List<DataSourceTable> myDataModelAdd(){
		return hiveService.myDataModelAdd();
	}
	
	//根据表名称搜索
	public List<DataSourceTable> DataSourceTableSearch(String tableName,List<DataSourceTable> DataSourceTable){
		return hiveService.DataSourceTableSearch(tableName, DataSourceTable);
	}
		
	@RequestMapping(value="/myDataModelSave", method=RequestMethod.POST,consumes=MediaType.APPLICATION_JSON_UTF8_VALUE)
	public void myDataModelSave( @RequestBody ModelVo  model){
		
//		System.out.println(model);
		hiveService.generateModel(model);
	}
	
	@RequestMapping("/generateModel")
//	public void generateModel(ModelVo modelVo){
		public void generateModel(){
		String modelVoStr="{'dimensions':[{'columnName':'order_customtype','dataType':'string','remarks':'客户类型','tableName':'dim_1cd97bd8aa9b4aa48a4a4f053fc4274a'},{'columnName':'order_time','dataType':'string','remarks':'时间','tableName':'dim_b25d4a7a6c5743a9b6ad08d83b0fa8c2'},{'columnName':'order_ordertype','dataType':'string','remarks':'订单类型','tableName':'dim_70c0d528e13e4521a97c87b796f115e9'}],'factTable':{'columns':[{'columnName':'order_money','columnRemarks':'金钱度量','dataType':'string','type':'2'},{'columnName':'order_customtype','columnRemarks':'客户类型','dataType':'string','type':'1'},{'columnName':'order_time','columnRemarks':'时间','dataType':'string','type':'1'},{'columnName':'order_ordertype','columnRemarks':'订单类型','dataType':'string','type':'1'}],'tableName':'fact_f4f4f9b3531d4a4d8e6d3ddc1acff839','tableRemarks':'订单数据模型'},'measures':[{'columnName':'order_money','computationRules':'sum','dataType':'string','remarks':'金钱度量','tableName':'fact_f4f4f9b3531d4a4d8e6d3ddc1acff839'}],'modelDesc':'订单数据模型','modelName':'订单','relations':[]}";
		ModelVo modelVo=(ModelVo)JSON.parseObject(modelVoStr,ModelVo.class);
	}
	
	@RequestMapping("/queryHiveTable")
	public List<HiveTableVo> queryHiveTable(String tableName){
		//fact_water_quality_change
		List<HiveTableVo> list=HiveUtil.listHiveTableVoList(tableName);
		return list;
	}
	@RequestMapping("/queryHiveTableColumns")
	public List<ColumnVo> queryHiveTableColumns(String tableName){
		List<ColumnVo> list=HiveUtil.getColumnInfo(tableName);
		return list;
	}
	
	@RequestMapping("/showModelDetail")
	public ModelVo myDataModelDetail(String cubeId){
		return hiveService.myDataModelDetail(cubeId);
	}
}

package com.jusfoun.jap.hive.domain;

import java.io.Serializable;
import javax.persistence.*;

@Table(name = "T_CUBE_HIVETABLE_RELATION")
public class CubeHiveTableRelation implements Serializable {
    /**
     * 主键
     */
    @Id
    @Column(name = "RELATION_ID")
    private String relationId;

    /**
     * cube主键
     */
    @Column(name = "CUBE_ID")
    private String cubeId;

    /**
     * hive表主键
     */
    @Column(name = "TABLE_ID")
    private String tableId;

    private static final long serialVersionUID = 1L;

    /**
     * 获取主键
     *
     * @return RELATION_ID - 主键
     */
    public String getRelationId() {
        return relationId;
    }

    /**
     * 设置主键
     *
     * @param relationId 主键
     */
    public void setRelationId(String relationId) {
        this.relationId = relationId;
    }

    /**
     * 获取cube主键
     *
     * @return CUBE_ID - cube主键
     */
    public String getCubeId() {
        return cubeId;
    }

    /**
     * 设置cube主键
     *
     * @param cubeId cube主键
     */
    public void setCubeId(String cubeId) {
        this.cubeId = cubeId;
    }

    /**
     * 获取hive表主键
     *
     * @return TABLE_ID - hive表主键
     */
    public String getTableId() {
        return tableId;
    }

    /**
     * 设置hive表主键
     *
     * @param tableId hive表主键
     */
    public void setTableId(String tableId) {
        this.tableId = tableId;
    }
}
package com.jusfoun.jap.hive.domain;

import java.io.Serializable;
import java.util.Date;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

import com.jusfoun.jap.util.StringUtil;

@Table(name = "T_HIVE_TABLE")
public class HiveTable implements Serializable {
    @Id
    @Column(name = "TABLE_ID")
    private String tableId;

    @Column(name = "TABLE_NAME")
    private String tableName;

    @Column(name = "TABLE_DESC")
    private String tableDesc;
    
    @Column(name = "CREATE_TIME")
    private Date createTime;
    
    @Column(name = "UPDATE_TIME")
    private Date updateTime;

    private static final long serialVersionUID = 1L;

    /**
     * @return TABLE_ID
     */
    public String getTableId() {
        return tableId;
    }

    /**
     * @param tableId
     */
    public void setTableId(String tableId) {
        this.tableId = tableId;
    }

    /**
     * @return TABLE_NAME
     */
    public String getTableName() {
        return tableName;
    }

    /**
     * @param tableName
     */
    public void setTableName(String tableName) {
        this.tableName = tableName;
    }

    /**
     * @return TABLE_DESC
     */
    public String getTableDesc() {
        return tableDesc;
    }

    /**
     * @param tableDesc
     */
    public void setTableDesc(String tableDesc) {
        this.tableDesc = tableDesc;
    }
    
    @Override
    public boolean equals(Object obj) {
    	if(obj instanceof HiveTable){
    		if(StringUtil.isNotEmpty(this.tableId)){
    			if(this.tableId==((HiveTable)obj).getTableId()){
    				return true;
    			}else{
    				return false;
    			}
    		}else{
    			if(this.tableName.equals(((HiveTable)obj).getTableName())){
    				return true;
    			}else{
    				return false;
    			}
    		}
    	}else{
    		return false;
    	}
    }

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}
    
    
}
package com.jusfoun.jap.hive.domain;

import java.io.Serializable;
import java.util.Date;

import javax.persistence.*;

@Table(name = "T_HIVE_TABLE_COLUMN")
public class HiveTableColumn implements Serializable {
    /**
     * 主键
     */
    @Id
    @Column(name = "COLUMN_ID")
    private String columnId;

    /**
     * 表ID
     */
    @Column(name = "TABLE_ID")
    private String tableId;

    /**
     * 列名
     */
    @Column(name = "COLUMN_NAME")
    private String columnName;

    /**
     * 数据类型
     */
    @Column(name = "DATE_TYPE")
    private String dateType;

    /**
     * 长度
     */
    @Column(name = "LENGTH")
    private String length;

    /**
     * 描述
     */
    @Column(name = "COLUMN_DESC")
    private String columnDesc;
    
    @Column(name = "CREATE_TIME")
    private Date createTime;
    
    @Column(name = "UPDATE_TIME")
    private Date updateTime;

    private static final long serialVersionUID = 1L;

    /**
     * 获取主键
     *
     * @return COLUMN_ID - 主键
     */
    public String getColumnId() {
        return columnId;
    }

    /**
     * 设置主键
     *
     * @param columnId 主键
     */
    public void setColumnId(String columnId) {
        this.columnId = columnId;
    }

    /**
     * 获取表ID
     *
     * @return TABLE_ID - 表ID
     */
    public String getTableId() {
        return tableId;
    }

    /**
     * 设置表ID
     *
     * @param tableId 表ID
     */
    public void setTableId(String tableId) {
        this.tableId = tableId;
    }

    /**
     * 获取列名
     *
     * @return COLUMN_NAME - 列名
     */
    public String getColumnName() {
        return columnName;
    }

    /**
     * 设置列名
     *
     * @param columnName 列名
     */
    public void setColumnName(String columnName) {
        this.columnName = columnName;
    }

    /**
     * 获取数据类型
     *
     * @return DATE_TYPE - 数据类型
     */
    public String getDateType() {
        return dateType;
    }

    /**
     * 设置数据类型
     *
     * @param dateType 数据类型
     */
    public void setDateType(String dateType) {
        this.dateType = dateType;
    }

    /**
     * 获取长度
     *
     * @return LENGTH - 长度
     */
    public String getLength() {
        return length;
    }

    /**
     * 设置长度
     *
     * @param length 长度
     */
    public void setLength(String length) {
        this.length = length;
    }

    /**
     * 获取描述
     *
     * @return COLUMN_DESC - 描述
     */
    public String getColumnDesc() {
        return columnDesc;
    }

    /**
     * 设置描述
     *
     * @param columnDesc 描述
     */
    public void setColumnDesc(String columnDesc) {
        this.columnDesc = columnDesc;
    }
    
    @Override
    public boolean equals(Object obj) {
    	if(obj instanceof HiveTableColumn){
    		if(((HiveTableColumn)obj).getTableId().equals(this.getTableId())&&((HiveTableColumn)obj).getColumnName().equals(this.getColumnName())){
    			return true;
    		}else{
    			return false;
    		}
    	}else{
    		return false;
    	}
    }

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}
    
    
}
package com.jusfoun.jap.hive.domain;

import java.io.Serializable;
import javax.persistence.*;

@Table(name = "T_HIVE_TABLE_RELATION")
public class HiveTableRelation implements Serializable {
    /**
     * 主键
     */
    @Id
    @Column(name = "RELATION_ID")
    private String relationId;

    /**
     * 左表主键
     */
    @Column(name = "LEFT_TABLE_ID")
    private String leftTableId;

    /**
     * 关联类型
     */
    @Column(name = "RELATION_TYPE")
    private String relationType;

    /**
     * 右表主键
     */
    @Column(name = "RIGTH_TABLE_ID")
    private String rigthTableId;

    @Column(name = "LEFT_COLUMN")
    private String leftColumn;

    @Column(name = "RIGHT_COLUMN")
    private String rightColumn;

    @Column(name = "CUBE_ID")
    private String cubeId;

    @Column(name = "FACT_NAME")
    private String factName;

    private static final long serialVersionUID = 1L;

    /**
     * 获取主键
     *
     * @return RELATION_ID - 主键
     */
    public String getRelationId() {
        return relationId;
    }

    /**
     * 设置主键
     *
     * @param relationId 主键
     */
    public void setRelationId(String relationId) {
        this.relationId = relationId;
    }

    /**
     * 获取左表主键
     *
     * @return LEFT_TABLE_ID - 左表主键
     */
    public String getLeftTableId() {
        return leftTableId;
    }

    /**
     * 设置左表主键
     *
     * @param leftTableId 左表主键
     */
    public void setLeftTableId(String leftTableId) {
        this.leftTableId = leftTableId;
    }

    /**
     * 获取关联类型
     *
     * @return RELATION_TYPE - 关联类型
     */
    public String getRelationType() {
        return relationType;
    }

    /**
     * 设置关联类型
     *
     * @param relationType 关联类型
     */
    public void setRelationType(String relationType) {
        this.relationType = relationType;
    }

    /**
     * 获取右表主键
     *
     * @return RIGTH_TABLE_ID - 右表主键
     */
    public String getRigthTableId() {
        return rigthTableId;
    }

    /**
     * 设置右表主键
     *
     * @param rigthTableId 右表主键
     */
    public void setRigthTableId(String rigthTableId) {
        this.rigthTableId = rigthTableId;
    }

    /**
     * @return LEFT_COLUMN
     */
    public String getLeftColumn() {
        return leftColumn;
    }

    /**
     * @param leftColumn
     */
    public void setLeftColumn(String leftColumn) {
        this.leftColumn = leftColumn;
    }

    /**
     * @return RIGHT_COLUMN
     */
    public String getRightColumn() {
        return rightColumn;
    }

    /**
     * @param rightColumn
     */
    public void setRightColumn(String rightColumn) {
        this.rightColumn = rightColumn;
    }

    /**
     * @return CUBE_ID
     */
    public String getCubeId() {
        return cubeId;
    }

    /**
     * @param cubeId
     */
    public void setCubeId(String cubeId) {
        this.cubeId = cubeId;
    }

    /**
     * @return FACT_NAME
     */
    public String getFactName() {
        return factName;
    }

    /**
     * @param factName
     */
    public void setFactName(String factName) {
        this.factName = factName;
    }
}
package com.jusfoun.jap.hive.domain;

import java.io.Serializable;
import java.util.Date;

import javax.persistence.*;

@Table(name = "T_KYLIN_TABLE")
public class KylinTable implements Serializable {
    /**
     * 主键
     */
    @Id
    @Column(name = "TABLE_ID")
    private String tableId;

    /**
     * cube主键
     */
    @Column(name = "CUBE_ID")
    private String cubeId;

    /**
     * 1：事实表2：维度表
     */
    @Column(name = "TABLE_TYPE")
    private String tableType;

    /**
     * 表名
     */
    @Column(name = "TABLE_NAME")
    private String tableName;

    /**
     * 描述
     */
    @Column(name = "TABLE_DESC")
    private String tableDesc;
    
    
    @Column(name = "SYNC_POLICY")
    private String syncPolicy;
    
    @Column(name = "SYNC_SQL")
    private String syncSql;

    private static final long serialVersionUID = 1L;

    /**
     * 获取主键
     *
     * @return TABLE_ID - 主键
     */
    public String getTableId() {
        return tableId;
    }

    /**
     * 设置主键
     *
     * @param tableId 主键
     */
    public void setTableId(String tableId) {
        this.tableId = tableId;
    }

    /**
     * 获取cube主键
     *
     * @return CUEB_ID - cube主键
     */
    public String getCubeId() {
        return cubeId;
    }

    /**
     * 设置cube主键
     *
     * @param cubeId cube主键
     */
    public void setCubeId(String cubeId) {
        this.cubeId = cubeId;
    }

    /**
     * 获取1：事实表2：维度表
     *
     * @return TABLE_TYPE - 1：事实表2：维度表
     */
    public String getTableType() {
        return tableType;
    }

    /**
     * 设置1：事实表2：维度表
     *
     * @param tableType 1：事实表2：维度表
     */
    public void setTableType(String tableType) {
        this.tableType = tableType;
    }

    /**
     * 获取表名
     *
     * @return TABLE_NAME - 表名
     */
    public String getTableName() {
        return tableName;
    }

    /**
     * 设置表名
     *
     * @param tableName 表名
     */
    public void setTableName(String tableName) {
        this.tableName = tableName;
    }

    /**
     * 获取描述
     *
     * @return TABLE_DESC - 描述
     */
    public String getTableDesc() {
        return tableDesc;
    }

    /**
     * 设置描述
     *
     * @param tableDesc 描述
     */
    public void setTableDesc(String tableDesc) {
        this.tableDesc = tableDesc;
    }


	public String getSyncPolicy() {
		return syncPolicy;
	}

	public void setSyncPolicy(String syncPolicy) {
		this.syncPolicy = syncPolicy;
	}

	public String getSyncSql() {
		return syncSql;
	}

	public void setSyncSql(String syncSql) {
		this.syncSql = syncSql;
	}
    
    
}
package com.jusfoun.jap.hive.domain;

import java.io.Serializable;
import java.math.BigDecimal;
import java.util.Date;

import javax.persistence.*;

@Table(name = "T_KYLIN_TABLE_COLUMN")
public class KylinTableColumn implements Serializable {
    /**
     * 主键
     */
    @Id
    @Column(name = "COLUMN_ID")
    private String columnId;

    /**
     * 表ID
     */
    @Column(name = "TABLE_ID")
    private String tableId;

    /**
     * 列名
     */
    @Column(name = "COLUMN_NAME")
    private String columnName;

    /**
     * 数据类型
     */
    @Column(name = "DATE_TYPE")
    private String dateType;

    /**
     * 长度
     */
    @Column(name = "LENGTH")
    private String length;

    /**
     * 描述
     */
    @Column(name = "COLUMN_DESC")
    private String columnDesc;

    /**
     * 1：维度：2度量
     */
    @Column(name = "COLUMN_TYPE")
    private String columnType;

    /**
     * hive表主键，来自那张hive表
     */
    @Column(name = "COLUMN_SOURCE")
    private String columnSource;
    
    /**
     * 
     */
    @Column(name="COMPUTATION_RULES")
    private String computationRules;
    

    private static final long serialVersionUID = 1L;

    /**
     * 获取主键
     *
     * @return COLUMN_ID - 主键
     */
    public String getColumnId() {
        return columnId;
    }

    /**
     * 设置主键
     *
     * @param columnId 主键
     */
    public void setColumnId(String columnId) {
        this.columnId = columnId;
    }

    /**
     * 获取表ID
     *
     * @return TABLE_ID - 表ID
     */
    public String getTableId() {
        return tableId;
    }

    /**
     * 设置表ID
     *
     * @param tableId 表ID
     */
    public void setTableId(String tableId) {
        this.tableId = tableId;
    }

    /**
     * 获取列名
     *
     * @return COLUMN_NAME - 列名
     */
    public String getColumnName() {
        return columnName;
    }

    /**
     * 设置列名
     *
     * @param columnName 列名
     */
    public void setColumnName(String columnName) {
        this.columnName = columnName;
    }

    /**
     * 获取数据类型
     *
     * @return DATE_TYPE - 数据类型
     */
    public String getDateType() {
        return dateType;
    }

    /**
     * 设置数据类型
     *
     * @param dateType 数据类型
     */
    public void setDateType(String dateType) {
        this.dateType = dateType;
    }

    /**
     * 获取长度
     *
     * @return LENGTH - 长度
     */
    public String getLength() {
        return length;
    }

    /**
     * 设置长度
     *
     * @param length 长度
     */
    public void setLength(String length) {
        this.length = length;
    }

    /**
     * 获取描述
     *
     * @return COLUMN_DESC - 描述
     */
    public String getColumnDesc() {
        return columnDesc;
    }

    /**
     * 设置描述
     *
     * @param columnDesc 描述
     */
    public void setColumnDesc(String columnDesc) {
        this.columnDesc = columnDesc;
    }

    /**
     * 获取1：维度：2度量
     *
     * @return COLUMN_TYPE - 1：维度：2度量
     */
    public String getColumnType() {
        return columnType;
    }

    /**
     * 设置1：维度：2度量
     *
     * @param columnType 1：维度：2度量
     */
    public void setColumnType(String columnType) {
        this.columnType = columnType;
    }

    /**
     * 获取hive表主键，来自那张hive表
     *
     * @return COLUMN_SOURCE - hive表主键，来自那张hive表
     */
    public String getColumnSource() {
        return columnSource;
    }

    /**
     * 设置hive表主键，来自那张hive表
     *
     * @param columnSource hive表主键，来自那张hive表
     */
    public void setColumnSource(String columnSource) {
        this.columnSource = columnSource;
    }

	public String getComputationRules() {
		return computationRules;
	}

	public void setComputationRules(String computationRules) {
		this.computationRules = computationRules;
	}

    
    
    
}
package com.jusfoun.jap.hive.job;

import java.util.Date;
import java.util.List;

import javax.annotation.Resource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import com.jusfoun.jap.cube.domain.Cube;
import com.jusfoun.jap.cube.service.CubeService;
import com.jusfoun.jap.cube.util.CubeConstants.SyncStatus;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.hive.service.HiveDataService;
import com.jusfoun.jap.kylin.service.KylinCubeService;
import com.jusfoun.jap.kylin.service.KylinJobService;
import com.jusfoun.jap.util.Constant;

@Component
public class HiveJob {
	
	private transient Logger LOG = LoggerFactory.getLogger(getClass());
	@Resource
	private CubeService cubeService;
	
	@Resource
	private KylinCubeService kylinCubeService;
	
	@Resource
	private HiveDataService hiveDataService;
	
	@Resource
	private KylinJobService kylinJobService;
	
    @Scheduled(cron = "${job.everyFiveMin.cron}")
    public void synchronizeData() {
    	if("0".equals(Constant.JOB_ENABLE))
    	{
    		return;
    	}
    	LOG.info("HiveJob.synchronizeData start...");
    	Date now = new Date();
    	CubeVo cubeVo = new CubeVo();
    	List<Cube> cubeList = cubeService.queryByCubeName(cubeVo);
    	if(null != cubeList && cubeList.size() > 0)
    	{
    		for(Cube cube : cubeList)
    		{
    			if(null != cube.getSyncRule())
    			{
    				if(cube.getSyncStatus() == SyncStatus.REDAY_EXEC)
        			{
        				syncCube(cube);
        			}
        			else if(cube.getSyncStatus() == SyncStatus.EXEC_COMPLATE)
        			{
        				long interval = (now.getTime()- cube.getSyncTime().getTime()) / 1000;
    	    			if(interval > cube.getSyncRule())
    	    			{
    	    				syncCube(cube);
    	    			}
        			}
    			}
    		}
    	}
    	LOG.info("HiveJob.synchronizeData end...");
    }

	private void syncCube(Cube cube) 
	{
		LOG.info("HiveJob.syncCube start... cubeId=" + cube.getCubeId());
		try {
			hiveDataService.synchronizeData(cube.getCubeId());
			CubeVo cubeInfo = new CubeVo();
			cubeInfo.setCubeId(cube.getCubeId());
			cubeInfo.setSyncStatus(new Long(SyncStatus.SYNC_DATA));
			cubeService.updateCubeInfo(cubeInfo);
			kylinCubeService.buildCube(cube.getCubeName());
			
			cubeInfo.setSyncStatus(new Long(SyncStatus.BULID_CUBE));
			cubeService.updateCubeInfo(cubeInfo);
			
		} catch (Exception e) {
			LOG.error(e.getMessage(), e);
		}
    	LOG.info("HiveJob.syncCube end... cubeId=" + cube.getCubeId());
	}
	
	 @Scheduled(cron = "${job.everyTenMin.cron}")
	 public void synchronizeCubeBuildStatus()
	 {
		 if("0".equals(Constant.JOB_ENABLE))
	     {
			 return;
	     }
	     CubeVo cubeVo = new CubeVo();
	     List<Cube> cubeList = cubeService.queryByCubeName(cubeVo);
	     if(null != cubeList && cubeList.size() > 0)
	     {
	    	 for(Cube cube : cubeList)
	    	 {
	    	 }
	     }
	    		
	 }

}

package com.jusfoun.jap.hive.mapper;

import com.jusfoun.jap.hive.domain.CubeHiveTableRelation;
import tk.mybatis.mapper.common.Mapper;

public interface CubeHiveTableRelationMapper extends Mapper<CubeHiveTableRelation> {
}
package com.jusfoun.jap.hive.mapper;

import java.util.List;

import com.jusfoun.jap.cube.domain.Cube;
import com.jusfoun.jap.cube.domain.Tag;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.hive.vo.DataSourceTable;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.workTable.domain.CubeDim;
import com.jusfoun.jap.workTable.domain.CubeFact;

public interface HiveMapper{
	
	//查询数据模型主页面
	public List<ModelVo> queryDataModel(String modelName,Boolean isShow);
	
	//查询所有的表信息
	public List<DataSourceTable> querydataSourceTable();
}

package com.jusfoun.jap.hive.mapper;

import java.util.List;

import com.jusfoun.jap.hive.domain.HiveTableColumn;
import tk.mybatis.mapper.common.Mapper;

public interface HiveTableColumnMapper extends Mapper<HiveTableColumn> {
	public void insertTableColumn(HiveTableColumn tableColumn);

}
package com.jusfoun.jap.hive.mapper;

import java.util.List;
import java.util.Set;

import org.apache.ibatis.annotations.Param;

import com.jusfoun.jap.hive.domain.HiveTable;

import tk.mybatis.mapper.common.Mapper;

public interface HiveTableMapper extends Mapper<HiveTable> {
	public void insertHiveTable(HiveTable hiveTable);
	
	public List<HiveTable> findHiveTableByTableId(@Param("set") Set<String> ids);
}
package com.jusfoun.jap.hive.mapper;

import java.util.List;

import com.jusfoun.jap.hive.domain.HiveTableRelation;
import com.jusfoun.jap.hive.vo.RelationVo;

import tk.mybatis.mapper.common.Mapper;

public interface HiveTableRelationMapper extends Mapper<HiveTableRelation> {
	public void insertHiveTableRelation(HiveTableRelation hiveTableRelation);
	
	public List<HiveTableRelation> findHiveTableRelationByCubeId(String cubeId);
	
	public List<RelationVo> findHiveTableRelationVoByCubeId(String cubeId);
}
package com.jusfoun.jap.hive.mapper;

import java.util.List;

import com.jusfoun.jap.hive.domain.HiveTableColumn;
import com.jusfoun.jap.hive.domain.KylinTableColumn;
import tk.mybatis.mapper.common.Mapper;

public interface KylinTableColumnMapper extends Mapper<KylinTableColumn> {
	public void insertKylinTableColumn(KylinTableColumn kylinTableColumn);
	
	
	public List<KylinTableColumn> findHiveTableColumnByTableId(List<String> ids);
}
package com.jusfoun.jap.hive.mapper;

import java.util.List;

import com.jusfoun.jap.hive.domain.KylinTable;
import com.jusfoun.jap.hive.domain.KylinTableColumn;

import tk.mybatis.mapper.common.Mapper;

public interface KylinTableMapper extends Mapper<KylinTable> {
	public void insertKylinTable(KylinTable kylinTable);
	
	public List<KylinTable> findKylinTableByCubeId(String cubeId);
}
package com.jusfoun.jap.hive.mapper;

import java.util.List;

import com.jusfoun.jap.cube.domain.Cube;
import com.jusfoun.jap.cube.domain.Tag;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.hive.vo.DataSourceTable;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.workTable.domain.CubeDim;
import com.jusfoun.jap.workTable.domain.CubeFact;

public interface SynchronizeDataMapper{
	
}

package com.jusfoun.jap.hive.service;

import java.util.List;

import javax.annotation.Resource;

import org.springframework.stereotype.Service;

import com.jusfoun.jap.hive.domain.KylinTable;
import com.jusfoun.jap.hive.util.HiveUtil;
import com.jusfoun.jap.util.Constant;

@Service
public class HiveDataService {
	
	@Resource
	private HiveService hiveService;
	
	public void synchronizeData(String cubeId) throws Exception{
		List<KylinTable> kylinTableList = hiveService.findKylinTableByCubeId(cubeId);
		if(null != kylinTableList && kylinTableList.size() > 0)
		{
			for(KylinTable kylinTable : kylinTableList)
			{
				HiveUtil.executSql(Constant.HIVE_URL+Constant.HIVE_ANALYSIS_DATABASE,kylinTable.getSyncSql());
			}
		}
	}
}

package com.jusfoun.jap.hive.service;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.github.pagehelper.PageHelper;
import com.itmuch.core.page.PageInfo;
import com.itmuch.core.page.PageVo;
import com.jusfoun.jap.admin.vo.PageInfoVo;
import com.jusfoun.jap.cube.service.CubeService;
import com.jusfoun.jap.cube.util.CubeConstants.SyncStatus;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.hive.domain.HiveTable;
import com.jusfoun.jap.hive.domain.HiveTableColumn;
import com.jusfoun.jap.hive.domain.HiveTableRelation;
import com.jusfoun.jap.hive.domain.KylinTable;
import com.jusfoun.jap.hive.domain.KylinTableColumn;
import com.jusfoun.jap.hive.mapper.HiveMapper;
import com.jusfoun.jap.hive.mapper.HiveTableColumnMapper;
import com.jusfoun.jap.hive.mapper.HiveTableMapper;
import com.jusfoun.jap.hive.mapper.HiveTableRelationMapper;
import com.jusfoun.jap.hive.mapper.KylinTableColumnMapper;
import com.jusfoun.jap.hive.mapper.KylinTableMapper;
import com.jusfoun.jap.hive.util.HiveUtil;
import com.jusfoun.jap.hive.vo.ColumnVo;
import com.jusfoun.jap.hive.vo.DataSourceTable;
import com.jusfoun.jap.hive.vo.DimensionVo;
import com.jusfoun.jap.hive.vo.HiveTableVo;
import com.jusfoun.jap.hive.vo.MeasureVo;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.hive.vo.RelationVo;
import com.jusfoun.jap.kylin.service.KylinService;
import com.jusfoun.jap.util.Constant;
import com.jusfoun.jap.util.hive.JDBCToHiveUtils;

@Service
public class HiveService {
	@Autowired
	private HiveMapper hiveMapperdao;

	@Autowired
	private HiveTableMapper hiveTableMapper;
	
	@Autowired
	private HiveTableColumnMapper hiveTableColumnMapper;
	
	@Autowired
	private HiveTableRelationMapper hiveTableRelationMapper;
	
	@Autowired
	private KylinTableMapper kylinTableMapper;
	
	@Autowired
	private KylinTableColumnMapper kylinTableColumnMapper;
	
	@Autowired
	private KylinService kylinService;
	
	@Autowired
	private CubeService cubeService;
	
	public String insertHiveTable(HiveTable hiveTable){
		hiveTable.setTableId(HiveUtil.getUUID());
		 hiveTableMapper.insertHiveTable(hiveTable);
		 return hiveTable.getTableId();
	}
	
	public String insertTableColumn(HiveTableColumn tableColumn){
		tableColumn.setColumnId(HiveUtil.getUUID());
		hiveTableColumnMapper.insertTableColumn(tableColumn);
		return tableColumn.getTableId();
	}
	
	public String insertHiveTableRelation(HiveTableRelation hiveTableRelation){
		hiveTableRelation.setRelationId(HiveUtil.getUUID());
		hiveTableRelationMapper.insertHiveTableRelation(hiveTableRelation);
		return hiveTableRelation.getRelationId();
	}
	
	public String insertKylinTableColumn(KylinTableColumn kylinTableColumn){
		kylinTableColumn.setColumnId(HiveUtil.getUUID());
		kylinTableColumnMapper.insertKylinTableColumn(kylinTableColumn);
		return kylinTableColumn.getColumnId();
	}
	
	public String insertKylinTable(KylinTable kylinTable){
		kylinTable.setTableId(HiveUtil.getUUID());
		kylinTableMapper.insertKylinTable(kylinTable);
		return kylinTable.getTableId();
		
	}
	
	public List<KylinTable> findKylinTableByCubeId(String cubeId){
		return kylinTableMapper.findKylinTableByCubeId(cubeId);
	}
	
	public List<KylinTableColumn> findHiveTableColumnByTableId(List<String> ids){
		return kylinTableColumnMapper.findHiveTableColumnByTableId(ids);
	}
	
	public List<HiveTable> findHiveTableByTableId(Set<String> ids){
		return hiveTableMapper.findHiveTableByTableId(ids);
	}
	
	public List<HiveTableRelation> findHiveTableRelationByCubeId(String cubeId){
		return hiveTableRelationMapper.findHiveTableRelationByCubeId(cubeId);
	}
	
	public List<RelationVo> findHiveTableRelationVoByCubeId(String cubeId){
		return hiveTableRelationMapper.findHiveTableRelationVoByCubeId(cubeId);
	}
		
	public void creatTableInHive(HiveTableVo vo){
		StringBuffer sb=new StringBuffer("create table ");
		sb.append(vo.getTableName()+" ( ");
		List<ColumnVo> columns=vo.getColumns();
		int size=columns.size();
		for(ColumnVo columnVo:columns){
			if(StringUtils.isNotEmpty(columnVo.getColumnRemarks())){
			sb.append(columnVo.getColumnName()+" "+columnVo.getDataType()+" comment '"+columnVo.getColumnRemarks()+"',");
			}else{
				sb.append(columnVo.getColumnName()+" "+columnVo.getDataType()+",");
			}
		}
		sb=new StringBuffer(sb.substring(0, sb.length()-1));
		if(StringUtils.isNotEmpty(vo.getTableRemarks())){
		sb.append(") comment '"+vo.getTableRemarks()+"'");
		}else{
			sb.append(")");
		}
		Connection conn=JDBCToHiveUtils.getConnnection(Constant.HIVE_URL+Constant.HIVE_ANALYSIS_DATABASE);
		try {
			JDBCToHiveUtils.prepare(conn, sb.toString()).execute();
		} catch (SQLException e) {
			e.printStackTrace();
		}
		System.out.println(sb.toString());
	}
	
	public ModelVo generateModel(ModelVo modelVo){
				Map<String,String> syncDimension=new HashMap<String,String>();
				Map<String,String> syncFactTable=new HashMap<String,String>();
				Set<String> hiveTableIds=new HashSet<String>();
				Map<String,String> tableNameMap=new HashMap<String,String>();
		
				Map<String, Set<HiveTableColumn>> tableMap=new HashMap<String,Set<HiveTableColumn>>();
				//用于kylin建立cube的dto对象
				ModelVo modelForKylin=new ModelVo();
				modelForKylin.setModelName(modelVo.getModelName());
				modelForKylin.setModelDesc(modelVo.getModelDesc());
				
				HiveTableVo factTable=new HiveTableVo();
				//hive定义事实表
				String factTableName="fact_"+HiveUtil.getUUID();
				factTable.setTableRemarks(modelVo.getModelDesc());
				factTable.setTableName(factTableName);
				Map<String,String> columnAndTable=new HashMap<String,String>();
				
			
				//hive定义度量表
				List<MeasureVo> measures=modelVo.getMeasures();
				for(MeasureVo measuer : measures){
					Set<HiveTableColumn> measureSet=tableMap.get(measuer.getTableName());
					if(measureSet==null){
						measureSet = new HashSet<HiveTableColumn>();
					}
					HiveTableColumn htc=new HiveTableColumn();
					htc.setColumnDesc(measuer.getRemarks());
					htc.setColumnName(measuer.getColumnName());
					htc.setDateType(measuer.getDataType());
					measureSet.add(htc);
					tableMap.put(measuer.getTableName(), measureSet);
					
					
					//hive事实表建模
					ColumnVo cv=new ColumnVo();
					cv.setColumnName(measuer.getTableName()+"_"+measuer.getColumnName());
					cv.setDataType(measuer.getDataType());
					cv.setColumnRemarks(measuer.getRemarks());
					cv.setType("2");
					factTable.getColumns().add(cv);
					
					syncFactTable.put(measuer.getTableName()+"_"+measuer.getColumnName(), measuer.getTableName()+"."+measuer.getColumnName());
					
					MeasureVo measuerForKylin =new MeasureVo();
					BeanUtils.copyProperties(measuer, measuerForKylin);
					measuerForKylin.setColumnName(measuer.getTableName()+"_"+measuer.getColumnName());
					measuerForKylin.setTableName(Constant.HIVE_ANALYSIS_DATABASE+"."+factTable.getTableName());
					modelForKylin.getMeasures().add(measuerForKylin);
					
					
					 
					
				}
				
				//hive定义维度表
				List<HiveTableVo> dimensionTables=new ArrayList<HiveTableVo>();
				List<DimensionVo> dimensions=modelVo.getDimensions();
				for(DimensionVo dimension:dimensions){
					Set<HiveTableColumn> dimensionSet=tableMap.get(dimension.getTableName());
					if(dimensionSet==null){
						dimensionSet = new HashSet<HiveTableColumn>();
					}
					HiveTableColumn htc=new HiveTableColumn();
					htc.setColumnDesc(dimension.getRemarks());
					htc.setColumnName(dimension.getColumnName());
					htc.setDateType(dimension.getDataType());
					dimensionSet.add(htc);
					tableMap.put(dimension.getTableName(),dimensionSet);
					//hive事实表建模
					ColumnVo cv=new ColumnVo();
					cv.setType("1");
					cv.setColumnName(dimension.getTableName()+"_"+dimension.getColumnName());
					cv.setDataType(dimension.getDataType());
					cv.setColumnRemarks(dimension.getRemarks());
					factTable.getColumns().add(cv);
					
					syncFactTable.put(dimension.getTableName()+"_"+dimension.getColumnName(),dimension.getTableName()+"."+dimension.getColumnName());
					
					//hive维度表赋值
					HiveTableVo htv=new HiveTableVo();
					String tableName="dim_"+HiveUtil.getUUID();
					htv.setTableName(tableName);
					htv.setTableRemarks(dimension.getRemarks());
					List<ColumnVo> columns=new ArrayList<ColumnVo>();
					ColumnVo column=new ColumnVo();
					column.setType("1");
					column.setColumnName(dimension.getTableName()+"_"+dimension.getColumnName());
					column.setColumnRemarks(dimension.getRemarks());
					column.setDataType(dimension.getDataType());
					columns.add(column);
					htv.setColumns(columns);
					dimensionTables.add(htv);
					//hive创建维度表
					this.creatTableInHive(htv);
					
					//同步数据
					syncDimension.put(tableName, dimension.getTableName()+";"+dimension.getColumnName());
					
					//维度表for kylin
					DimensionVo dimensionForKylin=new DimensionVo();
					BeanUtils.copyProperties(dimension, dimensionForKylin);
					 dimensionForKylin.setTableName(Constant.HIVE_ANALYSIS_DATABASE+"."+tableName);
					 dimensionForKylin.setColumnName(dimension.getTableName()+"_"+dimension.getColumnName());
					 modelForKylin.getDimensions().add(dimensionForKylin);
				}
				
				Set<String> tableSet=tableMap.keySet();

				for(String tableName :tableSet){
					HiveTable hiveTable=new HiveTable();
					hiveTable.setTableName(tableName);
					HiveTableVo htv=HiveUtil.getHiveTableVo(tableName);
					hiveTable.setTableDesc(htv.getTableRemarks());
					//oracle插入hivetable
					String tableId=this.insertHiveTable(hiveTable);
					hiveTableIds.add(tableId);
					tableNameMap.put(tableId, tableName);
					
					Set<HiveTableColumn> columnSet=tableMap.get(tableName);
					for(HiveTableColumn htc :columnSet){
						htc.setTableId(tableId);
						//oracle插入hiveTableColumn
						this.insertTableColumn(htc);
						columnAndTable.put(tableName+"_"+htc.getColumnName(), tableId);
					}
				}
				
				
				//hive生成事实表
				this.creatTableInHive(factTable);
				//给facttable增加数据库名称
				factTable.setTableName(factTable.getTableName());
				HiveTableVo factTableForKylin=new HiveTableVo();
				BeanUtils.copyProperties(factTable, factTableForKylin);
				factTableForKylin.setTableName(Constant.HIVE_ANALYSIS_DATABASE+"."+factTable.getTableName());
				modelForKylin.setFactTable(factTableForKylin);
				
				//kylin生成kylinTable
				//TODO 调用未涛接口
				String cubeId="";
				try {
					cubeId = kylinService.sendKylinRequest(modelForKylin);
				} catch (Exception e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				
				List<RelationVo> relationList=modelVo.getRelations();
				for(RelationVo rv : relationList){
					HiveTableRelation hiveTableRelation=new HiveTableRelation();
					hiveTableRelation.setCubeId(cubeId);
					hiveTableRelation.setLeftColumn(rv.getLeftColumn());
					hiveTableRelation.setLeftTableId(rv.getLeftTableId());
					hiveTableRelation.setRelationType(rv.getRelationType());
					hiveTableRelation.setRightColumn(rv.getRightColumn());
					hiveTableRelation.setRigthTableId(rv.getRigthTableId());
					//oracle插入hiveTableRelation
					this.insertHiveTableRelation(hiveTableRelation);
				}
				//在cubeInfo中插入
				//TODO
				//保存hivetable
				KylinTable kylinTable =new KylinTable();
				kylinTable.setCubeId(cubeId);
				kylinTable.setTableName(factTable.getTableName());
				kylinTable.setTableDesc(factTable.getTableRemarks());
				kylinTable.setTableType("1");
				List<String> columnListSelect=new ArrayList<String>();
				List<String> columnListInsert=new ArrayList<String>();
				for(ColumnVo cv:factTable.getColumns()){
					columnListSelect.add(cv.getColumnName());
					columnListInsert.add(syncFactTable.get(cv.getColumnName()));
				}
				String sync="insert overwrite table "+Constant.HIVE_ANALYSIS_DATABASE+"."+factTable.getTableName()+ " select "
						+StringUtils.join(columnListInsert,",") +" from ";
				List<RelationVo> relations= modelVo.getRelations();
				StringBuffer relationSql = new StringBuffer();
				if(null == relations || relations.size() == 0)
				{
					relationSql.append(measures.get(0).getTableName());
				}
				else
				{
					for(int i=0;i<relations.size();i++)
					{
						RelationVo relationVo = relations.get(i);
						HiveTableRelation htr=new HiveTableRelation();
						if(i==0)
						{
							relationSql.append(Constant.HIVE_SOURCE_DATABASE).append(".").append(relationVo.getLeftTableId()).append(" ");
							relationSql.append(relationVo.getRelationType()).append(" ");
							relationSql.append(Constant.HIVE_SOURCE_DATABASE).append(".").append(relationVo.getRigthTableId()).append(" on ");
							relationSql.append(relationVo.getLeftTableId()).append(".").append(relationVo.getLeftColumn());
							relationSql.append(" = ").append(relationVo.getRigthTableId()).append(".").append(relationVo.getRightColumn());
						}
						else
						{
							relationSql.append(" ").append(relationVo.getRelationType()).append(" ");
							relationSql.append(Constant.HIVE_SOURCE_DATABASE).append(".").append(relationVo.getRigthTableId()).append(" on ");
							relationSql.append(relationVo.getLeftTableId()).append(".").append(relationVo.getLeftColumn());
							relationSql.append(" = ").append(relationVo.getRigthTableId()).append(".").append(relationVo.getRightColumn());
						}
						htr.setCubeId(cubeId);
						htr.setLeftColumn(relations.get(i).getLeftColumn());
						htr.setLeftTableId(relations.get(i).getLeftTableId());
						htr.setRelationType(relations.get(i).getRelationType());
						htr.setRightColumn(relations.get(i).getRightColumn());
						htr.setRigthTableId(relations.get(i).getRigthTableId());
						//保存关联关系
						this.insertHiveTableRelation(htr);
					}
				}
				kylinTable.setSyncSql((sync+relationSql.toString()).toLowerCase());
				String kylinTableId=this.insertKylinTable(kylinTable);

				for(HiveTableVo htv:dimensionTables){
					KylinTable kylinTable_dim =new KylinTable();
					kylinTable_dim.setCubeId(cubeId);
					kylinTable_dim.setTableDesc(htv.getTableRemarks());
					kylinTable_dim.setTableName(htv.getTableName());
					String[] column=syncDimension.get(htv.getTableName()).split(";");
					//同步sql
					String sql="insert overwrite table " + Constant.HIVE_ANALYSIS_DATABASE+"." + 
					htv.getTableName() + " select distinct "+column[1]+" from "+ Constant.HIVE_SOURCE_DATABASE+ "." + column[0];
					kylinTable_dim.setSyncSql(sql.toLowerCase());
					kylinTable_dim.setTableType("2");
					String kylinTableId_dim=this.insertKylinTable(kylinTable_dim);
					
					for(ColumnVo cv:htv.getColumns()){
						KylinTableColumn ktc=new KylinTableColumn();
						ktc.setColumnDesc(cv.getColumnRemarks());
						ktc.setColumnName(cv.getColumnName());
						ktc.setColumnSource(columnAndTable.get(cv.getColumnName()));
						ktc.setDateType(cv.getDataType());
						ktc.setColumnType(cv.getType());
						ktc.setTableId(kylinTableId_dim);
						this.insertKylinTableColumn(ktc);
					}
				}
				
				for(ColumnVo cv:factTable.getColumns()){
					KylinTableColumn ktc=new KylinTableColumn();
					ktc.setColumnDesc(cv.getColumnRemarks());
					ktc.setColumnName(cv.getColumnName());
					ktc.setColumnSource(columnAndTable.get(cv.getColumnName()));
					ktc.setDateType(cv.getDataType());
					ktc.setColumnType(cv.getType());
					ktc.setTableId(kylinTableId);
					//生成kylinTableColumn
					this.insertKylinTableColumn(ktc);
				}
				//TODO
				//绦型步sql后 同步接口
				CubeVo cubeinfo=new CubeVo();
					cubeinfo.setCubeId(cubeId);
					cubeinfo.setCubeName("CUBE_"+modelForKylin.getFactTable().getTableName().replaceAll(Constant.HIVE_ANALYSIS_DATABASE+".", "").toUpperCase());
					cubeinfo.setCubeNameCn(modelForKylin.getModelName());
					cubeinfo.setCubeDescription(modelForKylin.getModelDesc());
					cubeinfo.setCubeDate(new Date());
					cubeinfo.setCubeStatus("0");//默认为隐藏
					cubeinfo.setSyncRule(modelVo.getSyncPolicy());
					cubeinfo.setSyncStatus(new Long(SyncStatus.REDAY_EXEC));
					cubeService.insertCube(cubeinfo);
				//kylinCubeService.buildCube("CUBE_"+modelVo.getFactTable().getTableName().replaceAll("default.", "").toUpperCase());
				
			return modelForKylin;
				
				
	}
	
	public ModelVo myDataModelDetail(String cubeId){

		ModelVo mv=new ModelVo();
		HiveTableVo factTable=new HiveTableVo();
		List<KylinTable> kylinTables=this.findKylinTableByCubeId(cubeId);
		List<String> ids=new ArrayList<String>();
		Set<String> tableIds=new HashSet<String>(); 
		Map<String,String> tableMap=new HashMap<String,String>();
		for(KylinTable kt:kylinTables){
			tableMap.put(kt.getTableId(), kt.getTableName());
			//如果为1 说明是事实表
			if("1".equals(kt.getTableType())){
				ids.add(kt.getTableId());
				factTable.setTableName(kt.getTableName());
				mv.setModelDesc(kt.getTableDesc());
			}
		}
		List<KylinTableColumn> kylinTableColumns=this.findHiveTableColumnByTableId(ids);
		
		for(KylinTableColumn ktc :kylinTableColumns){
			tableIds.add(ktc.getColumnSource());
		}
		List<HiveTable> hiveTables=this.findHiveTableByTableId(tableIds);
		for(HiveTable ht:hiveTables){
			tableMap.put(ht.getTableId(), ht.getTableName());
		}
		
		for(KylinTableColumn ktc :kylinTableColumns){
			//1表示维度
			if("1".equals(ktc.getColumnType())){
				DimensionVo dim=new DimensionVo();
				dim.setColumnName(ktc.getColumnName());
				dim.setDataType(ktc.getDateType());
				dim.setRemarks(ktc.getColumnDesc());
				dim.setTableName(tableMap.get(ktc.getColumnSource()));
				mv.getDimensions().add(dim);
			}else{
				//度量
				MeasureVo mea=new MeasureVo();
				mea.setColumnName(ktc.getColumnName());
				mea.setDataType(ktc.getDateType());
				mea.setComputationRules(ktc.getComputationRules());
				mea.setRemarks(ktc.getColumnDesc());
				mea.setTableName(tableMap.get(ktc.getColumnSource()));
				mv.getMeasures().add(mea);
			}
		}
		//事实表
		mv.setFactTable(factTable);
		//关系
		List<RelationVo> relations=this.findHiveTableRelationVoByCubeId(cubeId);
		for(RelationVo rv:relations){
//			rv.setLeftTableId(tableMap.get(rv.getLeftTableId()));
//			rv.setRigthTableId(tableMap.get(rv.getRigthTableId()));
		}
		mv.setRelations(relations);
		
		return mv;
	
	}

	public PageInfoVo<ModelVo> myDataModel(PageVo pageVo,String modelName, Boolean isShow) {
		String order = pageVo.getOrder();
		order = "rownum";
		PageHelper.startPage(pageVo.getPage(), pageVo.getRows(), order);
		List<ModelVo> list = hiveMapperdao.queryDataModel(modelName,isShow);
		PageInfo<ModelVo> info = new PageInfo<ModelVo>(list);
		PageInfoVo<ModelVo> cubePage = new PageInfoVo<ModelVo>(info.getList(), list);
		return cubePage;
	}
	
	//数据模型新增
	public  List<DataSourceTable> myDataModelAdd() {
		List<DataSourceTable> dataSourceTableList = hiveMapperdao.querydataSourceTable();
		return dataSourceTableList;
	}
	
	public List<DataSourceTable> DataSourceTableSearch(String tableName, List<DataSourceTable> dataSourceTableList) {
		List<DataSourceTable>  selectedTableList = new ArrayList<DataSourceTable>();
		for(DataSourceTable DataSourceTable :dataSourceTableList){
			if(DataSourceTable.getTableName().contains(tableName)){
				selectedTableList.add(DataSourceTable);
			}
		}
		return selectedTableList;
		
	}
	
	

	
}

package com.jusfoun.jap.hive.util;

import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.util.StringUtils;

import com.jusfoun.jap.hive.vo.ColumnVo;
import com.jusfoun.jap.hive.vo.HiveTableVo;
import com.jusfoun.jap.util.Constant;
import com.jusfoun.jap.util.hive.JDBCToHiveUtils;

public class HiveUtil {

	private transient static Logger LOG = LoggerFactory.getLogger(HiveUtil.class);
	
	public static boolean executSql(String url,String sql) throws Exception
	{
		boolean flag = false;
		try {
			Connection conn = JDBCToHiveUtils.getConnnection(url);
			PreparedStatement ps = JDBCToHiveUtils.prepare(conn, sql);
			flag = ps.execute();
		} catch (SQLException e) {
			LOG.error("HiveUtil.executSql url=[" + url + "],sql=["+sql+"]");
			LOG.error(e.getMessage(), e);
			throw e;
		}
		return flag;
	}
	/**
	 * 获得表的comment注释
	 * 
	 * @param tableName
	 * @return
	 * @throws SQLException
	 */
	private static String getTableRemarks(String tableName)  {
		Connection conn = JDBCToHiveUtils.getConnnection(Constant.HIVE_URL+Constant.HIVE_ANALYSIS_DATABASE);
		String remarks = "";
		ResultSet rs=null;
		DatabaseMetaData dmd;
		try {
			dmd = conn.getMetaData();
		
		// String schema = pros.get("user").toString();
		// rs = metaData.getTables(null, schema, null, new
		// String[]{"TABLE","VIEW"});
		 rs = dmd.getTables(null, Constant.HIVE_ANALYSIS_DATABASE, tableName, new String[] { "TABLE" });
		while (rs.next()) {
			remarks = rs.getString("remarks");
		}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally{
			JDBCToHiveUtils.closeConnection(conn, null, rs);
		}
	
		return remarks;
	}

	public static List<ColumnVo> getColumnInfo(String tableName) {
		Connection conn = JDBCToHiveUtils.getConnnection(Constant.HIVE_URL+Constant.HIVE_SOURCE_DATABASE);
		List<ColumnVo> list = new ArrayList<ColumnVo>();
		DatabaseMetaData dmd = null;
		ResultSet rs = null;
		String strJavaBean = "";
		try {
			dmd = conn.getMetaData();
			rs = dmd.getColumns(null, Constant.HIVE_SOURCE_DATABASE, tableName, null);
			Map map = new HashMap();
			while (rs.next()) {
				String columnName = rs.getString("COLUMN_NAME");// 列名
				// String dataType =
				// rs.getString("DATA_TYPE");//字段数据类型(对应java.sql.Types中的常量)
				String typeName = rs.getString("TYPE_NAME");// 字段类型名称(例如：VACHAR2)
				String remarks = rs.getString("REMARKS");// 注释
				ColumnVo columnVo = new ColumnVo();
				columnVo.setColumnName(columnName);
				columnVo.setColumnRemarks(remarks);
				columnVo.setDataType(typeName);
				list.add(columnVo);
			}

		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			JDBCToHiveUtils.closeConnection(conn, null, rs);
		}
		return list;
	}

	public static HiveTableVo getHiveTableVo(String tableName) {
		HiveTableVo hiveTableVo = new HiveTableVo();
		hiveTableVo.setTableName(tableName);
		hiveTableVo.setTableRemarks(getTableRemarks(tableName));
//		hiveTableVo.setColumns(getColumnInfo(tableName));
		return hiveTableVo;
	}

	public static String getUUID() {
		return UUID.randomUUID().toString().replace("-", "");
	}
	
	public static List<HiveTableVo> listHiveTableVoList(String tableName){
		if(StringUtils.isEmpty(tableName)){
			tableName="%";
		}else{
			tableName="%"+tableName+"%";
		}
		List<HiveTableVo> list =new ArrayList<HiveTableVo>();
		Connection conn = JDBCToHiveUtils.getConnnection(Constant.HIVE_URL+Constant.HIVE_SOURCE_DATABASE);
		ResultSet rs=null;
		DatabaseMetaData dmd;
		try {
			dmd = conn.getMetaData();
		
		// String schema = pros.get("user").toString();
		// rs = metaData.getTables(null, schema, null, new
		// String[]{"TABLE","VIEW"});
//		 rs = dmd.getTables(null, "%", tableName, new String[] { "TABLE" });
			rs = dmd.getTables(null, Constant.HIVE_SOURCE_DATABASE, tableName, new String[] { "TABLE" });
		while (rs.next()) {
			HiveTableVo htv=new HiveTableVo();
			String name=rs.getString("table_name");
			String remarks = rs.getString("remarks");
//			System.out.println(rs.getString("table_schem"));
			htv.setTableName(name);
			htv.setTableRemarks(remarks);
//			htv.setColumns(getColumnInfo(tableName));
			list.add(htv);
		}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}finally{
			JDBCToHiveUtils.closeConnection(conn, null, rs);
		}
		return list;
		
	}
}

package com.jusfoun.jap.hive.vo;

import java.io.Serializable;

public class ColumnVo implements Serializable{
	private String columnName;
	
	private String dataType;
	
	private String columnRemarks;
	
	/**
	 * 1维度 2度量
	 */
	private String type;

	public String getColumnName() {
		return columnName;
	}

	public void setColumnName(String columnName) {
		this.columnName = columnName;
	}


	public String getDataType() {
		return dataType;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}

	public String getType() {
		return type;
	}

	public void setType(String type) {
		this.type = type;
	}

	public String getColumnRemarks() {
		return columnRemarks;
	}

	public void setColumnRemarks(String columnRemarks) {
		this.columnRemarks = columnRemarks;
	}
}
package com.jusfoun.jap.hive.vo;

import java.io.Serializable;
import java.util.List;

/*
 * 数据源表和字段信息
 */

public class DataSourceTable implements Serializable{
	private String tableName;
	
	private List<String> columnList;

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public List<String> getColumnList() {
		return columnList;
	}

	public void setColumnList(List<String> columnList) {
		this.columnList = columnList;
	}
}
package com.jusfoun.jap.hive.vo;

import java.io.Serializable;

public class DimensionVo implements Serializable{
	
	private String tableName;//lookups->table;dimensions->table
	
	private String columnName;//lookups->join->primary_key
	
	private String remarks;//dimensions->columns,list就一个
	
	private String dataType;

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public String getColumnName() {
		return columnName;
	}

	public void setColumnName(String columnName) {
		this.columnName = columnName;
	}

	public String getRemarks() {
		return remarks;
	}

	public void setRemarks(String remarks) {
		this.remarks = remarks;
	}

	public String getDataType() {
		return dataType;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}
	
	
	

}

package com.jusfoun.jap.hive.vo;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class HiveTableVo implements Serializable{
	private String tableName;
	
	private String tableRemarks;
	
	private List<ColumnVo> columns=new ArrayList<ColumnVo>();

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public String getTableRemarks() {
		return tableRemarks;
	}

	public void setTableRemarks(String tableRemarks) {
		this.tableRemarks = tableRemarks;
	}

	public List<ColumnVo> getColumns() {
		return columns;
	}

	public void setColumns(List<ColumnVo> columns) {
		this.columns = columns;
	}
	
	public ColumnVo getColumnVo(String columnName){
		Map<String,ColumnVo> map=new HashMap<String,ColumnVo>();
		for(ColumnVo cv:this.columns){
			map.put(cv.getColumnName(), cv);
		}
		return map.get(columnName);
	}
	
	

}


	
	
	
	

package com.jusfoun.jap.hive.vo;

import java.io.Serializable;

public class MeasureVo implements Serializable{

	private String tableName;

	private String columnName;// metrics,从List<MeasureVo>中提取

	private String remarks;

	private String dataType;

	private String computationRules;

	public String getRemarks() {
		return remarks;
	}

	public void setRemarks(String remarks) {
		this.remarks = remarks;
	}

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public String getColumnName() {
		return columnName;
	}

	public void setColumnName(String columnName) {
		this.columnName = columnName;
	}

	public String getDataType() {
		return dataType;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}

	public String getComputationRules() {
		return computationRules;
	}

	public void setComputationRules(String computationRules) {
		this.computationRules = computationRules;
	}

}

package com.jusfoun.jap.hive.vo;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

public class ModelVo implements Serializable {
	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	private String modelName;//name
		
	private String modelDesc; //description
	
	private List<MeasureVo> measures=new ArrayList<MeasureVo>();
	
	private List<DimensionVo> dimensions=new ArrayList<DimensionVo>();
	
	private List<RelationVo> relations=new ArrayList<RelationVo>();
	
	private Long syncPolicy;
	
	private HiveTableVo factTable;

	public String getModelName() {
		return modelName;
	}

	public void setModelName(String modelName) {
		this.modelName = modelName;
	}

	public String getModelDesc() {
		return modelDesc;
	}

	public void setModelDesc(String modelDesc) {
		this.modelDesc = modelDesc;
	}

	public List<MeasureVo> getMeasures() {
		return measures;
	}

	public void setMeasures(List<MeasureVo> measures) {
		this.measures = measures;
	}

	public List<DimensionVo> getDimensions() {
		return dimensions;
	}

	public void setDimensions(List<DimensionVo> dimensions) {
		this.dimensions = dimensions;
	}

	public List<RelationVo> getRelations() {
		return relations;
	}

	public void setRelations(List<RelationVo> relations) {
		this.relations = relations;
	}

	public Long getSyncPolicy() {
		return syncPolicy;
	}

	public void setSyncPolicy(Long syncPolicy) {
		this.syncPolicy = syncPolicy;
	}

	public HiveTableVo getFactTable() {
		return factTable;
	}

	public void setFactTable(HiveTableVo factTable) {
		this.factTable = factTable;
	}
	
	

}

package com.jusfoun.jap.hive.vo;

import java.io.Serializable;

import javax.persistence.Column;

public class RelationVo implements Serializable{
	
	  /**
     * 左表主键
     */
    private String leftTableId;

    /**
     * 关联类型
     */
    private String relationType;

    /**
     * 右表主键
     */
    private String rigthTableId;

    private String leftColumn;

    private String rightColumn;
    
    /**
     * 表示左表是否是主表： y 是 n 不是
     */
    private String primary;

	public String getLeftTableId() {
		return leftTableId;
	}

	public void setLeftTableId(String leftTableId) {
		this.leftTableId = leftTableId;
	}

	public String getRelationType() {
		return relationType;
	}

	public void setRelationType(String relationType) {
		this.relationType = relationType;
	}

	public String getRigthTableId() {
		return rigthTableId;
	}

	public void setRigthTableId(String rigthTableId) {
		this.rigthTableId = rigthTableId;
	}

	public String getLeftColumn() {
		return leftColumn;
	}

	public void setLeftColumn(String leftColumn) {
		this.leftColumn = leftColumn;
	}

	public String getRightColumn() {
		return rightColumn;
	}

	public void setRightColumn(String rightColumn) {
		this.rightColumn = rightColumn;
	}

	public String getPrimary() {
		return primary;
	}

	public void setPrimary(String primary) {
		this.primary = primary;
	}
    
    

}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.jusfoun.jap.kylin.common;

public class DateFormat {

    public static final String COMPACT_DATE_PATTERN = "yyyyMMdd";
    public static final String DEFAULT_DATE_PATTERN = "yyyy-MM-dd";
    public static final String DEFAULT_TIME_PATTERN = "HH:mm:ss";
    public static final String DEFAULT_DATETIME_PATTERN_WITHOUT_MILLISECONDS = "yyyy-MM-dd HH:mm:ss";
    public static final String DEFAULT_DATETIME_PATTERN_WITH_MILLISECONDS = "yyyy-MM-dd HH:mm:ss.SSS";
    public static final String[] SUPPORTED_DATETIME_PATTERN = { //
            DEFAULT_DATE_PATTERN, //
            DEFAULT_DATETIME_PATTERN_WITHOUT_MILLISECONDS, //
            DEFAULT_DATETIME_PATTERN_WITH_MILLISECONDS, //
            COMPACT_DATE_PATTERN };
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.common;

public interface IEngineAware {

    public static final int ID_MR_V1 = 0;
    public static final int ID_MR_V2 = 2;
    public static final int ID_MR_II = 3;
    public static final int ID_SPARK = 5;

    int getEngineType();
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.common;

public interface IStorageAware {

    public static final int ID_HBASE = 0;
    public static final int ID_HYBRID = 1;
    public static final int ID_SHARDED_HBASE = 2;

    int getStorageType();
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.jusfoun.jap.kylin.domain.cube;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonProperty;

public class AggregationGroup {

    @JsonProperty("includes")
    private String[] includes;
    @JsonProperty("select_rule")
    private SelectRule selectRule;

    public String[] getIncludes() {
		return includes;
	}

	public void setIncludes(String[] includes) {
		this.includes = includes;
	}

	public void setSelectRule(SelectRule selectRule) {
        this.selectRule = selectRule;
    }

    public SelectRule getSelectRule() {
        return selectRule;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import java.util.Collections;
import java.util.List;

import com.fasterxml.jackson.annotation.JsonProperty;
import com.jusfoun.jap.kylin.common.IEngineAware;
import com.jusfoun.jap.kylin.common.IStorageAware;

/**
 */
public class CubeDesc {
    @JsonProperty("name")
    private String name;
    @JsonProperty("model_name")
    private String modelName;
    @JsonProperty("description")
    private String description;
    @JsonProperty("dimensions")
    private List<DimensionDesc> dimensions;
    @JsonProperty("measures")
    private List<MeasureDesc> measures;
    @JsonProperty("rowkey")
    private RowKeyDesc rowkey;
    @JsonProperty("aggregation_groups")
    private List<AggregationGroup> aggregationGroups;
    @JsonProperty("hbase_mapping")
    private HBaseMappingDesc hbaseMapping;
    @JsonProperty("notify_list")
    private List<String> notifyList;
    @JsonProperty("status_need_notify")
    private List<String> statusNeedNotify = Collections.emptyList();
    @JsonProperty("partition_date_start")
    private long partitionDateStart = 0L;
    @JsonProperty("auto_merge_time_ranges")
    private long[] autoMergeTimeRanges;
    @JsonProperty("retention_range")
    private long retentionRange = 0;
    @JsonProperty("engine_type")
    private int engineType = IEngineAware.ID_MR_V2;
    @JsonProperty("storage_type")
    private int storageType = IStorageAware.ID_SHARDED_HBASE;
    
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public String getModelName() {
		return modelName;
	}
	public void setModelName(String modelName) {
		this.modelName = modelName;
	}
	public String getDescription() {
		return description;
	}
	public void setDescription(String description) {
		this.description = description;
	}
	public List<DimensionDesc> getDimensions() {
		return dimensions;
	}
	public void setDimensions(List<DimensionDesc> dimensions) {
		this.dimensions = dimensions;
	}
	public List<MeasureDesc> getMeasures() {
		return measures;
	}
	public void setMeasures(List<MeasureDesc> measures) {
		this.measures = measures;
	}
	public RowKeyDesc getRowkey() {
		return rowkey;
	}
	public void setRowkey(RowKeyDesc rowkey) {
		this.rowkey = rowkey;
	}
	public List<AggregationGroup> getAggregationGroups() {
		return aggregationGroups;
	}
	public void setAggregationGroups(List<AggregationGroup> aggregationGroups) {
		this.aggregationGroups = aggregationGroups;
	}
	public HBaseMappingDesc getHbaseMapping() {
		return hbaseMapping;
	}
	public void setHbaseMapping(HBaseMappingDesc hbaseMapping) {
		this.hbaseMapping = hbaseMapping;
	}
	public List<String> getNotifyList() {
		return notifyList;
	}
	public void setNotifyList(List<String> notifyList) {
		this.notifyList = notifyList;
	}
	public List<String> getStatusNeedNotify() {
		return statusNeedNotify;
	}
	public void setStatusNeedNotify(List<String> statusNeedNotify) {
		this.statusNeedNotify = statusNeedNotify;
	}
	public long getPartitionDateStart() {
		return partitionDateStart;
	}
	public void setPartitionDateStart(long partitionDateStart) {
		this.partitionDateStart = partitionDateStart;
	}
	public long[] getAutoMergeTimeRanges() {
		return autoMergeTimeRanges;
	}
	public void setAutoMergeTimeRanges(long[] autoMergeTimeRanges) {
		this.autoMergeTimeRanges = autoMergeTimeRanges;
	}
	public long getRetentionRange() {
		return retentionRange;
	}
	public void setRetentionRange(long retentionRange) {
		this.retentionRange = retentionRange;
	}
	public int getEngineType() {
		return engineType;
	}
	public void setEngineType(int engineType) {
		this.engineType = engineType;
	}
	public int getStorageType() {
		return storageType;
	}
	public void setStorageType(int storageType) {
		this.storageType = storageType;
	}
    
    
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

public class CubeRequest {

    private String uuid;
    private String cubeName;
    private String cubeDescData;
    private String streamingData;
    private String kafkaData;
    private boolean successful;
    private String message;
    private String project;
    private String streamingCube;

    public String getUuid() {
        return uuid;
    }

    public void setUuid(String uuid) {
        this.uuid = uuid;
    }

    /**
     * @return the message
     */
    public String getMessage() {
        return message;
    }

    /**
     * @param message
     *            the message to set
     */
    public void setMessage(String message) {
        this.message = message;
    }

    /**
     * @return the status
     */
    public boolean getSuccessful() {
        return successful;
    }

    /**
     * @param status
     *            the status to set
     */
    public void setSuccessful(boolean status) {
        this.successful = status;
    }

    public CubeRequest() {
    }

    public String getCubeDescData() {
        return cubeDescData;
    }

    public void setCubeDescData(String cubeDescData) {
        this.cubeDescData = cubeDescData;
    }

    /**
     * @return the cubeDescName
     */
    public String getCubeName() {
        return cubeName;
    }

    /**
     * @param cubeName
     *            the cubeDescName to set
     */
    public void setCubeName(String cubeName) {
        this.cubeName = cubeName;
    }

    public String getProject() {
        return project;
    }

    public void setProject(String project) {
        this.project = project;
    }

    public String getStreamingCube() {
        return streamingCube;
    }

    public void setStreamingCube(String streamingCube) {
        this.streamingCube = streamingCube;
    }

    public String getStreamingData() {
        return streamingData;
    }

    public void setStreamingData(String streamingData) {
        this.streamingData = streamingData;
    }

    public String getKafkaData() {
        return kafkaData;
    }

    public void setKafkaData(String kafkaData) {
        this.kafkaData = kafkaData;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class DimensionDesc {

    @JsonProperty("name")
    private String name;
    @JsonProperty("table")
    private String table;
    @JsonProperty("column")
    private String column;
    @JsonProperty("derived")
    private String[] derived;
    
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public String getTable() {
		return table;
	}
	public void setTable(String table) {
		this.table = table;
	}
	public String getColumn() {
		return column;
	}
	public void setColumn(String column) {
		this.column = column;
	}
	public String[] getDerived() {
		return derived;
	}
	public void setDerived(String[] derived) {
		this.derived = derived;
	}
    
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import java.util.Set;

import com.fasterxml.jackson.annotation.JsonProperty;
import com.google.common.collect.Sets;

/**
 */
public class FunctionDesc {

    public static final String FUNC_SUM = "SUM";
    public static final String FUNC_MIN = "MIN";
    public static final String FUNC_MAX = "MAX";
    public static final String FUNC_COUNT = "COUNT";
    public static final String FUNC_COUNT_DISTINCT = "COUNT_DISTINCT";
    public static final Set<String> BUILT_IN_AGGREGATIONS = Sets.newHashSet();

    static {
        BUILT_IN_AGGREGATIONS.add(FUNC_COUNT);
        BUILT_IN_AGGREGATIONS.add(FUNC_MAX);
        BUILT_IN_AGGREGATIONS.add(FUNC_MIN);
        BUILT_IN_AGGREGATIONS.add(FUNC_SUM);
        BUILT_IN_AGGREGATIONS.add(FUNC_COUNT_DISTINCT);
    }

    public static final String PARAMETER_TYPE_CONSTANT = "constant";
    public static final String PARAMETER_TYPE_COLUMN = "column";

    @JsonProperty("expression")
    private String expression;
    @JsonProperty("parameter")
    private ParameterDesc parameter;
    @JsonProperty("returntype")
    private String returnType;
    public boolean isMin() {
        return FUNC_MIN.equalsIgnoreCase(expression);
    }

    public boolean isMax() {
        return FUNC_MAX.equalsIgnoreCase(expression);
    }

    public boolean isSum() {
        return FUNC_SUM.equalsIgnoreCase(expression);
    }

    public boolean isCount() {
        return FUNC_COUNT.equalsIgnoreCase(expression);
    }

    public boolean isCountDistinct() {
        return FUNC_COUNT_DISTINCT.equalsIgnoreCase(expression);
    }

    public String getExpression() {
        return expression;
    }

    public void setExpression(String expression) {
        this.expression = expression;
    }

    public ParameterDesc getParameter() {
        return parameter;
    }

    public void setParameter(ParameterDesc parameter) {
        this.parameter = parameter;
    }

    public int getParameterCount() {
        int count = 0;
        for (ParameterDesc p = parameter; p != null; p = p.getNextParameter()) {
            count++;
        }
        return count;
    }
    
    public void setReturnType(String returnType) {
        this.returnType = returnType;
    }
    
    public String getReturnType() {
        return returnType;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class HBaseColumnDesc {

    @JsonProperty("qualifier")
    private String qualifier;
    @JsonProperty("measure_refs")
    private List<String> measureRefs;

    public String getQualifier() {
        return qualifier;
    }

    public void setQualifier(String qualifier) {
        this.qualifier = qualifier;
    }

    public List<String> getMeasureRefs() {
        return measureRefs;
    }

    public void setMeasureRefs(List<String> measureRefs) {
        this.measureRefs = measureRefs;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class HBaseColumnFamilyDesc {

    @JsonProperty("name")
    private String name;
    @JsonProperty("columns")
    private HBaseColumnDesc[] columns;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public HBaseColumnDesc[] getColumns() {
        return columns;
    }

    public void setColumns(HBaseColumnDesc[] columns) {
        this.columns = columns;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class HBaseMappingDesc {

	@JsonProperty("column_family")
    private HBaseColumnFamilyDesc[] columnFamily;

	public HBaseColumnFamilyDesc[] getColumnFamily() {
		return columnFamily;
	}

	public void setColumnFamily(HBaseColumnFamilyDesc[] columnFamily) {
		this.columnFamily = columnFamily;
	}

}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */

public class MeasureDesc {

    @JsonProperty("name")
    private String name;
    @JsonProperty("function")
    private FunctionDesc function;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public FunctionDesc getFunction() {
        return function;
    }

    public void setFunction(FunctionDesc function) {
        this.function = function;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import java.io.UnsupportedEncodingException;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class ParameterDesc {

    @JsonProperty("type")
    private String type;
    @JsonProperty("value")
    private String value;

    @JsonProperty("next_parameter")
    private ParameterDesc nextParameter;

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }

    public byte[] getBytes() throws UnsupportedEncodingException {
        return value.getBytes("UTF-8");
    }

    public String getValue() {
        return value;
    }

    public void setValue(String value) {
        this.value = value;
    }

    public ParameterDesc getNextParameter() {
        return nextParameter;
    }

    public void setNextParameter(ParameterDesc nextParameter) {
        this.nextParameter = nextParameter;
    }

    public boolean isColumnType() {
        return FunctionDesc.PARAMETER_TYPE_COLUMN.equals(type);
    }

    @Override
    public boolean equals(Object o) {
        if (this == o)
            return true;
        if (o == null || getClass() != o.getClass())
            return false;

        ParameterDesc that = (ParameterDesc) o;

        if (nextParameter != null ? !nextParameter.equals(that.nextParameter) : that.nextParameter != null)
            return false;
        if (type != null ? !type.equals(that.type) : that.type != null)
            return false;
        if (value != null ? !value.equals(that.value) : that.value != null)
            return false;

        return true;
    }

    @Override
    public int hashCode() {
        int result = type != null ? type.hashCode() : 0;
        result = 31 * result + (value != null ? value.hashCode() : 0);
        result = 31 * result + (nextParameter != null ? nextParameter.hashCode() : 0);
        return result;
    }

    @Override
    public String toString() {
        return "ParameterDesc [type=" + type + ", value=" + value + ", nextParam=" + nextParameter + "]";
    }

}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonProperty;

/**
 * @author yangli9
 * 
 */
public class RowKeyColDesc {

    @JsonProperty("column")
    private String column;
    @JsonProperty("encoding")
    private String encoding;
    @JsonProperty("isShardBy")
    private boolean isShardBy;//usually it is ultra high cardinality column, shard by such column can reduce the agg cache for each shard
    @JsonProperty("index")
    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String index;

    public String getEncoding() {
        return encoding;
    }

    public void setEncoding(String encoding) {
        this.encoding = encoding;
    }

    public String getColumn() {
        return column;
    }

    public void setColumn(String column) {
        this.column = column;
    }

    public boolean isShardBy() {
        return isShardBy;
    }

    public void setShardBy(boolean shardBy) {
        isShardBy = shardBy;
    }

    public String getIndex() {
        return index;
    }

    public void setIndex(String index) {
        this.index = index;
    }
}
/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class RowKeyDesc {

    @JsonProperty("rowkey_columns")
    private RowKeyColDesc[] rowkeyColumns;

	public RowKeyColDesc[] getRowkeyColumns() {
		return rowkeyColumns;
	}

	public void setRowkeyColumns(RowKeyColDesc[] rowkeyColumns) {
		this.rowkeyColumns = rowkeyColumns;
	}
    
    

}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.jusfoun.jap.kylin.domain.cube;

import com.fasterxml.jackson.annotation.JsonProperty;

public class SelectRule {
	@JsonProperty("hierarchy_dims")
    public String[][] hierarchy_dims;
    @JsonProperty("mandatory_dims")
    public String[] mandatory_dims;
    @JsonProperty("joint_dims")
    public String[][] joint_dims;
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

/**
 * @author xduo
 * 
 */
public enum CubeBuildTypeEnum {
    /**
     * rebuild a segment or incremental build
     */
    BUILD,
    /**
     * merge segments
     */
    MERGE,

    /**
     * refresh segments
     */
    REFRESH
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

import java.util.Collection;
import java.util.List;
import java.util.concurrent.ConcurrentHashMap;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.JsonAutoDetect.Visibility;
import com.fasterxml.jackson.annotation.JsonBackReference;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import com.fasterxml.jackson.annotation.JsonManagedReference;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.google.common.collect.Lists;

@SuppressWarnings("serial")
@JsonAutoDetect(fieldVisibility = Visibility.NONE, getterVisibility = Visibility.NONE, isGetterVisibility = Visibility.NONE, setterVisibility = Visibility.NONE)
public class JobInstance{

    public static final String YARN_APP_URL = "yarn_application_tracking_url";
    public static final String MR_JOB_ID = "mr_job_id";

    @JsonProperty("name")
    private String name;

    @JsonProperty("type")
    private CubeBuildTypeEnum type; // java implementation
    @JsonProperty("duration")
    private long duration;
    @JsonProperty("related_cube")
    private String relatedCube;
    @JsonProperty("related_segment")
    private String relatedSegment;
    @JsonProperty("exec_start_time")
    private long execStartTime;
    @JsonProperty("exec_end_time")
    private long execEndTime;
    @JsonProperty("mr_waiting")
    private long mrWaiting = 0;
    @JsonManagedReference
    @JsonProperty("steps")
    private List<JobStep> steps;
    @JsonProperty("submitter")
    private String submitter;
    @JsonProperty("job_status")
    private JobStatusEnum status;

    public JobStep getRunningStep() {
        for (JobStep step : this.getSteps()) {
            if (step.getStatus().equals(JobStepStatusEnum.RUNNING) || step.getStatus().equals(JobStepStatusEnum.WAITING)) {
                return step;
            }
        }

        return null;
    }

    @JsonProperty("progress")
    public double getProgress() {
        int completedStepCount = 0;
        for (JobStep step : this.getSteps()) {
            if (step.getStatus().equals(JobStepStatusEnum.FINISHED)) {
                completedStepCount++;
            }
        }

        return 100.0 * completedStepCount / steps.size();
    }

    public JobStatusEnum getStatus() {
        return this.status;
    }

    public void setStatus(JobStatusEnum status) {
        this.status = status;
    }

    //    @JsonProperty("job_status")
    //    public JobStatusEnum getStatus() {
    //
    //        // JobStatusEnum finalJobStatus;
    //        int compositResult = 0;
    //
    //        // if steps status are all NEW, then job status is NEW
    //        // if steps status are all FINISHED, then job status is FINISHED
    //        // if steps status are all PENDING, then job status is PENDING
    //        // if steps status are FINISHED and PENDING, the job status is PENDING
    //        // if one of steps status is RUNNING, then job status is RUNNING
    //        // if one of steps status is ERROR, then job status is ERROR
    //        // if one of steps status is KILLED, then job status is KILLED
    //        // default status is RUNNING
    //
    //        System.out.println(this.getName());
    //
    //        for (JobStep step : this.getSteps()) {
    //            //System.out.println("step: " + step.getSequenceID() + "'s status:" + step.getStatus());
    //            compositResult = compositResult | step.getStatus().getCode();
    //        }
    //
    //        System.out.println();
    //
    //        if (compositResult == JobStatusEnum.FINISHED.getCode()) {
    //            return JobStatusEnum.FINISHED;
    //        } else if (compositResult == JobStatusEnum.NEW.getCode()) {
    //            return JobStatusEnum.NEW;
    //        } else if (compositResult == JobStatusEnum.PENDING.getCode()) {
    //            return JobStatusEnum.PENDING;
    //        } else if (compositResult == (JobStatusEnum.FINISHED.getCode() | JobStatusEnum.PENDING.getCode())) {
    //            return JobStatusEnum.PENDING;
    //        } else if ((compositResult & JobStatusEnum.ERROR.getCode()) == JobStatusEnum.ERROR.getCode()) {
    //            return JobStatusEnum.ERROR;
    //        } else if ((compositResult & JobStatusEnum.DISCARDED.getCode()) == JobStatusEnum.DISCARDED.getCode()) {
    //            return JobStatusEnum.DISCARDED;
    //        } else if ((compositResult & JobStatusEnum.RUNNING.getCode()) == JobStatusEnum.RUNNING.getCode()) {
    //            return JobStatusEnum.RUNNING;
    //        }
    //
    //        return JobStatusEnum.RUNNING;
    //    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public CubeBuildTypeEnum getType() {
        return type;
    }

    public void setType(CubeBuildTypeEnum type) {
        this.type = type;
    }

    public long getDuration() {
        return duration;
    }

    public void setDuration(long duration) {
        this.duration = duration;
    }

    public String getRelatedCube() {
        return relatedCube;
    }

    public void setRelatedCube(String relatedCube) {
        this.relatedCube = relatedCube;
    }

    public String getRelatedSegment() {
        return relatedSegment;
    }

    public void setRelatedSegment(String relatedSegment) {
        this.relatedSegment = relatedSegment;
    }

    /**
     * @return the execStartTime
     */
    public long getExecStartTime() {
        return execStartTime;
    }

    /**
     * @param execStartTime the execStartTime to set
     */
    public void setExecStartTime(long execStartTime) {
        this.execStartTime = execStartTime;
    }

    /**
     * @return the execEndTime
     */
    public long getExecEndTime() {
        return execEndTime;
    }

    /**
     * @param execEndTime the execEndTime to set
     */
    public void setExecEndTime(long execEndTime) {
        this.execEndTime = execEndTime;
    }

    public long getMrWaiting() {
        return this.mrWaiting;
    }

    public void setMrWaiting(long mrWaiting) {
        this.mrWaiting = mrWaiting;
    }

    public List<JobStep> getSteps() {
        if (steps == null) {
            steps = Lists.newArrayList();
        }
        return steps;
    }

    public void clearSteps() {
        getSteps().clear();
    }

    public void addSteps(Collection<JobStep> steps) {
        this.getSteps().addAll(steps);
    }

    public void addStep(JobStep step) {
        getSteps().add(step);
    }

    public void addStep(int index, JobStep step) {
        getSteps().add(index, step);
    }

    public JobStep findStep(String stepName) {
        for (JobStep step : getSteps()) {
            if (stepName.equals(step.getName())) {
                return step;
            }
        }
        return null;
    }

    public String getSubmitter() {
        return submitter;
    }

    public void setSubmitter(String submitter) {
        this.submitter = submitter;
    }

    @JsonIgnoreProperties(ignoreUnknown = true)
    public static class JobStep implements Comparable<JobStep> {

        @JsonBackReference
        private JobInstance jobInstance;

        @JsonProperty("id")
        private String id;

        @JsonProperty("name")
        private String name;

        @JsonProperty("sequence_id")
        private int sequenceID;

        @JsonProperty("exec_cmd")
        private String execCmd;

        @JsonProperty("interrupt_cmd")
        private String InterruptCmd;

        @JsonProperty("exec_start_time")
        private long execStartTime;
        @JsonProperty("exec_end_time")
        private long execEndTime;
        @JsonProperty("exec_wait_time")
        private long execWaitTime;

        @JsonProperty("step_status")
        private JobStepStatusEnum status;

        @JsonProperty("cmd_type")
        private JobStepCmdTypeEnum cmdType = JobStepCmdTypeEnum.SHELL_CMD_HADOOP;

        @JsonProperty("info")
        private ConcurrentHashMap<String, String> info = new ConcurrentHashMap<String, String>();

        @JsonProperty("run_async")
        private boolean runAsync = false;

        private ConcurrentHashMap<String, String> getInfo() {
            return info;
        }

        public void putInfo(String key, String value) {
            getInfo().put(key, value);
        }

        public String getInfo(String key) {
            return getInfo().get(key);
        }

        public void clearInfo() {
            getInfo().clear();
        }

        public String getName() {
            return name;
        }

        public void setName(String name) {
            this.name = name;
        }

        public int getSequenceID() {
            return sequenceID;
        }

        public void setSequenceID(int sequenceID) {
            this.sequenceID = sequenceID;
        }

        public String getExecCmd() {
            return execCmd;
        }

        public void setExecCmd(String execCmd) {
            this.execCmd = execCmd;
        }

        public JobStepStatusEnum getStatus() {
            return status;
        }

        public void setStatus(JobStepStatusEnum status) {
            this.status = status;
        }

        public String getId() {
            return id;
        }

        public void setId(String id) {
            this.id = id;
        }

        /**
         * @return the execStartTime
         */
        public long getExecStartTime() {
            return execStartTime;
        }

        /**
         * @param execStartTime the execStartTime to set
         */
        public void setExecStartTime(long execStartTime) {
            this.execStartTime = execStartTime;
        }

        /**
         * @return the execEndTime
         */
        public long getExecEndTime() {
            return execEndTime;
        }

        /**
         * @param execEndTime the execEndTime to set
         */
        public void setExecEndTime(long execEndTime) {
            this.execEndTime = execEndTime;
        }

        public long getExecWaitTime() {
            return execWaitTime;
        }

        public void setExecWaitTime(long execWaitTime) {
            this.execWaitTime = execWaitTime;
        }

        public String getInterruptCmd() {
            return InterruptCmd;
        }

        public void setInterruptCmd(String interruptCmd) {
            InterruptCmd = interruptCmd;
        }

        public JobStepCmdTypeEnum getCmdType() {
            return cmdType;
        }

        public void setCmdType(JobStepCmdTypeEnum cmdType) {
            this.cmdType = cmdType;
        }

        /**
         * @return the runAsync
         */
        public boolean isRunAsync() {
            return runAsync;
        }

        /**
         * @param runAsync the runAsync to set
         */
        public void setRunAsync(boolean runAsync) {
            this.runAsync = runAsync;
        }

        /**
         * @return the jobInstance
         */
        public JobInstance getJobInstance() {
            return jobInstance;
        }

        @Override
        public int hashCode() {
            final int prime = 31;
            int result = 1;
            result = prime * result + ((name == null) ? 0 : name.hashCode());
            result = prime * result + sequenceID;
            return result;
        }

        @Override
        public boolean equals(Object obj) {
            if (this == obj)
                return true;
            if (obj == null)
                return false;
            if (getClass() != obj.getClass())
                return false;
            JobStep other = (JobStep) obj;
            if (name == null) {
                if (other.name != null)
                    return false;
            } else if (!name.equals(other.name))
                return false;
            if (sequenceID != other.sequenceID)
                return false;
            return true;
        }

        @Override
        public int compareTo(JobStep o) {
            if (this.sequenceID < o.sequenceID) {
                return -1;
            } else if (this.sequenceID > o.sequenceID) {
                return 1;
            } else {
                return 0;
            }
        }
    }


}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

import java.util.List;

/**
 * @author xduo
 * 
 */
public class JobListRequest {

    private List<Integer> status;
    private String cubeName;
    private String projectName;
    private Integer offset;
    private Integer limit;
    private Integer timeFilter;

    public JobListRequest() {
    }

    public List<Integer> getStatus() {
        return status;
    }

    public void setStatus(List<Integer> status) {
        this.status = status;
    }

    public String getCubeName() {
        return cubeName;
    }

    public void setCubeName(String cubeName) {
        this.cubeName = cubeName;
    }

    public String getProjectName() {
        return projectName;
    }

    public void setProjectName(String projectName) {
        this.projectName = projectName;
    }

    public Integer getOffset() {
        return offset;
    }

    public void setOffset(Integer offset) {
        this.offset = offset;
    }

    public Integer getLimit() {
        return limit;
    }

    public void setLimit(Integer limit) {
        this.limit = limit;
    }

    public Integer getTimeFilter() {
        return timeFilter;
    }

    public void setTimeFilter(Integer timeFilter) {
        this.timeFilter = timeFilter;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

public enum JobStatusEnum {

    NEW(0), PENDING(1), RUNNING(2), FINISHED(4), ERROR(8), DISCARDED(16);

    private final int code;

    private JobStatusEnum(int statusCode) {
        this.code = statusCode;
    }

    public static JobStatusEnum getByCode(int statusCode) {
        for (JobStatusEnum status : values()) {
            if (status.getCode() == statusCode) {
                return status;
            }
        }

        return null;
    }

    public int getCode() {
        return this.code;
    }

    public boolean isComplete() {
        return code == JobStatusEnum.FINISHED.getCode() || code == JobStatusEnum.ERROR.getCode() || code == JobStatusEnum.DISCARDED.getCode();
    }

}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

/**
 * @author xduo, ysong1
 * 
 */
public enum JobStepCmdTypeEnum {
    SHELL_CMD, SHELL_CMD_HADOOP, JAVA_CMD_HADOOP_FACTDISTINCT, JAVA_CMD_HADOOP_BASECUBOID, JAVA_CMD_HADOOP_NDCUBOID, JAVA_CMD_HADOOP_RANGEKEYDISTRIBUTION, JAVA_CMD_HADOOP_CONVERTHFILE, JAVA_CMD_HADOOP_MERGECUBOID, JAVA_CMD_HADOOP_NO_MR_DICTIONARY, JAVA_CMD_HADDOP_NO_MR_CREATEHTABLE, JAVA_CMD_HADOOP_NO_MR_BULKLOAD
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

public enum JobStepStatusEnum {
    NEW(0), PENDING(1), RUNNING(2), FINISHED(4), ERROR(8), DISCARDED(16), WAITING(32), KILLED(64);

    private final int code;

    private JobStepStatusEnum(int statusCode) {
        this.code = statusCode;
    }

    public static JobStepStatusEnum getByCode(int statusCode) {
        for (JobStepStatusEnum status : values()) {
            if (status.getCode() == statusCode) {
                return status;
            }
        }

        return null;
    }

    public int getCode() {
        return this.code;
    }

    public boolean isComplete() {
        return code == JobStepStatusEnum.FINISHED.getCode() || code == JobStepStatusEnum.ERROR.getCode() || code == JobStepStatusEnum.DISCARDED.getCode();
    }

    public boolean isRunable() {
        return code == JobStepStatusEnum.PENDING.getCode() || code == JobStepStatusEnum.ERROR.getCode();
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.job;

public enum JobTimeFilterEnum {
    LAST_ONE_DAY(0), LAST_ONE_WEEK(1), LAST_ONE_MONTH(2), LAST_ONE_YEAR(3), ALL(4);

    private final int code;

    private JobTimeFilterEnum(int code) {
        this.code = code;
    }

    public static JobTimeFilterEnum getByCode(int code) {
        for (JobTimeFilterEnum timeFilter : values()) {
            if (timeFilter.getCode() == code) {
                return timeFilter;
            }
        }

        return null;
    }

    public int getCode() {
        return code;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.model;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonProperty;

public class DataModelDesc{
    public static enum RealizationCapacity {
        SMALL, MEDIUM, LARGE
    }
    
    @JsonProperty("name")
    private String name;

    @JsonProperty("description")
    private String description;

    @JsonProperty("fact_table")
    private String factTable;

    @JsonProperty("lookups")
    private List<LookupDesc> lookups;

    @JsonProperty("dimensions")
    private List<ModelDimensionDesc> dimensions;

    @JsonProperty("metrics")
    private String[] metrics;

    @JsonProperty("filter_condition")
    private String filterCondition;

    @JsonProperty("partition_desc")
    PartitionDesc partitionDesc; 
    
    @JsonProperty("last_modified")
    long lastModified;

	@JsonProperty("capacity")
    private RealizationCapacity capacity = RealizationCapacity.MEDIUM;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

    public String getDescription() {
        return description;
    }

    public void setDescription(String description) {
        this.description = description;
    }

    public String getFactTable() {
        return factTable;
    }

    public void setFactTable(String factTable) {
        this.factTable = factTable.toUpperCase();
    }

    public List<LookupDesc> getLookups() {
        return lookups;
    }

    public void setLookups(List<LookupDesc> lookups) {
        this.lookups = lookups;
    }

    public String getFilterCondition() {
        return filterCondition;
    }

    public void setFilterCondition(String filterCondition) {
        this.filterCondition = filterCondition;
    }

    public PartitionDesc getPartitionDesc() {
        return partitionDesc;
    }

    public void setPartitionDesc(PartitionDesc partitionDesc) {
        this.partitionDesc = partitionDesc;
    }

    public RealizationCapacity getCapacity() {
        return capacity;
    }

    public void setCapacity(RealizationCapacity capacity) {
        this.capacity = capacity;
    }

    public List<ModelDimensionDesc> getDimensions() {
        return dimensions;
    }

    public String[] getMetrics() {
        return metrics;
    }

    public void setDimensions(List<ModelDimensionDesc> dimensions) {
        this.dimensions = dimensions;
    }

    public void setMetrics(String[] metrics) {
        this.metrics = metrics;
    }

	public long getLastModified() {
		return lastModified;
	}

	public void setLastModified(long lastModified) {
		this.lastModified = lastModified;
	}
    
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.model;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class JoinDesc {

    @JsonProperty("type")
    private String type;
    @JsonProperty("primary_key")
    private List<String> primaryKey;
    @JsonProperty("foreign_key")
    private List<String> foreignKey;

    public String getType() {
        return type;
    }

    public void setType(String type) {
        this.type = type;
    }

    public List<String> getPrimaryKey() {
        return primaryKey;
    }

    public void setPrimaryKey(List<String> primaryKey) {
        this.primaryKey = primaryKey;
    }

    public List<String> getForeignKey() {
        return foreignKey;
    }

    public void setForeignKey(List<String> foreignKey) {
        this.foreignKey = foreignKey;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.model;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.JsonAutoDetect.Visibility;
import com.fasterxml.jackson.annotation.JsonProperty;

@JsonAutoDetect(fieldVisibility = Visibility.NONE, getterVisibility = Visibility.NONE, isGetterVisibility = Visibility.NONE, setterVisibility = Visibility.NONE)
public class LookupDesc {

    @JsonProperty("table")
    private String table;

    @JsonProperty("join")
    private JoinDesc join;
    
    public String getTable() {
        return table;
    }

    public void setTable(String table) {
        this.table = table;
    }

    public JoinDesc getJoin() {
        return join;
    }

    public void setJoin(JoinDesc join) {
        this.join = join;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.model;

import java.util.List;

import com.fasterxml.jackson.annotation.JsonProperty;

/**
 */
public class ModelDimensionDesc {
    @JsonProperty("table")
    private String table;
    @JsonProperty("columns")
    private List<String> columns;

    public String getTable() {
        return table;
    }

    public void setTable(String table) {
        this.table = table;
    }

    public List<String> getColumns() {
        return columns;
    }

    public void setColumns(List<String> columns) {
        this.columns = columns;
    }
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.model;

public class ModelRequest {

    private String uuid;
    private String modelName;
    private String modelDescData;
    private boolean successful;
    private String message;
    private String project;

    public String getUuid() {
        return uuid;
    }

    public void setUuid(String uuid) {
        this.uuid = uuid;
    }

    /**
     * @return the message
     */
    public String getMessage() {
        return message;
    }

    /**
     * @param message
     *            the message to set
     */
    public void setMessage(String message) {
        this.message = message;
    }

    /**
     * @return the status
     */
    public boolean getSuccessful() {
        return successful;
    }

    /**
     * @param status
     *            the status to set
     */
    public void setSuccessful(boolean status) {
        this.successful = status;
    }

    public ModelRequest() {
    }

    public String getModelDescData() {
        return modelDescData;
    }

    public void setModelDescData(String modelDescData) {
        this.modelDescData = modelDescData;
    }

    /**
     * @return the modelName
     */
    public String getModelName() {
        return modelName;
    }

    /**
     * @param modelName
     *            the cubeName to set
     */
    public void setModelName(String modelName) {
        this.modelName = modelName;
    }

    public String getProject() {
        return project;
    }

    public void setProject(String project) {
        this.project = project;
    }

}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.domain.model;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.JsonAutoDetect.Visibility;
import com.fasterxml.jackson.annotation.JsonProperty;
import com.jusfoun.jap.kylin.common.*;

/**
 * @author xduo
 * 
 */
@JsonAutoDetect(fieldVisibility = Visibility.NONE, getterVisibility = Visibility.NONE, isGetterVisibility = Visibility.NONE, setterVisibility = Visibility.NONE)
public class PartitionDesc {

    public static enum PartitionType {
        APPEND, //
        UPDATE_INSERT // not used since 0.7.1
    }

    @JsonProperty("partition_date_column")
    private String partitionDateColumn;

    @JsonProperty("partition_time_column")
    private String partitionTimeColumn;

    @JsonProperty("partition_date_start")
//  private long partitionDateStart = 0L;//Deprecated
    private String partitionDateStart;

    @JsonProperty("partition_date_format")
    private String partitionDateFormat = DateFormat.DEFAULT_DATE_PATTERN;

    @JsonProperty("partition_time_format")
    private String partitionTimeFormat = DateFormat.DEFAULT_TIME_PATTERN;

    @JsonProperty("partition_type")
    private PartitionType partitionType = PartitionType.APPEND;
    
    @JsonProperty("partition_time_start")
//  private long partitionTimeStart = 0L;//Deprecated
    private String partitionTimeStart;

    public String getPartitionDateColumn() {
        return partitionDateColumn;
    }

    public void setPartitionDateColumn(String partitionDateColumn) {
        this.partitionDateColumn = partitionDateColumn;
    }

    public String getPartitionTimeColumn() {
        return partitionTimeColumn;
    }

    public void setPartitionTimeColumn(String partitionTimeColumn) {
        this.partitionTimeColumn = partitionTimeColumn;
    }

//    @Deprecated
    public String getPartitionDateStart() {
        return partitionDateStart;
    }

//    @Deprecated
    public void setPartitionDateStart(String partitionDateStart) {
        this.partitionDateStart = partitionDateStart;
    }
    
	//  @Deprecated
	  public String getPartitionTimeStart() {
	      return partitionTimeStart;
	  }
	
	//  @Deprecated
	  public void setPartitionTimeStart(String partitionTimeStart) {
	      this.partitionTimeStart = partitionTimeStart;
	  }

    public String getPartitionDateFormat() {
        return partitionDateFormat;
    }

    public void setPartitionDateFormat(String partitionDateFormat) {
        this.partitionDateFormat = partitionDateFormat;
    }

    public String getPartitionTimeFormat() {
        return partitionTimeFormat;
    }

    public void setPartitionTimeFormat(String partitionTimeFormat) {
        this.partitionTimeFormat = partitionTimeFormat;
    }

    public PartitionType getPartitionType() {
        return partitionType;
    }

    public void setPartitionType(PartitionType partitionType) {
        this.partitionType = partitionType;
    }
//
//    public IPartitionConditionBuilder getPartitionConditionBuilder() {
//        return partitionConditionBuilder;
//    }
//
//    public TblColRef getPartitionDateColumnRef() {
//        return partitionDateColumnRef;
//    }

    // ============================================================================

//    public static interface IPartitionConditionBuilder {
//        String buildDateRangeCondition(PartitionDesc partDesc, long startInclusive, long endExclusive, Map<String, String> tableAlias);
//    }
//
//    public static class DefaultPartitionConditionBuilder implements IPartitionConditionBuilder {
//
//        @Override
//        public String buildDateRangeCondition(PartitionDesc partDesc, long startInclusive, long endExclusive, Map<String, String> tableAlias) {
//            StringBuilder builder = new StringBuilder();
//            String partitionDateColumnName = partDesc.getPartitionDateColumn();
//            String partitionTimeColumnName = partDesc.getPartitionTimeColumn();
//
//            if (partDesc.partitionColumnIsYmdInt()) {
//                buildSingleColumnRangeCondAsYmdInt(builder, partitionDateColumnName, startInclusive, endExclusive, tableAlias);
//            } else if (partDesc.partitionColumnIsTimeMillis()) {
//                buildSingleColumnRangeCondAsTimeMillis(builder, partitionDateColumnName, startInclusive, endExclusive, tableAlias);
//            } else if (partitionDateColumnName != null && partitionTimeColumnName == null) {
//                buildSingleColumnRangeCondition(builder, partitionDateColumnName, startInclusive, endExclusive, partDesc.getPartitionDateFormat(), tableAlias);
//            } else if (partitionDateColumnName == null && partitionTimeColumnName != null) {
//                buildSingleColumnRangeCondition(builder, partitionTimeColumnName, startInclusive, endExclusive, partDesc.getPartitionTimeFormat(), tableAlias);
//            } else if (partitionDateColumnName != null && partitionTimeColumnName != null) {
//                buildMultipleColumnRangeCondition(builder, partitionDateColumnName, partitionTimeColumnName, startInclusive, endExclusive, partDesc.getPartitionDateFormat(), partDesc.getPartitionTimeFormat(), tableAlias);
//            }
//
//            return builder.toString();
//        }
//
//        /**
//         * Convert to use table alias
//         */
//        private static String replaceColumnNameWithAlias(String columnName, Map<String, String> tableAlias) {
//            int indexOfDot = columnName.lastIndexOf(".");
//            if (indexOfDot > 0) {
//                String partitionTableName = columnName.substring(0, indexOfDot);
//                if (tableAlias != null && tableAlias.containsKey(partitionTableName))
//                    columnName = tableAlias.get(partitionTableName) + columnName.substring(indexOfDot);
//            }
//            return columnName;
//        }
//
//        private static void buildSingleColumnRangeCondAsTimeMillis(StringBuilder builder, String partitionColumnName, long startInclusive, long endExclusive, Map<String, String> tableAlias) {
//            partitionColumnName = replaceColumnNameWithAlias(partitionColumnName, tableAlias);
//            if (startInclusive > 0) {
//                builder.append(partitionColumnName + " >= " + startInclusive);
//                builder.append(" AND ");
//            }
//            builder.append(partitionColumnName + " < " + endExclusive);
//        }
//
//        private static void buildSingleColumnRangeCondAsYmdInt(StringBuilder builder, String partitionColumnName, long startInclusive, long endExclusive, Map<String, String> tableAlias) {
//            partitionColumnName = replaceColumnNameWithAlias(partitionColumnName, tableAlias);
//            if (startInclusive > 0) {
//                builder.append(partitionColumnName + " >= " + DateFormat.formatToDateStr(startInclusive, DateFormat.COMPACT_DATE_PATTERN));
//                builder.append(" AND ");
//            }
//            builder.append(partitionColumnName + " < " + DateFormat.formatToDateStr(endExclusive, DateFormat.COMPACT_DATE_PATTERN));
//        }
//
//        private static void buildSingleColumnRangeCondition(StringBuilder builder, String partitionColumnName, long startInclusive, long endExclusive, String partitionColumnDateFormat, Map<String, String> tableAlias) {
//            partitionColumnName = replaceColumnNameWithAlias(partitionColumnName, tableAlias);
//            if (startInclusive > 0) {
//                builder.append(partitionColumnName + " >= '" + DateFormat.formatToDateStr(startInclusive, partitionColumnDateFormat) + "'");
//                builder.append(" AND ");
//            }
//            builder.append(partitionColumnName + " < '" + DateFormat.formatToDateStr(endExclusive, partitionColumnDateFormat) + "'");
//        }
//
//        private static void buildMultipleColumnRangeCondition(StringBuilder builder, String partitionDateColumnName, String partitionTimeColumnName, long startInclusive, long endExclusive, String partitionColumnDateFormat, String partitionColumnTimeFormat, Map<String, String> tableAlias) {
//            partitionDateColumnName = replaceColumnNameWithAlias(partitionDateColumnName, tableAlias);
//            partitionTimeColumnName = replaceColumnNameWithAlias(partitionTimeColumnName, tableAlias);
//            if (startInclusive > 0) {
//                builder.append("(");
//                builder.append("(");
//                builder.append(partitionDateColumnName + " = '" + DateFormat.formatToDateStr(startInclusive, partitionColumnDateFormat) + "'").append(" AND ").append(partitionTimeColumnName + " >= '" + DateFormat.formatToDateStr(startInclusive, partitionColumnTimeFormat) + "'");
//                builder.append(")");
//                builder.append(" OR ");
//                builder.append("(");
//                builder.append(partitionDateColumnName + " > '" + DateFormat.formatToDateStr(startInclusive, partitionColumnDateFormat) + "'");
//                builder.append(")");
//                builder.append(")");
//                builder.append(" AND ");
//            }
//
//            builder.append("(");
//            builder.append("(");
//            builder.append(partitionDateColumnName + " = '" + DateFormat.formatToDateStr(endExclusive, partitionColumnDateFormat) + "'").append(" AND ").append(partitionTimeColumnName + " < '" + DateFormat.formatToDateStr(endExclusive, partitionColumnTimeFormat) + "'");
//            builder.append(")");
//            builder.append(" OR ");
//            builder.append("(");
//            builder.append(partitionDateColumnName + " < '" + DateFormat.formatToDateStr(endExclusive, partitionColumnDateFormat) + "'");
//            builder.append(")");
//            builder.append(")");
//        }
//    }
//
//    /**
//     * Another implementation of IPartitionConditionBuilder, for the fact tables which have three partition columns "YEAR", "MONTH", and "DAY"; This
//     * class will concat the three columns into yyyy-MM-dd format for query hive;
//     */
//    public static class YearMonthDayPartitionConditionBuilder implements PartitionDesc.IPartitionConditionBuilder {
//
//        @Override
//        public String buildDateRangeCondition(PartitionDesc partDesc, long startInclusive, long endExclusive, Map<String, String> tableAlias) {
//
//            String partitionColumnName = partDesc.getPartitionDateColumn();
//            String partitionTableName;
//
//            // convert to use table alias
//            int indexOfDot = partitionColumnName.lastIndexOf(".");
//            if (indexOfDot > 0) {
//                partitionTableName = partitionColumnName.substring(0, indexOfDot).toUpperCase();
//            } else {
//                throw new IllegalStateException("The partitionColumnName is invalid: " + partitionColumnName);
//            }
//
//            if (tableAlias.containsKey(partitionTableName)) {
//                partitionTableName = tableAlias.get(partitionTableName);
//            }
//
//            String concatField = String.format("CONCAT(%s.YEAR,'-',%s.MONTH,'-',%s.DAY)", partitionTableName, partitionTableName, partitionTableName);
//            StringBuilder builder = new StringBuilder();
//
//            if (startInclusive > 0) {
//                builder.append(concatField + " >= '" + DateFormat.formatToDateStr(startInclusive) + "' ");
//                builder.append("AND ");
//            }
//            builder.append(concatField + " < '" + DateFormat.formatToDateStr(endExclusive) + "'");
//
//            return builder.toString();
//        }
//    }
//
//    public static PartitionDesc getCopyOf(PartitionDesc partitionDesc) {
//        PartitionDesc newPartDesc = new PartitionDesc();
//        newPartDesc.setCubePartitionType(partitionDesc.getCubePartitionType());
//        newPartDesc.setPartitionDateColumn(partitionDesc.getPartitionDateColumn());
//        newPartDesc.setPartitionDateFormat(partitionDesc.getPartitionDateFormat());
//        newPartDesc.setPartitionDateStart(partitionDesc.getPartitionDateStart());
//        return newPartDesc;
//    }

}

package com.jusfoun.jap.kylin.service;

import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import com.jusfoun.jap.hive.vo.ColumnVo;
import com.jusfoun.jap.hive.vo.DimensionVo;
import com.jusfoun.jap.hive.vo.HiveTableVo;
import com.jusfoun.jap.hive.vo.MeasureVo;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.kylin.domain.cube.AggregationGroup;
import com.jusfoun.jap.kylin.domain.cube.CubeDesc;
import com.jusfoun.jap.kylin.domain.cube.CubeRequest;
import com.jusfoun.jap.kylin.domain.cube.DimensionDesc;
import com.jusfoun.jap.kylin.domain.cube.FunctionDesc;
import com.jusfoun.jap.kylin.domain.cube.HBaseColumnDesc;
import com.jusfoun.jap.kylin.domain.cube.HBaseColumnFamilyDesc;
import com.jusfoun.jap.kylin.domain.cube.HBaseMappingDesc;
import com.jusfoun.jap.kylin.domain.cube.MeasureDesc;
import com.jusfoun.jap.kylin.domain.cube.ParameterDesc;
import com.jusfoun.jap.kylin.domain.cube.RowKeyColDesc;
import com.jusfoun.jap.kylin.domain.cube.RowKeyDesc;
import com.jusfoun.jap.kylin.domain.cube.SelectRule;
import com.jusfoun.jap.kylin.util.KylinConstants.KylinMethod;
import com.jusfoun.jap.kylin.util.KylinHttpClientUtil;
import com.jusfoun.jap.util.Constant;
import com.jusfoun.jap.util.JacksonUtil;

@Service
public class KylinCubeService {

	private transient Logger LOG = LoggerFactory.getLogger(getClass());
	
	public String buildCube(String cubeName) throws Exception
	{
		// http请求
		String url = Constant.KYLIN_ADDRESS + KylinMethod.BUILD_CUBE + "/" + cubeName + "/rebuild";
		String json = "{\"buildType\":\"BUILD\",\"startTime\":0,\"endTime\":0}";
		String responseContent = KylinHttpClientUtil.sendHttpPut(url, json);
		return responseContent;
	}
	
	
	public String getCube(String cubeName) throws Exception
	{
		// http请求
		String url = Constant.KYLIN_ADDRESS + KylinMethod.CUBE_DESC +"/" + cubeName;
		String responseContent = KylinHttpClientUtil.sendHttpGet(url);
		return responseContent;
	}
	/**
	 * model json 数据发送
	 * @throws Exception 
	 */
	public CubeRequest createCubeModel(ModelVo modelVo, String modelName) throws Exception{
		// http请求
		String url = Constant.KYLIN_ADDRESS + KylinMethod.POST_CUBE;
		
		CubeRequest cubeRequest = new CubeRequest();
		//设置cubeRequest信息,
		cubeRequest.setProject(Constant.KYLIN_PROJECTNAME);
		CubeDesc cubeDesc = createCubeDesc(modelVo, modelName);
		cubeRequest.setCubeDescData(JacksonUtil.toJSon(cubeDesc));
		
		String json = JacksonUtil.toJSon(cubeRequest);
		LOG.info("createCubeModel request json="+json);
		String responseContent = KylinHttpClientUtil.sendHttpPost(url.toString(), json);
		LOG.info("createCubeModel responseContent="+responseContent);
		cubeRequest = JacksonUtil.readValue(responseContent, CubeRequest.class);
		return cubeRequest;
	}
	
	private CubeDesc createCubeDesc(ModelVo modelVo, String modelName) {
		CubeDesc cubeDesc = new CubeDesc();
		cubeDesc.setName("CUBE_"+modelVo.getFactTable().getTableName().replaceAll(Constant.HIVE_ANALYSIS_DATABASE+".", "").toUpperCase());
		cubeDesc.setModelName(modelName);
		cubeDesc.setDescription(modelVo.getModelDesc());
		cubeDesc.setDimensions(createDimensionDescList(modelVo));
		List<MeasureDesc> measures = createMeasureDescList(modelVo.getMeasures());
		cubeDesc.setMeasures(measures);
		cubeDesc.setRowkey(createRowkey(modelVo.getFactTable()));
		cubeDesc.setAggregationGroups(createAggregationGroups(modelVo.getFactTable()));
		cubeDesc.setPartitionDateStart(0);
		
		cubeDesc.setHbaseMapping(createHbaseMapping(measures));
		cubeDesc.setRetentionRange(0);
		List<String> statusNeedNotify = new ArrayList<String>();
		statusNeedNotify.add("ERROR");
		statusNeedNotify.add("DISCARDED");
		statusNeedNotify.add("SUCCEED");
		cubeDesc.setStatusNeedNotify(statusNeedNotify);
		//cubeDesc.setAutoMergeTimeRanges(null);//long[]
		cubeDesc.setEngineType(2);
		cubeDesc.setStorageType(2);
		return cubeDesc;
	}

	private HBaseMappingDesc createHbaseMapping(List<MeasureDesc> measures) {
		
		HBaseMappingDesc hBaseMappingDesc = new HBaseMappingDesc();
		
		List<HBaseColumnFamilyDesc> columnFamilyDescList = new ArrayList<HBaseColumnFamilyDesc>();
		HBaseColumnFamilyDesc columnFamily = new HBaseColumnFamilyDesc();
		columnFamily.setName("F1");
		
		List<HBaseColumnDesc> columns = new ArrayList<HBaseColumnDesc>();
		HBaseColumnDesc hBaseColumnDesc = new HBaseColumnDesc();
		hBaseColumnDesc.setQualifier("M");
		List<String> measureRefs = new ArrayList<String>();
		for(MeasureDesc desc : measures)
		{
			measureRefs.add(desc.getName());
		}
		hBaseColumnDesc.setMeasureRefs(measureRefs);
		columns.add(hBaseColumnDesc);
		
		HBaseColumnDesc[] columnsArray = (HBaseColumnDesc[]) columns.toArray(
				new HBaseColumnDesc[columns.size()]);
		columnFamily.setColumns(columnsArray);
		
		columnFamilyDescList.add(columnFamily);
		
		HBaseColumnFamilyDesc[] array = (HBaseColumnFamilyDesc[]) columnFamilyDescList.toArray(
				new HBaseColumnFamilyDesc[columnFamilyDescList.size()]);
		hBaseMappingDesc.setColumnFamily(array);
		return hBaseMappingDesc;
	}

	//createcCubeDesc->setDimensions
	private List<DimensionDesc> createDimensionDescList(ModelVo modelVo) {
		List<DimensionDesc> dimensionDescList = new ArrayList<DimensionDesc>();
		HiveTableVo factTable = modelVo.getFactTable();
		List<ColumnVo> factColums = factTable.getColumns();
		DimensionDesc dimensionDesc = null;
		for(ColumnVo vo : factColums)
		{
			dimensionDesc = new DimensionDesc();
			dimensionDesc.setName(factTable.getTableName()+"."+vo.getColumnName());
			dimensionDesc.setTable(factTable.getTableName());
			dimensionDesc.setColumn(vo.getColumnName());
			dimensionDescList.add(dimensionDesc);
		}
		List<DimensionVo> list = modelVo.getDimensions();
		for(DimensionVo dimensionVo : list)
		{
			dimensionDesc = new DimensionDesc();
			dimensionDesc.setName(dimensionVo.getTableName()+"_DERIVED");
			dimensionDesc.setTable(dimensionVo.getTableName());
			String[] derived = new String[]{dimensionVo.getColumnName()};
			dimensionDesc.setDerived(derived);//String[]
			dimensionDescList.add(dimensionDesc);
		}
		
		return dimensionDescList;
	}
	
	//createcCubeDesc->setMeasures
	private List<MeasureDesc> createMeasureDescList(List<MeasureVo> measuresList) {
		List<MeasureDesc> measureDescList = new ArrayList<MeasureDesc>();
		//第一个默认信息
		MeasureDesc defaultMeasureDesc = new MeasureDesc();
		defaultMeasureDesc.setName("_COUNT_");
		
		FunctionDesc defaultFunctionDesc = new FunctionDesc();
		defaultFunctionDesc.setExpression("COUNT");
		defaultFunctionDesc.setReturnType("BIGINT");
		
		ParameterDesc defaultParameterDesc = new ParameterDesc();
		defaultParameterDesc.setType("constant");
		defaultParameterDesc.setValue("1");
		defaultParameterDesc.setNextParameter(null);
		
		defaultFunctionDesc.setParameter(defaultParameterDesc);
		defaultMeasureDesc.setFunction(defaultFunctionDesc);//FunctionDesc
		measureDescList.add(defaultMeasureDesc);
		
		MeasureDesc measureDesc = null;
		FunctionDesc functionDesc = null;
		ParameterDesc parameterDesc = null;
		//循环体
//		for(MeasureVo measureVo:measuresList){
//			measureDesc = new MeasureDesc();
//			measureDesc.setName("_"+measureVo.getComputationRules()+"_");
//			
//			functionDesc = new FunctionDesc();
//			functionDesc.setReturnType("column");
//			parameterDesc = new ParameterDesc();
//			parameterDesc.setValue(measureVo.getColumnName());
//			//parameterDesc.setValue();
//			functionDesc.setParameter(parameterDesc);
//			measureDesc.setFunction(functionDesc);//FunctionDesc
//			measureDescList.add(measureDesc);
//		}
		return measureDescList;
	}
	
	//createcCubeDesc->setRowkey
	private RowKeyDesc createRowkey(HiveTableVo factTable) {
		
		RowKeyDesc rowKeyDesc = new RowKeyDesc();
		List<RowKeyColDesc>  list = new ArrayList<RowKeyColDesc>();
		
		List<ColumnVo> columns= factTable.getColumns();
		RowKeyColDesc rowKeyColDesc = null;
		for(ColumnVo vo : columns)
		{
			rowKeyColDesc = new RowKeyColDesc();
			rowKeyColDesc.setColumn(vo.getColumnName());
			rowKeyColDesc.setEncoding("dict");
			list.add(rowKeyColDesc);
		}
		
		rowKeyDesc.setRowkeyColumns((RowKeyColDesc[]) list.toArray(new RowKeyColDesc[list.size()]));
		return rowKeyDesc;
	}

	//createcCubeDesc->setAggregationGroups
	private List<AggregationGroup> createAggregationGroups(HiveTableVo factTable) {
		
		List<ColumnVo> columns = factTable.getColumns();
		List<String> includes = new ArrayList<String>();
		for (ColumnVo vo : columns) {
			includes.add(vo.getColumnName());
		}
		
		List<AggregationGroup> agregationGroupList= new ArrayList<AggregationGroup>();
		AggregationGroup agregationGroup = new AggregationGroup();
		agregationGroup.setIncludes((String[]) includes.toArray(new String[includes.size()]));
		
		SelectRule selectRule = new  SelectRule();
		agregationGroup.setSelectRule(selectRule);
		agregationGroupList.add(agregationGroup);
		return agregationGroupList;
	}
	
}

package com.jusfoun.jap.kylin.service;

import org.springframework.stereotype.Service;

import com.jusfoun.jap.kylin.domain.job.JobListRequest;
import com.jusfoun.jap.kylin.util.KylinConstants.KylinMethod;
import com.jusfoun.jap.kylin.util.KylinHttpClientUtil;
import com.jusfoun.jap.util.Constant;

@Service
public class KylinJobService {
	
	/**
	 * http://58.240.82.126:7070/kylin/api/jobs?
	 * cubeName=CUBE_FACT_53912C625E974A4B8822C54DBCF27C09&limit=15&offset=0
	 * &projectName=analysis&status=4&timeFilter=1
	 * @return
	 */
	public String getJob(JobListRequest request) throws Exception
	{
		// http请求
		String url = Constant.KYLIN_ADDRESS + KylinMethod.GET_JOBS +"?";
		String responseContent = KylinHttpClientUtil.sendHttpGet(url);
		return responseContent;
	}

}

package com.jusfoun.jap.kylin.service;

import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import com.jusfoun.jap.hive.vo.ColumnVo;
import com.jusfoun.jap.hive.vo.DimensionVo;
import com.jusfoun.jap.hive.vo.HiveTableVo;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.kylin.domain.model.DataModelDesc;
import com.jusfoun.jap.kylin.domain.model.DataModelDesc.RealizationCapacity;
import com.jusfoun.jap.kylin.domain.model.JoinDesc;
import com.jusfoun.jap.kylin.domain.model.LookupDesc;
import com.jusfoun.jap.kylin.domain.model.ModelDimensionDesc;
import com.jusfoun.jap.kylin.domain.model.ModelRequest;
import com.jusfoun.jap.kylin.domain.model.PartitionDesc;
import com.jusfoun.jap.kylin.util.KylinConstants.KylinMethod;
import com.jusfoun.jap.kylin.util.KylinHttpClientUtil;
import com.jusfoun.jap.util.Constant;
import com.jusfoun.jap.util.JacksonUtil;

@Service
public class KylinModelService {

	private transient Logger LOG = LoggerFactory.getLogger(getClass());
	/**
	 * model json 数据发送
	 * 
	 * @throws Exception
	 */
	public String createDataModel(ModelVo modelVo) throws Exception {
		
		// http请求
		String url = Constant.KYLIN_ADDRESS + KylinMethod.POST_MODEL;
				
		ModelRequest modelRequest = new ModelRequest();
		// 设置modelRequest信息,
		modelRequest.setProject(Constant.KYLIN_PROJECTNAME);
		DataModelDesc dataModelDesc = createDataModelDesc(modelVo);
		modelRequest.setModelDescData(JacksonUtil.toJSon(dataModelDesc));
		String json = JacksonUtil.toJSon(modelRequest);
		//
		LOG.info("createDataModel request json="+json);
		String responseContent = KylinHttpClientUtil.sendHttpPost(url.toString(), json);
		LOG.info("createDataModel responseContent="+responseContent);
		return dataModelDesc.getName();
	}

	private DataModelDesc createDataModelDesc(ModelVo modelVo) {
		DataModelDesc dataModelDesc = new DataModelDesc();
		dataModelDesc.setName("MODEL_"+modelVo.getFactTable().getTableName().replaceAll(Constant.HIVE_ANALYSIS_DATABASE+".", "").toUpperCase());
		dataModelDesc.setDescription("");
		dataModelDesc.setFactTable(modelVo.getFactTable().getTableName());
		dataModelDesc.setLookups(createLookupDescList(modelVo.getDimensions()));// List<LookupDesc>
		dataModelDesc.setFilterCondition("");
		dataModelDesc.setCapacity(RealizationCapacity.MEDIUM);
		dataModelDesc.setDimensions(createModelDimensionDescList(modelVo.getFactTable(), modelVo.getDimensions()));// List<ModelDimensionDesc>
		dataModelDesc.setMetrics(createMetrics(modelVo.getFactTable()));// String[]
		dataModelDesc.setPartitionDesc(new PartitionDesc());
		dataModelDesc.setLastModified(0);
		return dataModelDesc;
	}

	private String[] createMetrics(HiveTableVo factTable) {
		List<String> metrics = new ArrayList<String>();
		List<ColumnVo> columns = factTable.getColumns();
		for (ColumnVo vo : columns) {
			metrics.add(vo.getColumnName());
		}
		return (String[]) metrics.toArray(new String[metrics.size()]);
	}

	// createDataModel->createDataModelDesc->setLookups
	private List<LookupDesc> createLookupDescList(List<DimensionVo> dimensionVoList) {
		List<LookupDesc> lookupDescList = new ArrayList<LookupDesc>();
		// 循环体
		for (DimensionVo dimensionVo : dimensionVoList) {
			LookupDesc lookupDesc = new LookupDesc();
			lookupDesc.setTable(dimensionVo.getTableName());
			lookupDesc.setJoin(createJoinDesc(dimensionVo.getColumnName()));// JoinDesc
			lookupDescList.add(lookupDesc);
		}
		return lookupDescList;
	}

	// createDataModel->createDataModelDesc->createLookupDescList->setJoin
	private JoinDesc createJoinDesc(String columnName) {
		JoinDesc joinDesc = new JoinDesc();
		joinDesc.setType("inner");
		List<String> primaryKeList = new ArrayList<String>();
		primaryKeList.add(columnName);
		joinDesc.setPrimaryKey(primaryKeList);// String[]
		joinDesc.setForeignKey(primaryKeList);// String[]
		return joinDesc;
	}

	// createDataModel->createDataModelDesc->setDimensions
	private List<ModelDimensionDesc> createModelDimensionDescList(HiveTableVo hiveTableVo,
			List<DimensionVo> dimensionVoList) {
		List<ModelDimensionDesc> modelDimensionDescList = new ArrayList<ModelDimensionDesc>();
		// 第一个diension从hiveTableVo获取
		ModelDimensionDesc firstDimensionDesc = new ModelDimensionDesc();
		firstDimensionDesc.setTable(hiveTableVo.getTableName());
		List<String> columnList = new ArrayList<String>();
		for (ColumnVo columnVo : hiveTableVo.getColumns()) {
			columnList.add(columnVo.getColumnName());
		}
		firstDimensionDesc.setColumns(columnList);
		modelDimensionDescList.add(firstDimensionDesc);

		// 循环体
		for (DimensionVo dimensionVo : dimensionVoList) {
			ModelDimensionDesc modelDimensionDesc = new ModelDimensionDesc();
			modelDimensionDesc.setTable(dimensionVo.getTableName());
			List<String> columnsList = new ArrayList<String>();
			columnsList.add(dimensionVo.getColumnName());
			modelDimensionDesc.setColumns(columnsList);// String[]
			modelDimensionDescList.add(modelDimensionDesc);
		}

		return modelDimensionDescList;
	}

	// createDataModel->createDataModelDesc->setPartitionDesc
	private PartitionDesc createPartitionDesc() {
		PartitionDesc partitionDesc = new PartitionDesc();
		partitionDesc.setPartitionDateColumn(null);
		partitionDesc.setPartitionDateStart(null);
		partitionDesc.setPartitionType(null);
		partitionDesc.setPartitionDateFormat(null);
		partitionDesc.setPartitionTimeColumn(null);
		partitionDesc.setPartitionTimeStart(null);
		return partitionDesc;
	}

}

package com.jusfoun.jap.kylin.service;

import java.util.List;

import javax.annotation.Resource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import com.itmuch.core.page.PageVo;
import com.jusfoun.jap.cube.service.CubeService;
import com.jusfoun.jap.hive.vo.DimensionVo;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.kylin.domain.cube.CubeRequest;
import com.jusfoun.jap.kylin.util.KylinConstants;
import com.jusfoun.jap.kylin.util.KylinHttpClientUtil;
import com.jusfoun.jap.util.Constant;

@Service
public class KylinService {
	

	private transient Logger LOG = LoggerFactory.getLogger(getClass());
	@Resource
	private KylinModelService kylinModelService;
	@Resource
	private KylinCubeService kylinCubeService;
	@Resource
	private CubeService cubeService;
	
	public String sendKylinRequest(ModelVo modelVo) throws Exception{
		
		//1:加载hive表
		loadHiveTable(modelVo);
		//2:创建model
		String modelName = kylinModelService.createDataModel(modelVo);
		//3:创建cube
		CubeRequest cubeRequest = kylinCubeService.createCubeModel(modelVo, modelName);
		return cubeRequest.getUuid();
	}

	private void loadHiveTable(ModelVo modelVo) throws Exception {
		
		StringBuffer url = new StringBuffer();
		url.append(Constant.KYLIN_ADDRESS).append(KylinConstants.KylinMethod.LOAD_HIVETABLE).append("/");
		url.append(modelVo.getFactTable().getTableName()).append(",");
		List<DimensionVo> dimensionList = modelVo.getDimensions();
		for(DimensionVo vo : dimensionList)
		{
			url.append(vo.getTableName()).append(",");
		}
		url.append("/").append(Constant.KYLIN_PROJECTNAME);
		String json = "{\"calculate\":\"true\"}";
		LOG.info("loadHiveTable request url="+url.toString());
		String responseContent = KylinHttpClientUtil.sendHttpPost(url.toString(), json);
		LOG.info("loadHiveTable response="+responseContent);
	}
}

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

package com.jusfoun.jap.kylin.util;

import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.Reader;
import java.util.HashMap;
import java.util.Map;

import com.fasterxml.jackson.core.JsonGenerationException;
import com.fasterxml.jackson.core.JsonParseException;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonMappingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;

public class JsonUtil {

    // reuse the object mapper to save memory footprint
    private static final ObjectMapper mapper = new ObjectMapper();
    private static final ObjectMapper indentMapper = new ObjectMapper();

    static {
        mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
        indentMapper.configure(SerializationFeature.INDENT_OUTPUT, true);
    }

    public static <T> T readValue(File src, Class<T> valueType) throws IOException, JsonParseException, JsonMappingException {
        return mapper.readValue(src, valueType);
    }

    public static <T> T readValue(String content, Class<T> valueType) throws IOException, JsonParseException, JsonMappingException {
        return mapper.readValue(content, valueType);
    }

    public static <T> T readValue(Reader src, Class<T> valueType) throws IOException, JsonParseException, JsonMappingException {
        return mapper.readValue(src, valueType);
    }

    public static <T> T readValue(InputStream src, Class<T> valueType) throws IOException, JsonParseException, JsonMappingException {
        return mapper.readValue(src, valueType);
    }

    public static <T> T readValue(byte[] src, Class<T> valueType) throws IOException, JsonParseException, JsonMappingException {
        return mapper.readValue(src, valueType);
    }

    public static Map<String, String> readValueAsMap(String content) throws IOException {
        TypeReference<HashMap<String, String>> typeRef = new TypeReference<HashMap<String, String>>() {
        };
        return mapper.readValue(content, typeRef);
    }

    public static void writeValueIndent(OutputStream out, Object value) throws IOException, JsonGenerationException, JsonMappingException {
        indentMapper.writeValue(out, value);
    }

    public static void writeValue(OutputStream out, Object value) throws IOException, JsonGenerationException, JsonMappingException {
        mapper.writeValue(out, value);
    }

    public static String writeValueAsString(Object value) throws JsonProcessingException {
        return mapper.writeValueAsString(value);
    }

    public static byte[] writeValueAsBytes(Object value) throws JsonProcessingException {
        return mapper.writeValueAsBytes(value);
    }

    public static String writeValueAsIndentString(Object value) throws JsonProcessingException {
        return indentMapper.writeValueAsString(value);
    }

}

package com.jusfoun.jap.kylin.util;

public interface KylinConstants {

	interface KylinMethod
	{
		String LOAD_HIVETABLE = "/kylin/api/tables";
		String POST_MODEL = "/kylin/api/models";
		String POST_CUBE = "/kylin/api/cubes";
		String CUBE_DESC = "/kylin/api/cube_desc";
		String BUILD_CUBE = "/kylin/api/cubes";
		String GET_JOBS = "/kylin/api/jobs";
	}
	
}

package com.jusfoun.jap.kylin.util;

import java.io.IOException;

import org.apache.http.HttpEntity;
import org.apache.http.HttpStatus;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.methods.HttpPut;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import org.apache.log4j.Logger;

import com.jusfoun.jap.util.Constant;

public class KylinHttpClientUtil {

	private static final Logger LOGGER = Logger.getLogger(KylinHttpClientUtil.class);

	public static final String CONTENT_TYPE = "application/json;charset=UTF-8";
	public static final String UTF_8 = "UTF-8";
	public static final int CONNECTION_TIMEOUT = 60000;

	private static RequestConfig requestConfig = RequestConfig.custom()
			.setSocketTimeout(CONNECTION_TIMEOUT)
			.setConnectTimeout(CONNECTION_TIMEOUT).build();

	/**
	 * 发送 post请求
	 * 
	 * @param httpUrl
	 *            地址
	 * @param maps
	 *            参数
	 * @throws Exception 
	 */
	public static String sendHttpPost(String url, String json) throws Exception {
		HttpPost httpPost = new HttpPost(url);// 创建httpPost
		httpPost.addHeader("Authorization", Constant.KYLIN_AUTHORIZATION);
		httpPost.addHeader("content-type", CONTENT_TYPE);
		StringEntity entity = new StringEntity(json, UTF_8);
		entity.setContentType(CONTENT_TYPE);
		httpPost.setEntity(entity);
		return sendHttpPost(httpPost);
	}

	/**
	 * 发送Post请求
	 * 
	 * @param httpPost
	 * @return
	 * @throws Exception 
	 */
	private static String sendHttpPost(HttpPost httpPost) throws Exception {
		CloseableHttpClient httpClient = null;
		CloseableHttpResponse response = null;
		HttpEntity entity = null;
		String responseContent = null;
		try {
			// 创建默认的httpClient实例.
			httpClient = HttpClients.createDefault();
			httpPost.setConfig(requestConfig);
			// 执行请求
			response = httpClient.execute(httpPost);
			int statusCode = response.getStatusLine().getStatusCode();
			entity = response.getEntity();
        	responseContent = EntityUtils.toString(entity, UTF_8);
            if (statusCode != HttpStatus.SC_OK) {
            	LOGGER.error("responseContent=" + responseContent);
            	throw new Exception(responseContent);
            }
		} catch (Exception e) {
			LOGGER.error(e.getMessage(), e);
			throw e;
		} finally {
			try {
				// 关闭连接,释放资源
				if (response != null) {
					response.close();
				}
				if (httpClient != null) {
					httpClient.close();
				}
			} catch (IOException e) {
				LOGGER.error(e.getMessage(), e);
				throw e;
			}
		}
		return responseContent;
	}

	/**
	 * 发送 get请求
	 * 
	 * @param httpUrl
	 * @throws Exception 
	 */
	public static String sendHttpGet(String httpUrl) throws Exception {
		//封装参数
		HttpGet httpGet = new HttpGet(httpUrl);// 创建get请求
		httpGet.addHeader("Authorization", Constant.KYLIN_AUTHORIZATION);
		httpGet.addHeader("content-type", CONTENT_TYPE);
		return sendHttpGet(httpGet);
	}

	/**
	 * 发送Get请求
	 * 
	 * @param httpPost
	 * @return
	 * @throws Exception 
	 */
	private static String sendHttpGet(HttpGet httpGet) throws Exception {
		CloseableHttpClient httpClient = null;
		CloseableHttpResponse response = null;
		HttpEntity entity = null;
		String responseContent = null;

		try {
			// 创建默认的httpClient实例.
			httpClient = HttpClients.createDefault();
			httpGet.setConfig(requestConfig);
			// 执行请求
			response = httpClient.execute(httpGet);
			int statusCode = response.getStatusLine().getStatusCode();
			entity = response.getEntity();
			responseContent = EntityUtils.toString(entity, "UTF-8");
			if (statusCode != HttpStatus.SC_OK) {
            	LOGGER.error("responseContent=" + responseContent);
            	throw new Exception(responseContent);
            }
		} catch (Exception e) {
			LOGGER.error(e.getMessage(), e);
			throw e;
		} finally {
			try {
				// 关闭连接,释放资源
				if (response != null) {
					response.close();
				}
				if (httpClient != null) {
					httpClient.close();
				}
			} catch (IOException e) {
				LOGGER.error(e.getMessage(), e);
				throw e;
			}
		}
		return responseContent;
	}

	/**
	 * 发送 get请求
	 * 
	 * @param httpUrl
	 * @throws Exception 
	 */
	public static String sendHttpPut(String httpUrl, String json) throws Exception {
		//封装参数
		HttpPut httpPut = new HttpPut(httpUrl);// 创建get请求
		httpPut.addHeader("Authorization", Constant.KYLIN_AUTHORIZATION);
		httpPut.addHeader("content-type", CONTENT_TYPE);
		StringEntity entity = new StringEntity(json, UTF_8);
		entity.setContentType(CONTENT_TYPE);
		httpPut.setEntity(entity);
		return sendHttpPut(httpPut);
	}

	/**
	 * 发送Get请求
	 * 
	 * @param httpPost
	 * @return
	 * @throws Exception 
	 */
	private static String sendHttpPut(HttpPut httpPut) throws Exception {
		CloseableHttpClient httpClient = null;
		CloseableHttpResponse response = null;
		HttpEntity entity = null;
		String responseContent = null;

		try {
			// 创建默认的httpClient实例.
			httpClient = HttpClients.createDefault();
			httpPut.setConfig(requestConfig);
			// 执行请求
			response = httpClient.execute(httpPut);
			int statusCode = response.getStatusLine().getStatusCode();
			entity = response.getEntity();
			responseContent = EntityUtils.toString(entity, "UTF-8");
			if (statusCode != HttpStatus.SC_OK) {
            	LOGGER.error("responseContent=" + responseContent);
            	throw new Exception(responseContent);
            }
		} catch (Exception e) {
			LOGGER.error(e.getMessage(), e);
			throw e;
		} finally {
			try {
				// 关闭连接,释放资源
				if (response != null) {
					response.close();
				}
				if (httpClient != null) {
					httpClient.close();
				}
			} catch (IOException e) {
				LOGGER.error(e.getMessage(), e);
				throw e;
			}
		}
		return responseContent;
	}
}

package com.jusfoun.jap.story.controller;

import java.sql.SQLException;
import java.util.List;

import javax.annotation.Resource;

import org.json.JSONException;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import com.alibaba.fastjson.JSON;
import com.itmuch.core.util.SubjectUtil;
import com.jusfoun.jap.story.domain.Story;
import com.jusfoun.jap.story.vo.StoryVo;
import com.jusfoun.jap.story.service.StoryService;

@RestController
@RequestMapping(value = "/stories")
public class StoryController {

	@Resource
	StoryService storyService;
	
	//故事详情
	 @RequestMapping(value="/{id}",method=RequestMethod.GET)
	    public StoryVo getStory(Story story) throws SQLException, JSONException{
		 	story.setUserId(SubjectUtil.getUserId().toString());
		 	return storyService.getStory(story);
	   }
	 //故事列表
	 @RequestMapping(method=RequestMethod.GET)
	    public List<Story> getStorys( Story story){
		 story.setUserId(SubjectUtil.getUserId().toString());
		 	return storyService.getStorys(story);
	   }
	 //新建故事
	 @RequestMapping(method=RequestMethod.POST)
	    public String createStory(@ModelAttribute("story") String story){
		 	System.out.println("输入的参数为："+story);
		 	StoryVo storyVo = JSON.parseObject(story, StoryVo.class);// json转换为WorkCondition的对象
		 	storyVo.setUserId(SubjectUtil.getUserId().toString());
		 	return storyService.createStory(storyVo);
	   }
	 //更新故事
	 @RequestMapping(value="/{id}",method=RequestMethod.PUT)
	    public void updateStory(@PathVariable String id,@ModelAttribute("story") String story){
		 	StoryVo storyVo = JSON.parseObject(story, StoryVo.class);// json转换为WorkCondition的对象
		 	storyVo.setId(id);
		 	storyVo.setUserId(SubjectUtil.getUserId().toString());
		 	storyService.updateStory(storyVo);
	   }
	 //删除故事
	 @RequestMapping(value="/{id}",method=RequestMethod.DELETE)
	    public void delStory(StoryVo story){
		 	storyService.delStory(story);
	   }
	 
	 //复制故事
	 @RequestMapping(value="/{id}",method=RequestMethod.POST)
	    public void copyStory(Story story){
		 	story.setUserId(SubjectUtil.getUserId().toString());
		 	storyService.copyStory(story);
	 }
}

/**
 * 
 */
package com.jusfoun.jap.story.domain;

import java.util.Date;

import javax.persistence.Column;
import javax.persistence.Table;

/**
 * @author xc
 *	故事
 */
@Table(name = "story")
public class Story {

	/**
	 * 故事id
	 */
	@Column(name = "STORY_ID")
	private String id;
	
	/**
	 * 故事名称
	 */
	@Column(name = "STORY_NAME")
	private String name;
	
	/**
	 * 故事描述
	 */
	@Column(name = "STORY_DESCRIPTION")
	private String description;
	
	/**
	 * 用户id
	 */
	@Column(name = "USER_ID")
	private String userId;
	
	/**
	 * 创建时间
	 */
	@Column(name = "CREATE_TIME")
	private Date createTime;
	
	/**
	 * 更新时间
	 */
	@Column(name = "UPDATE_TIME")
	private Date updateTime;
	
	/**
	 * 故事样式
	 */
	@Column(name = "LAYOUT")
	private String layout;
	
	/**
	 * 故事背景色
	 */
	@Column(name = "BACKGROUND_COLOR")
	private String backgroundColor;
	
	/**
	 * 标题字体大小
	 */
	@Column(name = "TITLE_FONT_SIZE")
	private String titleFontSize;
	
	/**
	 * 标题字体粗细
	 */
	@Column(name = "TITLE_FONT_WEIGHT")
	private String titleFontWeight;
	
	/**
	 * 标题字体颜色
	 */
	@Column(name = "TITLE_FONT_COLOR")
	private String titleFontColor;
	
	/**
	 * 标题是否显示
	 */
	@Column(name = "TITLE_SHOW")
	private String titleShow;
	
	/**
	 * 主题id主键
	 */
	@Column(name = "THEME_ID")
	private String themeId;
	
	public String getThemeId() {
		return themeId;
	}

	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}

	public String getTitleFontSize() {
		return titleFontSize;
	}

	public void setTitleFontSize(String titleFontSize) {
		this.titleFontSize = titleFontSize;
	}

	public String getTitleFontWeight() {
		return titleFontWeight;
	}

	public void setTitleFontWeight(String titleFontWeight) {
		this.titleFontWeight = titleFontWeight;
	}

	public String getTitleFontColor() {
		return titleFontColor;
	}

	public void setTitleFontColor(String titleFontColor) {
		this.titleFontColor = titleFontColor;
	}

	public String getTitleShow() {
		return titleShow;
	}

	public void setTitleShow(String titleShow) {
		this.titleShow = titleShow;
	}

	public String getBackgroundColor() {
		return backgroundColor;
	}

	public void setBackgroundColor(String backgroundColor) {
		this.backgroundColor = backgroundColor;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}

	public String getLayout() {
		return layout;
	}

	public void setLayout(String layout) {
		this.layout = layout;
	}
	
	
}

package com.jusfoun.jap.story.mapper;

import java.util.List;
import java.util.Map;

import com.jusfoun.jap.story.domain.Story;
import com.jusfoun.jap.story.vo.StoryVo;

import tk.mybatis.mapper.common.Mapper;

public interface StoryMapper extends Mapper<Story> {

	StoryVo getStory(Story story);

	List<Story> getStorys(Story story);

	int createStory(StoryVo storyVo);

	void updateStory(StoryVo storyVo);

	void delStory(StoryVo storyVo);

	Integer copyStory(Story story);

	List<String> selectNames(Story story);

	String getCopyStoryId(Story story);

	Integer copyStoryDashboardRela(Map<String,String> map);

	void delStoryDashboardRela(StoryVo storyVo);

	void insertStoryDashboardRela(StoryVo storyVo);
	
}
package com.jusfoun.jap.story.service;

import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import javax.annotation.Resource;

import org.json.JSONException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.jusfoun.jap.dashboard.domain.Dashboard;
import com.jusfoun.jap.dashboard.mapper.DashboardMapper;
import com.jusfoun.jap.dashboard.service.DashboardService;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.story.domain.Story;
import com.jusfoun.jap.story.mapper.StoryMapper;
import com.jusfoun.jap.story.vo.StoryVo;
import com.jusfoun.jap.util.StringUtil;

@Service
public class StoryService{

	@Autowired
	private StoryMapper storyDao;
	
	@Autowired
	private DashboardMapper dashboardDao;
	
	@Resource
	private DashboardService dashboardService;

	public StoryVo getStory(Story story) throws SQLException, JSONException {
		StoryVo Storyvo =  storyDao.getStory(story);
		List<DashboardVo> dashboardVos = new ArrayList<DashboardVo>();
		List<Dashboard> list = dashboardDao.queryDashboardbyStory(story);
		for(Dashboard db : list){
			DashboardVo dbv = dashboardService.getDashboard(db);
			dbv.setBackgroundColor(db.getBackgroundColor());
			dbv.setBorderColor(db.getBorderColor());
			dbv.setBorderShow(db.getBorderShow());
			dashboardVos.add(dbv);
		}
		Storyvo.setDashboardVo(dashboardVos);
		return Storyvo;
	}

	public List<Story> getStorys(Story story) {
		List<Story> Storys = storyDao.getStorys(story);		
		return Storys;
	}

	public String createStory(StoryVo story) {
		String id = UUID.randomUUID().toString().replaceAll("-", "");
		story.setId(id);
		storyDao.createStory(story);
		if(StringUtil.isNotEmpty(story.getDashboardVo())){
			storyDao.insertStoryDashboardRela(story);//插入现在有而原来没有的关联关系
		}
		return id;
	}

	public void updateStory(StoryVo story) {
		storyDao.updateStory(story);//更新详情名称之类
		storyDao.delStoryDashboardRela(story);//删除原来有而最新的没有的关联表信息
		if(StringUtil.isNotEmpty(story.getDashboardVo())){
			storyDao.insertStoryDashboardRela(story);//插入现在有而原来没有的关联关系
		}
	}

	public void delStory(StoryVo story) {
		storyDao.delStory(story);
		storyDao.delStoryDashboardRela(story);
	}

	public void copyStory(Story story) {
		//1获取该仪表盘的副本名列表
		List<String> names = storyDao.selectNames(story);
		int copyOrder =1;
		story.setName(storyDao.getStory(story).getName());
		boolean getOrder = false;//false 表示 该序号的副本没有
		for(;;copyOrder++){
			getOrder = false;
			for(String name:names){
				if((story.getName()+"-副本"+copyOrder).equals(name)){//检测到该序列的副本
					getOrder = true;
					break;
				}
			}
			if(!getOrder){//如果没有检测到循环结束copyOrder为可以使用的值
				break;
			}
		}
		
		//2插入新的仪表盘记录并返回主键
		story.setName(story.getName()+"-副本"+copyOrder);//更换新的名字
		storyDao.copyStory(story);//插入
		String copyId = storyDao.getCopyStoryId(story);//返回主键
		//3.插入与数据分析的关联记录
		Map<String,String> mapId=new HashMap<String,String>();
		mapId.put("copyId", copyId);
		mapId.put("id", story.getId());
		storyDao.copyStoryDashboardRela(mapId);
		
	}
	
}

/**
 * 
 */
package com.jusfoun.jap.story.vo;

import java.util.Date;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.Table;

import com.jusfoun.jap.dashboard.vo.DashboardVo;

/**
 * @author xc
 *
 */
@Table(name = "story")
public class StoryVo {

	/**
	 * 故事id
	 */
	@Column(name = "STORY_ID")
	private String id;
	
	/**
	 * 故事名称
	 */
	@Column(name = "STORY_NAME")
	private String name;
	
	/**
	 * 故事描述
	 */
	@Column(name = "STORY_DESCRIPTION")
	private String description;
	
	/**
	 * 用户id
	 */
	@Column(name = "USER_ID")
	private String userId;
	
	/**
	 * 创建时间
	 */
	@Column(name = "CREATE_TIME")
	private Date createTime;
	
	/**
	 * 更新时间
	 */
	@Column(name = "UPDATE_TIME")
	private Date updateTime;
	
	/**
	 * 故事样式
	 */
	@Column(name = "LAYOUT")
	private String layout;
	
	/**
	 * 故事背景色
	 */
	@Column(name = "BACKGROUND_COLOR")
	private String backgroundColor;
	
	/**
	 * 标题字体大小
	 */
	@Column(name = "TITLE_FONT_SIZE")
	private String titleFontSize;
	
	/**
	 * 标题字体粗细
	 */
	@Column(name = "TITLE_FONT_WEIGHT")
	private String titleFontWeight;
	
	/**
	 * 标题字体颜色
	 */
	@Column(name = "TITLE_FONT_COLOR")
	private String titleFontColor;
	
	/**
	 * 标题是否显示
	 */
	@Column(name = "TITLE_SHOW")
	private String titleShow;
	
	/**
	 * 主题id主键
	 */
	@Column(name = "THEME_ID")
	private String themeId;
	
	public String getThemeId() {
		return themeId;
	}

	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}

	private List<DashboardVo> dashboardVo;

	
	public String getTitleFontSize() {
		return titleFontSize;
	}

	public void setTitleFontSize(String titleFontSize) {
		this.titleFontSize = titleFontSize;
	}

	public String getTitleFontWeight() {
		return titleFontWeight;
	}

	public void setTitleFontWeight(String titleFontWeight) {
		this.titleFontWeight = titleFontWeight;
	}

	public String getTitleFontColor() {
		return titleFontColor;
	}

	public void setTitleFontColor(String titleFontColor) {
		this.titleFontColor = titleFontColor;
	}

	public String getTitleShow() {
		return titleShow;
	}

	public void setTitleShow(String titleShow) {
		this.titleShow = titleShow;
	}

	public String getId() {
		return id;
	}

	public String getBackgroundColor() {
		return backgroundColor;
	}

	public void setBackgroundColor(String backgroundColor) {
		this.backgroundColor = backgroundColor;
	}

	public void setId(String id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getDescription() {
		return description;
	}

	public void setDescription(String description) {
		this.description = description;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public Date getCreateTime() {
		return createTime;
	}

	public void setCreateTime(Date createTime) {
		this.createTime = createTime;
	}

	public Date getUpdateTime() {
		return updateTime;
	}

	public void setUpdateTime(Date updateTime) {
		this.updateTime = updateTime;
	}

	public String getLayout() {
		return layout;
	}

	public void setLayout(String layout) {
		this.layout = layout;
	}

	public List<DashboardVo> getDashboardVo() {
		return dashboardVo;
	}

	public void setDashboardVo(List<DashboardVo> dashboardVo) {
		this.dashboardVo = dashboardVo;
	}
	
	
}

/**
 * 
 */
package com.jusfoun.jap.theme.controller;

import javax.annotation.Resource;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.theme.domain.Theme;
import com.jusfoun.jap.theme.service.ThemeService;

/**
 * @author wcq
 *
 */
@RestController
@RequestMapping(value = "/theme")
public class ThemeController {
	@Resource
	private ThemeService themeService;
	
	@RequestMapping("/getThemeList")
	public Result getThemeList(Theme theme) {
		Result result = new Result();
		result = themeService.getThemeList(theme);
		return result;
	}
}

/**
 * 
 */
package com.jusfoun.jap.theme.domain;

/**
 * @author wcq
 *
 */
public class Theme {
	private String themeId;
	private String themeName;
	private String dashboardTitle;
	private String dashboardBorder;
	private String dashboardBackground;
	private String storyTitle;
	private String storyBorder;
	private String storyBackground;
	private String themeColor;

	/**
	 * @return the themeColor
	 */
	public String getThemeColor() {
		return themeColor;
	}

	/**
	 * @param themeColor the themeColor to set
	 */
	public void setThemeColor(String themeColor) {
		this.themeColor = themeColor;
	}

	public String getThemeId() {
		return themeId;
	}

	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}

	public String getThemeName() {
		return themeName;
	}

	public void setThemeName(String themeName) {
		this.themeName = themeName;
	}

	public String getDashboardTitle() {
		return dashboardTitle;
	}

	public void setDashboardTitle(String dashboardTitle) {
		this.dashboardTitle = dashboardTitle;
	}

	public String getDashboardBorder() {
		return dashboardBorder;
	}

	public void setDashboardBorder(String dashboardBorder) {
		this.dashboardBorder = dashboardBorder;
	}

	public String getDashboardBackground() {
		return dashboardBackground;
	}

	public void setDashboardBackground(String dashboardBackground) {
		this.dashboardBackground = dashboardBackground;
	}

	public String getStoryTitle() {
		return storyTitle;
	}

	public void setStoryTitle(String storyTitle) {
		this.storyTitle = storyTitle;
	}

	public String getStoryBorder() {
		return storyBorder;
	}

	public void setStoryBorder(String storyBorder) {
		this.storyBorder = storyBorder;
	}

	public String getStoryBackground() {
		return storyBackground;
	}

	public void setStoryBackground(String storyBackground) {
		this.storyBackground = storyBackground;
	}

}

/**
 * 
 */
package com.jusfoun.jap.theme.mapper;

import java.util.List;

import com.jusfoun.jap.theme.domain.Theme;
import com.jusfoun.jap.theme.vo.ThemeVO;

/**
 * @author wcq
 *
 */
public interface ThemeMapper {
	public List<ThemeVO> getThemeList(Theme theme);
}

/**
 * 
 */
package com.jusfoun.jap.theme.service;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.theme.domain.Theme;
import com.jusfoun.jap.theme.mapper.ThemeMapper;
import com.jusfoun.jap.theme.vo.ThemeVO;

/**
 * @author wcq
 *
 */
@Service
public class ThemeService {
	@Autowired 
	protected ThemeMapper dao;
	
	public Result getThemeList(Theme theme){
		Result result = new Result();
		List<ThemeVO> themeList= new ArrayList<ThemeVO>();
		themeList = dao.getThemeList(theme);
		if(themeList!=null&&!"".equals(themeList)){
			for(ThemeVO Themevo:themeList){
				if(Themevo.getThemeColor()!=null&&!"".equals(Themevo.getThemeColor())){
					Themevo.setThemeColorArr(Themevo.getThemeColor().replace("[", "").replace("\"", "").replace("]", "").split(","));
				}
			}
		}
		result.setSuccess(true);
		result.setData(themeList);
		return result;
	}
}

/**
 * 
 */
package com.jusfoun.jap.theme.vo;

/**
 * @author wcq
 *
 */
public class ThemeVO {
	private String themeId;
	private String themeName;
	private String dashboardTitle;
	private String dashboardBorder;
	private String dashboardBackground;
	private String storyTitle;
	private String storyBorder;
	private String storyBackground;
	private String themeColor;
	private String[] themeColorArr;
	/**
	 * @return the themeColor
	 */
	public String getThemeColor() {
		return themeColor;
	}
	/**
	 * @param themeColor the themeColor to set
	 */
	public void setThemeColor(String themeColor) {
		this.themeColor = themeColor;
	}
	/**
	 * @return the themeId
	 */
	public String getThemeId() {
		return themeId;
	}
	/**
	 * @param themeId the themeId to set
	 */
	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}
	/**
	 * @return the themeName
	 */
	public String getThemeName() {
		return themeName;
	}
	/**
	 * @param themeName the themeName to set
	 */
	public void setThemeName(String themeName) {
		this.themeName = themeName;
	}
	/**
	 * @return the dashboardTitle
	 */
	public String getDashboardTitle() {
		return dashboardTitle;
	}
	/**
	 * @param dashboardTitle the dashboardTitle to set
	 */
	public void setDashboardTitle(String dashboardTitle) {
		this.dashboardTitle = dashboardTitle;
	}
	/**
	 * @return the dashboardBorder
	 */
	public String getDashboardBorder() {
		return dashboardBorder;
	}
	/**
	 * @param dashboardBorder the dashboardBorder to set
	 */
	public void setDashboardBorder(String dashboardBorder) {
		this.dashboardBorder = dashboardBorder;
	}
	/**
	 * @return the dashboardBackground
	 */
	public String getDashboardBackground() {
		return dashboardBackground;
	}
	/**
	 * @param dashboardBackground the dashboardBackground to set
	 */
	public void setDashboardBackground(String dashboardBackground) {
		this.dashboardBackground = dashboardBackground;
	}
	/**
	 * @return the storyTitle
	 */
	public String getStoryTitle() {
		return storyTitle;
	}
	/**
	 * @param storyTitle the storyTitle to set
	 */
	public void setStoryTitle(String storyTitle) {
		this.storyTitle = storyTitle;
	}
	/**
	 * @return the storyBorder
	 */
	public String getStoryBorder() {
		return storyBorder;
	}
	/**
	 * @param storyBorder the storyBorder to set
	 */
	public void setStoryBorder(String storyBorder) {
		this.storyBorder = storyBorder;
	}
	/**
	 * @return the storyBackground
	 */
	public String getStoryBackground() {
		return storyBackground;
	}
	/**
	 * @param storyBackground the storyBackground to set
	 */
	public void setStoryBackground(String storyBackground) {
		this.storyBackground = storyBackground;
	}
	public String[] getThemeColorArr() {
		return themeColorArr;
	}
	public void setThemeColorArr(String[] themeColorArr) {
		this.themeColorArr = themeColorArr;
	}
}

/**
 * 
 */
package com.jusfoun.jap.util.annotation;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
/**
 * @author xc
 *  自定义注解 拦截Controller
 */
@Target({ElementType.PARAMETER, ElementType.METHOD})    
@Retention(RetentionPolicy.RUNTIME)    
@Documented
public @interface SystemControllerLog {
	String description()  default "";
	String operType() default "";
	String module() default "";
}

/**
 * 
 */
package com.jusfoun.jap.util.annotation;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * @author xc
 *
 */
@Target({ElementType.PARAMETER, ElementType.METHOD})    
@Retention(RetentionPolicy.RUNTIME)    
@Documented
public @interface SystemLoginLog {

	String description()  default "";
	String operType() default "";
	String module() default "";
}

/**
 * 
 */
package com.jusfoun.jap.util.annotation;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * @author xc
 * 自定义注解 拦截service
 */
@Target({ElementType.PARAMETER, ElementType.METHOD})    
@Retention(RetentionPolicy.RUNTIME)    
@Documented
public @interface SystemServiceLog {

	String description()  default "";
	String operType() default "";
	String module() default "";
}

package com.jusfoun.jap.util.common;

import org.springframework.beans.BeansException;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;


public class SpringUtil implements ApplicationContextAware{
	
	private static ApplicationContext staticapplicationcontext;
	
	public void setApplicationContext(ApplicationContext applicationContext)
	  throws BeansException
	{
		SpringUtil.staticapplicationcontext = applicationContext;
	}

	public static Object getBean(String name) {
	  if (staticapplicationcontext != null) {
	    return staticapplicationcontext.getBean(name);
	  }
	  return null;
	}

	public static <T> T getBean(Class<T> clazz) {
	  if (staticapplicationcontext != null) {
	    return staticapplicationcontext.getBean(clazz);
	  }
	  return null;
	}

	public static ApplicationContext getApplicationContext() {
	  return staticapplicationcontext;
	}
	
}


package com.jusfoun.jap.util;

import java.util.MissingResourceException;
import java.util.ResourceBundle;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * 存放系统全局变量
 * 
 */
public final class Constant
{
    /**
     * 日志信息
     */
	private transient Logger logger = LoggerFactory.getLogger(getClass());
	
	/**
	 * phoenix url地址
	 */
	public static String PHOENIX_URL;

	/**
	 * hdfs url地址
	 */
	public static String HDFS_URL;
	
	/**
	 * kylin jdbc
	 */
	public static String KYLIN_URL;
	public static String KYLIN_USERNAME;
	public static String KYLIN_PASSWORD;
	public static String KYLIN_DATABASE;
	public static String KYLIN_PROJECTNAME;
	public static String KYLIN_ADDRESS;
	public static String KYLIN_AUTHORIZATION;
	
	public static String HIVE_DRIVERNAME;
	public static String HIVE_URL;
	public static String HIVE_SOURCE_DATABASE;
	public static String HIVE_ANALYSIS_DATABASE;
	//启动定时任务
	public static String JOB_ENABLE;
	
    static
    {
        initParam();
    }

    /**
     * 初始化系统参数
     */
    public static void initParam()
    {
    	PHOENIX_URL = InitParam.getInitParamMap().get("phoenix.url");
    	HDFS_URL = InitParam.getInitParamMap().get("hdfs.url");
    	KYLIN_URL= InitParam.getInitParamMap().get("kylin.url");
    	KYLIN_USERNAME= InitParam.getInitParamMap().get("kylin.username");
    	KYLIN_PASSWORD= InitParam.getInitParamMap().get("kylin.password");
    	KYLIN_DATABASE= InitParam.getInitParamMap().get("kylin.database");
    	KYLIN_ADDRESS = InitParam.getInitParamMap().get("kylin.address");
    	KYLIN_AUTHORIZATION = InitParam.getInitParamMap().get("kylin.authorization");
    	KYLIN_PROJECTNAME= InitParam.getInitParamMap().get("kylin.projectName");
    	HIVE_DRIVERNAME=InitParam.getInitParamMap().get("hive.drivername");
    	HIVE_URL=InitParam.getInitParamMap().get("hive.url");
    	HIVE_SOURCE_DATABASE=InitParam.getInitParamMap().get("hive.source.database");
    	HIVE_ANALYSIS_DATABASE=InitParam.getInitParamMap().get("hive.analysis.database");
    	JOB_ENABLE=InitParam.getInitParamMap().get("job.enable");
    	
    }
    
    /**
     * 日志模块，操作类型常量
     */
    public static final String LOGIN = "38D6D3B082CA36B4E050A8C0226414A3";
    public static final String LOGOUT = "38D6D3B082CE36B4E050A8C0226414A3";
    public static final String QUERY = "38D6D3B082C936B4E050A8C0226414A3";
    public static final String INSERT = "38D6D3B082CB36B4E050A8C0226414A3";
    public static final String UPDATE = "38D6D3B082CD36B4E050A8C0226414A3";
    public static final String DELETE = "38D6D3B082CC36B4E050A8C0226414A3";
    public static final String INSERT_UPDATE = "38D6D3B082D736B4E050A8C0226414A3";
    
    /**
     * 日志模块，模块id常量
     */
    public static final String DWFX = "38D6D3B082D436B4E050A8C0226414A3";
    public static final String XTGL_ZZGL = "38D6D3B082D336B4E050A8C0226414A3";
    public static final String XTGL_YHGL = "38D6D3B082D136B4E050A8C0226414A3";
    public static final String XTGL_CDGL = "38D6D3B082D036B4E050A8C0226414A3";
    public static final String XTGL_RZGL = "38D6D3B082CF36B4E050A8C0226414A3";
    public static final String XTGL_MXGL = "38D6D3B082D236B4E050A8C0226414A3";
    public static final String XTGL_YCSJGL = "38D6D3B082D536B4E050A8C0226414A3";
    public static final String XTGL_JSGL = "38D6D3B082D636B4E050A8C0226414A3";

    public static final String DEFAULT_ENTCRYPT_STR = "jusfoun_JAP_2016-8-10_19:59:37";
    public static final String DEFAULT_SF = "SHA-1";
    
    private static String getStringDefault(ResourceBundle rb, String key, String defaultvalue)
    {
        try
        {
            return rb.getString(key);
        }
        catch (MissingResourceException e)
        {
            return defaultvalue;
        }

    }


}

package com.jusfoun.jap.util;

import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.GregorianCalendar;

public class DateUtil
{
    private static final int LAST_SECOND_OF_MINUTE = 59;
    private static final int LAST_MINUTE_OF_HOUR = 59;
    private static final int LAST_HOUR_OF_DAY = 23;
    public static int YEAR = 1;
    public static int MONTH = 2;
    public static int WEEK_OF_YEAR = 3;
    public static int WEEK_OF_MONTH = 4;
    public static int DAY_OF_MONTH = 5;
    public static int DAY_OF_YEAR = 6;
    /** 年 格式化 */
    public static final String YEAR_MONTH = "yyyy-MM";
    /** 日期 格式化 */
    public static final String DATE = "yyyy-MM-dd";
    /** 日期时间 格式化 */
    public static final String TIMESTAMP = "yyyy-MM-dd HH:mm:ss";
    /** 时间 格式化 */
    public static final String TIME = "HH:mm:ss";
    /**
     * 返回指定日期类型日期增量日期
     * 
     * @param dateType 日期类型
     * @param count 增加数量，可以为负数
     * @return
     */
    public static Date getMagicDate(int dateType, int count)
    {
        Calendar calendar = new GregorianCalendar();
        Date todayTime = new Date();
        calendar.setTime(todayTime);
        calendar.add(dateType, count);
        return calendar.getTime();
    }

    /**
     * 返回指定日期类型日期增量日期
     * 
     * @param dateType 日期类型
     * @param count 增加数量，可以为负数
     * @param baseDate 参照日期
     * @return
     */
    public static Date getMagicDate(int dateType, int count, Date baseDate)
    {
        Calendar calendar = new GregorianCalendar();
        calendar.setTime(baseDate);
        calendar.add(dateType, count);
        return calendar.getTime();
    }

    public static String getDateNow()
    {
        return dateToString(new Date(), DATE);
    }

    /**
     * 日期转换为指定格式的字符
     * 
     * @param date 日期
     * @param dateFormat 日期格式
     * @return
     */
    public static String dateToString(Date date, String dateFormat)
    {
        SimpleDateFormat df = null;
        String returnValue = "";
        if (date != null)
        {
            df = new SimpleDateFormat(dateFormat);
            returnValue = df.format(date);
        }
        return returnValue;
    }

    public static Date getDayStartSeconds(Date date)
    {
        Date start = null;
        String dateStr = DateUtil.dateToString(date, "yyyy-MM-dd");
        try
        {
            start = DateUtil.stringToDate(dateStr, "yyyy-MM-dd");
        }
        catch (Exception e)
        {
            e.printStackTrace();
        }
        return start;
    }

    public static Date getDayEndSeconds(Date date)
    {
        Date end = null;
        String dateStr = DateUtil.dateToString(date, "yyyy-MM-dd");
        try
        {
            end = DateUtil.stringToDate(dateStr, "yyyy-MM-dd");
            end.setHours(23);
            end.setMinutes(59);
            end.setSeconds(59);
        }
        catch (Exception e)
        {
            e.printStackTrace();
        }
        return end;
    }

    /**
     * 日期字符串转换为日期格式
     * 
     * @param dateStr 日期字符串
     * @param dateFormat 日期格式
     * @return
     * @throws ParseException
     */
    public static Date stringToDate(String dateStr, String dateFormat) throws ParseException
    {
        SimpleDateFormat sf = new SimpleDateFormat(dateFormat);
        try
        {
            return sf.parse(dateStr);
        }
        catch (ParseException e)
        {
            e.printStackTrace();
            throw new ParseException("日期解析错误！", 0);
        }
    }

    /**
     * 获得当前日期与本周日相差的天数
     * 
     * @return 星期日是第一天，星期一是第二天......
     */
    public static int getMondayPlus()
    {
        Calendar cd = Calendar.getInstance();
        // 获得今天是一周的第几天，星期日是第一天，星期一是第二天......
        int dayOfWeek = cd.get(Calendar.DAY_OF_WEEK) - 1; // 因为按中国礼拜一作为第一天所以这里减1
        if (dayOfWeek == 1)
        {
            return 0;
        }
        else
        {
            return 1 - dayOfWeek;
        }
    }

    /**
     * 根据报表时间标志，取得时间段
     * 
     * @param timeType 时间标志
     * @return String[]
     * @throws ParseException
     * @throws ParseException
     */
    @SuppressWarnings("deprecation")
    public static String[] time(String timeType)
    {
        try
        {
            String[] time = new String[2];
            Timestamp beginTime = null;
            Timestamp endTime = null;
            java.util.Date today = new java.util.Date();
            java.util.GregorianCalendar calendar = new java.util.GregorianCalendar();
            calendar.setTime(today);
            if ("0".equals(timeType))
            {
                // 当天
                beginTime = new Timestamp(calendar.getTime().getTime());
                calendar.add(Calendar.DATE, 1);
                endTime = new Timestamp(calendar.getTime().getTime());
                time[0] = beginTime.toString().substring(0, 10);
                time[1] = endTime.toString().substring(0, 10);
            }
            else if ("1".equals(timeType))
            {
                // 前一天
                calendar.add(Calendar.DATE, -1);
                beginTime = new Timestamp(calendar.getTime().getTime());
                endTime = new Timestamp(calendar.getTime().getTime());
                time[1] = beginTime.toString().substring(0, 10) + " 23:59:59";
                time[0] = endTime.toString().substring(0, 10);
            }
            else if ("2".equals(timeType))
            {
                // 前三天
                calendar.add(Calendar.DATE, -1);
                beginTime = new Timestamp(calendar.getTime().getTime());
                calendar.add(Calendar.DATE, -2);
                endTime = new Timestamp(calendar.getTime().getTime());
                time[1] = beginTime.toString().substring(0, 10) + " 23:59:59";
                time[0] = endTime.toString().substring(0, 10);
            }
            else if ("3".equals(timeType))
            {
                // 上一周
                // 获取上周一的时间
                int weeks = 0;
                weeks--;
                int mondayPlus = getMondayPlus();
                calendar.add(Calendar.DATE, mondayPlus + 7 * weeks);
                beginTime = new Timestamp(calendar.getTime().getTime());
                // 获取上周日的时间
                calendar.add(Calendar.DATE, 6);
                endTime = new Timestamp(calendar.getTime().getTime());
                time[0] = beginTime.toString().substring(0, 10);
                time[1] = endTime.toString().substring(0, 10) + " 23:59:59";
            }
            else if ("4".equals(timeType))
            {
                // 上一月
                beginTime = new Timestamp(calendar.getTime().getTime());
                calendar.add(Calendar.MONTH, -1);
                beginTime = new Timestamp(calendar.getTime().getTime());
                time[0] = beginTime.toString().substring(0, 8) + "01";
                String endStr = beginTime.toString().substring(0, 5) + String.valueOf(beginTime.getMonth() + 2) + "-01";
                SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
                try
                {
                    calendar.setTime(sdf.parse(endStr));
                }
                catch (ParseException e)
                {
                    e.printStackTrace();
                }
                calendar.add(Calendar.DATE, -1);
                endTime = new Timestamp(calendar.getTime().getTime());
                time[1] = endTime.toString().substring(0, 10) + " 23:59:59";
            }
            else if ("5".equals(timeType))
            {
                // 上一季
                beginTime = new Timestamp(calendar.getTime().getTime());
                calendar.add(Calendar.MONTH, -3);
                endTime = new Timestamp(calendar.getTime().getTime());
                String beginTimeStr = beginTime.toString().substring(0, 8) + "01";
                SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
                calendar.setTime(sdf.parse(beginTimeStr));
                calendar.add(Calendar.DATE, -1);
                beginTime = new Timestamp(calendar.getTime().getTime());
                time[1] = beginTime.toString().substring(0, 10) + " 23:59:59";
                time[0] = endTime.toString().substring(0, 8) + "01";
            }
            else
            {
                // 去年
                beginTime = new Timestamp(calendar.getTime().getTime());
                calendar.add(Calendar.YEAR, -1);
                endTime = new Timestamp(calendar.getTime().getTime());
                time[1] = beginTime.toString().substring(0, 5) + "01-01";
                time[0] = endTime.toString().substring(0, 5) + "01-01";
            }
            return time;
        }
        catch (ParseException e)
        {
            e.printStackTrace();
            return null;
        }
    }

    /**
     * 获取当前日期格式 yyyy-MM-dd hh:mm:ss
     * 
     * @return the current date/time
     */
    public static String getDateTimeNow()
    {
        return dateToString(new Date(), TIMESTAMP);
    }

    /**
     * 获取日期间间隔秒数 getIntervalDays
     * 
     * @param startday
     * @param endday
     * @return
     */
    public static int getIntervalSeconds(Date startday, Date endday)
    {
        if (startday.after(endday))
        {
            Date cal = startday;
            startday = endday;
            endday = cal;
        }
        long sl = startday.getTime();
        long el = endday.getTime();
        long ei = el - sl;
        return (int) (ei / 1000);
    }

    /**
     * Date2 string.
     * 
     * @param pattern the pattern
     * @param date the date
     * @return the string
     */
    public static String dateToString(String pattern, Date date)
    {
        String date_string;
        SimpleDateFormat df = new SimpleDateFormat(pattern);
        if (date != null)
        {
            date_string = df.format(date);
        }
        else
        {
            return null;
        }
        return date_string;
    }

    /**
     * @brief 获取一个时间，这个时间是今天的第0秒
     * @return 时间
     */
    public static Date getTodayAtFirstSecond()
    {
        Calendar now = Calendar.getInstance();
        now.setTimeInMillis(System.currentTimeMillis());
        Calendar cal = Calendar.getInstance();
        cal.clear();
        cal.set(now.get(Calendar.YEAR), now.get(Calendar.MONTH), now.get(Calendar.DAY_OF_MONTH));
        return cal.getTime();
    }

    /**
     * @brief 获取一个时间，这个时间是今天的最后一秒
     * @return 时间
     */
    public static Date getTodayAtLastSecond()
    {
        Calendar now = Calendar.getInstance();
        now.setTimeInMillis(System.currentTimeMillis());
        Calendar cal = Calendar.getInstance();
        cal.clear();
        cal.set(now.get(Calendar.YEAR), now.get(Calendar.MONTH), now.get(Calendar.DAY_OF_MONTH), LAST_HOUR_OF_DAY,
                LAST_MINUTE_OF_HOUR, LAST_SECOND_OF_MINUTE);
        return cal.getTime();
    }

    /**
     * @brief 两个时间之间的天数
     * @param startDate
     * @param endDate
     * @return
     */
    public static int getDays(String startDate, String endDate, String fmt)
    {
        if (startDate == null || startDate.equals(" "))
            return 0;
        if (endDate == null || endDate.equals(" "))
            return 0;
        // 转换为标准时间
        SimpleDateFormat myFormatter = new SimpleDateFormat(fmt);
        java.util.Date date = null;
        java.util.Date mydate = null;
        try
        {
            date = myFormatter.parse(startDate);
            mydate = myFormatter.parse(endDate);
        }
        catch (Exception e)
        {
        }
        long day = (mydate.getTime() - date.getTime()) / (24 * 60 * 60 * 1000);
        return (int) day;
    }
}

package com.jusfoun.jap.util;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;

/**
 * 利用JAVA提供的MessageDigest进行加密处理
 * 
 * @author Administrator
 */
public class EncryptUtil
{
    public EncryptUtil()
    {
    }

    /**
     * @param strSrc 待加密字符串
     * @param encName 加密算法名称(example:MD5、SHA-1、SHA-256)
     * @return
     */
    public static String encrypt(String strSrc, String encName)
    {
        MessageDigest md = null;
        String strDes = null;
        byte[] bt = strSrc.getBytes();
        try
        {
            if (encName == null || "".equals(encName))
            {
                encName = "MD5";
            }
            md = MessageDigest.getInstance(encName);
            md.update(bt);
            strDes = bytes2Hex(md.digest()); // to HexString
        }
        catch (NoSuchAlgorithmException e)
        {
            System.out.println("Invalid algorithm.");
            return null;
        }
        return strDes;
    }

    /**
     * 返回hex字符串
     * 
     * @param bts
     * @return
     */
    public static String bytes2Hex(byte[] bts)
    {
        String des = "";
        String tmp = null;
        for (int i = 0; i < bts.length; i++)
        {
            tmp = (Integer.toHexString(bts[i] & 0xFF));
            if (tmp.length() == 1)
            {
                des += "0";
            }
            des += tmp;
        }
        return des;
    }
}

package com.jusfoun.jap.util.hive;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import com.jusfoun.jap.util.Constant;

public class JDBCToHiveUtils {
	
	private static Connection conn;


	public static Connection getConnnection(String url) {
		try {
			conn = DriverManager.getConnection(url, "", ""); // 此处的用户名一定是有权限操作HDFS的用户，否则程序会提示"permission
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return conn;
	}

	public static PreparedStatement prepare(Connection conn, String sql) {
		PreparedStatement ps = null;
		try {
			ps = conn.prepareStatement(sql);
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return ps;
	}

	public static void closeConnection(Connection con) {
		if (con != null) {
			try {
				con.close();
			} catch (Exception ex) {
			}
		}
	}

	public static void closeConnection(Connection con, Statement stat) {
		// 释放stat
		if (stat != null) {
			try {
				stat.close();
			} catch (Exception ex) {
			}
		}
		// 释放con
		closeConnection(con);
	}

	public static void closeConnection(Connection con, Statement stat, ResultSet rs) {
		// 释放rs
		if (rs != null) {
			try {
				rs.close();
			} catch (Exception ex) {
			}
		}
		// 释放stat,con
		closeConnection(con, stat);
	}
}

package com.jusfoun.jap.util.hive;

public class QueryHiveTest {

//	public static void main(String[] args) {
//		// TODO Auto-generated method stub
//		 String tablename="kylin_sales";
//
//         QueryHiveUtils.getAll(tablename);
//	}

}

package com.jusfoun.jap.util.hive;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import com.jusfoun.jap.util.Constant;

public class QueryHiveUtils {
	private static Connection conn=JDBCToHiveUtils.getConnnection(Constant.HIVE_URL+Constant.HIVE_ANALYSIS_DATABASE);

    private static PreparedStatement ps;

    private static ResultSet rs;

    public static void getAll(String tablename)

    {

        String sql="select * from "+tablename;

        System.out.println(sql);

        try {

            ps=JDBCToHiveUtils.prepare(conn, sql);

            rs=ps.executeQuery();

            int columns=rs.getMetaData().getColumnCount();

            while(rs.next())

            {

                for(int i=1;i<=columns;i++)

                {

                    System.out.print(rs.getString(i));

                    System.out.print("\t\t");

                }

                System.out.println();

            }

        } catch (SQLException e) {

            // TODO Auto-generated catch block

            e.printStackTrace();

        }

 

    }
}

package com.jusfoun.jap.util;

import java.util.Enumeration;
import java.util.Map;
import java.util.MissingResourceException;
import java.util.ResourceBundle;
import java.util.concurrent.ConcurrentHashMap;

import org.apache.log4j.Logger;

public class InitParam
{
    /**
     * 操作日志的逻辑实现类
     */
    private static Logger logger = Logger.getLogger(InitParam.class);

    private static ResourceBundle rb = null;

    /**
     * 初始化init.properties参数
     */
    private static Map<String, String> initParamMap = new ConcurrentHashMap<String, String>();

    static
    {
        try
        {
            // 读取版本配置文件
            rb = ResourceBundle.getBundle("application");
            Enumeration<String> keys = rb.getKeys();
            while (keys.hasMoreElements())
            {
                String key = keys.nextElement();
                initParamMap.put(key, rb.getString(key));
            }
        }
        catch (MissingResourceException e)
        {
            logger.error(e.getMessage(), e);
        }
    }

    public static Map<String, String> getInitParamMap()
    {
        return initParamMap;
    }
    
}

package com.jusfoun.jap.util;

import com.fasterxml.jackson.core.JsonParser;
import com.fasterxml.jackson.core.JsonParser.Feature;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;

public class JacksonUtil {
	public static ObjectMapper objectMapper;

	/**
	 * 使用泛型方法，把json字符串转换为相应的JavaBean对象。
	 * (1)转换为普通JavaBean：readValue(json,Student.class)
	 * (2)转换为List,如List<Student>,将第二个参数传递为Student
	 * [].class.然后使用Arrays.asList();方法把得到的数组转换为特定类型的List
	 * 
	 * @param jsonStr
	 * @param valueType
	 * @return
	 */
	public static <T> T readValue(String jsonStr, Class<T> valueType) {
		if (objectMapper == null) {
			objectMapper = new ObjectMapper();
			objectMapper.configure(JsonParser.Feature.ALLOW_SINGLE_QUOTES, true);
			objectMapper.configure(Feature.ALLOW_UNQUOTED_CONTROL_CHARS, true) ; 
		}

		try {
			return objectMapper.readValue(jsonStr, valueType);
		} catch (Exception e) {
			e.printStackTrace();
		}

		return null;
	}
	
	/**
	 * json数组转List
	 * @param jsonStr
	 * @param valueTypeRef
	 * @return
	 */
	public static <T> T readValue(String jsonStr, TypeReference<T> valueTypeRef){
		if (objectMapper == null) {
			objectMapper = new ObjectMapper();
		}

		try {
			return objectMapper.readValue(jsonStr, valueTypeRef);
		} catch (Exception e) {
			e.printStackTrace();
		}

		return null;
	}

	/**
	 * 把JavaBean转换为json字符串
	 * 
	 * @param object
	 * @return
	 */
	public static String toJSon(Object object) {
		if (objectMapper == null) {
			objectMapper = new ObjectMapper();
		}

		try {
			return objectMapper.writeValueAsString(object);
		} catch (Exception e) {
			e.printStackTrace();
		}

		return null;
	}

}

/**
 * 
 */
package com.jusfoun.jap.util.kylin;

import java.io.FileOutputStream;
import java.io.IOException;
import java.lang.reflect.Method;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;

import javax.servlet.ServletContext;

import org.apache.commons.lang.StringUtils;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;
import org.apache.kylin.jdbc.Driver;
import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFRichTextString;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.common.Results;
import com.jusfoun.jap.workTable.vo.ChartData;
import com.jusfoun.jap.workTable.vo.DataY;
import com.jusfoun.jap.workTable.vo.WorkTableDetail;

/**   
 * 此类描述的是：   从kylin获取数据
 * @author: 王存泉   
 * @version: 2016年6月3日 下午7:05:07    
 */

public class GetKylinData {
	public String  getData(String sql,String kylinUrl,String kylinUsername,String kylinPassword) throws SQLException, JSONException {
		Properties info = new Properties();
		Driver driver = null;
		try {
			driver = (Driver) Class.forName("org.apache.kylin.jdbc.Driver").newInstance();
		} catch (InstantiationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		info.put("user", kylinUsername);
		info.put("password", kylinPassword);
		Connection conn = driver.connect(kylinUrl, info);
		Statement state = conn.createStatement();
		ResultSet resultSet = state.executeQuery(sql);
		String result = "";
		result = resultSetToJson(resultSet);
		conn.close();
		state.close();
		return result;
	}
	public static List  getDataBean(StringBuffer sb,String kylinUrl,String kylinUsername,String kylinPassword,Class  cls) throws Exception {
		Properties info = new Properties();
		Driver driver = null;
		try {
			driver = (Driver) Class.forName("org.apache.kylin.jdbc.Driver").newInstance();
		} catch (InstantiationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		info.put("user", kylinUsername);
		info.put("password", kylinPassword);
		Connection conn = driver.connect(kylinUrl, info);
		Statement state = conn.createStatement();
		ResultSet resultSet = state.executeQuery(sb.toString());
		List resultList = new ArrayList();
		resultList = resultSetToList(resultSet,cls);
		conn.close();
		state.close();
		return resultList;
	}
	public static List resultSetToList(ResultSet rs, Class cls)throws Exception {  
        //取得Method   
        Method[] methods = cls.getDeclaredMethods();   
//       System.out.println(methods[0].getName());  
        List lst = new ArrayList();  
        // 用于获取列数、或者列类型  
        ResultSetMetaData meta = rs.getMetaData();  
        Object obj = null;  
        while (rs.next()) {  
            // 获取formbean实例对象  
            obj = cls.newInstance(); // 用Class.forName方法实例化对象和new创建实例化对象是有很大区别的，它要求JVM首先从类加载器中查找类，然后再实例化，并且能执行类中的静态方法。而new仅仅是新建一个对象实例  
            // 循环获取指定行的每一列的信息  
            for (int i = 1; i <= meta.getColumnCount(); i++) {  
                // 当前列名  
                String colName = meta.getColumnLabel(i);  
//                System.out.println("getColumnLabel结果为："+colName);
//                String colNames = meta.getColumnName(i);  //驼峰转化
//                String colName = camelName(colNames);
//               System.out.println("驼峰转化结果为："+colName);
                // 设置方法名  
                String setMethodName = "set" + colName;  
                    
                  
                 //遍历Method   
                for (int j = 0; j < methods.length; j++) {   
                    if (methods[j].getName().equalsIgnoreCase(setMethodName)) {   
                        setMethodName = methods[j].getName();   
                          
//                        System.out.println(setMethodName);  
                        // 获取当前位置的值，返回Object类型  
                        Object value = rs.getObject(colName);   
                        if(value == null){  
                        	value="";  
                        }  
                        //实行Set方法   
                        try {   
                            //// 利用反射获取对象  
                            //JavaBean内部属性和ResultSet中一致时候   
                            Method setMethod = obj.getClass().getMethod(   
                                    setMethodName, value.getClass());   
//                            Method setMethod = cls.getDeclaredMethod(StringHelper
//                                    .asserSetMethodName(StringHelper
//                                            .toJavaAttributeName(setMethodName)), String.class);   
                            setMethod.invoke(obj, value);   
                        } catch (Exception e) {   
                            //JavaBean内部属性和ResultSet中不一致时候，使用String来输入值。   
                           e.printStackTrace();  
                        }   
                    }   
                }   
            }  
            lst.add(obj);  
        }  
        return lst;  
} 
	public static  String resultSetToJson(ResultSet rs) throws SQLException,JSONException  
	{  
	   // json数组  
	   JSONArray array = new JSONArray();  
	    
	   // 获取列数  
	   ResultSetMetaData metaData = rs.getMetaData();  
	   int columnCount = metaData.getColumnCount();  
	    
	   // 遍历ResultSet中的每条数据  
	    while (rs.next()) {  
	        JSONObject jsonObj = new JSONObject();  
	         
	        // 遍历每一列  
	        for (int i = 1; i <= columnCount; i++) {  
	            String columnName =metaData.getColumnLabel(i);  
	            String value = rs.getString(columnName);  
	            if(value==null){
	            	value="";
	            }
	            jsonObj.put(columnName, value);  
	        }   
	        array.put(jsonObj);   
	    }  
	    
	   return array.toString();  
	}  
	public static  String resultSetToJson(ResultSet rs, List<String> dimSort, List<String> measureDuLiangName, List<String> measureDanWei) throws SQLException,JSONException  
	{  
	   // json数组  
	   JSONArray array = new JSONArray();  
	   JSONArray array1 = new JSONArray();
	   // 获取列数  
	   ResultSetMetaData metaData = rs.getMetaData();  
	   int columnCount = metaData.getColumnCount();  
	    
	   // 遍历ResultSet中的每条数据  
	    while (rs.next()) {  
	        JSONObject jsonObj = new JSONObject();  
	        array = new JSONArray();
	        // 遍历每一列  
	        for (int i = 1; i <= columnCount; i++) {
	        	jsonObj = new JSONObject();
	            String columnName =metaData.getColumnLabel(i);  
	            String value = rs.getString(columnName)==null?"未知":rs.getString(columnName);  
	            if(value==null){
	            	value="";
	            }
	            jsonObj.put("columnName", columnName);  
	            jsonObj.put("value", value); 
	            if(dimSort.size()>=i){
	            	jsonObj.put("columnNameCn", dimSort.get(i-1));
	            }else {
	            	jsonObj.put("columnNameCn", measureDuLiangName.get(i-dimSort.size()-1));
	            	jsonObj.put("unit", measureDanWei.get(i-dimSort.size()-1));
	            }
	            array.put(jsonObj);
	        } 
	        array1.put(array);
	    }  
	    
	   return array1.toString();
	}  
	
	
	public static Results  getMultidimenDataResult (StringBuffer maxAndMinSql,String dataType,List<String> measureDuLiangName,List<WorkTableDetail> measuresList, List<String> dimSort,List<String> measureDanWei,int dimSize,StringBuffer sb,String kylinUrl,String kylinUsername,String kylinPassword) throws SQLException, JSONException {
		Properties info = new Properties();
		Driver driver = null;
		try {
			driver = (Driver) Class.forName("org.apache.kylin.jdbc.Driver").newInstance();
		} catch (InstantiationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		info.put("user", kylinUsername);
		info.put("password", kylinPassword);
		Connection conn = driver.connect(kylinUrl, info);
		Statement state = conn.createStatement();
		ResultSet rsmaxAndMin = state.executeQuery(maxAndMinSql.toString());
		List<String> minY = new ArrayList<String>();//最小度量值合集
		List<String> maxY = new ArrayList<String>();//最大度量值合集
		if(rsmaxAndMin.next()){
			for(int mm=1;mm<=rsmaxAndMin.getMetaData().getColumnCount();mm++){
				int mo = (mm-1)%2;
				int dex = (mm-1)/2;
				if(mo==0){//最大值
					maxY.add(dex, rsmaxAndMin.getString(mm));
				}else minY.add(dex, rsmaxAndMin.getString(mm));
			}
		}
		conn.close();
		state.close();
		conn = driver.connect(kylinUrl, info);
		state = conn.createStatement();
		ResultSet rs = state.executeQuery(sb.toString());
		Results result = new Results();
        if(dataType.equals("table")){//表格
        	result.setData(resultSetToJson(rs,dimSort,measureDuLiangName,measureDanWei));
        } else if ("mixTwoDim".equals(dataType)||"mixTowDimLine".equals(dataType)){//两维多曲线 或者两维面积图
        	result.setData(resultSetToDD(rs,dimSort,measuresList,measureDuLiangName,measureDanWei));
        } else if ("mixTwoMeasure".equals(dataType)){//两度量
        	result.setData(resultSetToDM(rs,dimSort,measuresList,measureDuLiangName,measureDanWei));
        }else if ("mixTwoMeasureTwoY".equals(dataType)){//两度量双Y轴
        	result.setData(resultSetToDM(rs,dimSort,measuresList,measureDuLiangName,measureDanWei));
        }else {//多维图形
        	result = resltsetToPic( maxY, minY, rs,dimSize,dimSort,dataType, measureDuLiangName,measureDanWei);
        }
        	
		conn.close();
		state.close();
		return result;
	}
	private static ChartData resultSetToDM(ResultSet rs, List<String> dimSort, List<WorkTableDetail> measuresList,
			List<String> measureDuLiangName, List<String> measureDanWei) throws SQLException {
		ChartData returnChartData = new ChartData();
		List<String> dataX = new ArrayList<String>();
		List<String> datay1 = new ArrayList<String>();
		List<String> datay2 = new ArrayList<String>();
		DataY DataY1 = new DataY();
		DataY DataY2 = new DataY();
		List<DataY> dataY = new ArrayList<DataY>();
	    while (rs.next()) {
	    	dataX.add(rs.getString(1));
	    	datay1.add(rs.getString(measuresList.get(0).getTableColumn()));
	    	datay2.add(rs.getString(measuresList.get(1).getTableColumn()));
	    }
	    DataY1.setData_y(datay1);
	    DataY1.setNameDuliang(measureDuLiangName.get(0));
	    DataY1.setChartType(measuresList.get(0).getChartType());
	    DataY1.setUnitDuliang(measureDanWei.get(0));
	    DataY2.setData_y(datay2);
	    DataY2.setNameDuliang(measureDuLiangName.get(1));
	    DataY2.setChartType(measuresList.get(1).getChartType());
	    DataY2.setUnitDuliang(measureDanWei.get(1));
	    dataY.add(DataY1);
	    dataY.add(DataY2);
	    returnChartData.setDataY(dataY);
	    returnChartData.setNameWeidu(dimSort.get(0));
	    returnChartData.setDataX(dataX);
	    return returnChartData;
	}
	private static ChartData resultSetToDD(ResultSet rs, List<String> dimSort, List<WorkTableDetail> measuresList, List<String> measureDuLiangName,
			List<String> measureDanWei) throws SQLException{
			ChartData returnChartData = new ChartData();
			List<DataY> dataY = new ArrayList<DataY>();
			String dataType = measuresList.get(0).getChartType();
			DataY DataY = new DataY();
			List<String> datay = new ArrayList<String>();
			List<String> dataX = new ArrayList<String>();
			String firstDV = "";//第一维度的值用来比较当前的值是否改变；
			String secDv = "";
		   returnChartData.setNameWeidu(dimSort.get(1));//第二维度的名称
		   // 遍历ResultSet中的每条数据  
		    while (rs.next()) {  
		        if("".equals(firstDV)||firstDV.equals(rs.getString(1))){//第一行或者相等
		        	
		        	if("".equals(firstDV)){
		        		firstDV = rs.getString(1);
			        	DataY = new DataY();
			        	DataY.setNameDuliang(rs.getString(1));
			        	DataY.setChartType(dataType);
			        	DataY.setUnitDuliang(measureDanWei.get(0));
						datay = new ArrayList<String>();
			        }
		        	//dataX.add(rs.getString(2));
		        }else if(!firstDV.equals(rs.getString(1))){//不是第一行且或者是第一纬度值更改dataY需要新加datay数组
		        	firstDV = rs.getString(1);
		        	for(int i=datay.size();i<dataX.size();i++){
	        			datay.add(null);
	        		}
		        	DataY.setData_y(datay);
		        	dataY.add(DataY);
		        	DataY = new DataY();
		        	DataY.setChartType(dataType);
		        	DataY.setNameDuliang(rs.getString(1));
		        	DataY.setUnitDuliang(measureDanWei.get(0));
					datay = new ArrayList<String>();
		        }

	        	secDv = rs.getString(2);
	        	if(dataX.contains(secDv)){//包含该值
	        		if(datay.size()==dataX.indexOf(secDv)){//位置相同
	        			datay.add(rs.getString(3));
	        		}else if(datay.size()<dataX.indexOf(secDv)){//
	        			for(int i=0;i<dataX.indexOf(secDv)-datay.size();i++){//位置在后面
	        				datay.add(null);
	        			}
	        			datay.add(rs.getString(3));
	        		}else{//位置在前面
	        			datay.set(dataX.indexOf(secDv), rs.getString(3));
	        		}
	        	}else{//不包含该值1直接将该值添加至dataX，datay最后位置2.之前的datay要加null
	        		for(int i=datay.size();i<dataX.size();i++){
	        			datay.add(null);
	        		}
	        		datay.add(rs.getString(3));
	        		dataX.add(secDv);
	        		if(dataY!=null&&dataY.size()>0){
	        			for(DataY dy:dataY){
	        				dy.getData_y().add(null);
	        			}
	        		}
	        	}
		    }
		    //循环结束没有比较的行，将最后的列添加进来
		    for(int i=datay.size();i<dataX.size();i++){
    			datay.add(null);
    		}
		    DataY.setData_y(datay);
        	dataY.add(DataY);
		    returnChartData.setDataX(dataX);
        	returnChartData.setDataY(dataY);
        	return returnChartData;
	}
	public static Results resltsetToPic(List<String> maxY,List<String> minY,ResultSet rs,int dimSize,List<String> dimSort,String dataType,List<String> measureDuLiangName,List<String> measureDanWei) throws SQLException {
		Results result = new Results();
		ResultSetMetaData metaData = rs.getMetaData();  
		int columnCount = metaData.getColumnCount();//总共的列数量
		List<String> dataX = new ArrayList<String>();
		List<DataY> dataYs = new ArrayList<DataY>();
		DataY dataY = new DataY(); 
		if(dimSize==1){//维度只有1的时候
			ChartData chartData = new ChartData();
			List<ChartData> chartOneList = new ArrayList<ChartData>();
			int FirstFlag = 0;
			while (rs.next()) {
				FirstFlag++;
				//一维只需要直接拼接就可以
				String dataXNow = rs.getString(1);
				dataX.add(dataXNow);
				if(FirstFlag==1){//只有第一次的时候才会记录临时变量，第二个开始就需要判断当前和上次有没有变化来决定是否重新取值
					chartData.setNameWeidu(dimSort.get(0));//一维只需要赋值一次  维度名称 即大类名称
					for(int i = (1+dimSize);i <= columnCount;i++){//一维度量从第二列开始
						List<String> data_y = new ArrayList<String>();
						dataY = new DataY();
						dataY.setDataType(dataType);
						dataY.setNameDuliang(measureDuLiangName.get(i-dimSize-1));
						dataY.setUnitDuliang(measureDanWei.get(i-dimSize-1));
						data_y.add(rs.getString(i)==null?"未知":rs.getString(i));
						dataY.setData_y(data_y);
						dataYs.add(dataY);
					}
				}else{
					for(int i = (1+dimSize);i <= columnCount;i++){//取度量从第二列开始
						List<String> data_y = new ArrayList<String>();
						dataY = dataYs.get(i-1-dimSize);//数组是从0个开始需要减去维度个数
						data_y = dataY.getData_y();
						String value = rs.getString(i)==null?"未知":rs.getString(i);
						data_y.add(value);//减1是减去维度的个数
					}
				}
			}
			chartData.setDataY(dataYs);
			chartData.setDataX(dataX);
			chartOneList.add(chartData);
			result.setData(chartOneList);
		}
		if(dimSize>1){
			ChartData[] remarkCD = new ChartData[dimSize+1];//记录每层的对象，当发生改变时将该层及以后的放到前一层记录中，第一个位置存放虚拟的公共父级对象，用于将后面的数据添加进来
			List<List<ChartData>>  returnData = new ArrayList<List<ChartData>>();//
			String [] remarkDV = new String [dimSize-1];//记录每层维度的值，用来和下一层对比
			for(int i=0;i<dimSize+1;i++){
				remarkCD[i] = new ChartData();
				returnData.add(i, new ArrayList<ChartData>());
			}
			while (rs.next()) {
				for(int i = 1;i<=columnCount;i++){
					if(i<dimSize){//前面的维度层
						if(remarkDV[i-1]==null||remarkDV[i-1]==""||rs.getString(i) ==remarkDV[i-1]||(rs.getString(i)==null?("未知").equals(remarkDV[i-1]):rs.getString(i).equals(remarkDV[i-1]))){//第一行数据，数组是空的。值相同
							remarkDV[i-1] = rs.getString(i)==null?"未知":rs.getString(i);
							remarkCD[i].setNameWeidu(dimSort.get(i-1));
							remarkCD[i].setValueName(rs.getString(i)==null?"未知":rs.getString(i));
						}else{//当前维度层值发生变化
							for(int iBack=dimSize;iBack>=i;iBack-- ){//逐层回收到上层数据
								ChartData ChartData = new ChartData();
								ChartData = remarkCD[iBack];
								ChartData.setData(null);
								returnData.get(iBack).add(ChartData);
								remarkCD[iBack-1].setColspan(remarkCD[iBack-1].getColspan()+remarkCD[iBack].getColspan());//将下级占的列加到自己上
								List<ChartData> listdatax = remarkCD[iBack-1].getData();
								if(listdatax == null){
									listdatax = new ArrayList<ChartData>();
								}
								listdatax.add(remarkCD[iBack]);
								remarkCD[iBack-1].setData(listdatax);
								if(iBack<dimSize){
									remarkDV[iBack-1] = rs.getString(iBack)==null?"未知":rs.getString(iBack);//将用来对比维度值得数组置空
								}
								remarkCD[iBack] = new ChartData();//被回收的位置的对象改为新的对象
							}
							//第一个发生改变的位置的对象及对比值置为当前值
							remarkCD[i].setNameWeidu(dimSort.get(i-1));
							remarkCD[i].setValueName(rs.getString(i)==null?"未知":rs.getString(i));
						}
					}else if(i==dimSize){//后面的数据层（一个datax）
						remarkCD[i].setColspan(1);
						remarkCD[i].setNameWeidu(dimSort.get(i-1));
						List xList = remarkCD[dimSize].getDataX();//存放x数据集
						if(xList==null){
							xList = new ArrayList();
						}
						xList.add(rs.getString(i)==null?"未知":rs.getString(i));
						remarkCD[dimSize].setDataX(xList);
					}else{//后面的数据层（一个或多个datay）
						List<DataY> yList = remarkCD[dimSize].getDataY();//存放y数据集
						if(yList==null){
							yList = new ArrayList<DataY>();
						}
						if(yList.size()<i-dimSize){//第一次添加该度量的值
							DataY datay = new DataY();
							datay.setDataType(dataType);
							datay.setNameDuliang(measureDuLiangName.get(i-dimSize-1));
							datay.setUnitDuliang(measureDanWei.get(i-dimSize-1));
							List<String> data_y = datay.getData_y();
							if(data_y==null){
								data_y=new ArrayList<String>();
							}
							data_y.add(rs.getString(i)==null?"未知":rs.getString(i));
							datay.setData_y(data_y);
							datay.setMinY(minY.get(i-dimSize-1));
							datay.setMaxY(maxY.get(i-dimSize-1));
							yList.add(datay);
							remarkCD[dimSize].setDataY(yList);
						}else{//之前插入过该度量的值
							DataY datay = yList.get(i-dimSize-1);
							List<String> data_y = datay.getData_y();
							data_y.add(rs.getString(i)==null?"未知":rs.getString(i));
							datay.setData_y(data_y);
						}
					}
				}
			}
			for(int iBack=dimSize;iBack>=1;iBack-- ){//逐层回收到上层数据*最后的数据没有后面的维度值与之对比所以自动将不为空的对象回收
				List<ChartData> listdatax = remarkCD[iBack-1].getData();
				ChartData ChartData = new ChartData();
				ChartData = remarkCD[iBack];
				ChartData.setData(null);
				returnData.get(iBack).add(ChartData);
				remarkCD[iBack-1].setColspan(remarkCD[iBack-1].getColspan()+remarkCD[iBack].getColspan());//将下级占的列加到自己上
				if(listdatax == null){
					listdatax = new ArrayList<ChartData>();
				}
				listdatax.add(remarkCD[iBack]);
				remarkCD[iBack-1].setData(listdatax);
			}
			returnData.remove(0);
			result.setData(returnData);
		}
		return result;
	}
	public String getKylinData(String url,String authorization){
        DefaultHttpClient httpClient = new DefaultHttpClient();
        HttpGet httpGet = new HttpGet(url);
        httpGet.addHeader("Authorization", authorization);
        String responseString = "";
        try {            
            HttpResponse response = httpClient.execute(httpGet);            
            HttpEntity httpEntity = response.getEntity();            
            responseString = EntityUtils.toString(httpEntity);   
        } catch (ClientProtocolException e) {
        } catch (IOException e) {    
//            ipFlag = false;            
        } catch (Exception e) {
//            ipFlag = false;            
        }
		return responseString;
	}
	public static Results getDoubleDemType(StringBuffer sql) {
		// TODO Auto-generated method stub
		return null;
	}
	public static  Result exportExcel(String workTableName, List<String> measureDuLiangName, List<WorkTableDetail> measuresList,
			List<String> dimSort, List<String> measureDanWei, int dimSize, StringBuffer sql, String kylinUrl,
			String kylinUsername, String kylinPassword) throws SQLException, IOException {
		Result result = new Result();
		Properties info = new Properties();
		Driver driver = null;
		try {
			driver = (Driver) Class.forName("org.apache.kylin.jdbc.Driver").newInstance();
		} catch (InstantiationException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IllegalAccessException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (ClassNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		info.put("user", kylinUsername);
		info.put("password", kylinPassword);
		Connection conn = driver.connect(kylinUrl, info);
		Statement state = conn.createStatement();
		ResultSet rs = state.executeQuery(sql.toString());
		  
		   // 获取列数  
		   ResultSetMetaData metaData = rs.getMetaData();  
		   int columnCount = metaData.getColumnCount();
		   if(StringUtils.isEmpty(workTableName)){
			   workTableName="新建数据分析";
		   }
		   SimpleDateFormat dateFormater = new SimpleDateFormat("yyyyMMddhhmmss");
		   Date date=new Date();
		   workTableName = workTableName+dateFormater.format(date)+".xls";
		   FileOutputStream fos = new FileOutputStream(workTableName);
		   HSSFWorkbook wb = new HSSFWorkbook();
      	   HSSFSheet s = wb.createSheet();
      	   wb.setSheetName(0, "Sheet1");
		   // 遍历ResultSet中的每条数据  
      	   HSSFRow row = s.createRow(0);
	      	 for (int i = 1; i <= columnCount; i++) {
	      		HSSFCell cell = row.createCell(i-1);
	      		if(dimSort.size()>=i){
	      			HSSFRichTextString hts=new HSSFRichTextString(dimSort.get(i-1));
	      			cell.setCellValue(hts);
	            }else {
	            	HSSFRichTextString hts=new HSSFRichTextString(measureDuLiangName.get(i-dimSort.size()-1)+"("+measureDanWei.get(i-dimSort.size()-1)+")");
	            	cell.setCellValue(hts);
	            }
	      	 }
      	   int rowCount =0;
		    while (rs.next()) {
		    	row = s.createRow(++rowCount);
		        // 遍历每一列  
		        for (int i = 1; i <= columnCount; i++) {
		        	 HSSFCell cell = row.createCell(i-1);
		            String columnName =metaData.getColumnLabel(i);  
		            String value = rs.getString(columnName);  
		            if(value==null){
		            	value="";
		            }
		            HSSFRichTextString hts=new HSSFRichTextString(value);
		        	 cell.setCellValue(hts);
		        } 
		    } 
		 wb.write(fos);
		 fos.flush();
       	 fos.close();
       	result.setData(workTableName);
		return result;
	}
	
}

package com.jusfoun.jap.util;

import java.io.UnsupportedEncodingException;
import java.math.BigDecimal;
import java.net.URLEncoder;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.regex.Pattern;

public final class StringUtil
{
    
    /**
     * 如果对象Null或"null"返回空字符串.
     * 
     * @param obj 需要toString的对象
     * @return string 返回非空的字符串
     */
    public static String notNull(Object obj)
    {
        return notNull(obj, false);
    }

    /**
     * Not null.
     * 
     * @param obj the obj
     * @param stutas the stutas 是否严格校验 "null"字符串
     * @return the string
     */
    public static String notNull(Object obj, boolean stutas)
    {
        String strString = "";
        if (obj != null)
        {
            if (stutas)
            {
                strString = obj.toString();
            }
            else
            {
                strString = obj.toString().trim();
                if ("null".equals(strString))
                {
                    return "";
                }
            }
        }
        return strString;
    }

    public static boolean isNull(Object obj)
    {
        if (obj != null)
        {
            String str = obj.toString().trim();
            return str.isEmpty() || "null".equals(str.toLowerCase());
        }
        else
        {
            return true;
        }
    }

    public static String valueOf(Object value)
    {
        return value != null ? String.valueOf(value) : "";
    }

    /**
     * Checks if is empty.
     * 
     * @param str the str
     * @return true, if is empty
     */
    public static boolean isEmpty(Object str)
    {
        return str == null || str.toString().isEmpty();
    }

    /**
     * Checks if is not empty.
     * 
     * @param str the str
     * @return true, if is not empty
     */
    public static boolean isNotEmpty(Object str)
    {
        return !StringUtil.isEmpty(str);
    }

    /**
     * 方法定义：toBoolean<br>
     * 用途说明： 将字符串y|yes|true|1 转换成true否则false<br>
     * 例如：toBoolean("y") 返回true.
     * 
     * @param theString 需要判断的字符串
     * @return boolean 返回布尔值true|false
     */
    public static boolean toBoolean(String theString)
    {
        if (theString == null)
        {
            return false;
        }
        theString = theString.trim();
        if (theString.equalsIgnoreCase("y") || theString.equalsIgnoreCase("yes") || theString.equalsIgnoreCase("true")
                || theString.equalsIgnoreCase("1"))
        {
            return true;
        }
        return false;
    }

    public static boolean toBoolean(Object obj)
    {
        if (obj == null)
        {
            return false;
        }
        return toBoolean(obj.toString());
    }

    /**
     * 将字符串按指定加密类型加密支持MD5 SHA-1.
     * 
     * @param data 需要Hash的字符串
     * @param type 加密类型 （"MD5" or "SHA-1"）
     * @return 返回的加密字串，SHA1是产生一个20字节的二进制数组
     */
    public static synchronized String hashKey(String data, String type)
    {
        MessageDigest digest = null;
        if (digest == null)
        {
            try
            {
                digest = MessageDigest.getInstance(type);
            }
            catch (NoSuchAlgorithmException nsae)
            {
                System.err.println("Failed to load the MD5 MessageDigest. ");
            }
        }
        digest.update(data.getBytes());
        return byteToHex(digest.digest());
    }

    /**
     * 字符串不能为"" 或 null 如果是则返回异常.
     * 
     * @param theString 需要断言的字符串
     * @param theMessage 是null或空白时,相应的错误提示信息
     * @throws IllegalArgumentException
     *             是一个RuntimeException运行时异常不强制捕获异常，如果需要时可以主动捕获异常。
     */
    public static void assertNotBlank(String theString, String theMessage)
    {
        if (theString == null)
        {
            throw new IllegalArgumentException("Null argument not allowed: " + theMessage);
        }
        if ("".equals(theString.trim()))
        {
            throw new IllegalArgumentException("Blank argument not allowed: " + theMessage);
        }
    }

    /**
     * 判断指定的String是否为一个Integer 整数.
     * 
     * @param theString 需要断言的字符串
     * @param theMessage 不是number时,相应的错误提示信息
     * @return the int
     * @throws IllegalArgumentException 如果表示number,则throw 此exception,
     * @see #assertNotBlank(String,String)
     */
    public static int assertInteger(String theString, String theMessage)
    {
        assertNotBlank(theString, theMessage);
        try
        {
            int result = Integer.parseInt(theString);
            return result;
        }
        catch (NumberFormatException e)
        {
            throw new IllegalArgumentException("[" + theString + "]is not a integer value." + theMessage);
        }
    }

    /**
     * 获取字符32位字符串的UUID（唯一）.
     * 
     * @return the UUID
     */
    public static String getUUID()
    {
        String uuid = java.util.UUID.randomUUID().toString();
        return uuid.replaceAll("-", "");
    }

    /**
     * 获取UUID的HashCode.
     * 
     * @return the uUID hash code
     */
    public static long getUUIDHashCode()
    {
        return getUUID().hashCode();
    }

    /**
     * 获取Long型的UUID（唯一）.
     * 
     * @return the UUID least bits
     */
    public static long getUUID2Long()
    {
        return java.util.UUID.randomUUID().getLeastSignificantBits() * -1;
    }

    /**
     * 判断指定的String是否为一个boolean.
     * 
     * @param theString 需要断言的字符串
     * @param theMessage 不是boolean时,相应的错误提示信息
     * @throws IllegalArgumentException 如果表示boolean,则throw 此exception,
     * @see #assertNotBlank(String,String)
     */
    public static void assertBoolean(String theString, String theMessage)
    {
        assertNotBlank(theString, theMessage);
        if (!(theString.equalsIgnoreCase("yes") || theString.equalsIgnoreCase("true")
                || theString.equalsIgnoreCase("no") || theString.equalsIgnoreCase("false")
                || theString.equalsIgnoreCase("y") || theString.equalsIgnoreCase("n")))
        {
            throw new IllegalArgumentException("[" + theString + "]is not a boolean value." + theMessage);
        }
    }

    /**
     * 用于把Request para 的encoding <br>
     * 从缺省的ISO8859-5 转换为指定的Encoding.
     * 
     * @param value the value
     * @param newEncoding , if = null, default set to "GBK"
     * @return 做过Encoding变换的String
     * @history 2004/06/25 getBytes的时候应该指定用ISO-8859-1
     */
    public static String convertEncoding(String value, String newEncoding)
    {
        if (value == null)
        {
            return "";
        }
        if (newEncoding == null)
        {
            newEncoding = "GBK";
        }
        try
        {
            return new String(value.getBytes("ISO-8859-1"), newEncoding);
        }
        catch (java.io.UnsupportedEncodingException use)
        {
            return use.toString();
        }
    }

    /**
     * 字节数组转换为十六进制字符串.
     * 
     * @param hash 需要转换的字节数组
     * @return 返回的十六进制字符串
     */
    public static String byteToHex(byte hash[])
    {
        StringBuffer buf = new StringBuffer(hash.length * 2);
        int i;
        for (i = 0; i < hash.length; i++)
        {
            if ((hash[i] & 0xff) < 0x10)
            {
                buf.append("0");
            }
            buf.append(Long.toString(hash[i] & 0xff, 16));
        }
        return buf.toString();
    }

    /**
     * 对字符串进行处理，使得它能够在HTML页面上进行正常表示 <br />
     * 具体转换的内容是： <table border="1">
     * <tr>
     * <td>原内容</td>
     * <td>转换后</td>
     * </tr>
     * <tr>
     * <td>"<" </td>
     * <td>"&amp;lt;" </td>
     * </tr>
     * <tr>
     * <td>">" </td>
     * <td>"&amp;gt;" </td>
     * </tr>
     * <tr>
     * <td>"&" </td>
     * <td>"&amp;amp;" </td>
     * </tr>
     * <tr>
     * <td>"\"' </td>
     * <td>"&amp;quot;" </td>
     * </tr>
     * <tr>
     * <td>"\r" </td>
     * <td> "&lt;BR&gt;"</td>
     * </tr>
     * <tr>
     * <td>"\n" </td>
     * <td>"&lt;BR&gt;" </td>
     * </tr>
     * <tr>
     * <td>"\t" </td>
     * <td>4个Space </td>
     * </tr>
     * <tr>
     * <td>Space </td>
     * <td>"&amp;nbsp;" </td>
     * </tr>
     * </table>.
     * 
     * @param value 目标字符串
     * @return 返回字符串
     */
    public static String filter(String value)
    {
        if (value == null)
        {
            return null;
        }
        StringBuffer result = new StringBuffer();
        for (int i = 0; i < value.length(); i++)
        {
            char ch = value.charAt(i);
            if (ch == '<')
            {
                result.append("&lt;");
            }
            else if (ch == '>')
            {
                result.append("&gt;");
            }
            else if (ch == '&')
            {
                result.append("&amp;");
            }
            else if (ch == '"')
            {
                result.append("&quot;");
            }
            else if (ch == '\r')
            {
                result.append("<BR>");
            }
            else if (ch == '\n')
            {
                if (!(i > 0 && value.charAt(i - 1) == '\r'))
                {
                    result.append("<BR>");
                }
            }
            else if (ch == '\t')
            {
                result.append("&nbsp;&nbsp;&nbsp;&nbsp");
            }
            else if (ch == ' ')
            {
                result.append("&nbsp;");
            }
            else
            {
                result.append(ch);
            }
        }
        return result.toString();
    }

    /**
     * 对目前的支持Word联动的HTML编辑器的Filter功能.
     * 
     * @param value the value
     * @return String
     */
    public static String filterForHtmlEditor(String value)
    {
        if (value == null)
        {
            return null;
        }
        StringBuffer result = new StringBuffer();
        for (int i = 0; i < value.length(); i++)
        {
            char ch = value.charAt(i);
            if (ch == '\r')
            {
                result.append("");
            }
            else if (ch == '\n')
            {
                if (!(i > 0 && value.charAt(i - 1) == '\r'))
                {
                    result.append("");
                }
            }
            else if (ch == '\t')
            {
                result.append("    ");
            }
            else
            {
                result.append(ch);
            }
        }
        return result.toString();
    }

    /**
     * 数字转换成字母.
     * 
     * @param number the number
     * @param upperCaseFlag 大小写标示
     * @return java.lang.String
     * @throws Exception the exception
     */
    public static String numberToLetter(int number, boolean upperCaseFlag) throws Exception
    {
        // add nine to bring the numbers into the right range (in java, a= 10, z
        // = 35)
        if (number < 1 || number > 26)
        {
            throw new Exception("The number is out of the proper range (1 to " + "26) to be converted to a letter.");
        }
        int modnumber = number + 9;
        char thechar = Character.forDigit(modnumber, 36);
        if (upperCaseFlag)
        {
            thechar = Character.toUpperCase(thechar);
        }
        return "" + thechar;
    }

    /**
     * 字符串转换成整数.
     * 
     * @param value the value
     * @return the integer
     */
    public static Integer string2Integer(String value)
    {
        if (value != null && value.length() > 0)
        {
            boolean flag = Pattern.matches("-?\\d+", value);
            if (flag)
            {
                return Integer.valueOf(value);
            }
            else
            {
                throw new NumberFormatException();
            }
        }
        else
        {
            return null;
        }
    }

    /**
     * 字符串转换成长整数.
     * 
     * @param value the value
     * @return the long
     */
    public static Long string2Long(String value)
    {
        if (value != null && value.length() > 0)
        {
            boolean flag = Pattern.matches("-?\\d+", value);
            if (flag)
            {
                return Long.valueOf(value);
            }
            else
            {
                throw new NumberFormatException();
            }
        }
        else
        {
            return null;
        }
    }

    /**
     * 字符串转换成小数.
     * 
     * @param value the value
     * @return the big decimal
     */
    public static BigDecimal string2BigDecimal(String value)
    {
        if (value != null && value.length() > 0)
        {
            boolean flag = Pattern.matches("-?[0-9]+(.[0-9]+)?", value);
            if (flag)
            {
                return new BigDecimal(value);
            }
            else
            {
                throw new NumberFormatException();
            }
        }
        else
        {
            return null;
        }
    }

    /**
     * 字符串转换成短整数.
     * 
     * @param value the value
     * @return the short
     */
    public static Short string2Short(String value)
    {
        if (value != null && value.length() > 0)
        {
            boolean flag = Pattern.matches("-?\\d+", value);
            if (flag)
            {
                return Short.valueOf(value);
            }
            else
            {
                throw new NumberFormatException();
            }
        }
        else
        {
            return null;
        }
    }

    /**
     * 字符串转换成短整数.
     * 
     * @param value the value
     * @return the byte[]
     */
    public static byte[] string2Blob(String value)
    {
        if (value != null && value.length() > 0)
        {
            return value.getBytes();
        }
        else
        {
            return null;
        }
    }

    /**
     * To string.
     * 
     * @param object object
     * @return string
     */
    public static String toString(Object object)
    {
        String value = String.valueOf(object);
        if ("null".equals(value))
        {
            return null;
        }
        return value;
    }

    /**
     * 特殊字符转义.
     * 
     * @param specialCharacters 包含特殊字符的字符串
     * @return 返回转义后的字符串
     */
    public static String escapeSpecialCharacters(String specialCharacters)
    {
        return specialCharacters.replaceAll(Pattern.quote("\\"), "\\\\\\\\").replaceAll("%", "\\\\%").replaceAll("_",
                "\\\\_");
    }

    /**
     * 处理字符串空值 nvl
     * 
     * @param s
     * @return
     */
    public static String nvl(String s)
    {
        return nvl(s, "");
    }

    /**
     * 带默认值处理字符串空值 nvl
     * 
     * @param s
     * @param defaultValue
     * @return
     */
    public static String nvl(String s, String defaultValue)
    {
        if (s == null || "".equals(s) || "null".equals(s))
        {
            s = defaultValue;
        }
        return s;
    }

    /**
     * 将NULL的OBJECT转化为字符串"&nbsp"
     * 
     * @param obj
     * @return
     */
    public static String null2HtmlBlank(Object obj)
    {
        if (obj == null)
        {
            return "&nbsp";
        }
        else
        {
            return String.valueOf(obj);
        }
    }


    public static boolean isEmptyByObject(Object value)
    {
        return value == null ? true : value.toString().isEmpty() ? true : false;
    }

    public static boolean isNotEmptyByObject(Object value)
    {
        return !isEmpty(value);
    }

}

package com.jusfoun.jap.workTable.controller;

import java.io.IOException;
import java.sql.SQLException;
import java.util.List;
import javax.annotation.Resource;

import org.json.JSONException;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.itmuch.core.util.SubjectUtil;
import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.common.Results;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.dashboard.service.DashboardService;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.workTable.domain.ColumnChinese;
import com.jusfoun.jap.workTable.service.WorkTableService;
import com.jusfoun.jap.workTable.vo.ConnectionVO;
import com.jusfoun.jap.workTable.vo.CubeDimVo;
import com.jusfoun.jap.workTable.vo.Measures;
import com.jusfoun.jap.workTable.vo.WorkTableCondition;
import com.jusfoun.jap.workTable.vo.WorkTableVo;

@RestController
@RequestMapping(value = "/workTable")
public class WorkTableController {

	@Resource
	private WorkTableService workTableService;
	@Resource
	private DashboardService dashboardService;
	
	@RequestMapping("")
	//@RequiresPermissions("sys:cube:view")
	public String index() {
		return "workTable/html/zztzfx/html/zztzfx_work";
	}

	/**
	 * 加载单个cube详细信息，输入参数为cubeId
	 *
	 * @param pageVo
	 * @param cubeVo
	 * @return
	 */
	@RequestMapping("/getFactTableRule")
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public Result getFactTableRule(Measures measures) {
		Result result = new Result();
		result = workTableService.getFactTableRule(measures);
		return result;
	}

	@RequestMapping("/getCubeDetailById")
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public Result cubeQueryByCubeId(CubeVo cubeVo) {
		Result result = new Result();
		result = workTableService.queryByCubeId(cubeVo);
		return result;
	}
	/**
	 * 根据选择的维度，查询维度的取值范围，入参为维度名称
	 *
	 * @param cubeDimVo
	 * @return
	 */
	@RequestMapping("/queryByCondition")
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public Result queryByCondition(CubeDimVo cubeDimVo) {
		return workTableService.queryByCondition(cubeDimVo);
	}


	

	/**
	 * 根据cubeId和tableName查询出关联条件
	 *
	 * @param cubeDimVo
	 * @return
	 */
	public List<CubeDimVo> getConnectByCubeIdAndTableName(ConnectionVO connectionVO) {
		List<CubeDimVo> listDim = workTableService.getConnectByCubeIdAndTableName(connectionVO);
		return listDim;
	}

	/**
	 * 根据cubeId查询cube描述
	 *
	 * @param cubeDimVo
	 * @return
	 */
	public String queryCubeDescriptionByCubeId(CubeVo cubeVo) {
		String cubeDescription = workTableService.queryCubeDescriptionByCubeId(cubeVo);
		return cubeDescription;
	}

	/**
	 * 根据cubeId查询度量列中文名称
	 *
	 * @param cubeVo
	 * @return
	 */
	public List<ColumnChinese> queryFactByCubeId(CubeVo cubeVo) {
		List<ColumnChinese> listFact = workTableService.queryFactByCubeId(cubeVo);
		return listFact;
	}

	/**
	 * 1.获取json转换为WorkCondition的对象 2.存储work_table表 3.存储work_table_detail表
	 * @return 
	 *
	 *
	 * @return
	 */
	@RequestMapping("/saveWorkTable")
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public Result saveWorkTable(@ModelAttribute("workConditionString") String workConditionString) {
		return workTableService.saveWorkTable(workConditionString);
	}

	@RequestMapping("/queryWorkTable")
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public List<WorkTableVo> queryWorkTable(WorkTableVo workTable) {
		workTable.setUserId(SubjectUtil.getUserId().toString());
		List<WorkTableVo> tableList = workTableService.queryWorkTable(workTable);
		return tableList;
	}

	@RequestMapping("/showWorkTable")
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public WorkTableCondition showWorkTable(WorkTableCondition workTable) {
		WorkTableCondition workTable1 = workTableService.showWorkTable(workTable);
		return workTable1;
	}
	
	
	
	@RequestMapping(value = "/getKylinByCondition",	consumes=MediaType.APPLICATION_JSON_UTF8_VALUE)
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public Results getKylinByCondition(@RequestBody WorkTableCondition workTableCondition) throws SQLException, JSONException{
        return workTableService.getKylinByCondition(workTableCondition);
	}
	
	//复制数据分析
	@RequestMapping(value="/{workTableId}",method=RequestMethod.POST)
	 public void copyWorktable(WorkTableVo WorkTableVo){
		workTableService.copyWorktable(WorkTableVo);
	 }
	
	//删除数据分析
	@RequestMapping(value="/{workTableId}",method=RequestMethod.DELETE)
	 public Results delWorktable(WorkTableVo WorkTableVo){
		Results result = new Results();
		String listPie = workTableService.delWorktable(WorkTableVo);//返回挂载该工作表的仪表盘
		result.setData(listPie);
		return result;
	 }
	
	@RequestMapping(value="/getKylinListByCondition",consumes=MediaType.APPLICATION_JSON_UTF8_VALUE,method=RequestMethod.POST)
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public DashboardVo getListKylinByCondition(@RequestBody DashboardVo DashboardVo) throws SQLException, JSONException{
        return dashboardService.getListKylinByCondition(DashboardVo.getWorkTables());
	}
	
	
	@RequestMapping(value = "/exportExcel",	consumes=MediaType.APPLICATION_JSON_UTF8_VALUE)
	@ResponseBody
	//@RequiresPermissions("sys:cube:view")
	public Result exportExcel(@RequestBody WorkTableCondition workTableCondition) throws SQLException, JSONException, IOException{
        return workTableService.exportExcel(workTableCondition);
	}
	
}

package com.jusfoun.jap.workTable.domain;

import java.util.List;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;
import com.itmuch.core.entity.BaseEntity;
import com.jusfoun.jap.workTable.vo.RuleVO;

@Table(name = "T_COLUMN_CHINESE")
public class ColumnChinese {
	
	@Id
    @Column(name = "ID")
    private String id;
	private String factRules;
	private List<RuleVO> rules;
	private String cubeName;
	@Column(name = "COLUMN_NAME")
    private String tableColumn;
    
	@Column(name = "COLUMN_NAME_CN")
    private String tableColumnCn;
	
	@Column(name = "COLUMN_ORDER")
    private Integer columnOrder;
    
	@Column(name = "TABLE_NAME")
    private String tableName;
	
	@Column(name = "TABLE_NAME_CN")
    private String tableNameCn;
	
	@Column(name = "NEXT_FLAG")
    private Integer nextFlag;
	@Column(name = "DATA_NAME")
    private String dataName;
	
	@Column(name = "MEASURE_UNIT")
    private String measureUnit;
	public String getFactRules() {
		return factRules;
	}

	public void setFactRules(String factRules) {
		this.factRules = factRules;
	}

	public List<RuleVO> getRules() {
		return rules;
	}

	public void setRules(List<RuleVO> rules) {
		this.rules = rules;
	}
	public Integer getNextFlag() {
		return nextFlag;
	}

	public void setNextFlag(Integer nextFlag) {
		this.nextFlag = nextFlag;
	}

	public String getMeasureUnit() {
		return measureUnit;
	}

	public void setMeasureUnit(String measureUnit) {
		this.measureUnit = measureUnit;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}


	public Integer getColumnOrder() {
		return columnOrder;
	}

	public void setColumnOrder(Integer columnOrder) {
		this.columnOrder = columnOrder;
	}

	public String getTableNameCn() {
		return tableNameCn;
	}

	public void setTableNameCn(String tableNameCn) {
		this.tableNameCn = tableNameCn;
	}

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public String getDataName() {
		return dataName;
	}

	public String getTableColumn() {
		return tableColumn;
	}

	public void setTableColumn(String tableColumn) {
		this.tableColumn = tableColumn;
	}

	public String getTableColumnCn() {
		return tableColumnCn;
	}

	public void setTableColumnCn(String tableColumnCn) {
		this.tableColumnCn = tableColumnCn;
	}

	public void setDataName(String dataName) {
		this.dataName = dataName;
	}

	public String getCubeName() {
		return cubeName;
	}

	public void setCubeName(String cubeName) {
		this.cubeName = cubeName;
	}

	
    
	
}
package com.jusfoun.jap.workTable.domain;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "T_CUBE_DIM")
public class CubeDim extends BaseEntity {

	@Id
	@Column(name = "cube_dim_id")
	private String cubeDimId;

	@Column(name = "cube_id")
	private String cubeId;

	@Column(name = "dim_table_name")
	private String dimTableName;

	@Column(name = "dim_table_column")
	private String dimColumn;
	
	@Column(name = "dim_type")
	private String dimType;

	@Column(name = "table_Connect_Column")
	private String tableConnectColumn;

	public String getTableConnectColumn() {
		return tableConnectColumn;
	}

	public void setTableConnectColumn(String tableConnectColumn) {
		this.tableConnectColumn = tableConnectColumn;
	}

	public String getCubeDimId() {
		return cubeDimId;
	}

	public void setCubeDimId(String cubeDimId) {
		this.cubeDimId = cubeDimId;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getDimTableName() {
		return dimTableName;
	}

	public void setDimTableName(String dimTableName) {
		this.dimTableName = dimTableName;
	}

	public String getDimColumn() {
		return dimColumn;
	}

	public void setDimColumn(String dimColumn) {
		this.dimColumn = dimColumn;
	}

	public String getDimType() {
		return dimType;
	}

	public void setDimType(String dimType) {
		this.dimType = dimType;
	}

	
    
	
}
package com.jusfoun.jap.workTable.domain;


import java.util.List;

import javax.persistence.Column;
import javax.persistence.Id;
import javax.persistence.Table;

import com.itmuch.core.entity.BaseEntity;

@Table(name = "T_CUBE_FACT")
public class CubeFact extends BaseEntity{
	
	@Id
    @Column(name = "cube_fact_id")
    private Long cubeFactId;
	
	@Column(name = "cube_id")
    private String cubeId;
    
	@Column(name = "fact_table_name")
    private String factTableName;
    
	@Column(name = "fact_table_column")
    private String factTableColumn;
	
	@Column(name = "fact_table_rule")
    private List<String> factTableRule;
	/*
	 *存储和查询时用字符串factTableRules
	 *返回给js时用list形式
	 */
	private String factTableRules;
	public List<String> getFactTableRule() {
		return factTableRule;
	}

	public void setFactTableRule(List<String> factTableRule) {
		this.factTableRule = factTableRule;
	}

	public Long getCubeFactId() {
		return cubeFactId;
	}

	public void setCubeFactId(Long cubeFactId) {
		this.cubeFactId = cubeFactId;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getFactTableName() {
		return factTableName;
	}

	public void setFactTableName(String factTableName) {
		this.factTableName = factTableName;
	}

	public String getFactTableColumn() {
		return factTableColumn;
	}

	public void setFactTableColumn(String factTableColumn) {
		this.factTableColumn = factTableColumn;
	}

	public String getFactTableRules() {
		return factTableRules;
	}

	public void setFactTableRules(String factTableRules) {
		this.factTableRules = factTableRules;
	}
	
	
	
	
    
	
}
package com.jusfoun.jap.workTable.mapper;

import java.util.List;
import java.util.Map;

import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.dashboard.domain.Dashboard;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.workTable.domain.ColumnChinese;
import com.jusfoun.jap.workTable.vo.ConnectionVO;
import com.jusfoun.jap.workTable.vo.CubeDimVo;
import com.jusfoun.jap.workTable.vo.Measures;
import com.jusfoun.jap.workTable.vo.RuleVO;
import com.jusfoun.jap.workTable.vo.TableChinese;
import com.jusfoun.jap.workTable.vo.WorkTableCondition;
import com.jusfoun.jap.workTable.vo.WorkTableDetail;
import com.jusfoun.jap.workTable.vo.WorkTableVo;

public interface ColumnChineseMapper{

	/**
	 * 封装前台查询条件
	 *
	 * @param queuryVo
	 *            前台查询条件
	 * @return
	 */
	public List<CubeVo> queryDimByCubeId(CubeVo cubeVo);

	public List<ColumnChinese> queryFactByCubeId(CubeVo cubeVo);

	public List<CubeDimVo> queryDimByCondition(CubeDimVo cubeDimVo);

	public List<CubeDimVo> getConnectByCubeIdAndTableName(ConnectionVO connectionVO);

	public String queryCubeDescriptionByCubeId(CubeVo cubeVo);

	public int saveWorkTable(WorkTableCondition workTableCondition);
	
	public void saveFiltersDetail(WorkTableCondition workTableCondition);
	public void saveMeasuresDetail(WorkTableCondition workTableCondition);
	public void saveDimTableDetail(WorkTableCondition workTableCondition);

	public List<WorkTableVo> queryWorkTable(WorkTableVo workTable);
	public List<WorkTableVo> queryWorkTablebyPie(Dashboard Dashboard);

	public String queryFactTableRule(Measures measures);
	
	public List<RuleVO> getRules(List<String> ruleIds);
	
	public List<ColumnChinese> queryColumnCn(CubeDimVo CubeDimVo);

	public List<ColumnChinese> getColumnChinese(ColumnChinese columnChinese);

	public void updateColumnChinese(ColumnChinese columnChinese);

	public void deleteWorkTableDetail(String workTableId);

	public Integer updateWorkTable(WorkTableCondition workTableCondition);

	public void updateTableChinese(ColumnChinese columnChinese);

	public List<TableChinese> queryDimListByCubeId(CubeVo cubeVo);

	public List<String> selectNames(WorkTableVo workTableVo);

	public void copyWorkTable(WorkTableVo workTableVo);

	public String getCopyWorkTableId(WorkTableVo workTableVo);


	public List<WorkTableDetail> queryWorkTableDimList(WorkTableCondition workTable);

	public List<WorkTableDetail> queryWorkTablemeasureList(WorkTableCondition workTable);

	public List<WorkTableDetail> queryWorkTablefilterList(WorkTableCondition workTable);

	public WorkTableVo getWorkTable(WorkTableCondition workTable);

	public void copyWorktableDetail(Map<String, String> mapId);

	public void deleteWorkTable(String workTableId);

	public void deleteDashTabRale(String workTableId);

	public List<String> getPieNames(WorkTableVo workTableVo);

	public List<WorkTableVo> queryWorkTableList(List<WorkTableVo> list);

	public List<WorkTableDetail> queryWorkTableAllDetail(WorkTableCondition workTable);

	public int checkWorkTableCode(WorkTableCondition workTableCondition);

}
package com.jusfoun.jap.workTable.service;

import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import javax.annotation.Resource;

import org.apache.commons.lang.StringUtils;
import org.apache.shiro.authz.annotation.RequiresPermissions;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.alibaba.fastjson.JSON;
import com.github.pagehelper.PageHelper;
import com.itmuch.core.page.PageInfo;
import com.itmuch.core.page.PageVo;
import com.itmuch.core.util.SubjectUtil;
import com.itmuch.core.web.converter.Result;
import com.jusfoun.jap.admin.vo.PageInfoVo;
import com.jusfoun.jap.common.Results;
import com.jusfoun.jap.cube.vo.CubeVo;
import com.jusfoun.jap.dashboard.service.DashboardService;
import com.jusfoun.jap.dashboard.vo.DashboardVo;
import com.jusfoun.jap.util.kylin.GetKylinData;
import com.jusfoun.jap.workTable.domain.ColumnChinese;
import com.jusfoun.jap.workTable.mapper.ColumnChineseMapper;
import com.jusfoun.jap.workTable.vo.ConnectionVO;
import com.jusfoun.jap.workTable.vo.CubeDetail;
import com.jusfoun.jap.workTable.vo.CubeDimVo;
import com.jusfoun.jap.workTable.vo.Measures;
import com.jusfoun.jap.workTable.vo.RuleVO;
import com.jusfoun.jap.workTable.vo.TableChinese;
import com.jusfoun.jap.workTable.vo.WorkTableCondition;
import com.jusfoun.jap.workTable.vo.WorkTableDetail;
import com.jusfoun.jap.workTable.vo.WorkTableVo;

@Service
public class WorkTableService {
	@Autowired 
	protected ColumnChineseMapper dao;
	@Resource
    private DashboardService dashboardService;
	@Value("${kylin.url}")
	private String kylinUrl;
	@Value("${kylin.username}")
	private String kylinUsername;
	@Value("${kylin.password}")
	private String kylinPassword;
	@Value("${kylin.database}")//kylin的数据库名称
	private String kylinDatabase;
	
	public Result queryByCubeId(CubeVo cubeVo) {
		Result result = new Result();
		if (cubeVo.getCubeId() == null) {
			result.setSuccess(false);
			result.setMsg("CubeId is null");
			return result;
		}
		List<TableChinese> listDim = dao.queryDimListByCubeId(cubeVo);
		List<ColumnChinese> listFact = dao.queryFactByCubeId(cubeVo);
		if(listFact!=null&&listFact.size()>0){
			for(ColumnChinese ColumnChinese :listFact){
				String rules = ColumnChinese.getFactRules();
				if(rules!=null&&rules.length()>0){
					List<RuleVO> ruleVOList = new ArrayList<RuleVO>();
					String[] listRules = rules.replace("[", "").replace("]","").split(",");
					List<String> ruleIds  = Arrays.asList(listRules);
					ruleVOList = dao.getRules(ruleIds);//[qw,wq,e,o]
					ColumnChinese.setRules(ruleVOList);
				}
			}
		}
		CubeDetail CubeDetail =new CubeDetail();
		CubeDetail.setListDim(listDim);
		CubeDetail.setListFact(listFact);
		result.setData(CubeDetail);
		return result;
	}

	public List<CubeDimVo> queryCubeDimByCondition(CubeDimVo cubeDimVo) {
		List<CubeDimVo> listDim = dao.queryDimByCondition(cubeDimVo);
		return listDim;
	}

	public List<CubeDimVo> getConnectByCubeIdAndTableName(ConnectionVO connectionVO) {
		List<CubeDimVo> listDim = dao.getConnectByCubeIdAndTableName(connectionVO);
		return listDim;
	}

	public String queryCubeDescriptionByCubeId(CubeVo cubeVo) {
		String cubeDescription = dao.queryCubeDescriptionByCubeId(cubeVo);
		return cubeDescription;
	}

	public List<ColumnChinese> queryFactByCubeId(CubeVo cubeVo) {
		List<ColumnChinese> listFact = dao.queryFactByCubeId(cubeVo);
		return listFact;
	}

	public void saveWorkTable(WorkTableCondition workTableCondition) {
		dao.saveWorkTable(workTableCondition);
	}

	/**
	 * 组装sql数据
	 *
	 * @param workCondition
	 * @return
	 */
	public  StringBuffer getKylinSql(WorkTableCondition workTableCondition) {
		ConnectionVO connectionVO = new ConnectionVO();
		connectionVO.setCubeId(workTableCondition.getCubeId());
		List<WorkTableDetail> dimTableList = workTableCondition.getDimTable();
		List<WorkTableDetail> measuresList = workTableCondition.getMeasures();
		List<WorkTableDetail> filters = workTableCondition.getFilters();

		StringBuffer sb = new StringBuffer();
		String dimColumn = "";
		String measureColumn = "";
		String measureColumnAs = "";//别名
		String dimTable = "";
		String measureTable = "";
		String filterTable = "";
		List<String> tableNameList = new ArrayList<String>();
		sb.append("select ");
		for(int i=0;i<dimTableList.size();i++){
			//RowType 标记行类型1：维度行，2：筛选行，3：即在筛选也在维度行
			dimTable = dimTableList.get(i).getTableName();
			dimColumn = dimTableList.get(i).getTableColumn();
//			if(dimTableList.get(i).getRowType().equals("1")||dimTableList.get(i).getRowType().equals("3")){
				sb.append(dimTable+"."+dimColumn+", ");
//			}
			tableNameList.add(dimTable);
		}
		for(int i=0;i<measuresList.size();i++){
			//RowType 标记行类型1：度量行，2：筛选行，3：即在筛选也在度量行
//			if(measuresList.get(i).getRowType().equals("1")||measuresList.get(i).getRowType().equals("3")){
				measureColumn = measuresList.get(i).getTableColumn();
				measureColumnAs = measureColumn;
				if("count1".equals(measureColumn)){
					measureColumn="'count1'";
				}
				measureTable = measuresList.get(i).getTableName();
				String ruleName = "";//度量规则名称
				ruleName = measuresList.get(i).getFactTableRule();
				if(i == measuresList.size()-1){//度量中的最后一个的时候没有逗号
					if("COUNT_DISTINCT".equals(ruleName)){//sql里不能使用，所以要转换
						sb.append("COUNT(DISTINCT(" + measureColumn+")) as " + measureColumnAs+" ");
					}else{
						sb.append(ruleName+"(" + measureColumn+") as " + measureColumnAs+" ");
					}
				}else{
					if("COUNT_DISTINCT".equals(ruleName)){//sql里不能使用，所以要转换
						sb.append("COUNT(DISTINCT(" + measureColumn+")) as " + measureColumnAs+", ");
					}else{
						sb.append(ruleName+"(" + measureColumn+") as " + measureColumnAs+", ");
					}
				}
//			}
			tableNameList.add(measureTable);
		}
		//虽然不是最后一个，但是有可能最后一个不是类型为2的，这样就会导致最后多一个逗号，需要去除
		if(sb.substring(sb.length()-2, sb.length()-1).equals(",")){
			System.out.println("sql最后一个字符为："+sb.substring(sb.length()-2, sb.length()-1));
			sb.delete(sb.length()-2, sb.length()-1);
		}
		//获取筛选行中可能不存在于维度和度量的表
		for(int i=0;i<filters.size();i++){
			if(filters.get(i)!=null){
				filterTable = filters.get(i).getTableName();
				tableNameList.add(filterTable);
			}
		}
		//表名去重
		List<String> listTableDis = new LinkedList<String>();
		for(int i= 0;i<tableNameList.size();i++){
			String tableNameTem = tableNameList.get(i);
			if(!listTableDis.contains(tableNameTem)){
				listTableDis.add(tableNameTem);
			}
		}
		connectionVO.setTableNameList(listTableDis);
		sb.append("from ");
		for(int i=0;i<measuresList.size()&&i<1;i++){//取度量中的第一个，一个分析模型中只能有一个事实表
			measureTable = measuresList.get(i).getTableName();
			sb.append(kylinDatabase+"."+measureTable+" ");//度量列是否有多个待定
		}
		List<CubeDimVo> listDimCondition = this.getConnectByCubeIdAndTableName(connectionVO);//根据cubeId和tableName查询出关联条件
		//进行表关联，但是维度表中 可能有多个字段来自一个表，所以需要去掉重复的，事实表只有一个，上面已经进行了拼装，现在不需要再次拼接
		List<String> listTableTemp = new LinkedList<String>();
		for(int i=0;i<dimTableList.size();i++){
			String dimTableName = dimTableList.get(i).getTableName();
			if(!listTableTemp.contains(dimTableName)&&!dimTableName.contains("FACT")){//如果维度来自度量的特殊情况下，就不需要进行表连接
				listTableTemp.add(dimTableName);
				sb.append(" inner join ");//使用left 不用inner，inner时错误数据会被过滤；
				sb.append(kylinDatabase+"."+dimTableName+" ");
				sb.append(" on ");
				for(int j=0;j<listDimCondition.size();j++){
					if(listDimCondition.get(j)!=null){
						String dimTableConnectTem = listDimCondition.get(j).getTableConnectColumn() +"  ";
						//比如FACT_ORDER.CUSTOM_KEY=DIM_CUSTOM.CUSTOM_KEY 只要包维度表名称的就是关联字段
						if(dimTableConnectTem.contains(dimTableName)){
							sb.append(listDimCondition.get(j).getTableConnectColumn());
						}
					}
				}
			}else{
				System.out.println("关联表存在重复的表名："+dimTableName+", 重复的维度列为："+dimTableList.get(i).getTableColumn());
			}
		}
		//筛选行中的列，不在度量或者维度中，此时需要将关联表添加上
		for(int i=0;i<filters.size();i++){
			if(filters.get(i)!=null){
				String filterTableName = filters.get(i).getTableName();
				String tableType = filters.get(i).getTableType();//度量表有且只有一个，不需要重复添加1维度2度量
				if(!listTableTemp.contains(filterTableName)&&tableType.equals("1")&&!filterTableName.contains("FACT")){
					listTableTemp.add(filterTableName);
					sb.append(" inner join ");//使用left 不用inner，inner时错误数据会被过滤；
					sb.append(kylinDatabase+"."+filterTableName+" ");
					sb.append(" on ");
					for(int j=0;j<listDimCondition.size();j++){
						String dimTableConnectTem = listDimCondition.get(j).getTableConnectColumn() +"  ";
						//比如FACT_ORDER.CUSTOM_KEY=DIM_CUSTOM.CUSTOM_KEY 只要包维度表名称的就是关联字段
						if(dimTableConnectTem.contains(filterTableName)){
							sb.append(listDimCondition.get(j).getTableConnectColumn());
						}
					}
				}else{
					System.out.println("关联表存在重复的表名："+filterTableName+", 重复的维度列为："+filters.get(i).getTableColumn());
				}
			
			}
		}
		sb.append(" where 1=1 ");
		//filters
		for(int i=0;i<filters.size();i++){
			if(filters.get(i)!=null&&!(null==filters.get(i).getListFilters())){//当筛选条件值不为空时才可以拼接条件
				if(filters.get(i).getListFilters().size()>0){//筛选数据不能为空
					if(filters.get(i).getListFilters().size()==1&&filters.get(i).getListFilters().get(0).equals("")&&filters.get(i).getListFilters().get(0)==null){//空数组长度为1且为空字符或者null，也需要排除
						System.out.println("筛选维度或者度量为空，表名称为："+filters.get(i).getTableName()+"表列名为："+filters.get(i).getListFilters());
					}else{
						if(filters.get(i).getTableType().equals("1")){//1代表筛选行里的维度，2代表筛选行里的度量
							sb.append(" and ");
							dimTable = filters.get(i).getTableName();
							dimColumn = filters.get(i).getTableColumn();
							sb.append(dimTable+"."+dimColumn+" ");
							sb.append("in (");
							List<String> list = filters.get(i).getListFilters();
							for(int j=0;j<list.size();j++){
								String value = list.get(j).replaceAll("\"", "");
								if(j==list.size()-1){
									sb.append("'" +value+ "'" );
								}else{
									sb.append("'" +value+ "'" +",");
								}
							}
							sb.append("" +")");
						}
					}
				}
			}
		}
		sb.append(" group by ");
		for(int i=0;i<dimTableList.size();i++){
			//RowType 标记行类型1：维度行，2：筛选行，3：即在筛选也在维度行
			//如果不是最后一个，但是后面的都是重复的不需要加，此时最后会多一个逗号，所以最后判断删掉
//			if(dimTableList.get(i).getRowType().equals("1")||dimTableList.get(i).getRowType().equals("3")){
				dimColumn = dimTableList.get(i).getTableColumn();
				dimTable = dimTableList.get(i).getTableName();
				if(i == dimTableList.size()-1){
					sb.append(dimTable+"."+dimColumn+" ");
				}else{
					sb.append(dimTable+"."+dimColumn+", ");
				}
//			}
		}
		if(sb.substring(sb.length()-2, sb.length()-1).equals(",")){
			System.out.println("sql最后一个字符为："+sb.substring(sb.length()-2, sb.length()-1));
			sb.delete(sb.length()-2, sb.length()-1);
		}
		//增加度量筛选条件拼接 having 
		for(int i=0;i<filters.size();i++){
			if(filters.get(i)!=null){
				//取度量中的第一个，一个分析模型中只能有一个事实表
				if(i==0){//只有第一个度量循环时才会加having 
					sb.append(" having  1=1 ");
				}
				String tableType = filters.get(i).getTableType();//1代表筛选行里的维度，2代表筛选行里的度量
				String measuresTableName  = filters.get(i).getTableName();
				String measuresColumn   = filters.get(i).getTableColumn();
				String ruleName = filters.get(i).getFactTableRule();//度量规则名称
				//标记行类型1：度量行，2：筛选行，3：即在筛选也在度量行
				if(tableType.equals("2")){
					List<String> measureSizeList = new ArrayList<String>();
					measureSizeList = filters.get(i).getListFilters();
					if(measureSizeList!=null){
						for(int j = 0 ;j<measureSizeList.size();j++){
							String measureSize = measureSizeList.get(j);
							if(!StringUtils.isEmpty(measureSize)&&!"null".equals(measureSize)){
								Double size = Double.valueOf(measureSize);
								if(j==0){//如果是第一个度量时候
									if("count1".equals(measuresColumn)){
										if("COUNT_DISTINCT".equals(ruleName)){//sql里不能使用，所以要转换
											sb.append(" and COUNT(DISTINCT('count1'))>="+size+" ");
										}else{
											sb.append(" and "+ruleName+"('count1')>="+size+" ");
										}
									}else{
										if("COUNT_DISTINCT".equals(ruleName)){//sql里不能使用，所以要转换
											sb.append(" and COUNT(DISTINCT("+measuresTableName+"."+measuresColumn+"))>="+size+" ");
										}else{
											sb.append(" and "+ruleName+" ("+measuresTableName+"."+measuresColumn+")>="+size+" ");
										}
									}
								}else{
									if("count1".equals(measuresColumn)){
										if("COUNT_DISTINCT".equals(ruleName)){//sql里不能使用，所以要转换
											sb.append(" and COUNT(DISTINCT('count1'))<="+size+" ");
										}else{
											sb.append(" and "+ruleName+"('count1')<="+size+" ");
										}
									}else{
										if("COUNT_DISTINCT".equals(ruleName)){//sql里不能使用，所以要转换
											sb.append(" and COUNT(DISTINCT("+measuresTableName+"."+measuresColumn+"))<="+size+" ");
										}else{
											sb.append(" and "+ruleName+" ("+measuresTableName+"."+measuresColumn+")<="+size+" ");
										}
									}
								}
							}
						}
					}
				}
			}
		}
		sb.append(" order by ");
		for(int i=0;i<dimTableList.size();i++){
			//RowType 标记行类型1：维度行，2：筛选行，3：即在筛选也在维度行
			//如果不是最后一个，但是后面的都是重复的不需要加，此时最后会多一个逗号，所以最后判断删掉
//			if(dimTableList.get(i).getRowType().equals("1")||dimTableList.get(i).getRowType().equals("3")){
				dimColumn = dimTableList.get(i).getTableColumn();
				dimTable = dimTableList.get(i).getTableName();
				if(i == dimTableList.size()-1){
					sb.append(dimTable+"."+dimColumn+" ");
				}else{
					sb.append(dimTable+"."+dimColumn+", ");
				}
//			}
		}
		if(sb.substring(sb.length()-2, sb.length()-1).equals(",")){
			System.out.println("sql最后一个字符为："+sb.substring(sb.length()-2, sb.length()-1));
			sb.delete(sb.length()-2, sb.length()-1);
		}
//		sb.append(" limit 16 ");
		System.out.println("查询sql为：");
		System.out.println(sb.toString().toLowerCase());
		return sb;
	}
	// 保存数据分析详情
	public void saveWorkTableDetail(WorkTableCondition workTableCondition) {
		List<WorkTableDetail> filterList = workTableCondition.getFilters();
		if(filterList!=null&filterList.size()>0){
			for(WorkTableDetail d:filterList){
				if(d.getListFilters()!=null&d.getListFilters().size()>0){
					StringBuilder sb = new StringBuilder("[");
					for (String a :d.getListFilters()) {
						sb.append(a+",");
					}
					String filter = sb.toString();
					filter = filter.substring(0, filter.length()-1)+"]";
					d.setListFilter(filter);
				}
			}
			workTableCondition.setFilters(filterList);
			dao.saveFiltersDetail(workTableCondition);
		}
		
		List<WorkTableDetail> measureList = workTableCondition.getMeasures();
		
		if(measureList!=null&measureList.size()>0){
			if("mixTwoMeasureTwoY".equals(workTableCondition.getDataType())
					||"mixTowDimLine".equals(workTableCondition.getDataType())
					||"mixTwoMeasure".equals(workTableCondition.getDataType())
					||"mixTwoDim".equals(workTableCondition.getDataType())){
				int i= 0;
				for(WorkTableDetail d:measureList){
					if(i==0){
						d.setChartType("line");
					}else{
						d.setChartType("bar");
					}
					i++;
				}
			}
			workTableCondition.setMeasures(measureList);
			dao.saveMeasuresDetail(workTableCondition);
		}
		dao.saveDimTableDetail(workTableCondition);
	}

	// 查询数据分析列表
	public List<WorkTableVo> queryWorkTable(WorkTableVo workTable) {
		return dao.queryWorkTable(workTable);
	}

	public WorkTableCondition showWorkTable(WorkTableCondition workTable) {
		WorkTableVo workTable1 = new WorkTableVo();
		workTable1 = dao.getWorkTable(workTable);
		if(workTable1==null){
			return null;
		}
		List<WorkTableDetail> dimTable = new ArrayList<WorkTableDetail>();
		List<WorkTableDetail> measures = new ArrayList<WorkTableDetail>();
		List<WorkTableDetail> filters = new ArrayList<WorkTableDetail>();
		List<WorkTableDetail> allDetail = dao.queryWorkTableAllDetail(workTable);
		if(allDetail!=null&&allDetail.size()>0){
			for(WorkTableDetail workTableDetail:allDetail){
				if("3".equals(workTableDetail.getTableType())){
					dimTable.add(workTableDetail);
				}else if("4".equals(workTableDetail.getTableType())){
					measures.add(workTableDetail);
				}else if("1".equals(workTableDetail.getTableType())||"2".equals(workTableDetail.getTableType())){
					filters.add(workTableDetail);
				}
			}
		}
		if(measures!=null&&measures.size()>0){
			for(WorkTableDetail WorkTableDetail :measures){
				String rules = WorkTableDetail.getFactRules();
				if(rules!=null&&rules.length()>0){
					List<RuleVO> ruleVOList = new ArrayList<RuleVO>();
					String[] listRules = rules.replace("[", "").replace("]","").split(",");
					ruleVOList = dao.getRules(Arrays.asList(listRules));//[qw,wq,e,o]
					WorkTableDetail.setRules(ruleVOList);
				}
			}
		}
		
		if(filters!=null&&filters.size()>0){
			CubeDimVo dimv = new CubeDimVo();
			for(WorkTableDetail WorkTableDetail :filters){
				String listFilter = WorkTableDetail.getListFilter();
				if("2".equals(WorkTableDetail.getTableType())){//筛选中的度量字段要带上所有的度量规则
					String rules = WorkTableDetail.getFactRules();
					if(rules!=null&&rules.length()>0){
						List<RuleVO> ruleVOList = new ArrayList<RuleVO>();
						String[] listRules = rules.replace("[", "").replace("]","").split(",");
						ruleVOList = dao.getRules(Arrays.asList(listRules));//[qw,wq,e,o]
						WorkTableDetail.setRules(ruleVOList);
					}
				}else if("step".equals(workTable1.getDataType())){//同比图需要将维度的值返回
					dimv.setTableName(WorkTableDetail.getTableName());
					dimv.setTableColumn(WorkTableDetail.getTableColumn());
					dimv = (CubeDimVo) queryByCondition(dimv).getData();
					WorkTableDetail.setListAllValue(dimv.getResultSet());
				}
				if(listFilter!=null&&listFilter.length()>0){
					String[] listFilters = listFilter.replace("[", "").replace("]","").split(",");
					WorkTableDetail.setListFilters((Arrays.asList(listFilters)));
				}
			}
		}
		workTable.setDimTable(dimTable);
		workTable.setWorkTableId(workTable1.getWorkTableId());
		workTable.setMeasures(measures);
		workTable.setFilters(filters);
		workTable.setCubeId(workTable1.getCubeId());
		workTable.setDataType(workTable1.getDataType());
		workTable.setUserId(workTable1.getUserId());
		workTable.setXsColor(workTable1.getXsColor());
		workTable.setXwColor(workTable1.getXwColor());
		workTable.setYsColor(workTable1.getYsColor());
		workTable.setYwColor(workTable1.getYwColor());
		workTable.setHeaderColor(workTable1.getHeaderColor());
		workTable.setBodyColor(workTable1.getBodyColor());
		workTable.setTableColor(workTable1.getTableColor());
		workTable.setWorkTableName(workTable1.getWorkTableName());
		workTable.setWorkTableCode(workTable1.getWorkTableCode());
		workTable.setThemeId(workTable1.getThemeId());
		if(workTable1.getThemeColor()!=null){
			workTable.setThemeColorArr(Arrays.asList(workTable1.getThemeColor().replace("[", "").replace("\"", "").replace("]", "").split(",")));
		}
		return workTable;
	}

	public Result getFactTableRule(Measures measures) {
		Result result = new Result();
		String rules = dao.queryFactTableRule(measures);//[qw,wq,e,o]
		String[] listRule = rules.replace("[", "").replace("]","").split(",");
		List<String> ruleIds = new ArrayList<String>();
//		ruleIds = listRule;
		ruleIds = Arrays.asList(listRule);
		List<RuleVO> ruleVOList = new ArrayList<RuleVO>();
		ruleVOList = dao.getRules(ruleIds);
		result.setData(ruleVOList);
		return result;
	}
	public List<ColumnChinese> queryColumnCn(CubeDimVo CubeDimVo) {
		return dao.queryColumnCn(CubeDimVo);
	}

	public PageInfoVo<ColumnChinese> getColumnChinese(PageVo pageVo, ColumnChinese columnChinese) {
		PageHelper.startPage(pageVo.getPage(), pageVo.getRows());
		List<ColumnChinese> list = dao.getColumnChinese(columnChinese);
		PageInfo<ColumnChinese> info = new PageInfo<ColumnChinese>(list);
		PageInfoVo<ColumnChinese> ColumnChinesePage = new PageInfoVo<ColumnChinese>(info.getList(), list);
		return ColumnChinesePage;
	}

	public void updateColumnChinese(ColumnChinese columnChinese) {
		dao.updateColumnChinese(columnChinese);
		dao.updateTableChinese(columnChinese);
	}

	public void deleteWorkTableDetail(String workTableId) {
		dao.deleteWorkTableDetail(workTableId);
	}

	public Integer updateWorkTable(WorkTableCondition workTableCondition) {
		Integer updateRow = dao.updateWorkTable(workTableCondition);
		return updateRow;
	}

	public void updateAllChn(List<ColumnChinese> columnChineseList) {
		for(ColumnChinese columnChinese:columnChineseList){
			dao.updateColumnChinese(columnChinese);
		}
	}

	public void copyWorktable(WorkTableVo workTableVo) {
		//1获取该数据分析的副本名列表
		List<String> names = dao.selectNames(workTableVo);
		int copyOrder =1;
		boolean getOrder = false;//false 表示 该序号的副本没有
		for(;;copyOrder++){
			getOrder = false;
			for(String name:names){
				if((workTableVo.getWorkTableName()+"-副本"+copyOrder).equals(name)){//检测到该序列的副本
					getOrder = true;
					break;
				}
			}
			if(!getOrder){//如果没有检测到循环结束copyOrder为可以使用的值
				break;
			}
		}
		
		//2插入新的数据分析记录并返回主键
		workTableVo.setWorkTableName(workTableVo.getWorkTableName()+"-副本"+copyOrder);//更换新的名字
		dao.copyWorkTable(workTableVo);//插入
		String copyId = dao.getCopyWorkTableId(workTableVo);//返回主键
		//3.插入与数据分析的关联记录
		Map<String,String> mapId=new HashMap<String,String>();
		mapId.put("copyId", copyId);
		mapId.put("id", workTableVo.getWorkTableId());
		dao.copyWorktableDetail(mapId);
				
	}

	public String delWorktable(WorkTableVo workTableVo) {
		List<String> pieNames = dao.getPieNames(workTableVo);
		if(pieNames==null||pieNames.size()==0){//该工作表未挂在仪表盘下
			dao.deleteWorkTable(workTableVo.getWorkTableId());
			dao.deleteWorkTableDetail(workTableVo.getWorkTableId());
			return null;
		}else{
			return pieNames.toString();
		}
		//dao.deleteDashTabRale(workTableVo.getWorkTableId());
	}
	public List<String> getFilterList (){
		return null;
		
	}
	public Result queryByCondition(CubeDimVo cubeDimVo) {
		Result result = new Result();
		List<CubeDimVo> list = new ArrayList<CubeDimVo>();
		list = queryCubeDimByCondition(cubeDimVo);
		String kylin = queryFromKylin(cubeDimVo);
		System.out.println(kylin);
		List<String> filterList = new ArrayList<String>();
		String key = "";
		String value = "";
		try {
			JSONArray myJsonArray = new JSONArray(kylin);
			for (int i = 0; i < myJsonArray.length(); i++) {
				JSONObject myObject = myJsonArray.getJSONObject(i);
				Iterator<?> iterator = myObject.keys();
				while (iterator.hasNext()) {
					key = (String) iterator.next();
					value = myObject.getString(key);
					filterList.add(value);
				}
			}

		} catch (JSONException e1) {
			e1.printStackTrace();
		}
		// new CubeDimVo();
		for (int i = 0; i < list.size(); i++) {
			cubeDimVo = list.get(i);// 查询汉语列名称最多只有一条
		}
		cubeDimVo.setResultSet(filterList);
		result.setData(cubeDimVo);
		return result;
	}
	
	public String queryFromKylin(CubeDimVo cubeDimVo) {
		StringBuffer sb = new StringBuffer();
		sb.append("select distinct ");
		String column = cubeDimVo.getTableColumn();
		String table = cubeDimVo.getTableName();
		sb.append(column + " from " +kylinDatabase+"."+table);
		/* sb.append("select distinct custom_name from dim_custom"); */
		GetKylinData data = new GetKylinData();
		String result = "";
		try {
			result = data.getData(sb.toString(), kylinUrl, kylinUsername, kylinPassword);
			System.out.println(result);

		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (JSONException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return result;
	}
	
	@RequestMapping("/saveWorkTable")
	@ResponseBody
	@RequiresPermissions("sys:cube:view")
	public Result saveWorkTable(String workConditionString) {
		Result result = new Result();
		WorkTableCondition workTableCondition = JSON.parseObject(workConditionString, WorkTableCondition.class);// json转换为WorkCondition的对象
		workTableCondition.setUserId(SubjectUtil.getUserId().toString());
		String workTableId = "";
		boolean insertWorkTable = true;//判断该数据分析是新建的（true）还是修改的（false）
		if(insertWorkTable=("".equals(workTableCondition.getWorkTableId())||workTableCondition.getWorkTableId()==null)){
			int count = dao.checkWorkTableCode(workTableCondition);//工作表编码重复的数量
			if(count >0){//重复code
				result.setSuccess(false);
				result.setCode(1001);
				result.setMsg("工作表编码有重复");
				return result;
			}
			workTableId = UUID.randomUUID().toString().replaceAll("-", "");// 为新建的数据分析创建主键
		}else{
			workTableId = workTableCondition.getWorkTableId();//修改数据分析使用原来的主键
		}
		workTableCondition.setWorkTableId(workTableId);
		if(insertWorkTable){//新增的数据分析
			saveWorkTable(workTableCondition);
		}else{
			if(0==updateWorkTable(workTableCondition)){//更新时原数据丢了，执行保存
				insertWorkTable = true;//标志为保存
				workTableId  = UUID.randomUUID().toString().replaceAll("-", "");// 为新建的数据分析创建主键
				workTableCondition.setWorkTableId(workTableId);
			}
		}
		
		if(!insertWorkTable){//修改的数据分析需要将原来的删除
			deleteWorkTableDetail(workTableCondition.getWorkTableId());
		}
		saveWorkTableDetail(workTableCondition);// 保存数据分析详情
		result.setData(workTableCondition);
		result.setSuccess(true);
		result.setCode(1000);
		return result;
	}
	

	public Results getKylinByCondition(WorkTableCondition workTableCondition) throws SQLException, JSONException {
        Results result = new Results();
		StringBuffer sql = getKylinSql(workTableCondition);
		String dataType = workTableCondition.getDataType();
		List<WorkTableDetail> dimTableList = workTableCondition.getDimTable();
		List<WorkTableDetail> measuresList = workTableCondition.getMeasures();
		List<String> dimSort = new ArrayList<String>();
		List<String> measureDanWei = new ArrayList<String>();
		List<String> measureDuLiangName = new ArrayList<String>();
		//获取最大最小值
		StringBuffer sb = new StringBuffer();
		String measureColumn = "";
		String measureColumnAs = "";//别名
        sb.append("select ");
		for(int i=0;i<measuresList.size();i++){
			measureColumn = measuresList.get(i).getTableColumn();
			measureColumnAs = measureColumn;
			if("count1".equals(measureColumn)){
				measureColumn="'count1'";
			}
			if(i == measuresList.size()-1){//度量中的最后一个的时候没有逗号
				sb.append("max(" + measureColumn+") as max" + measureColumnAs+", ");
				sb.append("min(" + measureColumn+") as min" + measureColumnAs+" ");
			}else{
				sb.append("max(" + measureColumn+") as max" + measureColumnAs+", ");
				sb.append("min(" + measureColumn+") as min" + measureColumnAs+", ");				
				}
		}
		sb.append("from ( "+sql +" ) ");
		int dimSize = 0;
		for(int i = 0;i<dimTableList.size();i++){
			WorkTableDetail CubeDimVo = new WorkTableDetail();
			CubeDimVo = dimTableList.get(i);
			//标记行类型1：维度行，2：筛选行，3：即在筛选也在维度行
//			if(CubeDimVo.getRowType().equals("1")||CubeDimVo.getRowType().equals("3")){
				//查询维度的中文名称
				List<ColumnChinese> columnChineseList = new ArrayList<ColumnChinese>();
				CubeDimVo CubeDimVoCond = new CubeDimVo();
				CubeDimVoCond.setTableColumn(CubeDimVo.getTableColumn());
				CubeDimVoCond.setTableName(CubeDimVo.getTableName());
				columnChineseList = queryColumnCn(CubeDimVoCond);
				for(int j=0;j<columnChineseList.size();j++){
					ColumnChinese ColumnChinese = new ColumnChinese();
					ColumnChinese= columnChineseList.get(j);
					dimSort.add(ColumnChinese.getTableColumnCn());
				}
				dimSize++;
//			}
		}
		for(int i = 0;i<measuresList.size();i++){
			WorkTableDetail Measures = new WorkTableDetail();
			Measures = measuresList.get(i);
			//标记行类型1：度量行，2：筛选行，3：即在筛选也在度量行
//			if(Measures.getRowType().equals("1")||Measures.getRowType().equals("3")){
				//查询每个度量的单位
				List<ColumnChinese> columnChineseList = new ArrayList<ColumnChinese>();
				CubeDimVo CubeDimVo = new CubeDimVo();
				CubeDimVo.setTableColumn(Measures.getTableColumn());
				CubeDimVo.setTableName(Measures.getTableName());
				columnChineseList = queryColumnCn(CubeDimVo);
				for(int j=0;j<columnChineseList.size();j++){
					ColumnChinese ColumnChinese = new ColumnChinese();
					ColumnChinese= columnChineseList.get(j);
					String danWei = ColumnChinese.getMeasureUnit();
					String duLiangName = ColumnChinese.getTableColumnCn();
					if(StringUtils.isEmpty(danWei)){
						danWei="";
					}
					measureDuLiangName.add(duLiangName);
					measureDanWei.add(danWei);
				}
//			}
		}
		result = GetKylinData.getMultidimenDataResult(sb,dataType,measureDuLiangName,measuresList,dimSort,measureDanWei,dimSize,sql,kylinUrl,kylinUsername,kylinPassword);
		result.setWorkTableId(workTableCondition.getWorkTableId());
		return result;
	}

	public WorkTableCondition showWorkTableofPie(WorkTableCondition workTable) {
		WorkTableVo workTable1 = new WorkTableVo();
		workTable1 = dao.getWorkTable(workTable);
		List<WorkTableDetail> dimTable = new ArrayList<WorkTableDetail>();
		List<WorkTableDetail> measures = new ArrayList<WorkTableDetail>();
		List<WorkTableDetail> filters = new ArrayList<WorkTableDetail>();
		List<WorkTableDetail> allDetail = dao.queryWorkTableAllDetail(workTable);
		if(allDetail!=null&&allDetail.size()>0){
			for(WorkTableDetail workTableDetail:allDetail){
				if("3".equals(workTableDetail.getTableType())){
					dimTable.add(workTableDetail);
				}else if("4".equals(workTableDetail.getTableType())){
					measures.add(workTableDetail);
				}else if("1".equals(workTableDetail.getTableType())||"2".equals(workTableDetail.getTableType())){
					filters.add(workTableDetail);
				}
			}
		}
		
		if(filters!=null&&filters.size()>0){
			CubeDimVo dimv = new CubeDimVo();
			for(WorkTableDetail WorkTableDetail :filters){
				String listFilter = WorkTableDetail.getListFilter();
				if("step".equals(workTable1.getDataType())&&"1".equals(WorkTableDetail.getTableType())){//同比图需要将维度的值返回
					dimv.setTableName(WorkTableDetail.getTableName());
					dimv.setTableColumn(WorkTableDetail.getTableColumn());
					dimv = (CubeDimVo) queryByCondition(dimv).getData();
					WorkTableDetail.setListAllValue(dimv.getResultSet());
				}
				if(listFilter!=null&&listFilter.length()>0){
					String[] listFilters = listFilter.replace("[", "").replace("]","").split(",");
					WorkTableDetail.setListFilters((Arrays.asList(listFilters)));
				}
			}
		}
		
		workTable.setDimTable(dimTable);
		workTable.setMeasures(measures);
		workTable.setFilters(filters);
		workTable.setCubeId(workTable1.getCubeId());
		workTable.setDataType(workTable1.getDataType());
		workTable.setUserId(workTable1.getUserId());
		workTable.setXsColor(workTable1.getXsColor());
		workTable.setXwColor(workTable1.getXwColor());
		workTable.setYsColor(workTable1.getYsColor());
		workTable.setYwColor(workTable1.getYwColor());
		workTable.setHeaderColor(workTable1.getHeaderColor());
		workTable.setBodyColor(workTable1.getBodyColor());
		workTable.setTableColor(workTable1.getTableColor());
		workTable.setWorkTableName(workTable1.getWorkTableName());
		workTable.setThemeId(workTable1.getThemeId());
		if(workTable1.getThemeColor()!=null){
			workTable.setThemeColorArr(Arrays.asList(workTable1.getThemeColor().replace("[", "").replace("\"", "").replace("]", "").split(",")));
		}
		return workTable;
	
	}

	public Result queryWorktableData(WorkTableCondition workTable) throws SQLException, JSONException {
		Results result = new Results();
		WorkTableCondition workTableCondition = showWorkTable(workTable);
		if(workTableCondition==null){
			return null;
		}
		Map<String,Object> worktable = new HashMap<String, Object>();
		worktable.put("workTableDetail", workTableCondition);
		worktable.put("workTableDate", getKylinByCondition(workTableCondition).getData());
		result.setData(worktable);
		result.setSuccess(true);
		return result;
	}

	public Result exportExcel(WorkTableCondition workTableCondition) throws SQLException, JSONException, IOException {
        Result result = new Result();
		StringBuffer sql = getKylinSql(workTableCondition);
		List<WorkTableDetail> dimTableList = workTableCondition.getDimTable();
		List<WorkTableDetail> measuresList = workTableCondition.getMeasures();
		List<String> dimSort = new ArrayList<String>();
		List<String> measureDanWei = new ArrayList<String>();
		List<String> measureDuLiangName = new ArrayList<String>();
		int dimSize = 0;
		for(int i = 0;i<dimTableList.size();i++){
			WorkTableDetail CubeDimVo = new WorkTableDetail();
			CubeDimVo = dimTableList.get(i);
				List<ColumnChinese> columnChineseList = new ArrayList<ColumnChinese>();
				CubeDimVo CubeDimVoCond = new CubeDimVo();
				CubeDimVoCond.setTableColumn(CubeDimVo.getTableColumn());
				CubeDimVoCond.setTableName(CubeDimVo.getTableName());
				columnChineseList = queryColumnCn(CubeDimVoCond);
				for(int j=0;j<columnChineseList.size();j++){
					ColumnChinese ColumnChinese = new ColumnChinese();
					ColumnChinese= columnChineseList.get(j);
					dimSort.add(ColumnChinese.getTableColumnCn());
				}
				dimSize++;
		}
		for(int i = 0;i<measuresList.size();i++){
			WorkTableDetail Measures = new WorkTableDetail();
			Measures = measuresList.get(i);
				List<ColumnChinese> columnChineseList = new ArrayList<ColumnChinese>();
				CubeDimVo CubeDimVo = new CubeDimVo();
				CubeDimVo.setTableColumn(Measures.getTableColumn());
				CubeDimVo.setTableName(Measures.getTableName());
				columnChineseList = queryColumnCn(CubeDimVo);
				for(int j=0;j<columnChineseList.size();j++){
					ColumnChinese ColumnChinese = new ColumnChinese();
					ColumnChinese= columnChineseList.get(j);
					String danWei = ColumnChinese.getMeasureUnit();
					String duLiangName = ColumnChinese.getTableColumnCn();
					if(StringUtils.isEmpty(danWei)){
						danWei="";
					}
					measureDuLiangName.add(duLiangName);
					measureDanWei.add(danWei);
				}
		}
		result = GetKylinData.exportExcel(workTableCondition.getWorkTableName(),measureDuLiangName,measuresList,dimSort,measureDanWei,dimSize,sql,kylinUrl,kylinUsername,kylinPassword);
		return result;
	}

	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author 
 *
 */
public class ChartData {
	private String nameWeidu;
	private int colspan;
	private String valueName;
	private List<String> dataX;
	private List<DataY> dataY;
	private List<ChartData> data;
	public String getValueName() {
		return valueName;
	}
	public void setValueName(String valueName) {
		this.valueName = valueName;
	}
	public List<ChartData> getData() {
		return data;
	}
	public void setData(List<ChartData> data) {
		this.data = data;
	}
	public String getNameWeidu() {
		return nameWeidu;
	}
	public void setNameWeidu(String nameWeidu) {
		this.nameWeidu = nameWeidu;
	}
	public List<String> getDataX() {
		return dataX;
	}
	public void setDataX(List<String> dataX) {
		this.dataX = dataX;
	}
	public List<DataY> getDataY() {
		return dataY;
	}
	public void setDataY(List<DataY> dataY) {
		this.dataY = dataY;
	}
	public int getColspan() {
		return colspan;
	}
	public void setColspan(int colspan) {
		this.colspan = colspan;
	}
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author Rain
 *
 */
public class ChartDataVo {
	private Title title;
	private Legend legend;
	private Xaxis xAxis;
	private Yaxis yAxis;
	private List<Serie> series;
	public Title getTitle() {
		return title;
	}
	public void setTitle(Title title) {
		this.title = title;
	}
	public Legend getLegend() {
		return legend;
	}
	public void setLegend(Legend legend) {
		this.legend = legend;
	}
	
	public Xaxis getxAxis() {
		return xAxis;
	}
	public void setxAxis(Xaxis xAxis) {
		this.xAxis = xAxis;
	}
	public Yaxis getyAxis() {
		return yAxis;
	}
	public void setyAxis(Yaxis yAxis) {
		this.yAxis = yAxis;
	}
	public List<Serie> getSeries() {
		return series;
	}
	public void setSeries(List<Serie> series) {
		this.series = series;
	}
	
	
	
	
}


/**   
 * 文件名：ChartDataVoNew.java   
 *   
 * 版本信息：   
 * 日期：2016年6月24日   
 * Copyright Corporation 2016    
 * 版权所有   
 *   
 */

package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * 此类描述的是：
 * 
 * @author: 王存泉
 * @version: 2016年6月24日 上午10:47:56
 */

public class ChartDataVoNew {
	private Boolean success;
	private String dataType;
	private List<String> name;
	private List<String> dataX;
	private List<List<String>> dataY;
	private List<Serie> series;

	
	
	public List<Serie> getSeries() {
		return series;
	}


	public void setSeries(List<Serie> series) {
		this.series = series;
	}


	/**   
	 * success   
	 *   
	 * @return the success   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public Boolean getSuccess() {
		return success;
	}

	
	/**   
	 * @param success the success to set   
	 */
	
	public void setSuccess(Boolean success) {
		this.success = success;
	}

	/**   
	 * dataType   
	 *   
	 * @return the dataType   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public String getDataType() {
		return dataType;
	}
	
	/**   
	 * @param dataType the dataType to set   
	 */
	
	public void setDataType(String dataType) {
		this.dataType = dataType;
	}
	
	/**   
	 * name   
	 *   
	 * @return the name   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public List<String> getName() {
		return name;
	}
	
	/**   
	 * @param name the name to set   
	 */
	
	public void setName(List<String> name) {
		this.name = name;
	}
	
	/**   
	 * dataX   
	 *   
	 * @return the dataX   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public List<String> getDataX() {
		return dataX;
	}
	
	/**   
	 * @param dataX the dataX to set   
	 */
	
	public void setDataX(List<String> dataX) {
		this.dataX = dataX;
	}
	
	/**   
	 * dataY   
	 *   
	 * @return the dataY   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public List<List<String>> getDataY() {
		return dataY;
	}
	
	/**   
	 * @param dataY the dataY to set   
	 */
	
	public void setDataY(List<List<String>> dataY) {
		this.dataY = dataY;
	}

}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author wcq
 *
 */
public class ChartFour {
	private String nameWeidu;
	private String valueName;
	private List<ChartThree> data;
	public String getNameWeidu() {
		return nameWeidu;
	}
	public void setNameWeidu(String nameWeidu) {
		this.nameWeidu = nameWeidu;
	}
	public String getValueName() {
		return valueName;
	}
	public void setValueName(String valueName) {
		this.valueName = valueName;
	}
	public List<ChartThree> getData() {
		return data;
	}
	public void setData(List<ChartThree> data) {
		this.data = data;
	}
	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author wcq
 *
 */
public class ChartOne {
	private String nameWeidu;
	private List<String> dataX;
	private List<DataY> dataY;
	public String getNameWeidu() {
		return nameWeidu;
	}
	public void setNameWeidu(String nameWeidu) {
		this.nameWeidu = nameWeidu;
	}
	public List<String> getDataX() {
		return dataX;
	}
	public void setDataX(List<String> dataX) {
		this.dataX = dataX;
	}
	public List<DataY> getDataY() {
		return dataY;
	}
	public void setDataY(List<DataY> dataY) {
		this.dataY = dataY;
	}
	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author wcq
 *
 */
public class ChartThree {
	private String nameWeidu;
	private String valueName;
	private List<ChartTwo> data;
	public String getNameWeidu() {
		return nameWeidu;
	}
	public void setNameWeidu(String nameWeidu) {
		this.nameWeidu = nameWeidu;
	}
	public String getValueName() {
		return valueName;
	}
	public void setValueName(String valueName) {
		this.valueName = valueName;
	}
	public List<ChartTwo> getData() {
		return data;
	}
	public void setData(List<ChartTwo> data) {
		this.data = data;
	}
	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author wcq
 *
 */
public class ChartTwo {
	private String nameWeidu;
	private String valueName;
	private List<ChartOne> data;
	public String getNameWeidu() {
		return nameWeidu;
	}
	public void setNameWeidu(String nameWeidu) {
		this.nameWeidu = nameWeidu;
	}
	public String getValueName() {
		return valueName;
	}
	public void setValueName(String valueName) {
		this.valueName = valueName;
	}
	public List<ChartOne> getData() {
		return data;
	}
	public void setData(List<ChartOne> data) {
		this.data = data;
	}
	
}

package com.jusfoun.jap.workTable.vo;

import java.util.List;

import com.jusfoun.jap.workTable.domain.ColumnChinese;

public class ColumnChineseList {
	private List<ColumnChinese> columnChineseList;

	public List<ColumnChinese> getColumnChineseList() {
		return columnChineseList;
	}

	public void setColumnChineseList(List<ColumnChinese> columnChineseList) {
		this.columnChineseList = columnChineseList;
	}
}
/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

/**
 * @author 
 *
 */
public class ColumnChineseVo {
	private String tableName;
	private String tableColumn;
	private String dataName;
	private String tableColumnCn;
	private Integer columnOrder;
	private Integer nextFlag;
	public String getDataName() {
		return dataName;
	}
	public void setDataName(String dataName) {
		this.dataName = dataName;
	}
	public String getTableColumn() {
		return tableColumn;
	}
	public void setTableColumn(String tableColumn) {
		this.tableColumn = tableColumn;
	}
	public String getTableColumnCn() {
		return tableColumnCn;
	}
	public void setTableColumnCn(String tableColumnCn) {
		this.tableColumnCn = tableColumnCn;
	}
	public Integer getColumnOrder() {
		return columnOrder;
	}
	public void setColumnOrder(Integer columnOrder) {
		this.columnOrder = columnOrder;
	}
	public Integer getNextFlag() {
		return nextFlag;
	}
	public void setNextFlag(Integer nextFlag) {
		this.nextFlag = nextFlag;
	}
	public String getTableName() {
		return tableName;
	}
	public void setTableName(String tableName) {
		this.tableName = tableName;
	}
	
}

 
    /**   
     * 文件名：ConnectionVO.java   
     *   
     * 版本信息：   
     * 日期：2016年6月21日   
     * Copyright Corporation 2016    
     * 版权所有   
     *   
     */   
    
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**   
     * 此类描述的是：   
     * @author: 王存泉   
     * @version: 2016年6月21日 下午6:16:01    
     */

public class ConnectionVO {
    private String cubeId;
    
	/**   
	 * cubeId   
	 *   
	 * @return the cubeId   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public String getCubeId() {
		return cubeId;
	}
	
	/**   
	 * @param cubeId the cubeId to set   
	 */
	
	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}
	
	/**   
	 * tableNameList   
	 *   
	 * @return the tableNameList   
	 * @since   CodingExample Ver(编码范例查看) 1.0   
	*/
	
	public List<String> getTableNameList() {
		return tableNameList;
	}
	
	/**   
	 * @param tableNameList the tableNameList to set   
	 */
	
	public void setTableNameList(List<String> tableNameList) {
		this.tableNameList = tableNameList;
	}
	private List<String> tableNameList;

}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

import com.jusfoun.jap.workTable.domain.ColumnChinese;

/**
 * @author 
 *
 */
public class CubeDetail {
	private List<TableChinese> listDim;
	private List<ColumnChinese> listFact;
	public List<TableChinese> getListDim() {
		return listDim;
	}
	public void setListDim(List<TableChinese> listDim) {
		this.listDim = listDim;
	}
	public List<ColumnChinese> getListFact() {
		return listFact;
	}
	public void setListFact(List<ColumnChinese> listFact) {
		this.listFact = listFact;
	}
	
}

package com.jusfoun.jap.workTable.vo;

import java.util.Arrays;
import java.util.List;


public class CubeDimVo {
	
    private String cubeDimId;
	
    private String cubeId;
    
    private String tableName;
    
    private String tableColumn;
    
//    private String dimType;
    
    private String tableColumnCn;
    
    private List resultSet;
    
    private String  dimKey;
    
    private List<String> ListDim;
    
    private int dimMeasureOrder ;//拖拽时的顺序
    private String tableConnectColumn;
    
	private String rowType;//标记行类型1：度量行，2：筛选行，3：即在筛选也在度量行
    
    public String getDimKey() {
		return dimKey;
	}

	public void setDimKey(String dimKey) {
		this.dimKey = dimKey;
	}

	public List<String> getListDim() {
		return ListDim;
	}

	public void setListDim(List<String> listDim) {
		ListDim = listDim;
	}

	public String getRowType() {
		return rowType;
	}

	public void setRowType(String rowType) {
		this.rowType = rowType;
	}

	public List getResultSet() {
		return resultSet;
	}

	public void setResultSet(List resultSet) {
		this.resultSet = resultSet;
	}

	public String getCubeDimId() {
		return cubeDimId;
	}

	public void setCubeDimId(String cubeDimId) {
		this.cubeDimId = cubeDimId;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}


//	public String getDimType() {
//		return dimType;
//	}
//
//	public void setDimType(String dimType) {
//		this.dimType = dimType;
//	}

	

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public String getTableConnectColumn() {
		return tableConnectColumn;
	}


	public String getTableColumn() {
		return tableColumn;
	}

	public void setTableColumn(String tableColumn) {
		this.tableColumn = tableColumn;
	}

	public String getTableColumnCn() {
		return tableColumnCn;
	}

	public void setTableColumnCn(String tableColumnCn) {
		this.tableColumnCn = tableColumnCn;
	}

	public void setTableConnectColumn(String tableConnectColumn) {
		this.tableConnectColumn = tableConnectColumn;
	}

	public void setListDim(String listFilter) {//将形如[1, 2, 3, 5]的字符串转为list<String>
		if(listFilter!=null&!"".equals(listFilter)){
			this.ListDim = Arrays.asList(listFilter.replace("[", "").replace("]","").split(","));
		}
	}

	public int getDimMeasureOrder() {
		return dimMeasureOrder;
	}

	public void setDimMeasureOrder(int dimMeasureOrder) {
		this.dimMeasureOrder = dimMeasureOrder;
	}
}
/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author wcq
 *
 */
public class DataY {
private String nameDuliang;
private String unitDuliang;
private String dataType;
private String chartType;
private String maxY;
private String minY;
private List<String> data_y;

public String getMaxY() {
	return maxY;
}
public void setMaxY(String maxY) {
	this.maxY = maxY;
}
public String getMinY() {
	return minY;
}
public void setMinY(String minY) {
	this.minY = minY;
}
public String getNameDuliang() {
	return nameDuliang;
}
public void setNameDuliang(String nameDuliang) {
	this.nameDuliang = nameDuliang;
}
public String getUnitDuliang() {
	return unitDuliang;
}
public void setUnitDuliang(String unitDuliang) {
	this.unitDuliang = unitDuliang;
}
public String getDataType() {
	return dataType;
}
public void setDataType(String dataType) {
	this.dataType = dataType;
}
public List<String> getData_y() {
	return data_y;
}
public void setData_y(List<String> data_y) {
	this.data_y = data_y;
}
public String getChartType() {
	return chartType;
}
public void setChartType(String chartType) {
	this.chartType = chartType;
}

}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author Rain
 *
 */
public class Legend {
	private String left;
	private List<String> data;
	public String getLeft() {
		return left;
	}
	public void setLeft(String left) {
		this.left = left;
	}
	public List<String> getData() {
		return data;
	}
	public void setData(List<String> data) {
		this.data = data;
	}
	
	
	

}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.Arrays;
import java.util.List;

/**
 * @author Rain
 *
 */
public class Measures {
	private String measuresTableName ;
	private String measuresColumn ;
	private List<String> ListMeasures ;
	private String rowType ;	//标记行类型1：度量行，2：筛选行，3：即在筛选也在度量行
	private int dimMeasureOrder ;//拖拽时的顺序
	
	public String getMeasuresTableName() {
		return measuresTableName;
	}
	public void setMeasuresTableName(String measuresTableName) {
		this.measuresTableName = measuresTableName;
	}
	public String getMeasuresColumn() {
		return measuresColumn;
	}
	public void setMeasuresColumn(String measuresColumn) {
		this.measuresColumn = measuresColumn;
	}
	public String getRowType() {
		return rowType;
	}
	public List<String> getListMeasures() {
		return ListMeasures;
	}
	public void setListMeasures(List<String> listMeasures) {
		ListMeasures = listMeasures;
	}
	public void setRowType(String rowType) {
		this.rowType = rowType;
	}
	public void setListMeasures(String listFilter) {//将形如[1, 2, 3, 5]的字符串转为list<String>
		if(listFilter!=null&!"".equals(listFilter)){
			this.ListMeasures = Arrays.asList(listFilter.replace("[", "").replace("]","").split(","));
		}
	}
	public int getDimMeasureOrder() {
		return dimMeasureOrder;
	}
	public void setDimMeasureOrder(int dimMeasureOrder) {
		this.dimMeasureOrder = dimMeasureOrder;
	}

}

package com.jusfoun.jap.workTable.vo;

public class RuleVO {
	private String factTableRule;
	private String ruleName;
	public String getFactTableRule() {
		return factTableRule;
	}
	public void setFactTableRule(String factTableRule) {
		this.factTableRule = factTableRule;
	}
	public String getRuleName() {
		return ruleName;
	}
	public void setRuleName(String ruleName) {
		this.ruleName = ruleName;
	}

}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author Rain
 *
 */
public class Serie {
	private String name;
	private String type;
	private List<String> data;
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public String getType() {
		return type;
	}
	public void setType(String type) {
		this.type = type;
	}
	public List<String> getData() {
		return data;
	}
	public void setData(List<String> data) {
		this.data = data;
	}
	
	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author 
 *
 */
public class TableChinese {
	private String tableName;
	private String tableNameCn;
	private List<ColumnChineseVo> data;
	public String getTableName() {
		return tableName;
	}
	public void setTableName(String tableName) {
		this.tableName = tableName;
	}
	public String getTableNameCn() {
		return tableNameCn;
	}
	public void setTableNameCn(String tableNameCn) {
		this.tableNameCn = tableNameCn;
	}
	public List<ColumnChineseVo> getData() {
		return data;
	}
	public void setData(List<ColumnChineseVo> data) {
		this.data = data;
	}
	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

/**
 * @author Rain
 *
 */
public class Title {
	private String text;
	private String left;
	
	public String getText() {
		return text;
	}
	public void setText(String text) {
		this.text = text;
	}
	public String getLeft() {
		return left;
	}
	public void setLeft(String left) {
		this.left = left;
	}
	

}

/**
 *
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author Rain
 *
 */
public class WorkCondition {
	private List<CubeDimVo> dimTable;
	private List<Measures> measures;
	private String cubeId;
	private String workTableName;
	private String workTableCode;
	private String workTableId;

	public String getWorkTableName() {
		return workTableName;
	}

	public void setWorkTableName(String workTableName) {
		this.workTableName = workTableName;
	}

	private String dataType;// line,bar,pie,gauge（仪表盘图）,radar(雷达图),funnel(漏斗图),scatter(散点图),map

	public List<CubeDimVo> getDimTable() {
		return dimTable;
	}

	public void setDimTable(List<CubeDimVo> dimTable) {
		this.dimTable = dimTable;
	}

	public String getDataType() {
		return dataType;
	}

	public List<Measures> getMeasures() {
		return measures;
	}

	public void setMeasures(List<Measures> measures) {
		this.measures = measures;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getWorkTableId() {
		return workTableId;
	}

	public void setWorkTableId(String workTableId) {
		this.workTableId = workTableId;
	}

	public String getWorkTableCode() {
		return workTableCode;
	}

	public void setWorkTableCode(String workTableCode) {
		this.workTableCode = workTableCode;
	}

}

/**
 *
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author Rain
 *
 */
public class WorkTableCondition {
	private List<WorkTableDetail> dimTable;
	private List<WorkTableDetail> measures;
	private List<WorkTableDetail> filters;
	private String cubeId;
	private String userId;
	private String workTableName;
	private String workTableCode;//工作表编码
	private String workTableId;
	private String dataType;// line,bar,pie,gauge（仪表盘图）,radar(雷达图),funnel(漏斗图),scatter(散点图),map
	private String xsColor;
	private String xwColor;
	private String ysColor;
	private String ywColor;
	private String tableColor;
	private String bodyColor;
	private String headerColor;
	private String themeId;
	private String themeColor;
	private List<String> themeColorArr;
	
	
	/**
	 * @return the themeId
	 */
	public String getThemeId() {
		return themeId;
	}

	/**
	 * @param themeId the themeId to set
	 */
	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}

	public String getTableColor() {
		return tableColor;
	}

	public void setTableColor(String tableColor) {
		this.tableColor = tableColor;
	}

	public String getBodyColor() {
		return bodyColor;
	}

	public void setBodyColor(String bodyColor) {
		this.bodyColor = bodyColor;
	}

	public String getHeaderColor() {
		return headerColor;
	}

	public void setHeaderColor(String headerColor) {
		this.headerColor = headerColor;
	}

	public List<WorkTableDetail> getFilters() {
		return filters;
	}

	public void setFilters(List<WorkTableDetail> filters) {
		this.filters = filters;
	}

	public String getWorkTableId() {
		return workTableId;
	}

	public void setWorkTableId(String workTableId) {
		this.workTableId = workTableId;
	}

	public List<WorkTableDetail> getDimTable() {
		return dimTable;
	}

	public void setDimTable(List<WorkTableDetail> dimTable) {
		this.dimTable = dimTable;
	}

	public List<WorkTableDetail> getMeasures() {
		return measures;
	}

	public void setMeasures(List<WorkTableDetail> measures) {
		this.measures = measures;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getWorkTableName() {
		return workTableName;
	}

	public void setWorkTableName(String workTableName) {
		this.workTableName = workTableName;
	}

	public String getDataType() {
		return dataType;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public String getXsColor() {
		return xsColor;
	}

	public void setXsColor(String xsColor) {
		this.xsColor = xsColor;
	}

	public String getXwColor() {
		return xwColor;
	}

	public void setXwColor(String xwColor) {
		this.xwColor = xwColor;
	}

	public String getYsColor() {
		return ysColor;
	}

	public void setYsColor(String ysColor) {
		this.ysColor = ysColor;
	}

	public String getYwColor() {
		return ywColor;
	}

	public void setYwColor(String ywColor) {
		this.ywColor = ywColor;
	}

	public String getThemeColor() {
		return themeColor;
	}

	public void setThemeColor(String themeColor) {
		this.themeColor = themeColor;
	}

	public List<String> getThemeColorArr() {
		return themeColorArr;
	}

	public void setThemeColorArr(List<String> themeColorArr) {
		this.themeColorArr = themeColorArr;
	}

	public String getWorkTableCode() {
		return workTableCode;
	}

	public void setWorkTableCode(String workTableCode) {
		this.workTableCode = workTableCode;
	}
	
	
}

package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 *
 * @author zsy
 *
 */
public class WorkTableDetail {
	private String tableType;// 1代表筛选行里的维度，2代表筛选行里的度量,3维度行，4度量行
	private String workTableId;// 数据分析id
	private String tableName;// 事实表或维表表名
	private String tableNameCn;
	private String tableColumn;// 事实表或维表列名
	private String tableColumnCn;
	private String factTableRule;// 度量计算规则
	private String ruleName;//度量规则中文名
	private String dimFactFilterId;// 主键
	private List<String> listFilters;// 筛选条件
	private List<String> listAllValue;// 该维度的所有值
	private String listFilter;// 筛选条件
	private String nextFlag;
	private String chartType;
	private Integer dimMeasureOrder;//维度或度量的顺序
	private String factRules;
	private List<RuleVO> rules;
	
	public String getTableNameCn() {
		return tableNameCn;
	}

	public void setTableNameCn(String tableNameCn) {
		this.tableNameCn = tableNameCn;
	}

	public String getTableColumnCn() {
		return tableColumnCn;
	}

	public void setTableColumnCn(String tableColumnCn) {
		this.tableColumnCn = tableColumnCn;
	}

	public String getRuleName() {
		return ruleName;
	}

	public void setRuleName(String ruleName) {
		this.ruleName = ruleName;
	}


	/**
	 * @return the listFilters
	 */
	public List<String> getListFilters() {
		return listFilters;
	}

	/**
	 * @param listFilters the listFilters to set
	 */
	public void setListFilters(List<String> listFilters) {
		this.listFilters = listFilters;
	}

	/**
	 * @return the listFilter
	 */
	public String getListFilter() {
		return listFilter;
	}

	/**
	 * @param listFilter the listFilter to set
	 */
	public void setListFilter(String listFilter) {
		this.listFilter = listFilter;
	}

	public String getFactTableRule() {
		return factTableRule;
	}

	public void setFactTableRule(String factTableRule) {
		this.factTableRule = factTableRule;
	}

	public String getTableType() {
		return tableType;
	}

	public void setTableType(String tableType) {
		this.tableType = tableType;
	}

	public String getWorkTableId() {
		return workTableId;
	}

	public void setWorkTableId(String workTableId) {
		this.workTableId = workTableId;
	}

	public String getTableName() {
		return tableName;
	}

	public void setTableName(String tableName) {
		this.tableName = tableName;
	}

	public String getTableColumn() {
		return tableColumn;
	}

	public void setTableColumn(String tableColumn) {
		this.tableColumn = tableColumn;
	}

	public String getDimFactFilterId() {
		return dimFactFilterId;
	}

	public void setDimFactFilterId(String dimFactFilterId) {
		this.dimFactFilterId = dimFactFilterId;
	}

	public Integer getDimMeasureOrder() {
		return dimMeasureOrder;
	}

	public void setDimMeasureOrder(Integer dimMeasureOrder) {
		this.dimMeasureOrder = dimMeasureOrder;
	}

	public String getNextFlag() {
		return nextFlag;
	}

	public void setNextFlag(String nextFlag) {
		this.nextFlag = nextFlag;
	}

	public List<RuleVO> getRules() {
		return rules;
	}

	public void setRules(List<RuleVO> rules) {
		this.rules = rules;
	}

	public String getFactRules() {
		return factRules;
	}

	public void setFactRules(String factRules) {
		this.factRules = factRules;
	}

	public String getChartType() {
		return chartType;
	}

	public void setChartType(String chartType) {
		this.chartType = chartType;
	}

	public List<String> getListAllValue() {
		return listAllValue;
	}

	public void setListAllValue(List<String> listAllValue) {
		this.listAllValue = listAllValue;
	}
	
}

package com.jusfoun.jap.workTable.vo;

import java.util.Date;
import java.util.List;

import com.jusfoun.jap.common.Results;

public class WorkTableResult {
	private String workTableId;
	private String workTableName;
	private String workTableCode;
	private Date workTableDate;
	private String userId;
	private String dataType;
	private String cubeId;
	private Integer workTableOrder;//仪表盘中工作表顺序
	private String tableBorderShow;
	private String tableBorderColor;
	private String tableBorderWidth;
	private Results result;
	private String xsColor;
	private String xwColor;
	private String ysColor;
	private String ywColor;
	private String tableColor;
	private String bodyColor;
	private String headerColor;
	private List<WorkTableDetail> dimTable;
	private List<WorkTableDetail> measures;
	private List<WorkTableDetail> filters;
	
	
	public String getTableColor() {
		return tableColor;
	}

	public void setTableColor(String tableColor) {
		this.tableColor = tableColor;
	}

	public String getBodyColor() {
		return bodyColor;
	}

	public void setBodyColor(String bodyColor) {
		this.bodyColor = bodyColor;
	}

	public String getHeaderColor() {
		return headerColor;
	}

	public void setHeaderColor(String headerColor) {
		this.headerColor = headerColor;
	}
	public String getTableBorderShow() {
		return tableBorderShow;
	}

	public void setTableBorderShow(String tableBorderShow) {
		this.tableBorderShow = tableBorderShow;
	}

	public String getTableBorderColor() {
		return tableBorderColor;
	}

	public void setTableBorderColor(String tableBorderColor) {
		this.tableBorderColor = tableBorderColor;
	}

	public String getTableBorderWidth() {
		return tableBorderWidth;
	}

	public void setTableBorderWidth(String tableBorderWidth) {
		this.tableBorderWidth = tableBorderWidth;
	}

	public Integer getWorkTableOrder() {
		return workTableOrder;
	}

	public void setWorkTableOrder(Integer workTableOrder) {
		this.workTableOrder = workTableOrder;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getWorkTableId() {
		return workTableId;
	}

	public void setWorkTableId(String workTableId) {
		this.workTableId = workTableId;
	}

	public String getWorkTableName() {
		return workTableName;
	}

	public void setWorkTableName(String workTableName) {
		this.workTableName = workTableName;
	}


	public Date getWorkTableDate() {
		return workTableDate;
	}

	public void setWorkTableDate(Date workTableDate) {
		this.workTableDate = workTableDate;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public String getDataType() {
		return dataType;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}

	public Results getResult() {
		return result;
	}

	public void setResult(Results result) {
		this.result = result;
	}

	public String getXsColor() {
		return xsColor;
	}

	public void setXsColor(String xsColor) {
		this.xsColor = xsColor;
	}

	public String getXwColor() {
		return xwColor;
	}

	public void setXwColor(String xwColor) {
		this.xwColor = xwColor;
	}

	public String getYsColor() {
		return ysColor;
	}

	public void setYsColor(String ysColor) {
		this.ysColor = ysColor;
	}

	public String getYwColor() {
		return ywColor;
	}

	public void setYwColor(String ywColor) {
		this.ywColor = ywColor;
	}

	public List<WorkTableDetail> getFilters() {
		return filters;
	}

	public void setFilters(List<WorkTableDetail> filters) {
		this.filters = filters;
	}

	public List<WorkTableDetail> getMeasures() {
		return measures;
	}

	public void setMeasures(List<WorkTableDetail> measures) {
		this.measures = measures;
	}

	public List<WorkTableDetail> getDimTable() {
		return dimTable;
	}

	public void setDimTable(List<WorkTableDetail> dimTable) {
		this.dimTable = dimTable;
	}

	public String getWorkTableCode() {
		return workTableCode;
	}

	public void setWorkTableCode(String workTableCode) {
		this.workTableCode = workTableCode;
	}
	
}

package com.jusfoun.jap.workTable.vo;

import java.util.Date;
import java.util.List;

import javax.persistence.Column;

public class WorkTableVo {
	private String workTableId;
	private String workTableName;
	private String workTableCode;
	private Date workTableDate;
	private String userId;
	private String dataType;
	private String cubeId;
	private Integer workTableOrder;//仪表盘中工作表顺序
	private String tableBorderShow;
	private String tableBorderColor;
	private String tableBorderWidth;
	private String xsColor;
	private String xwColor;
	private String ysColor;
	private String ywColor;
	private String tableColor;
	private String bodyColor;
	private String headerColor;
	private String themeId;
	private String themeColor;
	private List<String> themeColorArr;
	
	/**
	 * @return the themeId
	 */
	public String getThemeId() {
		return themeId;
	}

	/**
	 * @param themeId the themeId to set
	 */
	public void setThemeId(String themeId) {
		this.themeId = themeId;
	}

	public String getTableColor() {
		return tableColor;
	}

	public void setTableColor(String tableColor) {
		this.tableColor = tableColor;
	}

	public String getBodyColor() {
		return bodyColor;
	}

	public void setBodyColor(String bodyColor) {
		this.bodyColor = bodyColor;
	}

	public String getHeaderColor() {
		return headerColor;
	}

	public void setHeaderColor(String headerColor) {
		this.headerColor = headerColor;
	}

	public String getXsColor() {
		return xsColor;
	}

	public void setXsColor(String xsColor) {
		this.xsColor = xsColor;
	}

	public String getXwColor() {
		return xwColor;
	}

	public void setXwColor(String xwColor) {
		this.xwColor = xwColor;
	}

	public String getYsColor() {
		return ysColor;
	}

	public void setYsColor(String ysColor) {
		this.ysColor = ysColor;
	}

	public String getYwColor() {
		return ywColor;
	}

	public void setYwColor(String ywColor) {
		this.ywColor = ywColor;
	}

	public String getTableBorderShow() {
		return tableBorderShow;
	}

	public void setTableBorderShow(String tableBorderShow) {
		this.tableBorderShow = tableBorderShow;
	}

	public String getTableBorderColor() {
		return tableBorderColor;
	}

	public void setTableBorderColor(String tableBorderColor) {
		this.tableBorderColor = tableBorderColor;
	}

	public String getTableBorderWidth() {
		return tableBorderWidth;
	}

	public void setTableBorderWidth(String tableBorderWidth) {
		this.tableBorderWidth = tableBorderWidth;
	}

	public Integer getWorkTableOrder() {
		return workTableOrder;
	}

	public void setWorkTableOrder(Integer workTableOrder) {
		this.workTableOrder = workTableOrder;
	}

	public String getCubeId() {
		return cubeId;
	}

	public void setCubeId(String cubeId) {
		this.cubeId = cubeId;
	}

	public String getWorkTableId() {
		return workTableId;
	}

	public void setWorkTableId(String workTableId) {
		this.workTableId = workTableId;
	}

	public String getWorkTableName() {
		return workTableName;
	}

	public void setWorkTableName(String workTableName) {
		this.workTableName = workTableName;
	}


	public Date getWorkTableDate() {
		return workTableDate;
	}

	public void setWorkTableDate(Date workTableDate) {
		this.workTableDate = workTableDate;
	}

	public String getUserId() {
		return userId;
	}

	public void setUserId(String userId) {
		this.userId = userId;
	}

	public String getDataType() {
		return dataType;
	}

	public void setDataType(String dataType) {
		this.dataType = dataType;
	}

	public String getThemeColor() {
		return themeColor;
	}

	public void setThemeColor(String themeColor) {
		this.themeColor = themeColor;
	}

	public List<String> getThemeColorArr() {
		return themeColorArr;
	}

	public void setThemeColorArr(List<String> themeColorArr) {
		this.themeColorArr = themeColorArr;
	}

	public String getWorkTableCode() {
		return workTableCode;
	}

	public void setWorkTableCode(String workTableCode) {
		this.workTableCode = workTableCode;
	}

}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

import java.util.List;

/**
 * @author Rain
 */
public class Xaxis {
	private String type;
	private String name;
	private String splitLine;
	private List<String> data;
	public String getType() {
		return type;
	}
	public void setType(String type) {
		this.type = type;
	}
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	public String getSplitLine() {
		return splitLine;
	}
	public void setSplitLine(String splitLine) {
		this.splitLine = splitLine;
	}
	public List<String> getData() {
		return data;
	}
	public void setData(List<String> data) {
		this.data = data;
	}
	
	
}

/**
 * 
 */
package com.jusfoun.jap.workTable.vo;

/**
 * @author Rain
 *
 */
public class Yaxis {
	private String type;
	private String name;
	public String getType() {
		return type;
	}
	public void setType(String type) {
		this.type = type;
	}
	public String getName() {
		return name;
	}
	public void setName(String name) {
		this.name = name;
	}
	
	
}

package jap;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.SpringApplicationConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.web.WebAppConfiguration;

import com.alibaba.fastjson.JSON;
import com.jusfoun.Application;
import com.jusfoun.jap.hive.domain.HiveTable;
import com.jusfoun.jap.hive.domain.HiveTableRelation;
import com.jusfoun.jap.hive.domain.KylinTable;
import com.jusfoun.jap.hive.domain.KylinTableColumn;
import com.jusfoun.jap.hive.service.HiveService;
import com.jusfoun.jap.hive.util.HiveUtil;
import com.jusfoun.jap.hive.vo.ColumnVo;
import com.jusfoun.jap.hive.vo.DimensionVo;
import com.jusfoun.jap.hive.vo.HiveTableVo;
import com.jusfoun.jap.hive.vo.MeasureVo;
import com.jusfoun.jap.hive.vo.ModelVo;
import com.jusfoun.jap.hive.vo.RelationVo;
import com.jusfoun.jap.kylin.service.KylinService;

@RunWith(SpringJUnit4ClassRunner.class)
@SpringApplicationConfiguration(classes = Application.class)
@WebAppConfiguration
public class HiveTest {
	@Autowired
	HiveService hiveService;
	@Autowired
	KylinService kylinService;
	@Test
	public void test(){
		ModelVo modelVo=new ModelVo();
		List<DimensionVo> dimensions=new ArrayList<DimensionVo>();
		DimensionVo dim=new DimensionVo();
		dim.setColumnName("customtype");
		dim.setDataType("string");
		dim.setRemarks("客户类型");
		dim.setTableName("orderTable");
		dimensions.add(dim);
		DimensionVo dim2=new DimensionVo();
		dim2.setColumnName("time");
		dim2.setDataType("string");
		dim2.setRemarks("时间");
		dim2.setTableName("timeTable");
		dimensions.add(dim2);
		DimensionVo dim3=new DimensionVo();
		dim3.setColumnName("ordertype");
		dim3.setDataType("string");
		dim3.setRemarks("订单类型");
		dim3.setTableName("orderTable");
		dimensions.add(dim3);
		modelVo.setDimensions(dimensions);
		List<MeasureVo> measures=new ArrayList<MeasureVo>();
		MeasureVo mea=new MeasureVo();
		mea.setColumnName("money");
		mea.setComputationRules("sum");
		mea.setDataType("string");
		mea.setRemarks("金钱度量");
		mea.setTableName("moneyTable");
		measures.add(mea);
//		MeasureVo mea2=new MeasureVo();
//		mea2.setColumnName("total");
//		mea2.setComputationRules("sum");
//		mea2.setDataType("string");
//		mea2.setRemarks("数量度量");
//		mea2.setTableName("time_table");
//		measures.add(mea2);
		modelVo.setMeasures(measures);
		modelVo.setModelDesc("zhanghao_order");
		modelVo.setModelName("zhanghao_order");
//		modelVo.setRelations(relations);
//		modelVo.setSyncPolicy("每5分钟");
		try {
			kylinService.sendKylinRequest(hiveService.generateModel(modelVo));
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	
//	@Test
	public void createHive(){
		HiveTableVo vo=new HiveTableVo();
		vo.setTableName("hivetable");
		vo.setTableRemarks("张浩的第一张hive表");
		List<ColumnVo> columns=new ArrayList<ColumnVo>();
		ColumnVo cv1=new ColumnVo();
		cv1.setColumnName("column1");
		cv1.setColumnRemarks("字段1");
		cv1.setDataType("String");
		columns.add(cv1);
		ColumnVo cv2=new ColumnVo();
		cv2.setColumnName("column2");
		cv2.setColumnRemarks("字段2");
		cv2.setDataType("String");
		columns.add(cv2);
		vo.setColumns(columns);
		hiveService.creatTableInHive(vo);
	}
	
//	@Test
	public void getHiveList(){
//		for(HiveTableVo vo: HiveUtil.listHiveTableVoList("fact_water_quality_change")){
//			System.out.println(JSON.toJSON(vo));
//		}
		
	}
	
//	@Test
	public void getHive(){
		List<RelationVo> list=hiveService.findHiveTableRelationVoByCubeId("1");
		System.out.println(JSON.toJSON(list.get(0)));
		
	}
	
	public void showModelDetail(){
		String cubeId="1";
		ModelVo mv=new ModelVo();
		HiveTableVo factTable=new HiveTableVo();
		List<KylinTable> kylinTables=hiveService.findKylinTableByCubeId(cubeId);
		List<String> ids=new ArrayList<String>();
		Set<String> tableIds=new HashSet<String>(); 
		Map<String,String> tableMap=new HashMap<String,String>();
		for(KylinTable kt:kylinTables){
			ids.add(kt.getTableId());
			tableMap.put(kt.getTableId(), kt.getTableName());
			//如果为1 说明是事实表
			if("1".equals(kt.getTableType())){
				factTable.setTableName(kt.getTableName());
				mv.setModelDesc(kt.getTableDesc());
//				mv.setSyncPolicy(kt.getSyncPolicy());
			}
		}
		List<KylinTableColumn> kylinTableColumns=hiveService.findHiveTableColumnByTableId(ids);
		
		for(KylinTableColumn ktc :kylinTableColumns){
			tableIds.add(ktc.getColumnSource());
		}
		List<HiveTable> hiveTables=hiveService.findHiveTableByTableId(tableIds);
		for(HiveTable ht:hiveTables){
			tableMap.put(ht.getTableId(), ht.getTableName());
		}
		
		for(KylinTableColumn ktc :kylinTableColumns){
			//1表示维度
			if("1".equals(ktc.getColumnType())){
				DimensionVo dim=new DimensionVo();
				dim.setColumnName(ktc.getColumnName());
				dim.setDataType(ktc.getDateType());
				dim.setRemarks(ktc.getColumnDesc());
				dim.setTableName(tableMap.get(ktc.getColumnSource()));
				mv.getDimensions().add(dim);
			}else{
				//度量
				MeasureVo mea=new MeasureVo();
				mea.setColumnName(ktc.getColumnName());
				mea.setDataType(ktc.getDateType());
				mea.setComputationRules(ktc.getComputationRules());
				mea.setRemarks(ktc.getColumnDesc());
				mea.setTableName(tableMap.get(ktc.getColumnSource()));
			}
		}
		//事实表
		mv.setFactTable(factTable);
		//关系
		List<RelationVo> relations=hiveService.findHiveTableRelationVoByCubeId(cubeId);
		mv.setRelations(relations);
		
		
	}
	
	
	

}

